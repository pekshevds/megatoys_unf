
Функция ИспользоватьИнтеграцию() Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ИспользоватьИнтеграциюСИнтернетМагазином = Константы.ИспользоватьИнтеграциюСИнтернетМагазином.Получить()
	Или Не Константы.ФункциональнаяОпцияИспользоватьОбменССайтами.Получить();
	
	Возврат ИспользоватьИнтеграциюСИнтернетМагазином;
	
КонецФункции

Функция ЗначенияРеквизитовОбъекта(Ссылка, Знач Реквизиты, ВыбратьРазрешенные = Ложь, Знач КодЯзыка = Неопределено) Экспорт
	
	Возврат ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Ссылка, Реквизиты, ВыбратьРазрешенные, КодЯзыка);
	
КонецФункции

Функция ЗначениеРеквизитаОбъекта(Ссылка, Знач Реквизиты, ВыбратьРазрешенные = Ложь, Знач КодЯзыка = Неопределено) Экспорт
	
	Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Ссылка, Реквизиты, ВыбратьРазрешенные, КодЯзыка);
	
КонецФункции

Функция ПолучитьФайлыОбмена(НастройкаИнтеграции, ВыгружатьТолькоИзменения = Истина, ПараметрыКонтекст = Неопределено) Экспорт
	Возврат ИнтеграцияСИнтернетМагазиномСервер.ПолучитьФайлыОбмена(НастройкаИнтеграции, ВыгружатьТолькоИзменения, ПараметрыКонтекст);
КонецФункции

Функция ЗагрузитьЗаказыИзФайла(НастройкаИнтеграции, АдресХранилища) Экспорт
	
	КодНастройкиИнтеграции = "" + НастройкаИнтеграции.УникальныйИдентификатор();
	
	ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресХранилища);
	Если ДвоичныеДанные = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла("xml");
	ДвоичныеДанные.Записать(ИмяВременногоФайла);
	
	Файл = Новый Файл(ИмяВременногоФайла);
	
	Если НЕ Файл.Существует() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ЧтениеТекста = Новый ЧтениеТекста(ИмяВременногоФайла, КодировкаФайла(ИмяВременногоФайла));
	ДанныеЗаказовXDTO = ЧтениеТекста.Прочитать();
	ЧтениеТекста.Закрыть();
	
	УдалитьФайлы(ИмяВременногоФайла);
	
	Возврат ИнтеграцияСИнтернетМагазиномСервер.ЗагрузитьЗаказыВебСервис(ДанныеЗаказовXDTO, КодНастройкиИнтеграции);
	
КонецФункции

Функция КодировкаФайла(ИмяФайла)
	
	КодировкаXML = "UTF-8";
	
	ЧтениеXML = Новый ЧтениеXML;
	Попытка
		ЧтениеXML.ОткрытьФайл(ИмяФайла);
		ЧтениеXML.Прочитать();
		КодировкаXML = ЧтениеXML.КодировкаXML;
	Исключение
	КонецПопытки;
	ЧтениеXML.Закрыть();
	
	Возврат КодировкаXML;
	
КонецФункции


Функция ПрочитатьДанныеНаСервере(НастройкаИнтеграции, ИмяПоля) Экспорт
	
	СостояниеОбмена = РегистрыСведений.СостоянияОбменовИнтернетМагазина.СоздатьМенеджерЗаписи();
	СостояниеОбмена.НастройкаИнтеграции = НастройкаИнтеграции;
	СостояниеОбмена.ДействиеПриОбмене = Перечисления.ДействияПриОбмене.ЗагрузкаДанных;
	СостояниеОбмена.Прочитать();
	
	Возврат СостояниеОбмена[ИмяПоля].Получить();
	
КонецФункции

Функция ПрочитатьТекстОшибкиНаСервере(НастройкаИнтеграции) Экспорт
	
	СостояниеОбмена = РегистрыСведений.СостоянияОбменовИнтернетМагазина.СоздатьМенеджерЗаписи();
	СостояниеОбмена.НастройкаИнтеграции = НастройкаИнтеграции;
	СостояниеОбмена.ДействиеПриОбмене = Перечисления.ДействияПриОбмене.ЗагрузкаДанных;
	СостояниеОбмена.Прочитать();
	
	Возврат СостояниеОбмена.ПоследнийТекстОшибки;
	
КонецФункции

