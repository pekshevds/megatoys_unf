#Область ПрограммныйИнтерфейс

// Выполняет обработку оповещения о записи печатных форм объектов, обновляет
// информацию о блокировке.
//
// Параметры:
//  УправляемаяФорма - УправляемаяФорма
//  ИмяСобытия       - Строка
//   Параметр        - Произвольный - См. описание одноименного параметра в синтакс-помощнике
//                      "ФормаКлиентскогоПриложения.ОбработкаОповещения".
//   Источник        - Произвольный - См. описание одноименного параметра в синтакс-помощнике
//                      "ФормаКлиентскогоПриложения.ОбработкаОповещения".
//
Процедура ОбработкаОповещения(УправляемаяФорма, ИмяСобытия, Параметр, Источник) Экспорт
	
	Если ИмяСобытия = ИмяСобытияПриЗаписиПечатныхФорм() Тогда
		
		Если УправляемаяФорма.Объект.Ссылка = Источник Тогда
			
			Структура = Новый Структура("ИдентификаторыФайловСЭЦП,РеквизитыИдентификаторов", Null, Null);
			ЗаполнитьЗначенияСвойств(Структура, УправляемаяФорма);
			Если Структура.ИдентификаторыФайловСЭЦП <> Null
				И Структура.РеквизитыИдентификаторов <> Null Тогда
				
				Если Структура.ИдентификаторыФайловСЭЦП = Неопределено Тогда
					ИдентификаторыФайловСЭЦП = Новый Соответствие;
				Иначе
					ИдентификаторыФайловСЭЦП = Новый Соответствие(Структура.ИдентификаторыФайловСЭЦП);
				КонецЕсли;
				
				Для Каждого ЭлементСтруктуры Из Параметр Цикл
					ИдентификаторКоманды = Структура.РеквизитыИдентификаторов.Получить(ЭлементСтруктуры.Ключ);
					Если ИдентификаторКоманды <> Неопределено Тогда
						ИдентификаторыФайловСЭЦП.Вставить(ИдентификаторКоманды, Истина);
					КонецЕсли;
				КонецЦикла;
				
				УправляемаяФорма.ИдентификаторыФайловСЭЦП = Новый ФиксированноеСоответствие(ИдентификаторыФайловСЭЦП);
				
				ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(УправляемаяФорма);
				
			КонецЕсли;
			
			БлокировкаИзмененияОбъектовКлиентСервер.ОбновитьГруппуБлокировкиИзмененияОбъекта(УправляемаяФорма, Истина);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Обновляет подключаемые команды в форме списка при обработке оповещения о записи печатных форм.
//
// Параметры:
//  УправляемаяФорма - УправляемаяФорма
//  ИмяСобытия       - Строка
//  Параметр         - Произвольный - См. описание одноименного параметра в синтакс-помощнике
//                      "ФормаКлиентскогоПриложения.ОбработкаОповещения".
//  Источник         - Произвольный - См. описание одноименного параметра в синтакс-помощнике
//                      "ФормаКлиентскогоПриложения.ОбработкаОповещения".
//
Процедура ОбработкаОповещенияВФормеСписка(УправляемаяФорма, ИмяСобытия, Параметр, Источник) Экспорт
	
	Если ИмяСобытия = ИмяСобытияПриЗаписиПечатныхФорм() Тогда
		
		ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(УправляемаяФорма);
		
	КонецЕсли;
	
КонецПроцедуры

// СтандартныеПодсистемы.УправлениеПечатью

// См. УправлениеПечатьюКлиентПереопределяемый.ПечатьДокументовВыполнитьКоманду
//
Процедура ПечатьДокументовВыполнитьКоманду(Форма, Команда, ПродолжитьВыполнениеНаСервере, ДополнительныеПараметры) Экспорт
	
	Если Команда.Имя = "СохранитьВPDFИПодписатьФайл" Тогда
		ПодписатьПоНастройкам(Форма,
			ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ЗаписатьНаДиск"));
	ИначеЕсли Команда.Имя = "ОтправитьПодписанныеPDF" Тогда
		ПодписатьПоНастройкам(Форма,
			ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ОтправитьПоПочте"));
	ИначеЕсли Команда.Имя = "ПодписатьПечатныеФормы" Тогда
		Если Форма.Параметры.ПараметрыПечати.Свойство("ЦельПодписания") Тогда
			ПодписатьПечатныеФомыПриПечати(Форма, Форма.Параметры.ПараметрыПечати.ЦельПодписания);
		Иначе
			ПодписатьПечатныеФомыПриПечати(Форма,
				ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.Подписать"));
		КонецЕсли;
	ИначеЕсли Команда.Имя = "НачатьИзменениеПечатнойФормы" Тогда
		ВключитьРедактированиеПечатнойФормы(Форма);
	ИначеЕсли Команда.Имя = "НастроитьИПодписать" Тогда
		ЦельПодписания = Неопределено;
		Форма.Параметры.ПараметрыПечати.Свойство("ЦельПодписания", ЦельПодписания);
		НастроитьИПодписать(Форма, ЦельПодписания);
	ИначеЕсли Команда.Имя = "ОтказатьВПодписанииПечатныхФорм" Тогда
		ОтказатьВПодписании(Форма);
	ИначеЕсли Команда.Имя = "ОзнакомленоСКомментариямиКПечатнойФорме" Тогда
		ОзнакомитьсяСКомментариямиКПечатнойФорме(Форма);
	КонецЕсли;
	
	ИнтеграцияСРаботаВРоссииКлиент.ПечатьДокументовВыполнитьКоманду(Форма, Команда, ПродолжитьВыполнениеНаСервере, ДополнительныеПараметры);
	КабинетСотрудникаКлиент.ПечатьДокументовВыполнитьКоманду(Форма, Команда, ПродолжитьВыполнениеНаСервере, ДополнительныеПараметры);
	
КонецПроцедуры

// См. УправлениеПечатьюКлиентПереопределяемый.ПечатьДокументовПослеОткрытия
Процедура ПечатьДокументовПослеОткрытия(Форма) Экспорт
	
	Элементы = Форма.Элементы;
	
	Если Элементы.Страницы.ТекущаяСтраница = Элементы.СтраницаПечатнаяФормаНедоступна Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"НастроитьИПодписать",
			"Доступность",
			Ложь);
		
		ДоступностьКоманд = Элементы.Страницы.ТекущаяСтраница <> Элементы.СтраницаПечатнаяФормаНедоступна;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"СохранитьВPDFИПодписатьФайл",
			"Доступность",
			Ложь);
		
		ДоступностьКоманд = Элементы.Страницы.ТекущаяСтраница <> Элементы.СтраницаПечатнаяФормаНедоступна;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ОтправитьПодписанныеPDF",
			"Доступность",
			Ложь);
		
		ДоступностьКоманд = Элементы.Страницы.ТекущаяСтраница <> Элементы.СтраницаПечатнаяФормаНедоступна;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ПередатьПодписанныеPDFВСервисКабинетСотрудника",
			"Доступность",
			Ложь);
			
		ДоступностьКоманд = Элементы.Страницы.ТекущаяСтраница <> Элементы.СтраницаПечатнаяФормаНедоступна;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ПередатьПодписанныеPDFНаРаботаВРоссии",
			"Доступность",
			Ложь);
			
		ДоступностьКоманд = Элементы.Страницы.ТекущаяСтраница <> Элементы.СтраницаПечатнаяФормаНедоступна;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			КадровыйЭДОКлиентСервер.ПрефиксЭлементовОВозможностиРедактирования() + "КомандаРедактирования",
			"Доступность",
			Ложь);
			
	КонецЕсли;
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеПечатью

// Выполняет подписание печатных форм, выведенных в общую форму ПечатьДокументов.
//
// Параметры:
//  УправляемаяФорма              - УправляемаяФорма, общая форма ПечатьДокументов
//  ЦельПодписания                - ПеречислениеСсылка.ДействияСФайламиДокументовКЭДО
//  ДанныеСертификатовОрганизаций - Соответсвие
//										* Ключ     - Организация
//										* Значение - Массив, ссылок на
//											- СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования
//											- СправочникСсылка.Пользователи
//
Процедура ПодписатьПечатныеФомыПриПечати(УправляемаяФорма, ЦельПодписания, НастройкиПодписания = Неопределено) Экспорт
	
	// Сохранение отредактированной печатной формы
	НастройкаПечатнойФормы = УправлениеПечатьюКлиент.НастройкаТекущейПечатнойФормы(УправляемаяФорма);
	Если НастройкаПечатнойФормы <> Неопределено Тогда
		Если Не УправляемаяФорма.Элементы[НастройкаПечатнойФормы.ИмяРеквизита].Защита Тогда
			УправляемаяФорма[НастройкаПечатнойФормы.ИмяРеквизита] = УправляемаяФорма.ТекущаяПечатнаяФорма;
		КонецЕсли;
	КонецЕсли;
	
	ПечатныеФормы = Новый Массив;
	Для Каждого НастройкаПечатнойФормы Из УправляемаяФорма.НастройкиПечатныхФорм Цикл
		
		Если НастройкаПечатнойФормы.Печатать Тогда
			
			ОбластьТекст = УправляемаяФорма[НастройкаПечатнойФормы.ИмяРеквизита].Область(1, 1,
				УправляемаяФорма[НастройкаПечатнойФормы.ИмяРеквизита].ВысотаТаблицы,
				УправляемаяФорма[НастройкаПечатнойФормы.ИмяРеквизита].ШиринаТаблицы).Текст;
			
			ОписаниеФормы = Новый Структура;
			ОписаниеФормы.Вставить("ПечатнаяФорма", УправляемаяФорма[НастройкаПечатнойФормы.ИмяРеквизита]);
			ОписаниеФормы.Вставить("ИдентификаторПечатнойФормы", НастройкаПечатнойФормы.ИмяМакета);
			ОписаниеФормы.Вставить("Название", НастройкаПечатнойФормы.Название);
			
			ПечатныеФормы.Добавить(ОписаниеФормы);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если УправляемаяФорма.ПараметрыВывода.Свойство("ПараметрыПечатиВнешнейПечатнойФормы")
		И ЗначениеЗаполнено(УправляемаяФорма.ПараметрыВывода.ПараметрыПечатиВнешнейПечатнойФормы) Тогда
		
		Если Не УправляемаяФорма.Параметры.ПараметрыПечати.Свойство("ДополнительныеПараметры")
			Или Не ЗначениеЗаполнено(УправляемаяФорма.Параметры.ПараметрыПечати.ДополнительныеПараметры) Тогда
			
			УправляемаяФорма.Параметры.ПараметрыПечати.Вставить("ДополнительныеПараметры", Новый Структура);
		КонецЕсли;
		
		Для Каждого ОписаниеПараметра Из УправляемаяФорма.ПараметрыВывода.ПараметрыПечатиВнешнейПечатнойФормы Цикл
			Если ЗначениеЗаполнено(ОписаниеПараметра.Значение)
				И Не УправляемаяФорма.Параметры.ПараметрыПечати.ДополнительныеПараметры.Свойство(ОписаниеПараметра.Ключ) Тогда
				
				УправляемаяФорма.Параметры.ПараметрыПечати.ДополнительныеПараметры.Вставить(
					ОписаниеПараметра.Ключ, ОписаниеПараметра.Значение);
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	ПечатныеФормыОбъектов = КадровыйЭДОВызовСервера.ПечатныеФормыОбъектов(
		ПечатныеФормы,
		УправляемаяФорма.ОбъектыПечати,
		УправляемаяФорма.Параметры.ПараметрыПечати,
		УправляемаяФорма.УникальныйИдентификатор);
	
	Если Не ЗначениеЗаполнено(ПечатныеФормыОбъектов) Тогда
		Возврат;
	КонецЕсли;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Форма", УправляемаяФорма);
	ДополнительныеПараметры.Вставить("ПечатныеФормыОбъектов", ПечатныеФормыОбъектов);
	ДополнительныеПараметры.Вставить("ЦельПодписания", ЦельПодписания);
	ДополнительныеПараметры.Вставить("ПечатныеФормы", ПечатныеФормы);
	ДополнительныеПараметры.Вставить("ОбъектыПечати", УправляемаяФорма.ОбъектыПечати);
	
	Если УправляемаяФорма.Параметры.ПараметрыПечати.ДополнительныеПараметры.Свойство("ТребуетсяПечатнаяФормаБезПодписи")
		И УправляемаяФорма.Параметры.ПараметрыПечати.ДополнительныеПараметры.ТребуетсяПечатнаяФормаБезПодписи = Истина Тогда
		
		ПоказатьСостояниеСохраненныхБезЦифровыхПодписей(ПечатныеФормыОбъектов.Количество());
		Для Каждого ОписаниеПечатнойФормы Из ПечатныеФормыОбъектов Цикл
			ДанныеИдентификаторовПечатныхФорм = Новый Соответствие;
			ДанныеИдентификаторовПечатныхФорм.Вставить(ОписаниеПечатнойФормы.ИдентификаторПечатнойФормы, Истина);
			ОповеститьОбИзмененииПечатнойФормы(ОписаниеПечатнойФормы.Владелец, ДанныеИдентификаторовПечатныхФорм);
			ПослеПодписанияСохраненныхФорм(Истина, ДополнительныеПараметры); 
		КонецЦикла;
		Возврат;
	КонецЕсли;
	
	Оповещение = Новый ОписаниеОповещения("ПослеПодписанияСохраненныхФорм", ЭтотОбъект, ДополнительныеПараметры);
	ПодписатьФайлы(ПечатныеФормыОбъектов, Оповещение, УправляемаяФорма, ЦельПодписания, НастройкиПодписания);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

Функция ВыполнитьКомандуОткрытияПодписанныхФайлов(КомандаПечати) Экспорт
	
	Если ЭлектроннаяПодписьКлиент.ИспользоватьЭлектронныеПодписи() Тогда
		ПроверитьСертификатыПодписей(КомандаПечати);
		Возврат Неопределено;
	КонецЕсли;
	
	УправлениеПечатьюБЗККлиент.ВыполнитьКомандуПечати(КомандаПечати);
	
КонецФункции

Функция РазблокироватьФормуОбъекта(УправляемаяФорма, СсылкаНаОбъект) Экспорт
	
	Результат = КадровыйЭДОВызовСервера.РазблокироватьФормуОбъекта(СсылкаНаОбъект);
	Если ПустаяСтрока(Результат) Тогда
		
		Структура = Новый Структура("ИдентификаторыФайловСЭЦП", Null);
		ЗаполнитьЗначенияСвойств(Структура, УправляемаяФорма);
		Если Структура.ИдентификаторыФайловСЭЦП <> Null Тогда
			УправляемаяФорма.ИдентификаторыФайловСЭЦП = Неопределено;
		КонецЕсли;
		
		ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(УправляемаяФорма);
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ОткрытьФормуПодписанияПечатныхФорм(ПрисоединенныеФайлы, ВладелецФормы = Неопределено, ОписаниеОповещения = Неопределено, РежимОткрытия = Неопределено, ЦельПодписания = Неопределено, ЗаполнитьПараметрыКоманды = Ложь) Экспорт
	
	ПараметрыОткрытия = КадровыйЭДОВызовСервера.ПараметрыОткрытияФормыПодписанияПрисоединенныхФайлов(ПрисоединенныеФайлы, ЗаполнитьПараметрыКоманды);
	Если ЦельПодписания <> Неопределено Тогда
		Если Не ПараметрыОткрытия.Свойство("ПараметрыПечати") Тогда
			ПараметрыОткрытия.Вставить("ПараметрыОткрытия", Новый Структура);
		КонецЕсли;
		
		ПараметрыОткрытия.ПараметрыПечати.Вставить("ЦельПодписания", ЦельПодписания);
		
	КонецЕсли;
	ОткрытьФорму("ОбщаяФорма.ПечатьДокументов", ПараметрыОткрытия, ВладелецФормы, Истина, , , ОписаниеОповещения, РежимОткрытия);
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыПодписанияПечатныхФорм(ДокументыКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(ДокументыКадровогоЭДО) Тогда
		
		ЭлектронныеДокументы =
			КадровыйЭДОВызовСервера.ЭлектронныеДокументыПоСсылкамНаДокументыКадровогоЭДО(ДокументыКадровогоЭДО);
		
		ДополнительныеПараметрыОповещенияВопроса = Новый Структура;
		ДополнительныеПараметрыОповещенияВопроса.Вставить("Форма", ДополнительныеПараметры.Форма);
		ДополнительныеПараметрыОповещенияВопроса.Вставить("ЭлектронныеДокументы", ЭлектронныеДокументы);
		
		Если ЗначениеЗаполнено(ЭлектронныеДокументы.ПечатныеФормы)
			И Не ЗначениеЗаполнено(ЭлектронныеДокументы.ПрисоединенныеФайлы) Тогда
			
			ОбработатьВыборДокументовНаПодпись(
				Новый Структура("Значение", "ПодписатьДокументыСПечатнымиФормами"), ДополнительныеПараметрыОповещенияВопроса);
		ИначеЕсли Не ЗначениеЗаполнено(ЭлектронныеДокументы.ПечатныеФормы)
			И ЗначениеЗаполнено(ЭлектронныеДокументы.ПрисоединенныеФайлы) Тогда
			
			ОбработатьВыборДокументовНаПодпись(
				Новый Структура("Значение", "ПодписатьДокументыСФайлами"), ДополнительныеПараметрыОповещенияВопроса);
		Иначе
			
			Оповещение = Новый ОписаниеОповещения("ОбработатьВыборДокументовНаПодпись",
				ЭтотОбъект, ДополнительныеПараметрыОповещенияВопроса);
			
			ТекстВопроса = НСтр("ru = 'Среди выбранных документов есть документы с печатными формами и документы с файлами.
				|За один подход можно подписать документы с печатными формами или документы с файлами.'");
			
			КнопкиВопроса = Новый СписокЗначений;
			КнопкиВопроса.Добавить("ПодписатьДокументыСПечатнымиФормами", НСтр("ru = 'Подписать документы с печатными формами'"));
			КнопкиВопроса.Добавить("ПодписатьДокументыСФайлами", НСтр("ru = 'Подписать документы с файлами'"));
			КнопкиВопроса.Добавить(КодВозвратаДиалога.Отмена, НСтр("ru = 'Отмена'"));
			
			ПараметрыВопроса = СтандартныеПодсистемыКлиент.ПараметрыВопросаПользователю();
			ПараметрыВопроса.ПредлагатьБольшеНеЗадаватьЭтотВопрос = Ложь;
			
			СтандартныеПодсистемыКлиент.ПоказатьВопросПользователю(Оповещение, ТекстВопроса, КнопкиВопроса, ПараметрыВопроса);
			
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыСохранитьЭД(ДокументыКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(ДокументыКадровогоЭДО) Тогда
		СохранитьДокументыКЭДОНаДиск(ДокументыКадровогоЭДО);
		ОповеститьОНеобходимостиОбновленияФорм(ДокументыКадровогоЭДО);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыОткрытияЭлектронногоДокумента(ДокументКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(ДокументКадровогоЭДО) Тогда
		
		ЭлектронныйДокумент = КадровыйЭДОВызовСервера.ЭлектронныйДокументКадровогоЭДО(ДокументКадровогоЭДО);
		Если ЗначениеЗаполнено(ЭлектронныйДокумент) Тогда
			
			ДанныеФайла = РаботаСФайламиКлиент.ДанныеФайла(
				ЭлектронныйДокумент, ДополнительныеПараметры.Форма.УникальныйИдентификатор, Ложь);
			
			Если ДополнительныеПараметры.Форма.ЗапрещенныеРасширения.НайтиПоЗначению(ДанныеФайла.Расширение) <> Неопределено Тогда
				ДополнительныеПараметрыОповещения = Новый Структура;
				ДополнительныеПараметрыОповещения.Вставить("ЭлектронныйДокумент", ЭлектронныйДокумент);
				ДополнительныеПараметрыОповещения.Вставить("Форма", ДополнительныеПараметры.Форма);
				Оповещение = Новый ОписаниеОповещения(
					"ОткрытьЭлектронныйДокументПослеПодтверждения", ЭтотОбъект, ДополнительныеПараметрыОповещения);
				ПараметрыФормы = Новый Структура("Ключ", "ПередОткрытиемФайла");
				ОткрытьФорму("ОбщаяФорма.ПредупреждениеБезопасности", ПараметрыФормы, , , , , Оповещение);
				Возврат;
			КонецЕсли;
			
			ОткрытьЭлектронныйДокумент(ЭлектронныйДокумент,
				ДополнительныеПараметры.Форма.УникальныйИдентификатор);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыОткрытияВерсииЭлектронногоДокументаДляПечати(ДокументКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(ДокументКадровогоЭДО) Тогда
		
		ЭлектронныйДокумент = КадровыйЭДОВызовСервера.ЭлектронныйДокументКадровогоЭДО(ДокументКадровогоЭДО);
		Если ЗначениеЗаполнено(ЭлектронныйДокумент) Тогда
			ДанныеФайлаНаПечать = КадровыйЭДОВызовСервера.ДанныеЭлектронногоДокументаСоШтампамиПодписей(
				ЭлектронныйДокумент, ДополнительныеПараметры.Форма.УникальныйИдентификатор);
			Если ДанныеФайлаНаПечать = Неопределено Тогда
				ПоказатьПредупреждение(, НСтр("ru = 'Не удалось получить версию файла для печати'"));
			Иначе
				ФайловаяСистемаКлиент.ОткрытьФайл(ДанныеФайлаНаПечать.АдресВХранилище, , ДанныеФайлаНаПечать.ИмяФайла);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыОбновитьВ1СКабинетСотрудника(ДокументыКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	Если Не ЗарплатаКадрыВызовСервера.ЭтоПолноправныйПользователь() Тогда
		ТекстПредупреждения = НСтр("ru = 'Для выполнения команды необходимы полные права на базу данных'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	ОбрабатываемыеФайлы = Новый Массив;
	Если ЗначениеЗаполнено(ДокументыКадровогоЭДО) Тогда
		
		ЭлектронныеДокументы = КадровыйЭДОВызовСервера.ЭлектронныеДокументыПоСсылкамНаДокументыКадровогоЭДО(ДокументыКадровогоЭДО);
		ОбрабатываемыеФайлы = ОбщегоНазначенияКлиентСервер.СкопироватьРекурсивно(ЭлектронныеДокументы.ПрисоединенныеФайлы);
		ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ОбрабатываемыеФайлы, ЭлектронныеДокументы.ПечатныеФормы);
		
		ОбщегоНазначенияКлиентСервер.УдалитьВсеВхожденияЗначенияИзМассива(ОбрабатываемыеФайлы, Неопределено);
		
		КадровыйЭДОВызовСервера.ЗапланироватьДействияСПечатнымиФормами(ОбрабатываемыеФайлы,
			ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьВКабинетСотрудников"));
		
	КонецЕсли;
	ПредставлениеДокументов = СтрокаСЧислом(
		НСтр("ru = ';%1 документа; ;%1 документов;%1 документов;%1 документа'"),
			ОбрабатываемыеФайлы.Количество(), ВидЧисловогоЗначения.Количественное);
	Состояние(СтрШаблон(
		НСтр("ru = 'Запланировано обновление %1'"),
		ПредставлениеДокументов));
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыКонвертироватьДокументыВPDFA1A(ДокументыКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	Если Не ЗарплатаКадрыВызовСервера.ЭтоПолноправныйПользователь() Тогда
		ТекстПредупреждения = НСтр("ru = 'Для конвертации электронных документов печатных форм необходимы полные права на базу данных'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		Возврат;
	КонецЕсли;
	
	Если ДокументыКадровогоЭДО.Количество() = 0 Тогда
		ТекстПредупреждения = НСтр("ru = 'Выберите строки документы печатных форм которых хотите сконвертировать'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
	КонецЕсли;
	
	ТекстВопроса =
		НСтр("ru = 'При проведении конвертации файлы печатных форм будут ПЕРЕЗАПИСАНЫ в требуемом формате (PDF/A-1A).
		|Ранее установленные цифровые подписи перестанут действовать и поэтому будут УДАЛЕНЫ.
		|По окончании конвертации будет произведено повторное подписание печатных форм ответственным лицом организации, после чего печатные формы будут отправлены в кабинеты сотрудникам для повторного ознакомления.
		|
		|Перед проведением конвертации настоятельно рекомендуем СДЕЛАТЬ КОПИЮ БАЗЫ ДАННЫХ!
		|Проводите конвертацию маленькими ПОРЦИЯМИ документов, во избежание неприятностей, связанных с нехваткой памяти.
		|
		|Конвертировать?'");
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ДокументыКадровогоЭДО", ДокументыКадровогоЭДО);
	Оповещение = Новый ОписаниеОповещения("ОбработкаОтветаНаВопросОКонвертацииДокументов", ЭтотОбъект, ДополнительныеПараметры);
	ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыОбновитьСостоянияДокументов(ДокументыКадровогоЭДО, ДополнительныеПараметры) Экспорт
	
	ДлительнаяОперация = КадровыйЭДОВызовСервера.ОбновитьСостоянияДокументовКЭДОВФоне(ДокументыКадровогоЭДО);
	ОповещениеОЗавершении = Новый ОписаниеОповещения("ПослеОбновленияСостояний", ЭтотОбъект, ДополнительныеПараметры);
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ДополнительныеПараметры.Форма);
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, ОповещениеОЗавершении, ПараметрыОжидания);
	
КонецПроцедуры

Процедура ОбработатьВыборДокументовНаПодпись(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		Если Результат.Значение = "ПодписатьДокументыСПечатнымиФормами" Тогда
			Оповещение = Новый ОписаниеОповещения("ОбработатьРезультатыПодписанияДокументовСФайлами", ЭтотОбъект, Новый Структура);
			ОткрытьФормуПодписанияПечатныхФорм(ДополнительныеПараметры.ЭлектронныеДокументы.ПечатныеФормы,
				ДополнительныеПараметры.Форма, Оповещение, , ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.Подписать"));
		ИначеЕсли Результат.Значение = "ПодписатьДокументыСФайлами" Тогда
			ФайлыНаПодпись = КадровыйЭДОВызовСервера.ДанныеФайловНаПодпись(
				ДополнительныеПараметры.ЭлектронныеДокументы.ПрисоединенныеФайлы);
			Оповещение = Новый ОписаниеОповещения("ОбработатьРезультатыПодписанияДокументовСФайлами", ЭтотОбъект,
				Новый Структура("ПодписанныеФайлы", ДополнительныеПараметры.ЭлектронныеДокументы.ПрисоединенныеФайлы));
			ПодписатьФайлы(
				ФайлыНаПодпись,
				Оповещение,
				ДополнительныеПараметры.Форма,
				ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.Подписать"));
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработатьРезультатыПодписанияДокументовСФайлами(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		Если ДополнительныеПараметры.Свойство("ПодписанныеФайлы") Тогда
			КадровыйЭДОВызовСервера.УдалитьФайлыИзОбработкиПользователя(ДополнительныеПараметры.ПодписанныеФайлы);
		КонецЕсли;
		ПоказатьСостояниеОтправленныхНаПодпись(ДополнительныеПараметры);
		ОповеститьОбОбновленииДанныхДокументовКЭДО();
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоказатьСостояниеОтправленныхНаПодпись(ПараметрыОповещения) Экспорт
	
	Если ПараметрыОповещения.Свойство("ДанныеФайловНаПодпись")
		И ПараметрыОповещения.ДанныеФайловНаПодпись.Количество() > 0 Тогда
		
		КоличествоФайловНаправленныхНаПодпись = 0;
		Для Каждого ФайлыНаПодписьОрганизации Из ПараметрыОповещения.ДанныеФайловНаПодпись Цикл
			КоличествоФайловНаправленныхНаПодпись = КоличествоФайловНаправленныхНаПодпись + ФайлыНаПодписьОрганизации.Значение.Количество();
		КонецЦикла;
		
		УведомитьОКоличествоДокументовОтправленныхНаПодписание(КоличествоФайловНаправленныхНаПодпись);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПоказатьСостояниеОтправленныхНаПодписьПоКоллекцииНаправлений(НаправленияНаПодписание) Экспорт
	
	КоличествоФайловНаправленныхНаПодпись = 0;
	Для Каждого НаправленияПоОрганизации Из НаправленияНаПодписание Цикл
		Для Каждого НаправленияПоИдентификатору Из НаправленияПоОрганизации.Значение Цикл
			Для Каждого НаправленияПоТипуОбъекта Из НаправленияПоИдентификатору.Значение Цикл
				Для Каждого НаправлениеПоПодписантам Из НаправленияПоТипуОбъекта.Значение Цикл
					КоличествоФайловНаправленныхНаПодпись = КоличествоФайловНаправленныхНаПодпись
						+ НаправлениеПоПодписантам.Значение.ПрисоединенныеФайлы.Количество();
				КонецЦикла;
			КонецЦикла;
		КонецЦикла;
	КонецЦикла;
	УведомитьОКоличествоДокументовОтправленныхНаПодписание(КоличествоФайловНаправленныхНаПодпись);
	
КонецПроцедуры

Процедура УведомитьОКоличествоДокументовОтправленныхНаПодписание(КоличествоФайловНаправленныхНаПодпись)
	
	Если КоличествоФайловНаправленныхНаПодпись > 0 Тогда
		Состояние(СтрокаСЧислом(
			НСтр("ru = ';%1 документ направлен на подпись; ;%1 документа направлено на подпись;%1 документов направлены на подпись;%1 направлено на подпись'"),
			КоличествоФайловНаправленныхНаПодпись, ВидЧисловогоЗначения.Количественное));
	КонецЕсли;
	
КонецПроцедуры

Процедура ОткрытьФормыВыбораПодписантовПечатныхФорм(ВладелецФормы, Организация, Оповещение, ПодписантыПечатныхФорм = Неопределено, ВыборЕдинственногоПодписанта = Ложь) Экспорт
	
	ПараметрыОткрытия = Новый Структура;
	ПараметрыОткрытия.Вставить("Организации", Организация);
	ПараметрыОткрытия.Вставить("ВыборЕдинственногоПодписанта", ВыборЕдинственногоПодписанта);
	
	Если ПодписантыПечатныхФорм <> Неопределено Тогда
		ПараметрыОткрытия.Вставить("ПодписантыПечатныхФорм", Новый ФиксированныйМассив(ПодписантыПечатныхФорм));
	КонецЕсли;
	
	ОткрытьФорму("ОбщаяФорма.ВыборПодписантовПечатныхФорм", ПараметрыОткрытия, ВладелецФормы, Истина, , ,
		Оповещение, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

// См. ОбщегоНазначенияКлиентПереопределяемый.ПриНачалеРаботыСистемы.
Процедура ПриНачалеРаботыСистемы(Параметры) Экспорт 
	
	Если Не СистемаВзаимодействия.ИспользованиеДоступно() Тогда
		Возврат;
	КонецЕсли;
	
	Обработчик = Новый ОписаниеОповещения("ОбработатьДействияСообщения", ЭтотОбъект);
	СистемаВзаимодействия.ПодключитьОбработчикДействияСообщения(Обработчик);
	
КонецПроцедуры

Процедура ОчиститьНастройкиПодписанияПечатныхФорм() Экспорт
	
	КадровыйЭДОВызовСервера.ОчиститьНастройкиПодписанияПечатныхФорм();
	ПоказатьПредупреждение(, НСтр("ru = 'Настройки подписания ЭЦП (электронными цифровыми подписями) очищены.'"));
	
КонецПроцедуры

Процедура ПодписатьФайлы(ПодписываемыеФайлы, ОповещениеЗавершения, ФормаВладелец, ЦельПодписания, НастройкиПодписания = Неопределено) Экспорт
	
	Организации = Новый Массив;
	ФайлыБезВладельца = Истина;
	ИсключаемыеИзЛичногоПодписания = Новый Массив;
	НаправленияНаПодписание = Новый Соответствие;
	ДанныеФайловНаПодпись = Новый Соответствие;
	Для Каждого ДанныеФайла Из ПодписываемыеФайлы Цикл
		
		Если Не ЗначениеЗаполнено(ДанныеФайла.Организация) Тогда
			Продолжить;
		КонецЕсли;
		
		Организации.Добавить(ДанныеФайла.Организация);
		Если ЗначениеЗаполнено(ДанныеФайла.ФайлОбъекта) Тогда
			ФайлыБезВладельца = Ложь;
		КонецЕсли;
		
		Если НастройкиПодписания <> Неопределено Тогда
			НастройкиОрганизации = НастройкиПодписания.Получить(ДанныеФайла.Организация);
			Если НастройкиОрганизации <> Неопределено Тогда
				НастройкиИдентификатора = НастройкиОрганизации.Получить(ДанныеФайла.ИдентификаторПечатнойФормы);
				Если НастройкиИдентификатора <> Неопределено Тогда
					НастройкиТипаОбъекта = НастройкиИдентификатора.Получить(ТипЗнч(ДанныеФайла.Владелец));
					Если НастройкиТипаОбъекта <> Неопределено Тогда
						Если Не НастройкиТипаОбъекта.Инициатор Тогда
							ИсключаемыеИзЛичногоПодписания.Добавить(ДанныеФайла);
						КонецЕсли;
						Если НастройкиТипаОбъекта.ОтветственныеЛица.Количество() > 0 Тогда
							
							НаправленияПоОрганизации = НаправленияНаПодписание.Получить(ДанныеФайла.Организация);
							Если НаправленияПоОрганизации = Неопределено Тогда
								НаправленияПоОрганизации = Новый Соответствие;
								НаправленияНаПодписание.Вставить(ДанныеФайла.Организация, НаправленияПоОрганизации);
							КонецЕсли;
							НаправленияПоИдентификатору = НаправленияПоОрганизации.Получить(ДанныеФайла.ИдентификаторПечатнойФормы);
							Если НаправленияПоИдентификатору = Неопределено Тогда
								НаправленияПоИдентификатору = Новый Соответствие;
								НаправленияПоОрганизации.Вставить(ДанныеФайла.ИдентификаторПечатнойФормы, НаправленияПоИдентификатору);
							КонецЕсли;
							ТипВладельца = ТипЗнч(ДанныеФайла.Владелец);
							НаправленияПоТипуОбъекта = НаправленияПоИдентификатору.Получить(ТипВладельца);
							Если НаправленияПоТипуОбъекта = Неопределено Тогда
								НаправленияПоТипуОбъекта = Новый Соответствие;
								НаправленияПоИдентификатору.Вставить(ТипВладельца, НаправленияПоТипуОбъекта);
							КонецЕсли;
							
							НаправленияПоПодписантам = Неопределено;
							Для Каждого НастройкиОтветственныхЛиц Из НастройкиТипаОбъекта.ОтветственныеЛица Цикл
								Если НастройкиОтветственныхЛиц.Значение.Найти(ДанныеФайла.Владелец) <> Неопределено Тогда
									НаправленияПоПодписантам = НаправленияПоТипуОбъекта.Получить(НастройкиОтветственныхЛиц.Ключ);
									Если НаправленияПоПодписантам = Неопределено Тогда
										НаправленияПоПодписантам = Новый Структура("ПрисоединенныеФайлы,ОтветственныеЛица", Новый Массив, НастройкиОтветственныхЛиц.Ключ);
										ОтветственныеЛица = НастройкиОтветственныхЛиц.Ключ;
										Если НастройкиТипаОбъекта.Инициатор Тогда
											ОтветственныеЛица.Вставить(0, ПользователиКлиент.ТекущийПользователь());
										КонецЕсли;
										НаправленияПоТипуОбъекта.Вставить(ОтветственныеЛица, НаправленияПоПодписантам);
									КонецЕсли;
									Прервать;
								КонецЕсли;
							КонецЦикла;
							
							НаправленияПоПодписантам.ПрисоединенныеФайлы.Добавить(ДанныеФайла.ФайлОбъекта);
							
							// Подготовка коллекции к обновлению
							ДанныеФайлов = ДанныеФайловНаПодпись.Получить(ДанныеФайла.Организация);
							Если ДанныеФайлов = Неопределено Тогда
								ДанныеФайлов = Новый Массив;
								ДанныеФайловНаПодпись.Вставить(ДанныеФайла.Организация, ДанныеФайлов);
							КонецЕсли;
							
							Если ДанныеФайлов.Найти(ДанныеФайла) = Неопределено Тогда
								ДанныеФайлов.Добавить(ДанныеФайла);
							КонецЕсли;
							
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если НаправленияНаПодписание.Количество() > 0 Тогда
		
		КадровыйЭДОВызовСервера.НаправитьНаПодписаниеПоКоллекцииНаправлений(НаправленияНаПодписание, ЦельПодписания);
		ПоказатьСостояниеОтправленныхНаПодписьПоКоллекцииНаправлений(НаправленияНаПодписание);
		
		Если ДанныеФайловНаПодпись.Количество() > 0 Тогда
			Если ОповещениеЗавершения <> Неопределено Тогда
				ОповещениеЗавершения.ДополнительныеПараметры.Вставить("ДанныеФайловНаПодпись", ДанныеФайловНаПодпись);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Для Каждого ИсключениеИзПодписания Из ИсключаемыеИзЛичногоПодписания Цикл
		ОбщегоНазначенияКлиентСервер.УдалитьЗначениеИзМассива(
			ПодписываемыеФайлы, ИсключениеИзПодписания);
	КонецЦикла;
	
	Организации = ОбщегоНазначенияКлиентСервер.СвернутьМассив(Организации);
	ДанныеСертификатовОрганизаций = КадровыйЭДОВызовСервера.ДанныеСертификатовОрганизаций(Организации);
	
	ПараметрыПодписания = Новый Структура;
	ПараметрыПодписания.Вставить("ПодписываемыеФайлы", ПодписываемыеФайлы);
	ПараметрыПодписания.Вставить("Организации", Организации);
	ПараметрыПодписания.Вставить("СертификатыОрганизаций", ДанныеСертификатовОрганизаций.Сертификаты);
	ПараметрыПодписания.Вставить("ОповещениеЗавершения", ОповещениеЗавершения);
	ПараметрыПодписания.Вставить("ЦельПодписания", ЦельПодписания);
	
	Если Не ЗначениеЗаполнено(ПодписываемыеФайлы) Тогда
		ПодписатьФайлыСертификатами(Истина, ПараметрыПодписания);
		Возврат;
	КонецЕсли;
	
	Оповещение = Новый ОписаниеОповещения("ПодписатьФайлыСертификатами", ЭтотОбъект, ПараметрыПодписания);
	
	ПараметрыПодготовки = Новый Структура;
	ПараметрыПодготовки.Вставить("Организации", Организации);
	ПараметрыПодготовки.Вставить("ДанныеСертификатовОрганизаций", ДанныеСертификатовОрганизаций);
	ПараметрыПодготовки.Вставить("ОповещениеЗавершения", Оповещение);
	ПараметрыПодготовки.Вставить("ФормаВладелец", ФормаВладелец);
	ПараметрыПодготовки.Вставить("ИндексОрганизации", 0);
	ПараметрыПодготовки.Вставить("ФайлыБезВладельца", ФайлыБезВладельца);
	
	ПодготовитьСертификатыОрганизации(ПараметрыПодготовки);
	
КонецПроцедуры

Процедура ПоказатьСостояниеСохраненныхБезЦифровыхПодписей(КоличествоФайлов) Экспорт
	
	Если КоличествоФайлов > 0 Тогда
		
		Состояние(СтрокаСЧислом(
			НСтр("ru = ';%1 документ сохранен без цифровой подписи; ;%1 документа сохранено без цифровой подписи;%1 документов сохранено без цифровой подписи;%1 сохранено без цифровой подписи'"),
			КоличествоФайлов, ВидЧисловогоЗначения.Количественное));
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПодписатьПоНастройкам(УправляемаяФорма, ЦельПодписания = Неопределено) Экспорт
	
	ПараметрыОткрытия = ПараметрыОткрытияФормыНастройкиПодписания(УправляемаяФорма, ЦельПодписания);
	ОткрытьФорму("ОбщаяФорма.НастройкаПодписания", ПараметрыОткрытия, УправляемаяФорма, Истина);
	
КонецПроцедуры

Процедура НастроитьИПодписать(УправляемаяФорма, ЦельПодписания = Неопределено)
	
	ПараметрыОткрытия = ПараметрыОткрытияФормыНастройкиПодписания(УправляемаяФорма, ЦельПодписания);
	ПараметрыОткрытия.Вставить("Настроить", Истина);
	ОткрытьФорму("ОбщаяФорма.НастройкаПодписания", ПараметрыОткрытия, УправляемаяФорма, Истина);
	
КонецПроцедуры

Функция ПараметрыОткрытияФормыНастройкиПодписания(УправляемаяФорма, ЦельПодписания)
	
	Идентификаторы = Новый Массив;
	Для Каждого НастройкаПечатнойФормы Из УправляемаяФорма.НастройкиПечатныхФорм Цикл
		Если НастройкаПечатнойФормы.Печатать Тогда
			Идентификаторы.Добавить(НастройкаПечатнойФормы.ИмяМакета);
		КонецЕсли;
	КонецЦикла;
	
	ПараметрыОткрытия = Новый Структура;
	ПараметрыОткрытия.Вставить("ОбъектыПечати", УправляемаяФорма.ОбъектыПечати.ВыгрузитьЗначения());
	ПараметрыОткрытия.Вставить("Идентификаторы", ОбщегоНазначенияКлиентСервер.СвернутьМассив(Идентификаторы));
	ПараметрыОткрытия.Вставить("ЦельПодписания", ЦельПодписания);
	Возврат ПараметрыОткрытия;
	
КонецФункции

Процедура ОтказатьВПодписании(УправляемаяФорма) Экспорт
	
	ПараметрыОткрытия = Новый Структура("ФайлыДокументовКЭДО", ФайлыДокументовКЭДОФормыПечатьДокументов(УправляемаяФорма));
	ОткрытьФорму("ОбщаяФорма.ОтказВПодписании", ПараметрыОткрытия, УправляемаяФорма, Истина);
	
КонецПроцедуры

Процедура ОбработчикПодключаемойКомандыСохранитьМЧД(СписокМЧД, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(СписокМЧД) Тогда
		СохранитьМЧДНаДиск(СписокМЧД);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОповеститьОНеобходимостиОбновленияФорм(Источник) Экспорт
	Если ТипЗнч(Источник) = Тип("ДокументСсылка.ДокументКадровогоЭДО") Тогда
		ОповеститьОбИзменении(Источник);
		ОповеститьОбОбновленииДанныхДокументовКЭДО(Источник);
	Иначе
		ОповеститьОбИзменении(Тип("ДокументСсылка.ДокументКадровогоЭДО"));
		ОповеститьОбОбновленииДанныхДокументовКЭДО();
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ПодписаниеВФормеПечатьДокументов

Процедура ПодписатьФайлыСертификатами(Результат, ДополнительныеПараметры) Экспорт
	
	ПодписываемыеФайлы = ДополнительныеПараметры.ПодписываемыеФайлы;
	СертификатыОрганизаций = ДополнительныеПараметры.СертификатыОрганизаций;
	
	ДанныеФайловНаПодпись = Новый Соответствие;
	ДанныеФайловПоСертификатам = Новый Соответствие;
	Сертификаты = Новый Массив;
	Для Каждого ДанныеФайла Из ПодписываемыеФайлы Цикл
		
		Если ПустаяСтрока(ДанныеФайла.АдресВХранилище)
			И Не ЗначениеЗаполнено(ДанныеФайла.ФайлОбъекта) Тогда
			
			Продолжить;
		КонецЕсли;
		
		СертификатыОрганизации = СертификатыОрганизаций.Получить(
			?(ДанныеФайла.Организация = Неопределено, "Неопределено", ДанныеФайла.Организация));
		
		Если СертификатыОрганизации = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Если ТипЗнч(СертификатыОрганизации[0]) = Тип("СправочникСсылка.Пользователи") Тогда
			
			ДанныеФайлов = ДанныеФайловНаПодпись.Получить(ДанныеФайла.Организация);
			Если ДанныеФайлов = Неопределено Тогда
				ДанныеФайлов = Новый Массив;
				ДанныеФайловНаПодпись.Вставить(ДанныеФайла.Организация, ДанныеФайлов);
			КонецЕсли;
			
			Если ДанныеФайлов.Найти(ДанныеФайла) = Неопределено Тогда
				ДанныеФайлов.Добавить(ДанныеФайла);
			КонецЕсли;
			
		Иначе
			
			Для Каждого ДанныеСертификата Из СертификатыОрганизации Цикл
				
				Сертификат = ДанныеСертификата.Ключ;
				Если ДанныеФайла.УстановленныеПодписи <> Неопределено
					И ДанныеФайла.УстановленныеПодписи.Получить(Сертификат) = Истина Тогда
					
					Состояние(
						НСтр("ru = 'Документ уже подписан сертификатом'"),
						,
						ДанныеФайла.ФайлОбъекта);
					КадровыйЭДОВызовСервера.УдалитьФайлыИзОбработкиПользователя(
						ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ДанныеФайла.ФайлОбъекта));
					Продолжить;
				КонецЕсли;
				
				Если ЗначениеЗаполнено(ДанныеФайла.АдресВХранилище) Тогда
					АдресВХранилище = ДанныеФайла.АдресВХранилище;
				Иначе
					ДанныеПрисоединенногоФайла = РаботаСФайламиКлиент.ДанныеФайла(ДанныеФайла.ФайлОбъекта, Новый УникальныйИдентификатор, Истина);
					АдресВХранилище = ДанныеПрисоединенногоФайла.СсылкаНаДвоичныеДанныеФайла;
				КонецЕсли;
				
				Данные = Новый Структура;
				Данные.Вставить("Данные",        АдресВХранилище);
				Данные.Вставить("Представление", ДанныеФайла.ИмяФайла);
				Данные.Вставить("ИсходнаяСтрока", ДанныеФайла);
				
				Если ЗначениеЗаполнено(ДанныеФайла.ФайлОбъекта) Тогда
					Данные.Вставить("Объект", ДанныеФайла.ФайлОбъекта);
				КонецЕсли;
				
				НаборДанных = ДанныеФайловПоСертификатам.Получить(Сертификат);
				Если НаборДанных = Неопределено Тогда
					НаборДанных = Новый Массив;
					ДанныеФайловПоСертификатам.Вставить(Сертификат, НаборДанных);
					Сертификаты.Добавить(ДанныеСертификата);
				КонецЕсли;
				
				НаборДанных.Добавить(Данные);
				
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Если ДанныеФайловНаПодпись.Количество() > 0 Тогда
		НаправитьНаПодпись(ДанныеФайловНаПодпись, ДополнительныеПараметры.ЦельПодписания, СертификатыОрганизаций);
		Если ДополнительныеПараметры.ОповещениеЗавершения <> Неопределено Тогда
			Если ДополнительныеПараметры.ОповещениеЗавершения.ДополнительныеПараметры.Свойство("ДанныеФайловНаПодпись") Тогда
				ДанныеФайловНаПодписьПараметров = ДополнительныеПараметры.ОповещениеЗавершения.ДополнительныеПараметры.ДанныеФайловНаПодпись;
				Для Каждого ДанныеФайловНаПодписьОрганизации Из ДанныеФайловНаПодпись Цикл
					ДанныеФайлов = ДанныеФайловНаПодписьПараметров.Получить(ДанныеФайловНаПодписьОрганизации.Ключ);
					Если ДанныеФайлов = Неопределено Тогда
						ДанныеФайловНаПодписьПараметров.Вставить(ДанныеФайловНаПодписьОрганизации.Ключ, ДанныеФайловНаПодписьОрганизации.Значение);
					Иначе
						ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ДанныеФайлов, ДанныеФайловНаПодписьОрганизации.Значение, Истина);
					КонецЕсли;
				КонецЦикла;
			Иначе
				ДополнительныеПараметры.ОповещениеЗавершения.ДополнительныеПараметры.Вставить("ДанныеФайловНаПодпись", ДанныеФайловНаПодпись);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если Сертификаты.Количество() > 0 Тогда
		ПодписатьФайлыСертификатом(ДанныеФайловПоСертификатам, Сертификаты, 0,
			ДополнительныеПараметры.ОповещениеЗавершения);
	Иначе
		ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеЗавершения, ДополнительныеПараметры.ПодписываемыеФайлы);
	КонецЕсли;
	
КонецПроцедуры

#Область ПодготовкаСпискаСертификатовОрганизаций

Процедура ПодготовитьСертификатыОрганизации(ПараметрыПодготовки)
	
	ФормаВладелец = ПараметрыПодготовки.ФормаВладелец;
	Организация = ПараметрыПодготовки.Организации[ПараметрыПодготовки.ИндексОрганизации];
	ДанныеСертификатовОрганизаций = ПараметрыПодготовки.ДанныеСертификатовОрганизаций;
	
	СертификатыОрганизации = ДанныеСертификатовОрганизаций.Сертификаты.Получить(
		?(Организация = Неопределено, "Неопределено", Организация));
	
	Если Не ЗначениеЗаполнено(СертификатыОрганизации) И ЗначениеЗаполнено(Организация) Тогда
		Если ДанныеСертификатовОрганизаций.Свойство("ГоловныеОрганизации") Тогда
			ГоловнаяОрганизация = ДанныеСертификатовОрганизаций.ГоловныеОрганизации.получить(Организация);
			Если ЗначениеЗаполнено(ГоловнаяОрганизация) Тогда
				СертификатыОрганизации = ДанныеСертификатовОрганизаций.Сертификаты.Получить(ГоловнаяОрганизация);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ОбновитьСертификаты = ПараметрыПодготовки.ФайлыБезВладельца И Не ЗначениеЗаполнено(СертификатыОрганизации)
		Или (ДанныеСертификатовОрганизаций.ОрганизацииКОбновлению.Получить(Организация) <> Неопределено);
	
	Если Не ПараметрыПодготовки.ФайлыБезВладельца
		И (СертификатыОрганизации = Неопределено
			Или СертификатыОрганизации.Количество() = 0) Тогда
		
		Если КадровыйЭДОВызовСервера.ДоступенВыборПользователей() Тогда
			Оповещение = Новый ОписаниеОповещения("ПриВыбореОтветственныхЛиц", ЭтотОбъект, ПараметрыПодготовки);
			ОткрытьФормыВыбораПодписантовПечатныхФорм(ФормаВладелец, Организация, Оповещение);
		Иначе
			ТекстПредупреждения = СтрШаблон(
				НСтр("ru = 'Не найдено сертификатов %1 для подписания документов.'"),
				Организация);
			ПоказатьПредупреждение(, ТекстПредупреждения);
		КонецЕсли;
		
	ИначеЕсли ОбновитьСертификаты
		Или СертификатыОрганизации.Количество() > 0
			И ТипЗнч(СертификатыОрганизации[0]) = Тип("СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования") Тогда
		
		Оповещение = Новый ОписаниеОповещения("ПриВыбореСертификатов", ЭтотОбъект, ПараметрыПодготовки);
		
		ПараметрыОткрытия = Новый Структура;
		ПараметрыОткрытия.Вставить("Организация", Организация);
		
		ОткрытьФорму("ОбщаяФорма.ВыборСертификатовПодписей", ПараметрыОткрытия, ФормаВладелец, Истина, , ,
			Оповещение, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		
	Иначе
		ПодготовитьСертификатыСледующейОрганизации(ПараметрыПодготовки);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПодготовитьСертификатыСледующейОрганизации(ПараметрыПодготовки)
	
	ПараметрыПодготовки.ИндексОрганизации = ПараметрыПодготовки.ИндексОрганизации + 1;
	Если ПараметрыПодготовки.ИндексОрганизации < ПараметрыПодготовки.Организации.Количество() Тогда
		ПодготовитьСертификатыОрганизации(ПараметрыПодготовки);
	Иначе
		ВыполнитьОбработкуОповещения(ПараметрыПодготовки.ОповещениеЗавершения, Истина);
	КонецЕсли;
	
КонецПроцедуры

#Область ВыборСертификатов

Процедура ПриВыбореСертификатов(ВыбранныеСертификаты, ПараметрыПодготовки) Экспорт
	
	Если ВыбранныеСертификаты <> Неопределено Тогда
		
		Если ТипЗнч(ВыбранныеСертификаты) = Тип("СправочникСсылка.СертификатыКлючейЭлектроннойПодписиИШифрования") Тогда
			СертификатыОрганизации = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ВыбранныеСертификаты);
		Иначе
			СертификатыОрганизации = ВыбранныеСертификаты;
		КонецЕсли;
		
		Организация = ПараметрыПодготовки.Организации[ПараметрыПодготовки.ИндексОрганизации];
		ПараметрыПодготовки.ДанныеСертификатовОрганизаций.Сертификаты.Вставить(
			?(Организация = Неопределено, "Неопределено", Организация), СертификатыОрганизации);
		
		Если КадровыйЭДОВызовСервера.НеобходимостьЗадаватьВопросПриВыбореСертификатовОрганизации(Организация) Тогда
			
			ПараметрыВопроса = СтандартныеПодсистемыКлиент.ПараметрыВопросаПользователю();
			ПараметрыВопроса.Заголовок = НСтр("ru = 'Подписание документов'");
			ПараметрыВопроса.ПредлагатьБольшеНеЗадаватьЭтотВопрос = Ложь;
			
			Если СертификатыОрганизации.Количество() = 1 Тогда
				ТекстВопроса = НСтр("ru = 'Всегда подписывать выбранным сертификатом?'");
			Иначе
				ТекстВопроса = НСтр("ru = 'Всегда подписывать выбранными сертификатами?'");
			КонецЕсли;
			
			Кнопки = Новый СписокЗначений;
			Кнопки.Добавить(КодВозвратаДиалога.Да, НСтр("ru = 'Да'"));
			Кнопки.Добавить(КодВозвратаДиалога.Нет, НСтр("ru = 'Нет'"));
			Кнопки.Добавить("ВсегдаНет", НСтр("ru = 'Всегда нет'"));
			
			Оповещение = Новый ОписаниеОповещения("ОбработатьОтветОПодписанииВыбраннымиСертификатами", ЭтотОбъект, ПараметрыПодготовки);
			СтандартныеПодсистемыКлиент.ПоказатьВопросПользователю(Оповещение, ТекстВопроса, Кнопки, ПараметрыВопроса);
		Иначе
			ПодготовитьСертификатыСледующейОрганизации(ПараметрыПодготовки);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработатьОтветОПодписанииВыбраннымиСертификатами(Результат, ПараметрыПодготовки) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Организация = ПараметрыПодготовки.Организации[ПараметрыПодготовки.ИндексОрганизации];
	Если Результат.Значение = КодВозвратаДиалога.Да Тогда
		СертификатыОрганизации = ПараметрыПодготовки.ДанныеСертификатовОрганизаций.Сертификаты.Получить(
			?(Организация = Неопределено, "Неопределено", Организация));
		КадровыйЭДОВызовСервера.ЗапомнитьСертификатыОрганизации(Организация, СертификатыОрганизации, Не Результат.БольшеНеЗадаватьЭтотВопрос);
	ИначеЕсли Результат.Значение = "ВсегдаНет" Тогда
		КадровыйЭДОВызовСервера.ЗапомнитьНеобходимостьЗадаватьВопросПриВыбореСертификатовОрганизации(
			Организация, Ложь);
	КонецЕсли;
	
	ПодготовитьСертификатыСледующейОрганизации(ПараметрыПодготовки);
	
КонецПроцедуры

#КонецОбласти

#Область ВыборОтветственныхЛиц

Процедура ПриВыбореОтветственныхЛиц(ВыбранныеПодписанты, ПараметрыПодготовки) Экспорт
	
	Если ВыбранныеПодписанты = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Организация = ПараметрыПодготовки.Организации[ПараметрыПодготовки.ИндексОрганизации];
	ПараметрыПодготовки.ДанныеСертификатовОрганизаций.Сертификаты.Вставить(Организация, ВыбранныеПодписанты);
	
	ПараметрыВопроса = СтандартныеПодсистемыКлиент.ПараметрыВопросаПользователю();
	ПараметрыВопроса.Заголовок = НСтр("ru = 'Подписание документов'");
	ПараметрыВопроса.ПредлагатьБольшеНеЗадаватьЭтотВопрос = Ложь;
	
	Если ВыбранныеПодписанты.Количество() = 1 Тогда
		
		ТекстВопроса = СтрШаблон(
			НСтр("ru = 'Всегда направлять документы организации %1 на подписание выбранному
				|ответственному лицу (%2)?'"),
			Организация,
			ВыбранныеПодписанты[0]);
		
	Иначе
		
		ТекстВопроса = СтрШаблон(
			НСтр("ru = 'Всегда направлять документы организации %1 на подписание выбранным ответственным лицам?'"),
			Организация);
		
	КонецЕсли;
	
	Оповещение = Новый ОписаниеОповещения("ОбработатьОтветОВыбореОтветственныхЛиц", ЭтотОбъект, ПараметрыПодготовки);
	СтандартныеПодсистемыКлиент.ПоказатьВопросПользователю(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет, ПараметрыВопроса);
	
КонецПроцедуры

Процедура ОбработатьОтветОВыбореОтветственныхЛиц(Результат, ПараметрыПодготовки) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Результат.Значение = КодВозвратаДиалога.Да Тогда
		Организация = ПараметрыПодготовки.Организации[ПараметрыПодготовки.ИндексОрганизации];
		ВыбранныеПодписанты = ПараметрыПодготовки.ДанныеСертификатовОрганизаций.Сертификаты.Получить(Организация);
		КадровыйЭДОВызовСервера.ЗапомнитьПодписантов(Организация, ВыбранныеПодписанты);
	КонецЕсли;
	
	ПодготовитьСертификатыСледующейОрганизации(ПараметрыПодготовки);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ПодписаниеФайловПечатныхФорм

Процедура ПодписатьФайлыСертификатом(ДанныеФайловПоСертификатам, СертификатыОрганизаций, ИндексДанных, ОповещениеЗавершения)
	
	ДанныеСертификата = СертификатыОрганизаций[ИндексДанных];
	Сертификат = ДанныеСертификата.Ключ;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ДанныеФайловПоСертификатам", ДанныеФайловПоСертификатам);
	ДополнительныеПараметры.Вставить("СертификатыОрганизаций", СертификатыОрганизаций);
	ДополнительныеПараметры.Вставить("ИндексДанных", ИндексДанных);
	ДополнительныеПараметры.Вставить("ОповещениеЗавершения", ОповещениеЗавершения);
	
	ОтборСертификатов = Новый Массив;
	ОтборСертификатов.Добавить(Сертификат);
	
	ОписаниеДанных = Новый Структура;
	ОписаниеДанных.Вставить("БезПодтверждения",    Истина);
	ОписаниеДанных.Вставить("ПоказатьКомментарий", Ложь);
	ОписаниеДанных.Вставить("ОтборСертификатов", ОтборСертификатов);
	
	НаборДанных = ДанныеФайловПоСертификатам[Сертификат];
	Если НаборДанных.Количество() = 1 Тогда
		ОписаниеДанных.Вставить("Операция",            НСтр("ru = 'Подписание файла'"));
		ОписаниеДанных.Вставить("ЗаголовокДанных",     НСтр("ru = 'Файл'"));
		ОписаниеДанных.Вставить("Данные",              НаборДанных[0].Данные);
		ОписаниеДанных.Вставить("Представление",       НаборДанных[0].Представление);
		Если НаборДанных[0].Свойство("Объект") Тогда
			ОписаниеДанных.Вставить("Объект",          НаборДанных[0].Объект);
		КонецЕсли;
	Иначе
		ОписаниеДанных.Вставить("Операция",            НСтр("ru = 'Подписание файлов'"));
		ОписаниеДанных.Вставить("ЗаголовокДанных",     НСтр("ru = 'Файлы'"));
		ОписаниеДанных.Вставить("ПредставлениеНабора", НСтр("ru = 'Печатные формы (%1)'"));
		ОписаниеДанных.Вставить("НаборДанных",         НаборДанных);
	КонецЕсли;
	
	Состояние(ОписаниеДанных.Операция + Символы.ПС + Сертификат);
	
	Оповещение = Новый ОписаниеОповещения("ПослеПодписанияФайловСертификатом", ЭтотОбъект, ДополнительныеПараметры);
	ЭлектроннаяПодписьКлиент.Подписать(ОписаниеДанных, ЭтотОбъект, Оповещение);
	
КонецПроцедуры

Процедура ПослеПодписанияФайловСертификатом(Результат, ДополнительныеПараметры) Экспорт
	
	Если ТипЗнч(Результат) = Тип("Структура") И Результат.Успех Тогда
		
		ДанныеСертификата = ДополнительныеПараметры.СертификатыОрганизаций[ДополнительныеПараметры.ИндексДанных];
		Сертификат = ДанныеСертификата.Ключ;
		КадровыйЭДОВызовСервера.ПослеПодписанияФайловСертификатом(Результат, ДанныеСертификата.Значение);
		Если ДополнительныеПараметры.Свойство("ОповещениеЗавершения") Тогда
			
			ОповещениеЗавершения = ДополнительныеПараметры.ОповещениеЗавершения;
			ДополнительныеПараметрыОповещениеЗавершения = ОповещениеЗавершения.ДополнительныеПараметры;
			Если ДополнительныеПараметрыОповещениеЗавершения <> Неопределено
				И ДополнительныеПараметрыОповещениеЗавершения.Свойство("Форма") Тогда
				
				Если Не ДополнительныеПараметрыОповещениеЗавершения.Свойство("ОбновленныеФайлы") Тогда
					ДополнительныеПараметрыОповещениеЗавершения.Вставить("ОбновленныеФайлы", Новый Массив);
				КонецЕсли;
				
				ФайлыКОбработке = Новый Массив;
				
				Форма = ДополнительныеПараметрыОповещениеЗавершения.Форма;
				ОписанияФайлов = КадровыйЭДОКлиентСервер.ОписанияФайловПечатныхФормИзПараметровФормы(Форма.Параметры);
				ДанныеФайлов = ДополнительныеПараметры.ДанныеФайловПоСертификатам[Сертификат];
				Для Каждого ДанныеФайла Из ДанныеФайлов Цикл
					
					Если ЗначениеЗаполнено(ДанныеФайла.ИсходнаяСтрока.ФайлОбъекта) Тогда
						ФайлыКОбработке.Добавить(ДанныеФайла.ИсходнаяСтрока.ФайлОбъекта);
					Иначе
						Если Результат.Свойство("Данные") Тогда
							ДанныеФайла.ИсходнаяСтрока.Вставить("СвойстваПодписи", Результат.СвойстваПодписи);
						КонецЕсли;
					КонецЕсли;
					
					Если ОписанияФайлов <> Неопределено Тогда
						ОписаниеОригиналовИдентификатора = ОписанияФайлов.ОригиналыПечатныхФорм.Получить(
							ДанныеФайла.ИсходнаяСтрока.ИдентификаторПечатнойФормы);
						
						Если ОписаниеОригиналовИдентификатора <> Неопределено Тогда
							
							Оригиналы = ОписаниеОригиналовИдентификатора.Оригиналы;
							
							ИсходнаяСтрока = Оригиналы.Получить(ДанныеФайла.ИсходнаяСтрока.ФайлОбъекта);
							Если ИсходнаяСтрока <> Неопределено Тогда
								
								Если ИсходнаяСтрока.УстановленныеПодписи = Неопределено Тогда
									ИсходнаяСтрока.УстановленныеПодписи = Новый Соответствие;
								КонецЕсли;
								ИсходнаяСтрока.УстановленныеПодписи.Вставить(Сертификат, Истина);
								
								ДополнительныеПараметрыОповещениеЗавершения.ОбновленныеФайлы.Добавить(ИсходнаяСтрока);
								
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
		Иначе
			ОповещениеЗавершения = Неопределено;
		КонецЕсли;
		
		ИндексДанных = ДополнительныеПараметры.ИндексДанных + 1;
		Если ИндексДанных < ДополнительныеПараметры.СертификатыОрганизаций.Количество() Тогда
			
			ПодписатьФайлыСертификатом(
				ДополнительныеПараметры.ДанныеФайловПоСертификатам,
				ДополнительныеПараметры.СертификатыОрганизаций,
				ИндексДанных,
				ОповещениеЗавершения);
			
		Иначе
			
			Если ОповещениеЗавершения <> Неопределено Тогда
				ВыполнитьОбработкуОповещения(ОповещениеЗавершения, Истина);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

Процедура ПослеПодписанияСохраненныхФорм(РезультатПодписания, ДополнительныеПараметры) Экспорт
	
	Если РезультатПодписания <> Неопределено Тогда
		
		РезультатПодписанияФайлов = ДополнительныеПараметры.ПечатныеФормыОбъектов;
		
		ФормаПечатьДокументов = ДополнительныеПараметры.Форма;
		Если ДополнительныеПараметры.ЦельПодписания = ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.Подписать") Тогда
			
			Если ФормаПечатьДокументов.Открыта() Тогда
				ФормаПечатьДокументов.Закрыть();
			КонецЕсли;
			
		Иначе
			
			ОбрабатываемыеФайлы = Новый Массив;
			ВладельцыФайлов = Новый Соответствие;
			
			Если ДополнительныеПараметры.Свойство("ДанныеФайловНаПодпись") Тогда
				ДанныеФайловНаПодпись = ДополнительныеПараметры.ДанныеФайловНаПодпись;
			Иначе
				ДанныеФайловНаПодпись = Новый Соответствие;
			КонецЕсли;
			
			Для Каждого ОписаниеФайла Из РезультатПодписанияФайлов Цикл
				
				ФайлыНаПодписьОрганизации = ДанныеФайловНаПодпись.Получить(ОписаниеФайла.Организация);
				Если ФайлыНаПодписьОрганизации = Неопределено
					Или ФайлыНаПодписьОрганизации.Найти(ОписаниеФайла) = Неопределено Тогда
					
					Если ЗначениеЗаполнено(ОписаниеФайла.ФайлОбъекта) Тогда
						ОбрабатываемыеФайлы.Добавить(ОписаниеФайла.ФайлОбъекта);
					Иначе
						ОписаниеФайлаПодписанногоФайла = Новый Структура;
						ОписаниеФайлаПодписанногоФайла.Вставить("ПечатнаяФорма", ОписаниеФайла.ПечатнаяФорма);
						ОписаниеФайлаПодписанногоФайла.Вставить("СвойстваПодписи", ОписаниеФайла.СвойстваПодписи);
						ОписаниеФайлаПодписанногоФайла.Вставить("ИдентификаторПечатнойФормы", ОписаниеФайла.ИдентификаторПечатнойФормы);
						ОписаниеФайлаПодписанногоФайла.Вставить("ИмяФайла", ОписаниеФайла.ИмяФайла);
						ОписаниеФайлаПодписанногоФайла.Вставить("Название", ОписаниеФайла.Название);
						ОписаниеФайлаПодписанногоФайла.Вставить("АдресВХранилище", ОписаниеФайла.АдресВХранилище);
						ОписаниеФайлаПодписанногоФайла.Вставить("ФизическоеЛицо", ОписаниеФайла.ФизическоеЛицо);
						ОбрабатываемыеФайлы.Добавить(ОписаниеФайлаПодписанногоФайла);
					КонецЕсли;
					
				КонецЕсли;
				
				Если ЗначениеЗаполнено(ОписаниеФайла.Владелец) И ТипЗнч(ОписаниеФайла.Владелец) <> Тип("Строка") Тогда
					
					ИдентификаторыВладельца = ВладельцыФайлов.Получить(ОписаниеФайла.Владелец);
					Если ИдентификаторыВладельца = Неопределено Тогда
						ИдентификаторыВладельца = Новый Соответствие;
						ВладельцыФайлов.Вставить(ОписаниеФайла.Владелец, ИдентификаторыВладельца);
					КонецЕсли;
					
					ИдентификаторыВладельца.Вставить(ОписаниеФайла.ИдентификаторПечатнойФормы, Истина);
					
				КонецЕсли;
				
			КонецЦикла;
			
			Для Каждого ДанныеВладельца Из ВладельцыФайлов Цикл
				ОповеститьОбИзмененииПечатнойФормы(ДанныеВладельца.Ключ, ДанныеВладельца.Значение);
			КонецЦикла;
			
			Если ОбрабатываемыеФайлы.Количество() > 0 Тогда
				
				Если ДополнительныеПараметры.ЦельПодписания = ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ЗаписатьНаДиск") Тогда
					
					СохранитьПечатныеФормыНаДиск(ОбрабатываемыеФайлы);
					
				ИначеЕсли ДополнительныеПараметры.ЦельПодписания = ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ОтправитьПоПочте") Тогда
					
					ПараметрыОтправки = ФормаПечатьДокументов.ПараметрыВывода.ПараметрыОтправки;
					
					ПараметрыОткрытияФормы = Новый Структура;
					ПараметрыОткрытияФормы.Вставить("Получатели", ПараметрыОтправки.Получатель);
					ПараметрыОткрытияФормы.Вставить("Тема", ПараметрыОтправки.Тема);
					ПараметрыОткрытияФормы.Вставить("Текст", ПараметрыОтправки.Текст);
					ПараметрыОткрытияФормы.Вставить("СписокФайлов", ОбрабатываемыеФайлы);
					
					ОтправитьПечатныеФормыПоЭлектроннойПочте(ФормаПечатьДокументов, ПараметрыОткрытияФормы);
					
				ИначеЕсли ДополнительныеПараметры.ЦельПодписания = ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьНаРаботаВРоссии") Тогда
					
					ИнтеграцияСРаботаВРоссииКлиент.ПередатьДокументы(ОбрабатываемыеФайлы);
					
				ИначеЕсли ДополнительныеПараметры.ЦельПодписания = ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьВКабинетСотрудников") Тогда
					
					КадровыйЭДОВызовСервера.ЗапланироватьДействияСПечатнымиФормами(ОбрабатываемыеФайлы, ДополнительныеПараметры.ЦельПодписания);
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если ДополнительныеПараметры.Свойство("ОбновленныеФайлы") Тогда
				ОбновленныеФайлы = ДополнительныеПараметры.ОбновленныеФайлы;
			Иначе
				ОбновленныеФайлы = Новый Массив;
			КонецЕсли;
			
			Если ДанныеФайловНаПодпись.Количество() > 0 Тогда
				Для Каждого ФайлыНаПодписьОрганизации Из ДанныеФайловНаПодпись Цикл
					ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ОбновленныеФайлы, ФайлыНаПодписьОрганизации.Значение);
				КонецЦикла;
			КонецЕсли;
			
			ПоказатьСостояниеОтправленныхНаПодпись(ДополнительныеПараметры);
			
			Если ОбновленныеФайлы.Количество() > 0 Тогда
				КадровыйЭДОВызовСервера.ЗаменитьПечатныеФормы(
					ОбновленныеФайлы, ДополнительныеПараметры.ПечатныеФормы, ДополнительныеПараметры.ОбъектыПечати);
			КонецЕсли;
			
			Для Каждого ОписаниеПечатнойФормы Из ДополнительныеПараметры.ПечатныеФормы Цикл
				
				НайденныеФормы = ФормаПечатьДокументов.НастройкиПечатныхФорм.НайтиСтроки(Новый Структура("ИмяМакета", ОписаниеПечатнойФормы.ИдентификаторПечатнойФормы));
				Если НайденныеФормы.Количество() > 0 Тогда
					ФормаПечатьДокументов[НайденныеФормы[0].ИмяРеквизита] = ОписаниеПечатнойФормы.ПечатнаяФорма;
				КонецЕсли;
				
			КонецЦикла;
			
			ФормаПечатьДокументов.ПодключитьОбработчикОжидания("УстановитьТекущуюСтраницу", 0.1, Истина);
			
			ТекущаяНастройка = УправлениеПечатьюКлиент.НастройкаТекущейПечатнойФормы(ФормаПечатьДокументов);
			Если ТекущаяНастройка <> Неопределено Тогда
				
				ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
					ФормаПечатьДокументов.Элементы,
					"КнопкаРедактирование",
					"Пометка",
					Ложь);
				
				ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
					ФормаПечатьДокументов.Элементы,
					"КнопкаРедактирование",
					"Доступность",
					Ложь);
				
			КонецЕсли;
			
		КонецЕсли;
		
		ОповеститьОбОбновленииДанныхДокументовКЭДО();
		КадровыйЭДОВызовСервера.ОбновитьУведомленияВФоне();
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СохранениеНаНосители

Процедура СохранитьПечатныеФормыНаДиск(СписокФайлов, ОповещениеЗавершения = Неопределено) Экспорт
	
	СохранитьФайлыНаДиск(
		КадровыйЭДОВызовСервера.ФайлыПечатныхФормДляСохраненияНаДиск(СписокФайлов), ОповещениеЗавершения);
	
КонецПроцедуры

Процедура СохранитьДокументыКЭДОНаДиск(ДокументыКЭДО, ОповещениеЗавершения = Неопределено) Экспорт
	
	Состояние(НСтр("ru = 'Подготовка файлов к записи на диск'"));
	
	Если ЗначениеЗаполнено(ДокументыКЭДО) Тогда
		
		ФайлыЭлектронныхДокументов = КадровыйЭДОВызовСервера.ФайлыЭлектронныхДокументовДляСохраненияНаДиск(ДокументыКЭДО);
		Если Не ЗначениеЗаполнено(ФайлыЭлектронныхДокументов) Тогда
			ОбщегоНазначенияКлиент.СообщитьПользователю(
				НСтр("ru = 'Не задан электронный документ'"), ДокументыКЭДО[0], "ИмяФайлаСРасширением", "");
			Возврат;
		КонецЕсли;
		
		СохранитьФайлыНаДиск(ФайлыЭлектронныхДокументов, ОповещениеЗавершения);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура СохранитьМЧДНаДиск(СписокМЧД, ОповещениеЗавершения = Неопределено) Экспорт
	
	Состояние(НСтр("ru = 'Подготовка файлов к записи на диск'"));
	
	СохранитьФайлыНаДиск(
		КадровыйЭДОВызовСервера.ФайлыМЧДДляСохранениеНаДиск(СписокМЧД), ОповещениеЗавершения);
	
КонецПроцедуры

Процедура СохранитьФайлыНаДиск(СохраняемыеФайлы, ОповещениеЗавершения)
	
	Если ОповещениеЗавершения = Неопределено Тогда
		ОповещениеЗавершения = Новый ОписаниеОповещения("ПослеСохраненияФайловЭлектронныхДокументовНаДиск", ЭтотОбъект);
	КонецЕсли;
	
	ПараметрыСохранения = ФайловаяСистемаКлиент.ПараметрыСохраненияФайлов();
	ФайловаяСистемаКлиент.СохранитьФайлы(
		ОповещениеЗавершения, СохраняемыеФайлы, ПараметрыСохранения);
	
КонецПроцедуры

Процедура ПослеСохраненияФайловЭлектронныхДокументовНаДиск(СохраненныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если СохраненныеФайлы <> Неопределено Тогда
		
		Если СохраненныеФайлы.Количество() = 1 Тогда
			ТекстСообщения = НСтр("ru = 'Записан на диск:'");
			Пояснение = СохраненныеФайлы[0].Имя;
		Иначе
			ТекстСообщения = НСтр("ru = 'Записано на диск'");
			Пояснение = СтрокаСЧислом(
				НСтр("ru = ';%1 файл; ;%1 файла;%1 файлов;%1 файлов'"),
				СохраненныеФайлы.Количество(),
				ВидЧисловогоЗначения.Количественное);
		КонецЕсли;
		
		Состояние(ТекстСообщения, , Пояснение);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОтправкаНаЭлАдрес

Процедура ОтправитьПечатныеФормыПоЭлектроннойПочте(ВладелецФормы, ПараметрыОткрытияФормы)
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("ПараметрыОткрытияФормы", ПараметрыОткрытияФормы);
	ДополнительныеПараметры.Вставить("ВладелецФормы", ВладелецФормы);
	
	ОписаниеОповещения = Новый ОписаниеОповещения(
		"ОтправитьПечатныеФормыПоЭлектроннойПочтеНастройкаУчетнойЗаписиПредложена", ЭтотОбъект, ДополнительныеПараметры);
	
	Если ОбщегоНазначенияКлиент.ПодсистемаСуществует("СтандартныеПодсистемы.РаботаСПочтовымиСообщениями") Тогда
		МодульРаботаСПочтовымиСообщениямиКлиент = ОбщегоНазначенияКлиент.ОбщийМодуль("РаботаСПочтовымиСообщениямиКлиент");
		МодульРаботаСПочтовымиСообщениямиКлиент.ПроверитьНаличиеУчетнойЗаписиДляОтправкиПочты(ОписаниеОповещения);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтправитьПечатныеФормыПоЭлектроннойПочтеНастройкаУчетнойЗаписиПредложена(УчетнаяЗаписьНастроена, ДополнительныеПараметры) Экспорт
	
	Если УчетнаяЗаписьНастроена <> Истина Тогда
		Возврат;
	КонецЕсли;
	
	Если ДополнительныеПараметры.Свойство("ОповещениеЗавершения") Тогда
		ОповещениеЗавершения = ДополнительныеПараметры.ОповещениеЗавершения;
	Иначе
		ОповещениеЗавершения = Неопределено;
	КонецЕсли;
	
	ОткрытьФорму("ОбщаяФорма.ОтправкаПодписанныхФайлов",
		ДополнительныеПараметры.ПараметрыОткрытияФормы,
		ДополнительныеПараметры.ВладелецФормы,
		Истина, , , ОповещениеЗавершения,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

#КонецОбласти

Процедура ОповеститьОбОбновленииДанныхДокументовКЭДО(Источник = Неопределено) Экспорт
	
	Оповестить("ОбновленыДанныеДокументовКЭДО", , Источник);
	
КонецПроцедуры

Процедура НаправитьНаПодпись(ДанныеФайловНаПодпись, Действие, ИсполнителиОрганизаций) Экспорт
	
	Для Каждого ОписаниеДанных Из ДанныеФайловНаПодпись Цикл
		
		Организация = ОписаниеДанных.Ключ;
		Исполнители = ИсполнителиОрганизаций.Получить(Организация);
		
		ДанныеФайлов = Новый Массив;
		Для Каждого ОписаниеФайла Из ОписаниеДанных.Значение Цикл
			ДанныеФайлов.Добавить(ОписаниеФайла.ФайлОбъекта)
		КонецЦикла;
		
		КадровыйЭДОВызовСервера.НаправитьНаПодпись(ДанныеФайлов, Действие, Исполнители);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПроверитьСертификатыПодписей(КомандаПечати)
	
	ПодписиБезСертификатов = КадровыйЭДОВызовСервера.ПодписиБезСертификатов(КомандаПечати.ОбъектыПечати, КомандаПечати.Идентификатор);
	Если ЗначениеЗаполнено(ПодписиБезСертификатов) Тогда
		ДополнительныеПараметры = Новый Структура("КомандаПечати", КомандаПечати);
		ДополнительныеПараметры.Вставить("ПодписиБезСертификатов", ПодписиБезСертификатов);
		Оповещение = Новый ОписаниеОповещения("ПолучитьСведенияОСертификатеПослеСозданияМенеджера", ЭтотОбъект, ДополнительныеПараметры);
		ЭлектроннаяПодписьКлиент.СоздатьМенеджерКриптографии(Оповещение, "ПолучениеСертификатов");
		Возврат;
	КонецЕсли;
	
	УправлениеПечатьюБЗККлиент.ВыполнитьКомандуПечати(КомандаПечати);
	
КонецПроцедуры

#Область ПолучениеДанныхСертификатаИзПодписи

Функция ДанныеСертификатаПодписи(МенеджерКриптографии, ДвоичныеДанныеПодписи) Экспорт
	
	ДанныеСертификата = Новый Структура("Сертификат,Отпечаток,АдресСертификата");
	Попытка
		Сертификаты = МенеджерКриптографии.ПолучитьСертификатыИзПодписи(ДвоичныеДанныеПодписи);
		Если Сертификаты.Количество() > 0 Тогда
			
			ДанныеСертификата.Сертификат = Сертификаты[Сертификаты.Количество() - 1];
			ДанныеСертификата.Отпечаток = Base64Строка(ДанныеСертификата.Сертификат.Отпечаток);
			ДанныеСертификата.АдресСертификата = ПоместитьВоВременноеХранилище(
				ДанныеСертификата.Сертификат.Выгрузить(), Новый УникальныйИдентификатор);
			
		КонецЕсли;
	Исключение
		Ошибка = ИнформацияОбОшибке();
	КонецПопытки;
	
	Возврат ДанныеСертификата;
	
КонецФункции

Процедура НачатьПолучениеДанныхСертификатаПодписи(МенеджерКриптографии, ДвоичныеДанныеПодписи, ОповещениеЗавершения) Экспорт
	
	Попытка
		ДополнительныеПараметры = Новый Структура("ОповещениеЗавершения", ОповещениеЗавершения);
		Оповещение = Новый ОписаниеОповещения("ДанныеСертификатаПодписиЗавершение", ЭтотОбъект, ДополнительныеПараметры);
		МенеджерКриптографии.НачатьПолучениеСертификатовИзПодписи(Оповещение, ДвоичныеДанныеПодписи);
	Исключение
		ВыполнитьОбработкуОповещения(ОповещениеЗавершения, Неопределено);
	КонецПопытки;
	
КонецПроцедуры

Процедура ДанныеСертификатаПодписиЗавершение(Сертификаты, ДополнительныеПараметры) Экспорт
	
	Если ЗначениеЗаполнено(Сертификаты) Тогда
		
		ДанныеСертификата = Новый Структура("Сертификат,Отпечаток,АдресСертификата");
		ДанныеСертификата.Сертификат = Сертификаты[Сертификаты.Количество() - 1];
		ДанныеСертификата.Отпечаток = Base64Строка(ДанныеСертификата.Сертификат.Отпечаток);
		
		ДополнительныеПараметры.Вставить("ДанныеСертификата", ДанныеСертификата);
		Оповещение = Новый ОписаниеОповещения("ПоОкончанииВыгрузкиСертификата", ЭтотОбъект, ДополнительныеПараметры);
		ДанныеСертификата.Сертификат.НачатьВыгрузку(Оповещение);
		
		Возврат;
		
	Иначе
		ДанныеСертификата = Неопределено;
	КонецЕсли;
	
	ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеЗавершения, ДанныеСертификата);
	
КонецПроцедуры

Процедура ПоОкончанииВыгрузкиСертификата(ДвоичныеДанныеСертификата, ДополнительныеПараметры) Экспорт
	
	Если ДвоичныеДанныеСертификата <> Неопределено Тогда
		
		ДанныеСертификата = ДополнительныеПараметры.ДанныеСертификата;
		ДанныеСертификата.АдресСертификата = ПоместитьВоВременноеХранилище(
			ДвоичныеДанныеСертификата, Новый УникальныйИдентификатор);
		
	Иначе
		ДанныеСертификата = Неопределено;
	КонецЕсли;
	
	ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ОповещениеЗавершения, ДанныеСертификата);
	
КонецПроцедуры

#КонецОбласти

Процедура ПолучитьСведенияОСертификатеПослеСозданияМенеджера(МенеджерКриптографии, ДополнительныеПараметры) Экспорт
	
	Если ТипЗнч(МенеджерКриптографии) <> Тип("Строка") Тогда
		
		ДополнительныеПараметры.Вставить("МенеджерКриптографии", МенеджерКриптографии);
		ДополнительныеПараметры.Вставить("ИндексТекущейПодписи", 0);
		
		ИтерацияПолученияДанныхСертификатаБезПодписи(ДополнительныеПараметры);
		
	Иначе
		УправлениеПечатьюБЗККлиент.ВыполнитьКомандуПечати(ДополнительныеПараметры.КомандаПечати);
	КонецЕсли;
	
КонецПроцедуры

Процедура ИтерацияПолученияДанныхСертификатаБезПодписи(ДополнительныеПараметры)
	
	Оповещение = Новый ОписаниеОповещения("ПолучитьДанныеСертификатаОчереднойПодписи", ЭтотОбъект, ДополнительныеПараметры);
	
	ДвоичныеДанныеПодписи = ПолучитьИзВременногоХранилища(
		ДополнительныеПараметры.ПодписиБезСертификатов[ДополнительныеПараметры.ИндексТекущейПодписи].Подпись);
	
	Если ТипЗнч(ДвоичныеДанныеПодписи) = Тип("ДвоичныеДанные") Тогда
		НачатьПолучениеДанныхСертификатаПодписи(
			ДополнительныеПараметры.МенеджерКриптографии,
			ДвоичныеДанныеПодписи,
			Оповещение);
	Иначе
		ВыполнитьОбработкуОповещения(Оповещение, Неопределено);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПолучитьДанныеСертификатаОчереднойПодписи(ДанныеСертификата, ДополнительныеПараметры) Экспорт
	
	Если ДанныеСертификата <> Неопределено Тогда
		ПодписьБезСертификата = ДополнительныеПараметры.ПодписиБезСертификатов[ДополнительныеПараметры.ИндексТекущейПодписи];
		ПодписьБезСертификата.Отпечаток = ДанныеСертификата.Отпечаток;
		ПодписьБезСертификата.Сертификат = ДанныеСертификата.АдресСертификата;
	КонецЕсли;
	
	ДополнительныеПараметры.ИндексТекущейПодписи = ДополнительныеПараметры.ИндексТекущейПодписи + 1;
	Если ДополнительныеПараметры.ИндексТекущейПодписи < ДополнительныеПараметры.ПодписиБезСертификатов.Количество() Тогда
		ИтерацияПолученияДанныхСертификатаБезПодписи(ДополнительныеПараметры);
	Иначе
		
		ДополнительныеПараметрыКоманды = Новый Структура;
		Если ДополнительныеПараметры.КомандаПечати.Свойство("ДополнительныеПараметры") Тогда
			ДополнительныеПараметрыКоманды = ДополнительныеПараметры.КомандаПечати.ДополнительныеПараметры;
		КонецЕсли;
		
		ДополнительныеПараметрыКоманды.Вставить("ПодписиБезСертификатов", ДополнительныеПараметры.ПодписиБезСертификатов);
		ДополнительныеПараметры.КомандаПечати.Вставить("ДополнительныеПараметры", ДополнительныеПараметрыКоманды);
		
		УправлениеПечатьюБЗККлиент.ВыполнитьКомандуПечати(ДополнительныеПараметры.КомандаПечати);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработатьДействияСообщения(Сообщение, Действие, ДополнительныеПараметры) Экспорт
	
	Если Действие = КадровыйЭДОКлиентСервер.ИмяДействияУведомленияОзнакомитьсяИПодписать() Тогда
		ПараметрыОткрытия = Новый Структура("ДокументыНаПодпись", Истина);
		ОткрытьФорму("Документ.ДокументКадровогоЭДО.ФормаСписка", ПараметрыОткрытия, , Истина);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВключитьРедактированиеПечатнойФормы(УправляемаяФорма)
	
	Элементы = УправляемаяФорма.Элементы;
	
	НастройкаПечатнойФормы = УправлениеПечатьюКлиент.НастройкаТекущейПечатнойФормы(УправляемаяФорма);
	Если НастройкаПечатнойФормы <> Неопределено Тогда
		
		Редактирование = Не Элементы[КадровыйЭДОКлиентСервер.ПрефиксЭлементовОВозможностиРедактирования() + "КомандаРедактирования"].Пометка;
		
		ПолеТабличногоДокумента = Элементы[НастройкаПечатнойФормы.ИмяРеквизита];
		ПолеТабличногоДокумента.Редактирование = Редактирование;
		Элементы.ТекущаяПечатнаяФорма.Редактирование = ПолеТабличногоДокумента.Редактирование;
		Элементы.ТекущаяПечатнаяФорма.ОтображатьСетку = Элементы.ТекущаяПечатнаяФорма.Редактирование;
		Элементы.ТекущаяПечатнаяФорма.ОтображатьЗаголовки = Элементы.ТекущаяПечатнаяФорма.Редактирование;
		
		ПечатнаяФормаДоступна = Элементы.Страницы.ТекущаяСтраница <> Элементы.СтраницаПечатнаяФормаНедоступна;
		РедактированиеВозможно = ПечатнаяФормаДоступна И Не ПолеТабличногоДокумента.Защита;
		
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			КадровыйЭДОКлиентСервер.ПрефиксЭлементовОВозможностиРедактирования() + "КомандаРедактирования",
			"Пометка",
			Редактирование);
		
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			КадровыйЭДОКлиентСервер.ПрефиксЭлементовОВозможностиРедактирования() + "КомандаРедактирования",
			"Доступность",
			РедактированиеВозможно);
		
	КонецЕсли;
	
КонецПроцедуры

Функция ИмяСобытияПриЗаписиПечатныхФорм()
	Возврат "ЗаписьПечатныхФормСЭЦП";
КонецФункции

Процедура ОповеститьОбИзмененииПечатнойФормы(Владелец, ДанныеИдентификаторовПечатныхФорм)
	
	ОповеститьОбИзменении(Владелец);
	Оповестить(ИмяСобытияПриЗаписиПечатныхФорм(), ДанныеИдентификаторовПечатныхФорм, Владелец);
	
КонецПроцедуры

Процедура ОткрытьЭлектронныйДокументПослеПодтверждения(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено И Результат = "Продолжить" Тогда
		ОткрытьЭлектронныйДокумент(ДополнительныеПараметры.ЭлектронныйДокумент,
			ДополнительныеПараметры.Форма.УникальныйИдентификатор);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОткрытьЭлектронныйДокумент(ЭлектронныйДокумент, ИдентификаторХранилища)
	
	ДанныеФайла = РаботаСФайламиСлужебныйВызовСервера.ДанныеФайлаДляОткрытия(
		ЭлектронныйДокумент, Неопределено, ИдентификаторХранилища);
	
	РаботаСФайламиКлиент.ОткрытьФайл(ДанныеФайла);
	
КонецПроцедуры

Функция ФайлыДокументовКЭДОФормыПечатьДокументов(УправляемаяФорма)
	
	ФайлыДокументовКЭДО = Новый Массив;
	
	ОписанияФайлов = КадровыйЭДОКлиентСервер.ОписанияФайловПечатныхФормИзПараметровФормы(УправляемаяФорма.Параметры);
	Если ОписанияФайлов <> Неопределено Тогда
		Для Каждого ОписаниеИдентификатора Из ОписанияФайлов.ОригиналыПечатныхФорм Цикл
			Для Каждого ОписаниеОригиналов Из ОписаниеИдентификатора.Значение.Оригиналы Цикл
				ФайлыДокументовКЭДО.Добавить(ОписаниеОригиналов.Ключ);
			КонецЦикла;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ФайлыДокументовКЭДО;
	
КонецФункции

Процедура ОзнакомитьсяСКомментариямиКПечатнойФорме(УправляемаяФорма)
	
	КадровыйЭДОВызовСервера.УдалитьФайлыИзОбработкиПользователя(
		ФайлыДокументовКЭДОФормыПечатьДокументов(УправляемаяФорма),
		ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.Ознакомиться"));
	
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
		УправляемаяФорма.Элементы,
		"ОзнакомленоСКомментариямиКПечатнойФорме",
		"Доступность",
		Ложь);
	
КонецПроцедуры

#Область КонвертацияДокументов

Процедура ОбработкаОтветаНаВопросОКонвертацииДокументов(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ВыполнитьКонвертациюДокументов(ДополнительныеПараметры.ДокументыКадровогоЭДО);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыполнитьКонвертациюДокументов(ДокументыКадровогоЭДО)
	
	Результат = КадровыйЭДОВызовСервера.КонвертироватьДокументы(ДокументыКадровогоЭДО);
	Если Не ЗначениеЗаполнено(Результат.ДокументыСПечатнымиФормами) Тогда
		ТекстПредупреждения = НСтр("ru = 'Не найдено электронных документов печатных форм'");
		ПоказатьПредупреждение(, ТекстПредупреждения);
		ПоказатьПротоколКонвертацииДокументов(Результат);
		Возврат;
	КонецЕсли;
	
	ТекстыСообщения = Новый Массив;
	Если Результат.ЕстьОшибки Тогда
		ТекстыСообщения.Добавить(НСтр("ru = 'Среди выбранных документов есть документы с ошибками.'"));
	КонецЕсли;
	
	Если Результат.ЕстьДругиеДокументы Тогда
		ТекстыСообщения.Добавить(НСтр("ru = 'Среди выбранных документов есть документы не являющиеся печатными формами.'"));
	КонецЕсли;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Результат", Результат);
	Оповещение = Новый ОписаниеОповещения("ВыполнитьКонвертациюДокументовЗавершение", ЭтотОбъект, ДополнительныеПараметры);
	Если ТекстыСообщения.Количество() > 0
		Или Результат.ДокументыНеТребующиеКонвертации.Количество() > 0
		Или Результат.ДокументыПрошлыхПериодов.Количество() > 0 Тогда
		
		ДокументыСПечатнымиФормамиКоличество = СтрокаСЧислом(
			НСтр("ru = ';%1 электронный документ печатной формы;;%1 электронных документа печатных форм;%1 электронных документов печатных форм;%1 электронных документа печатных форм'"),
			Результат.ДокументыСПечатнымиФормами.Количество(),
			ВидЧисловогоЗначения.Количественное);
		Если Результат.ДокументыНеТребующиеКонвертации.Количество() > 0
			Или Результат.ДокументыПрошлыхПериодов.Количество() > 0 Тогда
			
			ТекстыЭтогоСообщения = Новый Массив;
			ТекстыЭтогоСообщения.Добавить(
				СтрШаблон(НСтр("ru = 'Можно сконвертировать %1, в том числе:'"),
					ДокументыСПечатнымиФормамиКоличество));
			Если Результат.ДокументыНеТребующиеКонвертации.Количество() Тогда
				ДокументыНеТребующиеКонвертацииКоличество = СтрокаСЧислом(
					НСтр("ru = ';%1 электронный документ возможно не требует;;%1 электронных документа возможно не требуют;%1 электронных документов возможно не требуют;%1 электронных документа возможно не требуют'"),
					Результат.ДокументыНеТребующиеКонвертации.Количество(),
					ВидЧисловогоЗначения.Количественное);
				ТекстСообщенияОКоличестве = СтрШаблон(НСтр("ru = '- %1 конвертации'"), ДокументыНеТребующиеКонвертацииКоличество);
				Если Результат.ДокументыПрошлыхПериодов.Количество() > 0 Тогда
					ТекстСообщенияОКоличестве = ТекстСообщенияОКоличестве + ";";
				Иначе
					ТекстСообщенияОКоличестве = ТекстСообщенияОКоличестве + ".";
				КонецЕсли;
				ТекстыЭтогоСообщения.Добавить(ТекстСообщенияОКоличестве);
			КонецЕсли;
			Если Результат.ДокументыПрошлыхПериодов.Количество() > 0 Тогда
				ДокументыПрошлыхПериодовКоличество = СтрокаСЧислом(
					НСтр("ru = ';%1 электронный документ;;%1 электронных документа;%1 электронных документов;%1 электронных документа'"),
					Результат.ДокументыПрошлыхПериодов.Количество(),
					ВидЧисловогоЗначения.Количественное);
				ТекстыЭтогоСообщения.Добавить(СтрШаблон(НСтр("ru = '- %1 из периода, когда не требовалось применение формата PDF/A-1A.'"), ДокументыПрошлыхПериодовКоличество));
			КонецЕсли;
			ТекстыСообщения.Добавить(СтрСоединить(ТекстыЭтогоСообщения, Символы.ПС));
			
		Иначе
			ТекстыСообщения.Добавить(СтрШаблон(НСтр("ru = 'Можно сконвертировать %1.'"), ДокументыСПечатнымиФормамиКоличество));
		КонецЕсли;
		ТекстыСообщения.Добавить(НСтр("ru = 'Продолжить?'"));
		ПоказатьВопрос(Оповещение, СтрСоединить(ТекстыСообщения, Символы.ПС), РежимДиалогаВопрос.ДаНетОтмена);
		
	Иначе
		ВыполнитьОбработкуОповещения(Оповещение, КодВозвратаДиалога.Да);
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыполнитьКонвертациюДокументовЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Оповещение = Новый ОписаниеОповещения("ПослеПодписанияФайловПриКонвертацииДокументов", ЭтотОбъект, ДополнительныеПараметры);
	Если Результат = КодВозвратаДиалога.Да Тогда
		
		КадровыйЭДОВызовСервера.УдалитьПодписиИОбновитьОсновныеДокументыПриКонвертацииДокументов(
			ДополнительныеПараметры.Результат);
		
		ПодписатьФайлы(
			КадровыйЭДОВызовСервера.ДанныеФайловНаПодпись(ДополнительныеПараметры.Результат.ЭлектронныеДокументыНаПодпись, Новый УникальныйИдентификатор),
			Оповещение, ЭтотОбъект, ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьВКабинетСотрудников"));
		
	Иначе
		ПоказатьПротоколКонвертацииДокументов(ДополнительныеПараметры.Результат);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПослеПодписанияФайловПриКонвертацииДокументов(Результат, ДополнительныеПараметры) Экспорт
	
	КадровыйЭДОВызовСервера.ЗапланироватьДействияСПечатнымиФормами(ДополнительныеПараметры.Результат.ЭлектронныеДокументы,
		ПредопределенноеЗначение("Перечисление.ДействияСФайламиДокументовКЭДО.ПередатьВКабинетСотрудников"));
	
	ПоказатьПротоколКонвертацииДокументов(ДополнительныеПараметры.Результат);
	
КонецПроцедуры

Процедура ПоказатьПротоколКонвертацииДокументов(Результат)
	Если Результат.Протокол.КоличествоСтрок() > 0 Тогда
		Результат.Протокол.Показать(
			НСтр("ru = 'Протокол конвертации электронных документов печатных форм в формат PDF/A-1A'"), НСтр("ru = 'Протокол конвертации.txt'"));
	КонецЕсли;
КонецПроцедуры

Процедура ПослеОбновленияСостояний(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ОповеститьОбИзменении(Тип("ДокументСсылка.ДокументКадровогоЭДО"));
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
