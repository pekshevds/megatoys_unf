#Область СлужебныеПроцедурыИФункции

Функция УдержанияПоРабочимМестам(РеквизитыДляПроведения) Экспорт 
	
	ФизическоеЛицо 	= РеквизитыДляПроведения.ФизическоеЛицо;
	Организация 	= РеквизитыДляПроведения.Организация;
	Период 			= РеквизитыДляПроведения.Месяц;
	
	ФизическиеЛица = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ФизическоеЛицо);
	НакопленныеКорректировки = ВзаиморасчетыССотрудниками.КорректировкиВыплаты(Организация, Период, ФизическиеЛица, РеквизитыДляПроведения.Ссылка);
	НакопленныеКорректировки.Колонки.СуммаКорректировки.Имя = "Сумма";
	
	ТаблицаНДФЛ = Новый ТаблицаЗначений;
	ТаблицаНДФЛ.Колонки.Добавить("ИдентификаторСтроки", Новый ОписаниеТипов("Число"));
	ТаблицаНДФЛ.Колонки.Добавить("ФизическоеЛицо", Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	ТаблицаНДФЛ.Колонки.Добавить("ВидУдержания", Новый ОписаниеТипов("ПеречислениеСсылка.ВидыОсобыхНачисленийИУдержаний"));
	ТаблицаНДФЛ.Колонки.Добавить("Сумма", Новый ОписаниеТипов("Число"));
	ТаблицаНДФЛ.Колонки.Добавить("ВидДоходаИсполнительногоПроизводства", Новый ОписаниеТипов("ПеречислениеСсылка.ВидыДоходовИсполнительногоПроизводства"));
	ТаблицаНДФЛ.Колонки.Добавить("БазаПоУмолчанию", Новый ОписаниеТипов("Булево"));
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", РеквизитыДляПроведения.Ссылка);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВозвратНДФЛ.ИдентификаторСтрокиНДФЛ КАК ИдентификаторСтрокиНДФЛ,
	|	ВозвратНДФЛ.Налог КАК Налог,
	|	ВозвратНДФЛ.НалогСПревышения КАК НалогСПревышения,
	|	ВозвратНДФЛ.РегистрацияВНалоговомОргане КАК РегистрацияВНалоговомОргане,
	|	ВозвратНДФЛ.СтавкаНалогообложенияРезидента КАК СтавкаНалогообложенияРезидента
	|ИЗ
	|	Документ.ВозвратНДФЛ.СуммыВозврата КАК ВозвратНДФЛ
	|ГДЕ
	|	ВозвратНДФЛ.Ссылка = &Ссылка";
	Выборка = Запрос.Выполнить().Выбрать();
	
	РегистрацииВНалоговомОргане = Новый Соответствие;
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.Налог > 0 Тогда
			НоваяСтрока = ТаблицаНДФЛ.Добавить();
			НоваяСтрока.ИдентификаторСтроки = Выборка.ИдентификаторСтрокиНДФЛ;
			НоваяСтрока.ФизическоеЛицо 		= ФизическоеЛицо;
			НоваяСтрока.Сумма 				= Выборка.Налог;
			НоваяСтрока.ВидУдержания 		= Перечисления.ВидыОсобыхНачисленийИУдержаний.НДФЛ;
			НоваяСтрока.БазаПоУмолчанию 	= (Выборка.СтавкаНалогообложенияРезидента <> Перечисления.НДФЛСтавкиНалогообложенияРезидента.Ставка13);
			НоваяСтрока.ВидДоходаИсполнительногоПроизводства = Перечисления.ВидыДоходовИсполнительногоПроизводства.ЗарплатаВознаграждения;
		КонецЕсли;
		
		Если Выборка.НалогСПревышения > 0 Тогда
			НоваяСтрока = ТаблицаНДФЛ.Добавить();
			НоваяСтрока.ИдентификаторСтроки = Выборка.ИдентификаторСтрокиНДФЛ;
			НоваяСтрока.ФизическоеЛицо 		= ФизическоеЛицо;
			НоваяСтрока.Сумма 				= Выборка.НалогСПревышения;
			НоваяСтрока.ВидУдержания 		= Перечисления.ВидыОсобыхНачисленийИУдержаний.НДФЛСПревышения;
			НоваяСтрока.БазаПоУмолчанию 	= (Выборка.СтавкаНалогообложенияРезидента <> Перечисления.НДФЛСтавкиНалогообложенияРезидента.Ставка13);
			НоваяСтрока.ВидДоходаИсполнительногоПроизводства = Перечисления.ВидыДоходовИсполнительногоПроизводства.ЗарплатаВознаграждения;
		КонецЕсли;
		
		РегистрацииВНалоговомОргане.Вставить(Выборка.ИдентификаторСтрокиНДФЛ, Выборка.РегистрацияВНалоговомОргане);
	
	КонецЦикла;
	
	РезультатыРаспределения = ОтражениеЗарплатыВУчете.ВозвратНДФЛПоРабочимМестамИСтатьям(ТаблицаНДФЛ, НакопленныеКорректировки, Организация, Период);
	
	УдержанияПоРабочимМестам = УчетНачисленнойЗарплаты.ТаблицаРаспределенияПоРабочимМестам();
	
	Для каждого СтрокаТЗ Из РезультатыРаспределения Цикл
		НоваяСтрока = УдержанияПоРабочимМестам.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, РеквизитыДляПроведения);
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗ);
		НоваяСтрока.НачислениеУдержание = СтрокаТЗ.ВидУдержания;
		НоваяСтрока.РегистрацияВНалоговомОргане = РегистрацииВНалоговомОргане[СтрокаТЗ.ИдентификаторСтроки];
		НоваяСтрока.Сумма = СтрокаТЗ.Результат;
	КонецЦикла;
	
	Возврат УдержанияПоРабочимМестам;
	
КонецФункции

Процедура ОбработкаПроверкиЗаполнения(Документ, Отказ, ПроверяемыеРеквизиты) Экспорт
	
	
	
КонецПроцедуры

#КонецОбласти