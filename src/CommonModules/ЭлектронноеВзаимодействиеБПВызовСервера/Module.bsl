
////////////////////////////////////////////////////////////////////////////////
// ЭлектронноеВзаимодействиеБПВызовСервера: вспомогательные процедуры и функции БЭД
//
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

#Область ДиректБанк

Функция ВидимостьЭлементовДиректБанк(Организация, ДанныеБанкаСчета) Экспорт
	
	ВалютаДенежныхСредств = УправлениеНебольшойФирмойПовтИсп.ПолучитьВалютуУчета();
	Если ТипЗнч(ДанныеБанкаСчета) = Тип("СправочникСсылка.БанковскиеСчета") Тогда
		ДанныеБанковскогоСчета = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДанныеБанкаСчета, "Банк, ВалютаДенежныхСредств");
		Банк = ДанныеБанковскогоСчета.Банк;
		ВалютаДенежныхСредств = ДанныеБанковскогоСчета.ВалютаДенежныхСредств;
	Иначе
		
		Банк = ДанныеБанкаСчета;
		
	КонецЕсли;
	
	Результат = "НеПоказывать";
	Если ВалютаДенежныхСредств <> УправлениеНебольшойФирмойПовтИсп.ПолучитьВалютуУчета()
		Или Не (ЗначениеЗаполнено(Банк) И ТипЗнч(Организация) = Тип("СправочникСсылка.Организации")) Тогда
		
		Возврат Результат;
		
	КонецЕсли;
	
	Если Организация.Пустая() Тогда
		
		НастройкаОбмена = Неопределено;
		
	Иначе
		
		НастройкаОбмена = ОбменСБанками.НастройкаОбмена(Организация, Банк);
		
	КонецЕсли;
	
	БИК = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Банк, "Код");
	РекомендуетсяПрямойОбменСБанком = Ложь;
	
	// Баннер директ-банка отображается у всех пользователей, который открыли элемент с баннером.
	// У этих пользователей может не быть доступа к банку и настройкам интеграции, поэтому
	// получать настройки интеграции нужно в привилегированном режиме.
	УстановитьПривилегированныйРежим(Истина);
	
	ВключенаИнтеграцияСБанком = ТипЗнч(Банк) = Тип("СправочникСсылка.Банки") И ЗначениеЗаполнено(Банк) И
		ОбменСБанками.ВозможенПрямойОбменСБанком(Банк.Код);
	УстановитьПривилегированныйРежим(Ложь);
	
	Если Не ВключенаИнтеграцияСБанком
		И Не ЗначениеЗаполнено(НастройкаОбмена)
		И ОбменСБанками.ВозможенПрямойОбменСБанком(БИК, 1, РекомендуетсяПрямойОбменСБанком) Тогда
		
		Результат = "ПоказатьГиперссылку";
		ВидимостьРекламы = ХранилищеОбщихНастроек.Загрузить("ВидимостьРекламыДиректБанк", БИК);
		ВидимостьРекламы = ?(ВидимостьРекламы = Неопределено, Истина, ВидимостьРекламы);
		Если ВидимостьРекламы И РекомендуетсяПрямойОбменСБанком Тогда
			
			Результат = "ПоказатьБаннер";
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура СохранитьНастройкуВидимостиРекламыДиректБанк(Банк, Видимость) Экспорт
	
	БИК = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Банк, "Код");
	ХранилищеОбщихНастроек.Сохранить("ВидимостьРекламыДиректБанк", БИК, Видимость);
	
КонецПроцедуры

Функция ДанныеВыписокБанкаВКоллекцию(Знач МассивВыписок) Экспорт
	
	МассивСчетов      = Новый Массив;
	СсылкаНаХранилище = "";
	ПолучитьДанныеВыпискиБанка(МассивВыписок, СсылкаНаХранилище, МассивСчетов);
	
	Возврат СсылкаНаХранилище;
	
КонецФункции

Функция АвтоматическоеПолучениеВыпискиДоступно(СписокОрганизаций) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПараметрыОбменСБанками.НастройкаОбмена КАК НастройкаОбмена
	|ИЗ
	|	РегистрСведений.ПараметрыОбменСБанками КАК ПараметрыОбменСБанками
	|ГДЕ
	|	ПараметрыОбменСБанками.АвтоматическоеПолучениеВыписки
	|	И ПараметрыОбменСБанками.НастройкаОбмена.Организация В(&СписокОрганизаций)";
	Запрос.УстановитьПараметр("СписокОрганизаций", СписокОрганизаций);
	УстановитьПривилегированныйРежим(Истина);
	РезультатЗапроса = Запрос.Выполнить();
	УстановитьПривилегированныйРежим(Ложь);
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

Функция НастройкиОбменаАвтоматическоеПолучениеВыписки(Организация = Неопределено, Банк = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ПараметрыОбменСБанками.НастройкаОбмена КАК НастройкаОбмена
	|ИЗ
	|	РегистрСведений.ПараметрыОбменСБанками КАК ПараметрыОбменСБанками
	|ГДЕ
	|	ПараметрыОбменСБанками.АвтоматическоеПолучениеВыписки
	|	И ПараметрыОбменСБанками.НастройкаОбмена.Ссылка ССЫЛКА Справочник.НастройкиОбменСБанками
	|	И НЕ ПараметрыОбменСБанками.НастройкаОбмена.ПометкаУдаления
	|	И НЕ ПараметрыОбменСБанками.НастройкаОбмена.Недействительна
	|	И ИСТИНА";
	ТекстДополнительногоОтбора = "";
	Если ЗначениеЗаполнено(Организация) Тогда
		ТекстДополнительногоОтбора = ТекстДополнительногоОтбора + " И ПараметрыОбменСБанками.НастройкаОбмена.Организация = &Организация ";
	КонецЕсли;
	Если ЗначениеЗаполнено(Банк) Тогда
		ТекстДополнительногоОтбора = ТекстДополнительногоОтбора + " И ПараметрыОбменСБанками.НастройкаОбмена.Банк = &Банк ";
	КонецЕсли;
	Если ТекстДополнительногоОтбора <> "" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ИСТИНА", ТекстДополнительногоОтбора);
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.УстановитьПараметр("Банк", Банк);
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("НастройкаОбмена");
	
КонецФункции

Функция ТаблицаОшибокАвтоматическоеПолучениеВыписки(НастройкиОбмена) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПараметрыОбменСБанками.ТекстОшибки КАК ТекстОшибки,
	|	ПараметрыОбменСБанками.НастройкаОбмена КАК НастройкаОбмена,
	|	ПараметрыОбменСБанками.ДатаСинхронизации КАК ДатаСинхронизации
	|ИЗ
	|	РегистрСведений.ПараметрыОбменСБанками КАК ПараметрыОбменСБанками
	|ГДЕ
	|	ПараметрыОбменСБанками.АвтоматическоеПолучениеВыписки
	|	И ПараметрыОбменСБанками.НастройкаОбмена В(&НастройкиОбмена)
	|	И (ВЫРАЗИТЬ(ПараметрыОбменСБанками.ТекстОшибки КАК СТРОКА(10))) <> """"
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаСинхронизации ВОЗР";
	Запрос.УстановитьПараметр("НастройкиОбмена", НастройкиОбмена);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ТаблицаДатыСинхронизацииАвтоматическоеПолучениеВыписки(НастройкиОбмена) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	ПараметрыОбменСБанками.ДатаСинхронизации КАК ДатаСинхронизации
	|ИЗ
	|	РегистрСведений.ПараметрыОбменСБанками КАК ПараметрыОбменСБанками
	|ГДЕ
	|	ПараметрыОбменСБанками.АвтоматическоеПолучениеВыписки
	|	И ПараметрыОбменСБанками.НастройкаОбмена В(&НастройкиОбмена)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаСинхронизации УБЫВ";
	Запрос.УстановитьПараметр("НастройкиОбмена", НастройкиОбмена);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

//Процедура ВыполнитьЗаписьСобытияПоЭДВЖурналРегистрации(ОписаниеСобытия,
//														КодСобытия = 0,
//														УровеньВажности = Неопределено,
//														ОбъектМетаданных = Неопределено,
//														ДанныеСсылка = Неопределено,
//														РежимТранзакции = Неопределено)
//	
//	Уровень = "Общая подсистема";
//	Если КодСобытия = 1 Тогда
//		Уровень = "Обмен с банками";
//	ИначеЕсли КодСобытия = 2 Тогда
//		Уровень = "Обмен с контрагентами";
//	ИначеЕсли КодСобытия = 3 Тогда
//		Уровень = "Обмен с сайтами";
//	ИначеЕсли КодСобытия = 4 Тогда
//		Уровень = "Регламентные задания";
//	КонецЕсли;
//	УровеньВажностиСобытия = ?(ТипЗнч(УровеньВажности) = Тип("УровеньЖурналаРегистрации"),
//		УровеньВажности, УровеньЖурналаРегистрации.Ошибка);
//	Шаблон = НСтр("ru = 'Электронное взаимодействие.%1'");
//	ИмяСобытия = СтрЗаменить(Шаблон, "%1", Уровень);
//	ЗаписьЖурналаРегистрации(ИмяСобытия,
//		УровеньВажностиСобытия, ОбъектМетаданных, ДанныеСсылка, ОписаниеСобытия, РежимТранзакции);
//	
//КонецПроцедуры

#Область ФормированиеВыписки

// Получает выписку банка в коллекцию ОбменСБанкомВФормате1С.НовыйДанныеИзБанка(),
// а также массив ссылок на банковские счета организаций в выписке.
//
// Параметры:
//  СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками, Массив - содержит ссылку или массив ссылок на выписки банка
//  СсылкаНаХранилище - Строка - содержит ссылку на хранилище тестовых данных;
//  МассивСчетов - Массив - содержит ссылки на банковские счета организации.
//
Процедура ПолучитьДанныеВыпискиБанка(Знач СообщениеОбмена,
										  СсылкаНаХранилище,
										  МассивСчетов = Неопределено)
	
	Если ТипЗнч(СообщениеОбмена) = Тип("ДокументСсылка.СообщениеОбменСБанками") Тогда
		МассивСообщений = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(СообщениеОбмена);
	Иначе
		МассивСообщений = СообщениеОбмена;
	КонецЕсли;
	
	ДеревоДанных = Неопределено;
	ОбменСБанками.ПолучитьДанныеВыпискиБанкаДеревоЗначений(МассивСообщений, ДеревоДанных);
	
	Если ДеревоДанных = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	МассивСчетов = Новый Массив;
	
	ДанныеВыписки = ОбменСБанкомВФормате1С.НовыйДанныеИзБанка();
	
	СтрокаТаблицыВыписок = ДеревоДанных.Строки.Найти("Выписки", "ПолныйПуть");
	
	Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(МассивСообщений.Получить(0), "Организация");
	ЗаполнитьШапкуВыписки(Организация, ДанныеВыписки, СтрокаТаблицыВыписок, МассивСчетов);
	
	// Реквизиты плательщика и получателя
	ОписаниеОбменаВФормате1С = Новый Структура("Участники, РеквизитыУчастника, ОписаниеФайлаОбмена");
	ОписаниеОбменаВФормате1С.Участники           = ОбменСБанкомВФормате1С.НовыйУчастники();
	ОписаниеОбменаВФормате1С.РеквизитыУчастника  = ОбменСБанкомВФормате1С.ЭлементыРеквизитовУчастника();
	ОписаниеОбменаВФормате1С.ОписаниеФайлаОбмена = ОбменСБанкомВФормате1С.ОписаниеФайлаОбмена();
	
	Индекс = 0;
	Для Каждого Выписка Из СтрокаТаблицыВыписок.Строки Цикл
		СтрокаОперацияВыписки = Выписка.Строки.Найти("Выписки.НомерСтроки.Операции", "ПолныйПуть");
		
		Если СтрокаОперацияВыписки.Значение = Неопределено Или СтрокаОперацияВыписки.Значение = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Для Каждого Операция Из СтрокаОперацияВыписки.Строки Цикл
			ДобавитьДокумент(ДанныеВыписки, Операция, ОписаниеОбменаВФормате1С, Индекс);
		КонецЦикла;
	КонецЦикла;
	
	ПрочитанныеДанныеСервиса = Новый Структура;
	ПрочитанныеДанныеСервиса.Вставить("ДанныеИзБанка", ДанныеВыписки);
	ПрочитанныеДанныеСервиса.Вставить("Протокол", ОбменСБанкомВФормате1С.НовыйПротоколЧтенияФайла());
	ОбменСБанкомВФормате1С.ЗаписатьВПротокол(ПрочитанныеДанныеСервиса.Протокол, Истина, "ЭлектроннаяВыписка");
	
	СсылкаНаХранилище = ПоместитьВоВременноеХранилище(ПрочитанныеДанныеСервиса, Новый УникальныйИдентификатор());
	
КонецПроцедуры

Процедура ЗаполнитьШапкуВыписки(Организация, ДанныеВыписки, СтрокаТаблицыВыписок, МассивСчетов)
	
	Если ДанныеВыписки = Неопределено Тогда
		ДанныеВыписки = ОбменСБанкомВФормате1С.НовыйДанныеИзБанка();
	КонецЕсли;
	
	Индекс = 0;
	
	// Заголовок.1CClientBankExchange
	ДанныеВыписки.Заголовок.Вставить("ВерсияФормата", "1.03");
	ДанныеВыписки.Заголовок.Вставить("Кодировка", "Windows");
	
	ПерваяВыписка = СтрокаТаблицыВыписок.Строки.Получить(0);
	
	ДобавитьНеПустойПараметр(ДанныеВыписки.Заголовок, ПерваяВыписка, "Отправитель",
		"Выписки.НомерСтроки.Банк.Наименование");
	ДанныеВыписки.Заголовок.Вставить("Получатель");
	
	ДатаСоздания = ЗначениеРеквизитаВДереве(ПерваяВыписка,    "Выписки.НомерСтроки.ДатаФормирования");
	Если ЗначениеЗаполнено(ДатаСоздания) Тогда
		ДанныеВыписки.Заголовок.Вставить("ДатаСоздания", Формат(ДатаСоздания, ФорматДатыРоссия()));
		ДанныеВыписки.Заголовок.Вставить("ВремяСоздания", Формат(ДатаСоздания, ФорматВремениРоссия()));
	КонецЕсли;
	
	ДатаНачала   = ЗначениеРеквизитаВДереве(ПерваяВыписка,    "Выписки.НомерСтроки.НачалоПериода");
	ДанныеВыписки.Заголовок.Вставить("ДатаНачала", Формат(ДатаНачала, ФорматДатыРоссия()));
	ПоследняяВыписка = СтрокаТаблицыВыписок.Строки.Получить(СтрокаТаблицыВыписок.Строки.Количество() - 1);
	ДатаКонца    = ЗначениеРеквизитаВДереве(ПоследняяВыписка, "Выписки.НомерСтроки.КонецПериода");
	ДанныеВыписки.Заголовок.Вставить("ДатаКонца", Формат(ДатаКонца, ФорматДатыРоссия()));
	
	НомерСчета   = ЗначениеРеквизитаВДереве(ПоследняяВыписка, "Выписки.НомерСтроки.НомерСчета"); // одинаковый для всех
	ДанныеВыписки.Заголовок.Вставить("РасчСчет", НомерСчета);
	
	ДополнительныеРеквизиты = Новый Структура("Владелец", Организация);
	СчетОрганизации = ОбщегоНазначенияБЭД.НайтиСсылку("БанковскиеСчетаОрганизаций", НомерСчета, ДополнительныеРеквизиты);
	МассивСчетов.Добавить(СчетОрганизации);
	
	// СекцияРасчСчет
	ДанныеВыписки.Условия.РасчСчет.Добавить(НомерСчета);
	ДанныеВыписки.Условия.Вставить("ДатаНачала", Формат(ДатаНачала, ФорматДатыРоссия()));
	ДанныеВыписки.Условия.Вставить("ДатаКонца",  Формат(ДатаКонца,  ФорматДатыРоссия()));
	
	ЗаполнитьОстаткиИОбороты(ДанныеВыписки, СтрокаТаблицыВыписок, ПерваяВыписка, ПоследняяВыписка);
	
КонецПроцедуры

Процедура ЗаполнитьОстаткиИОбороты(ДанныеВыписки, СтрокаТаблицыВыписок, ПерваяВыписка, ПоследняяВыписка)
	
	СтрокаОстатка = ДанныеВыписки.Остатки.Добавить();
	
	ЕстьОстатки = Ложь;
	НачальныйОстаток = ЗначениеРеквизитаВДереве(ПерваяВыписка, "Выписки.НомерСтроки.НачальныйОстаток");
	Если ЗначениеЗаполнено(НачальныйОстаток) Тогда
		СтрокаОстатка.НачальныйОстаток = Формат(НачальныйОстаток, "ЧРД=.; ЧГ=");
		ЕстьОстатки = Истина;
	КонецЕсли;
	
	ВсегоПоступило = 0;
	ВсегоСписано = 0;
	
	Для Каждого Выписка Из СтрокаТаблицыВыписок.Строки Цикл
		ТекВсегоПоступило = ЗначениеРеквизитаВДереве(Выписка, "Выписки.НомерСтроки.ОборотВходящихПлатежей");
		Если ЗначениеЗаполнено(ТекВсегоПоступило) Тогда
			ВсегоПоступило = ВсегоПоступило + ТекВсегоПоступило;
		КонецЕсли;
		ТекВсегоСписано = ЗначениеРеквизитаВДереве(Выписка,   "Выписки.НомерСтроки.ОборотИсходящихПлатежей");
		Если ЗначениеЗаполнено(ТекВсегоСписано) Тогда
			ВсегоСписано = ВсегоСписано + ТекВсегоСписано;
		КонецЕсли;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(ВсегоПоступило) Тогда
		СтрокаОстатка.ВсегоПоступило = Формат(ВсегоПоступило, "ЧРД=.; ЧГ=");
		ЕстьОстатки = Истина;
	КонецЕсли;
	Если ЗначениеЗаполнено(ВсегоСписано) Тогда
		СтрокаОстатка.ВсегоСписано = Формат(ВсегоСписано, "ЧРД=.; ЧГ=");
		ЕстьОстатки = Истина;
	КонецЕсли;
	
	КонечныйОстаток = ЗначениеРеквизитаВДереве(ПоследняяВыписка, "Выписки.НомерСтроки.КонечныйОстаток");
	Если ЗначениеЗаполнено(КонечныйОстаток) Тогда
		СтрокаОстатка.КонечныйОстаток = Формат(КонечныйОстаток, "ЧРД=.; ЧГ=");
		ЕстьОстатки = Истина;
	КонецЕсли;
	
	Если ЕстьОстатки Тогда
		СтрокаОстатка.РасчСчет   = ЗначениеРеквизитаВДереве(ПоследняяВыписка, "Выписки.НомерСтроки.НомерСчета");
		СтрокаОстатка.ДатаНачала = ЗначениеРеквизитаВДереве(ПерваяВыписка,    "Выписки.НомерСтроки.НачалоПериода");
		СтрокаОстатка.ДатаКонца  = ЗначениеРеквизитаВДереве(ПоследняяВыписка, "Выписки.НомерСтроки.КонецПериода");
	Иначе
		ДанныеВыписки.Остатки.Удалить(СтрокаОстатка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьДокумент(ДанныеВыписки, Операция, ОписаниеОбменаВФормате1С, Индекс)
	
	Документ = ДанныеВыписки.Документы.Добавить();
	
	СекцияДокумент = ЗначениеРеквизитаВДереве(Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.ВидДокумента");
	Документ.Вид   = СекцияДокумент;
	
	Номер          = ЗначениеРеквизитаВДереве(Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.НомерДокумента");
	Документ.Номер = Номер;
	
	Дата           = ЗначениеРеквизитаВДереве(Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.ДатаДокумента");
	Документ.Дата  = Дата;
	
	Сумма          = ЗначениеРеквизитаВДереве(Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.СуммаДокумента");
	Документ.Сумма = Формат(Сумма, "ЧРД=.; ЧГ=");
	
	ДобавитьПлательщикаИПолучателя(Документ, Операция, ОписаниеОбменаВФормате1С);
	
	ДобавитьНеПустойПараметр(Документ, Операция, "ВидПлатежа",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ВидПлатежа");
	ДобавитьНеПустойПараметр(Документ, Операция, "ВидОплаты",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ВидОперации");
	ДобавитьНеПустойПараметр(Документ, Операция, "Код",
		"Выписки.НомерСтроки.Операции.НомерСтроки.УникальныйИдентификаторПлатежа");
	ДобавитьНеПустойПараметр(Документ, Операция, "КодНазПлатежа",
		"Выписки.НомерСтроки.Операции.НомерСтроки.КодВидаДохода");
	
	ДобавитьНазначениеПлатежа(Документ, Операция);
	
	ДобавитьБюджетныеРеквизиты(Документ, Операция);
	
	ДобавитьНеПустойПараметр(Документ, Операция, "Очередность",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Очередность");
	
	ДобавитьДанныеПлатежногоТребования(Документ, Операция);
	
	Документ.Идентификатор = Формат(Индекс, "ЧН=0; ЧГ=;");
	Индекс = Индекс + 1;
	
КонецПроцедуры

Процедура ДобавитьДанныеПлатежногоТребования(Документ, Операция)
	
	СтруктурированноеНазначениеПлатежа = Документ.СтруктурированноеНазначениеПлатежа;
	
	СрокАкцепта = ЗначениеРеквизитаВДереве(Операция,
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежноеТребование.СрокАкцепта");
	Если ЗначениеЗаполнено(СрокАкцепта) Тогда
		СтруктурированноеНазначениеПлатежа.Вставить("СрокАкцепта", Формат(СрокАкцепта, "ЧДЦ=0; ЧГ="));
	КонецЕсли;
	
	ДобавитьНеПустойПараметр(СтруктурированноеНазначениеПлатежа, Операция, "ДатаОтсылкиДок",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежноеТребование.ДатаОтсылки");
	
	УсловиеОплаты = ЗначениеРеквизитаВДереве(Операция,
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежноеТребование.УсловиеОплаты");
	МассивПодстрок = СтрРазделить(УсловиеОплаты, Символы.ПС + Символы.ВК, Ложь);
	Индекс = 1;
	Для Каждого Строка Из МассивПодстрок Цикл
		СтруктурированноеНазначениеПлатежа.Вставить("УсловиеОплаты" + Индекс, Строка);
		Индекс = Индекс + 1;
		Если Индекс > 3 Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьПлательщикаИПолучателя(Документ, Операция, ОписаниеОбменаВФормате1С)
	
	ДанныеЭД = Новый Структура;
	
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикСчет",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.РасчСчет");
	
	НаправлениеПлатежа = ЗначениеРеквизитаВДереве(
		Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.НаправлениеПлатежа");
	
	ДатаОперации = ЗначениеРеквизитаВДереве(Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.ДатаОперации");
	Если НаправлениеПлатежа = "1" Тогда
		ДанныеЭД.Вставить("ДатаСписано", ДатаОперации);
	КонецЕсли;
	
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "Плательщик",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Наименование",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.НаименованиеМеждународное");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикИНН",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.ИНН");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикКПП",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.КПП");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикРасчСчет",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.РасчСчет");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикБанк1",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Банк.Наименование",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Банк.НаименованиеМеждународное");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикБанк2",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Банк.Город");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПлательщикБИК",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Банк.БИК",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Банк.SWIFT");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция,
		"Выписки.НомерСтроки.Операции.НомерСтроки.Плательщик.Банк.КоррСчет", "ПлательщикКорсчет");
	
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательСчет",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.РасчСчет");
	
	Если НаправлениеПлатежа = "2" Тогда
		ДанныеЭД.Вставить("ДатаПоступило", ДатаОперации);
	КонецЕсли;
	
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "Получатель",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Наименование",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.НаименованиеМеждународное");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательИНН",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.ИНН");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательКПП",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.КПП");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательРасчСчет",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.РасчСчет");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательБанк1",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Банк.Наименование",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Банк.НаименованиеМеждународное");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательБанк2",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Банк.Город");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательБИК",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Банк.БИК",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Банк.SWIFT");
	ДобавитьНеПустойПараметр(ДанныеЭД, Операция, "ПолучательКорсчет",
		"Выписки.НомерСтроки.Операции.НомерСтроки.Получатель.Банк.КоррСчет");
	
	ЗаполнитьЗначенияСвойств(Документ, ДанныеЭД);
	
	Для Каждого Участник Из ОписаниеОбменаВФормате1С.Участники Цикл
		Для Каждого КлючИЗначение Из ДанныеЭД Цикл
			РазделДанных = Участник + "Реквизиты";
			ОтборПравила = Новый Структура;
			ОтборПравила.Вставить("Тег",          ВРег(КлючИЗначение.Ключ));
			ОтборПравила.Вставить("РазделДанных", РазделДанных);
			Правила = ОписаниеОбменаВФормате1С.ОписаниеФайлаОбмена.ПравилаРазмещенияДанныхОДокументах.НайтиСтроки(ОтборПравила);
			Если Правила.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ИмяРеквизита = Правила[0].ИмяЭлемента;
			Если ОписаниеОбменаВФормате1С.РеквизитыУчастника.Найти(ИмяРеквизита) <> Неопределено Тогда
				Документ[РазделДанных].Вставить(ИмяРеквизита, ДанныеЭД[КлючИЗначение.Ключ]);
				Если ИмяРеквизита = "НаименованиеРасширенное" Тогда
					Документ[РазделДанных].Вставить("Наименование", ДанныеЭД[КлючИЗначение.Ключ]);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ОбменСБанкомВФормате1С.ИсправитьОшибкиПлательщикСчет(Документ);
	
КонецПроцедуры

Процедура ДобавитьБюджетныеРеквизиты(Документ, Операция)
	
	РеквизитыПлатежаВБюджет = Документ.РеквизитыПлатежаВБюджет;
	
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "СтатусСоставителя",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.СтатусСоставителя");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ПоказательКБК",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.ПоказательКБК");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ОКАТО",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.ОКТМО");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ПоказательОснования",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.ПоказательОснования");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ПоказательПериода",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.ПоказательПериода");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ПоказательНомера",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.ПоказательНомера");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ПоказательДаты",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.ПоказательДаты");
	ДобавитьНеПустойПараметр(РеквизитыПлатежаВБюджет, Операция, "ПоказательТипа",
		"Выписки.НомерСтроки.Операции.НомерСтроки.ПлатежВБюджет.КодВыплат");
	
КонецПроцедуры

Процедура ДобавитьНазначениеПлатежа(Документ, Операция)
	
	НазначениеПлатежа = ЗначениеРеквизитаВДереве(
		Операция, "Выписки.НомерСтроки.Операции.НомерСтроки.НазначениеПлатежа");
	НазначениеПлатежаОднойСтрокой = СтрЗаменить(СтрЗаменить(НазначениеПлатежа, Символы.ПС, ""), Символы.ВК, "");
	Документ.НазначениеПлатежа = НазначениеПлатежаОднойСтрокой;
	
КонецПроцедуры

Процедура ДобавитьНеПустойПараметр(Коллекция, ДеревоРазбора, ИмяПараметра, Путь, ПутьМеждународный = "")
	
	ЗначениеПараметра = ЗначениеРеквизитаВДереве(ДеревоРазбора, Путь);
	Если Не ЗначениеЗаполнено(ЗначениеПараметра) И Не ПустаяСтрока(ПутьМеждународный) Тогда
		ЗначениеПараметра = ЗначениеРеквизитаВДереве(ДеревоРазбора, ПутьМеждународный);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЗначениеПараметра) Тогда
		Если СтрНачинаетсяС(ВРег(ИмяПараметра), "НАЗНАЧЕНИЕПЛАТЕЖА") Тогда
			ЗначениеПараметра = ЗаменитьПереносыСтроки(ЗначениеПараметра);
		Иначе
			ЗначениеПараметра = СтрЗаменить(ЗначениеПараметра, Символы.ПС, "");
			ЗначениеПараметра = СтрЗаменить(ЗначениеПараметра, Символы.ВК, "");
		КонецЕсли;
		
		Если ТипЗнч(Коллекция) = Тип("Структура") И Не Коллекция.Свойство(ИмяПараметра) Тогда
			Коллекция.Вставить(ИмяПараметра);
		КонецЕсли;
		
		Коллекция[ИмяПараметра] = ЗначениеПараметра;
	КонецЕсли;
	
КонецПроцедуры

Функция ЗначениеРеквизитаВДереве(Дерево, ИмяРеквизита)
	
	Возврат ДеревоЭлектронногоДокументаБЭД.ЗначениеРеквизитаВДереве(Дерево, ИмяРеквизита, Ложь);
	
КонецФункции

// Возвращает формат даты для России.
// Не исправлять, т.к это не является ошибкой.
// 
// Возвращаемое значение:
//  Строка - формат даты для России
//
Функция ФорматДатыРоссия()
	
	Возврат "ДФ=dd.MM.yyyy";
	
КонецФункции

// Возвращает формат временем для России.
// Не исправлять, т.к это не является ошибкой.
// 
// Возвращаемое значение:
//  Строка - формат времени для России
//
Функция ФорматВремениРоссия()
	
	Возврат "HH:mm:ss";
	
КонецФункции

Функция ЗаменитьПереносыСтроки(ТекстРеквизита)
	
	// Заменим совокупность символов переноса строки ПС+ВК на пробел.
	// Совокупность ПС+ВК принята в Windows, но платформой в Windows определяется как один символ ПС.
	// Но в других ОС, скорее всего, эта совокупность будет определяться как 2 разных символа.
	ТекстРеквизита = СтрЗаменить(ТекстРеквизита, Символы.ПС + Символы.ВК, " ");
	// Если предыдущая замена не сработала, то заменим какждый спецсимвол отдельно.
	// В разных ОС будет сформирован (и виден) какой-то один из них.
	ТекстРеквизита = СтроковыеФункцииКлиентСервер.ЗаменитьОдниСимволыДругими(
		Символы.ПС + Символы.ВК,
		ТекстРеквизита,
		"  ");
	
	Возврат ТекстРеквизита;
	
КонецФункции

// Получает выписку банка в коллекцию ОбменСБанкомВФормате1С.НовыйДанныеИзБанка(),
// а также массив ссылок на банковские счета организаций в выписке.
//
// Параметры:
//  СообщениеОбмена - ДокументСсылка.СообщениеОбменСБанками, Массив - содержит ссылку или массив ссылок на выписки банка
//  МассивСчетов - Массив - содержит ссылки на банковские счета организации.
//
Функция ПрочитанныеДанныеСервиса(Знач СообщениеОбмена, МассивСчетов = Неопределено) Экспорт
	
	ДанныеВыписки = ОбменСБанкомВФормате1С.НовыйДанныеИзБанка();
	ПрочитанныеДанныеСервиса = Новый Структура;
	ПрочитанныеДанныеСервиса.Вставить("ДанныеИзБанка", ДанныеВыписки);
	ПрочитанныеДанныеСервиса.Вставить("Протокол", ОбменСБанкомВФормате1С.НовыйПротоколЧтенияФайла());
	
	Если ТипЗнч(СообщениеОбмена) = Тип("ДокументСсылка.СообщениеОбменСБанками") Тогда
		МассивСообщений = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(СообщениеОбмена);
	Иначе
		МассивСообщений = СообщениеОбмена;
	КонецЕсли;
	
	ДеревоДанных = Неопределено;
	ОбменСБанками.ПолучитьДанныеВыпискиБанкаДеревоЗначений(МассивСообщений, ДеревоДанных);
	
	Если ДеревоДанных = Неопределено Тогда
		Возврат ПрочитанныеДанныеСервиса;
	КонецЕсли;
	
	МассивСчетов = Новый Массив;
	
	СтрокаТаблицыВыписок = ДеревоДанных.Строки.Найти("Выписки", "ПолныйПуть");
	
	Организация = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(МассивСообщений.Получить(0), "Организация");
	ЗаполнитьШапкуВыписки(Организация, ПрочитанныеДанныеСервиса.ДанныеИзБанка, СтрокаТаблицыВыписок, МассивСчетов);
	
	// Реквизиты плательщика и получателя
	ОписаниеОбменаВФормате1С = Новый Структура("Участники, РеквизитыУчастника, ОписаниеФайлаОбмена");
	ОписаниеОбменаВФормате1С.Участники           = ОбменСБанкомВФормате1С.НовыйУчастники();
	ОписаниеОбменаВФормате1С.РеквизитыУчастника  = ОбменСБанкомВФормате1С.ЭлементыРеквизитовУчастника();
	ОписаниеОбменаВФормате1С.ОписаниеФайлаОбмена = ОбменСБанкомВФормате1С.ОписаниеФайлаОбмена();
	
	Индекс = 0;
	Для Каждого Выписка Из СтрокаТаблицыВыписок.Строки Цикл
		СтрокаОперацияВыписки = Выписка.Строки.Найти("Выписки.НомерСтроки.Операции", "ПолныйПуть");
		
		Если СтрокаОперацияВыписки.Значение = Неопределено Или СтрокаОперацияВыписки.Значение = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Для Каждого Операция Из СтрокаОперацияВыписки.Строки Цикл
			ДобавитьДокумент(ПрочитанныеДанныеСервиса.ДанныеИзБанка, Операция, ОписаниеОбменаВФормате1С, Индекс);
		КонецЦикла;
	КонецЦикла;
	
	ОбменСБанкомВФормате1С.ЗаписатьВПротокол(ПрочитанныеДанныеСервиса.Протокол, Истина, "ЭлектроннаяВыписка");
	
	Возврат ПрочитанныеДанныеСервиса;
	
КонецФункции

#КонецОбласти

#КонецОбласти
