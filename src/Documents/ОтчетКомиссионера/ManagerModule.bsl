#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// Параметры:
//   Ограничение - см. УправлениеДоступомПереопределяемый.ПриЗаполненииОграниченияДоступа.Ограничение.
//
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)
	|	И ЗначениеРазрешено(Контрагент)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

// Определяет список команд заполнения.
//
// Параметры:
//   КомандыЗаполнения - ТаблицаЗначений - Таблица с командами заполнения. Для изменения.
//       См. описание 1 параметра процедуры ЗаполнениеОбъектовПереопределяемый.ПередДобавлениемКомандЗаполнения().
//   Параметры - Структура - Вспомогательные параметры. Для чтения.
//       См. описание 2 параметра процедуры ЗаполнениеОбъектовПереопределяемый.ПередДобавлениемКомандЗаполнения().
//
Процедура ДобавитьКомандыЗаполнения(КомандыЗаполнения, Параметры) Экспорт
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

////////////////////////////////////////////////////////////////////////////////
// ПРОВОДКИ

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаУправленческий(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда 
		Запрос.Текст = ТекстЗапросаТаблицаУправленческий(); 
	Иначе
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	1 КАК Порядок,
	|	ТаблицаУправленческий.НомерСтроки КАК НомерСтроки,
	|	ТаблицаУправленческий.Период КАК Период,
	|	ТаблицаУправленческий.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический) КАК СценарийПланирования,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем КАК СчетДт,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВалютаДт,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаВалДт,
	|	ТаблицаУправленческий.СчетУчетаПродажи КАК СчетКт,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаКт,
	|	0 КАК СуммаВалКт,
	|	ТаблицаУправленческий.Сумма КАК Сумма,
	|	&ОтражениеВыручки КАК Содержание
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	1,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный
	|			ТОГДА ТаблицаДокумента.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный
	|			ТОГДА ТаблицаДокумента.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный
	|			ТОГДА ТаблицаДокумента.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный
	|			ТОГДА ТаблицаДокумента.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаДокумента.Сумма,
	|	&ЗачетПредоплаты
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаДокумента.Период КАК Период,
	|		ТаблицаДокумента.Организация КАК Организация,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателя КАК СчетУчетаАвансовПокупателя,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный КАК СчетУчетаАвансовПокупателяВалютный,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный КАК СчетУчетаРасчетовСПокупателемВалютный,
	|		ТаблицаДокумента.ВалютаРасчетов КАК ВалютаРасчетов,
	|		СУММА(ТаблицаДокумента.СуммаВал) КАК СуммаВал,
	|		СУММА(ТаблицаДокумента.Сумма) КАК Сумма
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ТаблицаДокумента.Период КАК Период,
	|			ТаблицаДокумента.Организация КАК Организация,
	|			ТаблицаДокумента.СчетУчетаАвансовПокупателя КАК СчетУчетаАвансовПокупателя,
	|			ТаблицаДокумента.СчетУчетаАвансовПокупателя.Валютный КАК СчетУчетаАвансовПокупателяВалютный,
	|			ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|			ТаблицаДокумента.СчетУчетаРасчетовСПокупателем.Валютный КАК СчетУчетаРасчетовСПокупателемВалютный,
	|			ТаблицаДокумента.ВалютаРасчетов КАК ВалютаРасчетов,
	|			ТаблицаДокумента.СуммаВал КАК СуммаВал,
	|			ТаблицаДокумента.Сумма КАК Сумма
	|		ИЗ
	|			ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ТаблицаДокумента.Дата,
	|			ТаблицаДокумента.Организация,
	|			ТаблицаДокумента.Контрагент.СчетУчетаАвансовПокупателя,
	|			ТаблицаДокумента.Контрагент.СчетУчетаАвансовПокупателя.Валютный,
	|			ТаблицаДокумента.Контрагент.СчетУчетаРасчетовСПокупателем,
	|			ТаблицаДокумента.Контрагент.СчетУчетаРасчетовСПокупателем.Валютный,
	|			ТаблицаДокумента.Валюта,
	|			0,
	|			ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)) КАК ТаблицаДокумента
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаДокумента.Период,
	|		ТаблицаДокумента.Организация,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный,
	|		ТаблицаДокумента.ВалютаРасчетов
	|	
	|	ИМЕЮЩИЕ
	|		(СУММА(ТаблицаДокумента.Сумма) >= 0.005
	|			ИЛИ СУММА(ТаблицаДокумента.Сумма) <= -0.005
	|			ИЛИ СУММА(ТаблицаДокумента.СуммаВал) >= 0.005
	|			ИЛИ СУММА(ТаблицаДокумента.СуммаВал) <= -0.005)) КАК ТаблицаДокумента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	1,
	|	ТаблицаУправленческий.Дата,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|			ТОГДА ТаблицаУправленческий.СчетУчета
	|		ИНАЧЕ &ОтрицательнаяКурсоваяРазницаСчетУчета
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|				И ТаблицаУправленческий.СчетУчетаВалютный
	|			ТОГДА ТаблицаУправленческий.Валюта
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	0,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|			ТОГДА &ПоложительнаяКурсоваяРазницаСчетУчета
	|		ИНАЧЕ ТаблицаУправленческий.СчетУчета
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы < 0
	|				И ТаблицаУправленческий.СчетУчетаВалютный
	|			ТОГДА ТаблицаУправленческий.Валюта
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	0,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|			ТОГДА ТаблицаУправленческий.СуммаКурсовойРазницы
	|		ИНАЧЕ -ТаблицаУправленческий.СуммаКурсовойРазницы
	|	КОНЕЦ,
	|	&КурсоваяРазница
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Дата КАК Дата,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Организация КАК Организация,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчета КАК СчетУчета,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчетаВалютный КАК СчетУчетаВалютный,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Валюта КАК Валюта,
	|		СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) КАК СуммаКурсовойРазницы
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ТаблицаДокумента.Дата КАК Дата,
	|			ТаблицаДокумента.Организация КАК Организация,
	|			ТаблицаДокумента.СчетУчета КАК СчетУчета,
	|			ТаблицаДокумента.СчетУчета.Валютный КАК СчетУчетаВалютный,
	|			ТаблицаДокумента.Валюта КАК Валюта,
	|			ТаблицаДокумента.СуммаКурсовойРазницы КАК СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг)
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ТаблицаДокумента.Дата,
	|			ТаблицаДокумента.Организация,
	|			ТаблицаДокумента.СчетУчета,
	|			ТаблицаДокумента.СчетУчета.Валютный,
	|			ТаблицаДокумента.Валюта,
	|			ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)) КАК ТаблицаКурсовыхРазницРасчетыСПокупателями
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Дата,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Организация,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчета,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчетаВалютный,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Валюта
	|	
	|	ИМЕЮЩИЕ
	|		(СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) >= 0.005
	|			ИЛИ СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) <= -0.005)) КАК ТаблицаУправленческий
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	4,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаЗатрат,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаЗатрат.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаЗатрат.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаВознаграждения,
	|	&ПрочиеРасходы
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	НЕ ТаблицаУправленческий.ЭтоВозврат
	|	И НЕ ТаблицаУправленческий.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.СуммаВознаграждения = 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	4,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаВознаграждения,
	|	&ПрочиеРасходы
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	НЕ ТаблицаУправленческий.ЭтоВозврат
	|	И ТаблицаУправленческий.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.СуммаВознаграждения = 0
	|	И ЛОЖЬ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	5,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаЗатрат,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаЗатрат.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаЗатрат.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаВознаграждения,
	|	&ПрочиеРасходы
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	ТаблицаУправленческий.ЭтоВозврат
	|	И ТаблицаУправленческий.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаУправленческий.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.СуммаВознаграждения = 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	5,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаВознаграждения,
	|	&ПрочиеРасходы
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	ТаблицаУправленческий.ЭтоВозврат
	|	И ТаблицаУправленческий.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И ТаблицаУправленческий.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.СуммаВознаграждения = 0
	|	И ЛОЖЬ
	|
	|УПОРЯДОЧИТЬ ПО
	|	Порядок,
	|	НомерСтроки";
	
	КонецЕсли;
	
	Запрос.УстановитьПараметр("КурсоваяРазница", СодержанияПроводок.КурсоваяРазница());
	Запрос.УстановитьПараметр("ЗачетПредоплаты", СодержанияПроводок.ЗачетПредоплаты());
	Запрос.УстановитьПараметр("ОтражениеВыручки", СодержанияПроводок.Выручка());
	Запрос.УстановитьПараметр("ПрочиеРасходы", СодержанияПроводок.ОтражениеЗатрат());
	Запрос.УстановитьПараметр("ОтражениеНДС", СодержанияПроводок.ОтражениеНДСПродажи());
	Запрос.УстановитьПараметр("ОтражениеНДСПриобретения", СодержанияПроводок.ОтражениеНДСПриобретения());
	Запрос.УстановитьПараметр("СчетУчетаНДСКУплате", Справочники.ВидыНалогов.СчетУчетаНДСКУплате());
	Запрос.УстановитьПараметр("ПоложительнаяКурсоваяРазницаСчетУчета", ПланыСчетов.Управленческий.ПрочиеДоходы);
	Запрос.УстановитьПараметр("ОтрицательнаяКурсоваяРазницаСчетУчета", ПланыСчетов.Управленческий.ПрочиеРасходы);
	Запрос.УстановитьПараметр("ИспользоватьНовуюСхемуДвижений", СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяПроводка = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаУправленческий.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяПроводка, Выборка);
	КонецЦикла;
	
КонецПроцедуры // СформироватьТаблицаУправленческий()

Процедура СформироватьТаблицаЗапасыСтараяВерсия(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	ЭтоОперацияВозврат = Ложь;
	
	Если СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионера Тогда
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОПродажахЗапасы();
		
		ТаблицаДокументовОснования = Новый СписокЗначений;
		ТаблицаДокументовОснования.Добавить(ДокументСсылкаОтчетКомиссионера);
		СебестоимостьПоОстаткам = Истина;
		
	Иначе
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОВозвратахЗапасы();
		Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		
		ЗапросОснования = Новый Запрос;
		ЗапросОснования.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
		
		ЗапросОснования.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТаблицаПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера
		|ИЗ
		|	ВременнаяТаблицаПокупатели КАК ТаблицаПокупатели
		|ГДЕ
		|	НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|	И НЕ ТаблицаПокупатели.ОтчетКомиссионера = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаПокупатели.ОтчетКомиссионера";
		
		ЗапросОснования.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		
		ТаблицаДокументовОснования = ЗапросОснования.Выполнить().Выгрузить();
		ЭтоОперацияВозврат = Истина;
		
		СебестоимостьПоОстаткам = ?(ДокументСсылкаОтчетКомиссионера.Покупатели.Найти(Документы.ОтчетКомиссионера.ПустаяСсылка()) = Неопределено, Ложь, Истина);
		
	КонецЕсли;
	
	РезервированиеЗапасов = ПолучитьФункциональнуюОпцию("РезервированиеЗапасов");
	Запрос.УстановитьПараметр("РезервированиеЗапасов", РезервированиеЗапасов);
	
	Запрос.УстановитьПараметр("ОтчетОтКомиссионера", НСтр("ru = 'Отчет комиссионера'"));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаЗапасы", РезультатЗапроса.Выгрузить());
	
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	// Установка исключительной блокировки контролируемых остатков запасов.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаЗапасы.Организация КАК Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета КАК СчетУчета,
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ТаблицаЗапасы.ЗаказПокупателя КАК ЗаказПокупателя
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПокупателя";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.Запасы");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
	
	Для каждого КолонкаРезультатЗапроса Из РезультатЗапроса.Колонки Цикл
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных(КолонкаРезультатЗапроса.Имя, КолонкаРезультатЗапроса.Имя);
	КонецЦикла;
	Блокировка.Заблокировать();
	
	// Получение остатков запасов по стоимости.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Запасы.Период КАК ДатаОстатка,
	|	Запасы.Регистратор КАК Регистратор,
	|	Запасы.Организация КАК Организация,
	|	Запасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	Запасы.СчетУчета КАК СчетУчета,
	|	Запасы.Номенклатура КАК Номенклатура,
	|	Запасы.Характеристика КАК Характеристика,
	|	Запасы.Партия КАК Партия,
	|	Запасы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	Запасы.Количество КАК КоличествоОстаток,
	|	Запасы.СуммаБезНДС КАК СуммаБезНДСОстаток,
	|	Запасы.Сумма КАК СуммаОстаток
	|ПОМЕСТИТЬ ДвиженияПоОснованиям
	|ИЗ
	|	РегистрНакопления.Запасы КАК Запасы
	|ГДЕ
	|	Запасы.Регистратор В(&ТаблицаДокументовОснования)
	|	И ВЫБОР
	|			КОГДА &ЭтоОперацияВозврат
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&ПериодКонтроля КАК ДатаОстатка,
	|	ЗапасыОстатки.Организация КАК Организация,
	|	ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ЗапасыОстатки.СчетУчета КАК СчетУчета,
	|	ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыОстатки.Партия КАК Партия,
	|	ЗапасыОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК КоличествоОстаток,
	|	СУММА(ЗапасыОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДСОстаток,
	|	СУММА(ЗапасыОстатки.СуммаОстаток) КАК СуммаОстаток,
	|	&ТекущийДокумент КАК Регистратор
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЗапасыОстатки.Организация КАК Организация,
	|		ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|		ЗапасыОстатки.СчетУчета КАК СчетУчета,
	|		ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|		ЗапасыОстатки.Характеристика КАК Характеристика,
	|		ЗапасыОстатки.Партия КАК Партия,
	|		ЗапасыОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|		СУММА(ЗапасыОстатки.КоличествоОстаток) КАК КоличествоОстаток,
	|		СУММА(ЗапасыОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДСОстаток,
	|		СУММА(ЗапасыОстатки.СуммаОстаток) КАК СуммаОстаток
	|	ИЗ
	|		РегистрНакопления.Запасы.Остатки(
	|				&МоментКонтроля,
	|				&СебестоимостьПоОстаткам
	|					И  ВЫБОР
	|						КОГДА &РезервированиеЗапасов
	|							ТОГДА (Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя) В
	|									(ВЫБРАТЬ
	|										ТаблицаЗапасы.Организация,
	|										ТаблицаЗапасы.СтруктурнаяЕдиница,
	|										ТаблицаЗапасы.СчетУчета,
	|										ТаблицаЗапасы.Номенклатура,
	|										ТаблицаЗапасы.Характеристика,
	|										ТаблицаЗапасы.Партия,
	|										ТаблицаЗапасы.ЗаказПокупателя
	|									ИЗ
	|										ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы)
	|						ИНАЧЕ (Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия) В
	|								(ВЫБРАТЬ
	|									ТаблицаЗапасы.Организация,
	|									ТаблицаЗапасы.СтруктурнаяЕдиница,
	|									ТаблицаЗапасы.СчетУчета,
	|									ТаблицаЗапасы.Номенклатура,
	|									ТаблицаЗапасы.Характеристика,
	|									ТаблицаЗапасы.Партия
	|								ИЗ
	|									ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы)
	|					КОНЕЦ) КАК ЗапасыОстатки
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ЗапасыОстатки.Организация,
	|		ЗапасыОстатки.СтруктурнаяЕдиница,
	|		ЗапасыОстатки.СчетУчета,
	|		ЗапасыОстатки.Номенклатура,
	|		ЗапасыОстатки.Характеристика,
	|		ЗапасыОстатки.Партия,
	|		ЗапасыОстатки.ЗаказПокупателя
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДвиженияДокументаЗапасы.Организация,
	|		ДвиженияДокументаЗапасы.СтруктурнаяЕдиница,
	|		ДвиженияДокументаЗапасы.СчетУчета,
	|		ДвиженияДокументаЗапасы.Номенклатура,
	|		ДвиженияДокументаЗапасы.Характеристика,
	|		ДвиженияДокументаЗапасы.Партия,
	|		ДвиженияДокументаЗапасы.ЗаказПокупателя,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ДвиженияДокументаЗапасы.СуммаБезНДС
	|			ИНАЧЕ -ДвиженияДокументаЗапасы.СуммаБезНДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Сумма, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Сумма, 0)
	|		КОНЕЦ
	|	ИЗ
	|		РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|	ГДЕ
	|		ДвиженияДокументаЗапасы.Регистратор = &ТекущийДокумент
	|		И ВЫБОР
	|				КОГДА &СебестоимостьПоОстаткам
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ) КАК ЗапасыОстатки
	|ГДЕ
	|	ВЫБОР
	|			КОГДА &СебестоимостьПоОстаткам
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстатки.Организация,
	|	ЗапасыОстатки.СтруктурнаяЕдиница,
	|	ЗапасыОстатки.СчетУчета,
	|	ЗапасыОстатки.Номенклатура,
	|	ЗапасыОстатки.Характеристика,
	|	ЗапасыОстатки.Партия,
	|	ЗапасыОстатки.ЗаказПокупателя
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДвиженияПоОснованиям.ДатаОстатка,
	|	ДвиженияПоОснованиям.Организация,
	|	ДвиженияПоОснованиям.СтруктурнаяЕдиница,
	|	ДвиженияПоОснованиям.СчетУчета,
	|	ДвиженияПоОснованиям.Номенклатура,
	|	ДвиженияПоОснованиям.Характеристика,
	|	ДвиженияПоОснованиям.Партия,
	|	ДвиженияПоОснованиям.ЗаказПокупателя,
	|	ДвиженияПоОснованиям.КоличествоОстаток,
	|	ДвиженияПоОснованиям.СуммаБезНДСОстаток,
	|	ДвиженияПоОснованиям.СуммаОстаток,
	|	ДвиженияПоОснованиям.Регистратор
	|ИЗ
	|	ДвиженияПоОснованиям КАК ДвиженияПоОснованиям";
	
	ПериодКонтроля = СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени.Дата;
	Запрос.УстановитьПараметр("РезервированиеЗапасов", ПолучитьФункциональнуюОпцию("РезервированиеЗапасов"));
	Запрос.УстановитьПараметр("ПериодКонтроля", ПериодКонтроля);
	Запрос.УстановитьПараметр("ТаблицаДокументовОснования", ТаблицаДокументовОснования);
	Запрос.УстановитьПараметр("СебестоимостьПоОстаткам", СебестоимостьПоОстаткам);
	Запрос.УстановитьПараметр("ЭтоОперацияВозврат", ЭтоОперацияВозврат);
	Запрос.УстановитьПараметр("ТекущийДокумент", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("МоментКонтроля", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ТаблицаЗапасыОстатки = РезультатЗапроса.Выгрузить();
	ТаблицаЗапасыОстатки.Индексы.Добавить("Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя, Регистратор");
	
	ВременнаяТаблицаЗапасы = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы.СкопироватьКолонки();
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений Тогда
		ЗначениеКолонкиСтруктурнаяЕдиница = ВременнаяТаблицаЗапасы.ВыгрузитьКолонку("СтруктурнаяЕдиница");
		ВременнаяТаблицаЗапасы.Колонки.Удалить("СтруктурнаяЕдиница");
		
		МассивТипов = Новый Массив;
		МассивТипов.Добавить(Тип("Null"));
		МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
		МассивТипов.Добавить(Тип("СправочникСсылка.СтруктурныеЕдиницы"));
		ОписаниеТиповКолонки = Новый ОписаниеТипов(МассивТипов);
		
		НоваяКолонка = ВременнаяТаблицаЗапасы.Колонки.Добавить("СтруктурнаяЕдиница", ОписаниеТиповКолонки);
		
		ВременнаяТаблицаЗапасы.ЗагрузитьКолонку(ЗначениеКолонкиСтруктурнаяЕдиница, "СтруктурнаяЕдиница");
	КонецЕсли;

	Для н = 0 По СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы.Количество() - 1 Цикл
		
		СтрокаТаблицаЗапасы = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы[н];
		
		СтруктураДляПоиска = Новый Структура;
		СтруктураДляПоиска.Вставить("Регистратор", СтрокаТаблицаЗапасы.Документ);
		СтруктураДляПоиска.Вставить("Организация", СтрокаТаблицаЗапасы.Организация);
		СтруктураДляПоиска.Вставить("СтруктурнаяЕдиница", СтрокаТаблицаЗапасы.СтруктурнаяЕдиница);
		СтруктураДляПоиска.Вставить("СчетУчета", СтрокаТаблицаЗапасы.СчетУчета);
		СтруктураДляПоиска.Вставить("Номенклатура", СтрокаТаблицаЗапасы.Номенклатура);
		СтруктураДляПоиска.Вставить("Характеристика", СтрокаТаблицаЗапасы.Характеристика);
		СтруктураДляПоиска.Вставить("Партия", СтрокаТаблицаЗапасы.Партия);
		СтруктураДляПоиска.Вставить("ЗаказПокупателя", СтрокаТаблицаЗапасы.ЗаказПокупателя);
		
		КоличествоТребуется = ?(ЭтоОперацияВозврат, -СтрокаТаблицаЗапасы.Количество, СтрокаТаблицаЗапасы.Количество);
		
		Если КоличествоТребуется > 0  Тогда
			
			МесяцПродажиИВозвратаСовпадает = Истина;
			
			Если ЭтоОперацияВозврат И СтрокаТаблицаЗапасы.РучнаяСебестоимость > 0 Тогда
				
				// Себестоимость указана явно в документе
				СуммаКСписанию = СтрокаТаблицаЗапасы.РучнаяСебестоимость;
				
			Иначе
				
				МассивСтрокОстатков = ТаблицаЗапасыОстатки.НайтиСтроки(СтруктураДляПоиска);
				
				КоличествоОстаток = 0;
				СуммаОстаток = 0;
				СуммаБезНДСОстаток = 0;
				
				Если МассивСтрокОстатков.Количество() > 0 Тогда
					КоличествоОстаток = МассивСтрокОстатков[0].КоличествоОстаток;
					СуммаОстаток = МассивСтрокОстатков[0].СуммаОстаток;
					СуммаБезНДСОстаток = МассивСтрокОстатков[0].СуммаБезНДСОстаток;
				КонецЕсли;
				
				Если ЭтоОперацияВозврат И МассивСтрокОстатков.Количество() > 0 Тогда
					МесяцПродажиИВозвратаСовпадает = (НачалоМесяца(ПериодКонтроля) = НачалоМесяца(МассивСтрокОстатков[0].ДатаОстатка));
				КонецЕсли; 
				
				Если КоличествоОстаток > 0 И КоличествоОстаток > КоличествоТребуется Тогда
					
					СуммаКСписанию = Окр(СуммаОстаток * КоличествоТребуется / КоличествоОстаток , 2, 1);
					СуммаБезНДСКСписанию = Окр(СуммаБезНДСОстаток * КоличествоТребуется / КоличествоОстаток , 2, 1);
					
					МассивСтрокОстатков[0].КоличествоОстаток = МассивСтрокОстатков[0].КоличествоОстаток - КоличествоТребуется;
					МассивСтрокОстатков[0].СуммаОстаток = МассивСтрокОстатков[0].СуммаОстаток - СуммаКСписанию;
					МассивСтрокОстатков[0].СуммаБезНДСОстаток = МассивСтрокОстатков[0].СуммаБезНДСОстаток - СуммаБезНДСКСписанию;
					
				ИначеЕсли КоличествоОстаток = КоличествоТребуется Тогда
					
					СуммаКСписанию = СуммаОстаток;
					СуммаБезНДСКСписанию = СуммаБезНДСОстаток;
					
					МассивСтрокОстатков[0].КоличествоОстаток = 0;
					МассивСтрокОстатков[0].СуммаОстаток = 0;
					МассивСтрокОстатков[0].СуммаБезНДСОстаток = 0;
					
				Иначе
					СуммаКСписанию = 0;
					СуммаБезНДСКСписанию = 0;
				КонецЕсли;
				
			КонецЕсли;
			
			// Добавим строку по заказу.
			СтрокаТаблицыРасход = ВременнаяТаблицаЗапасы.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицыРасход, СтрокаТаблицаЗапасы);
			
			СтрокаТаблицыРасход.Сумма = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
			СтрокаТаблицыРасход.СуммаБезНДС = ?(ЭтоОперацияВозврат, -СуммаБезНДСКСписанию, СуммаБезНДСКСписанию);
			СтрокаТаблицыРасход.Количество = ?(ЭтоОперацияВозврат, -КоличествоТребуется, КоличествоТребуется);
			
			Если ЭтоОперацияВозврат И НЕ МесяцПродажиИВозвратаСовпадает Тогда
				СтрокаТаблицыРасход.ФиксированнаяСтоимость = Истина;
			КонецЕсли; 
			
			Если Окр(СуммаКСписанию, 2, 1) <> 0
				Или Окр(СуммаБезНДСКСписанию, 2, 1) <> 0 Тогда
				
				// Сформируем проводки.
				СтрокаТаблицаУправленческий = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаУправленческий.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицаУправленческий, СтрокаТаблицаЗапасы);
				СтрокаТаблицаУправленческий.Содержание = ?(ЭтоОперацияВозврат, НСтр("ru = 'Сторнирование себестоимости'"), НСтр("ru='Себестоимость продажи'"));
				СтрокаТаблицаУправленческий.Сумма = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				
				Если СтрокаТаблицаЗапасы.УдержатьКомиссионноеВознаграждение Тогда
					
					СтрокаТаблицаУправленческий = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаУправленческий.Добавить();
					ЗаполнитьЗначенияСвойств(СтрокаТаблицаУправленческий, СтрокаТаблицаЗапасы);
					СтрокаТаблицаУправленческий.СчетКт = ПланыСчетов.Управленческий.РасчетыСПокупателями;
					СтрокаТаблицаУправленческий.Содержание = ?(ЭтоОперацияВозврат, НСтр("ru = 'Сторнирование комиссионное вознаграждение'"), НСтр("ru='Комиссионное вознаграждение'"));
					СтрокаТаблицаУправленческий.Сумма = СтрокаТаблицаЗапасы.СуммаВознаграждения;
					
					Если СтрокаТаблицаУправленческий.СчетКт.Валютный Тогда
						СтрокаТаблицаУправленческий.СуммаВалКт = СтрокаТаблицаЗапасы.СуммаВознаграждения;
						СтрокаТаблицаУправленческий.ВалютаКт = ДокументСсылкаОтчетКомиссионера.Договор.ВалютаРасчетов;
					КонецЕсли;
					
				КонецЕсли;
				
				// Продвигаем себестоимость продаж.
				СтрокаТаблицаПродажи = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПродажи.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицаПродажи, СтрокаТаблицаЗапасы);
				
				СтрокаТаблицаПродажи.Количество = 0;
				СтрокаТаблицаПродажи.Сумма = 0;
				СтрокаТаблицаПродажи.СуммаНДС = 0;
				СтрокаТаблицаПродажи.Себестоимость = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				СтрокаТаблицаПродажи.СебестоимостьБезНДС = ?(ЭтоОперацияВозврат, -СуммаБезНДСКСписанию, СуммаБезНДСКСписанию); 
				
				Если СтрокаТаблицаЗапасы.УдержатьКомиссионноеВознаграждение Тогда
					
					// Нужно увеличить себестоимость продажи на сумму вознаграждения.
					НоваяСтрока	= СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПродажи.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицаЗапасы);
					
					НоваяСтрока.Количество		= 0;
					НоваяСтрока.Сумма			= 0;
					НоваяСтрока.СуммаНДС		= 0;
					НоваяСтрока.Себестоимость	= СтрокаТаблицаЗапасы.СуммаВознаграждения;
					
				КонецЕсли;
				
				// Продвигаем доходы и расходы.
				СтрокаДоходыИРасходы = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаДоходыИРасходы.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаДоходыИРасходы, СтрокаТаблицаЗапасы);
				
				СтрокаДоходыИРасходы.СтруктурнаяЕдиница = СтрокаТаблицаЗапасы.ПодразделениеПродажи;
				СтрокаДоходыИРасходы.СчетУчета = СтрокаТаблицаЗапасы.СчетУчетаСебестоимость;
				СтрокаДоходыИРасходы.СуммаДоходов = 0;
				СтрокаДоходыИРасходы.СуммаРасходов = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				СтрокаДоходыИРасходы.Сумма = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				СтрокаДоходыИРасходы.СодержаниеПроводки = ?(ЭтоОперацияВозврат, НСтр("ru = 'Сторнирование расходов'"), НСтр("ru='Отражение расходов'"));
				
				Если ЗначениеЗаполнено(ДокументСсылкаОтчетКомиссионера.Проект) Тогда
					СтрокаДоходыИРасходы.Проект = ДокументСсылкаОтчетКомиссионера.Проект;
				КонецЕсли;
				
				Если СтрокаТаблицаЗапасы.УдержатьКомиссионноеВознаграждение Тогда
					
					// Нужно увеличить себестоимость продажи на сумму вознаграждения.
					НоваяСтрока= СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаДоходыИРасходы.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицаЗапасы);
					
					НоваяСтрока.СтруктурнаяЕдиница = СтрокаТаблицаЗапасы.ПодразделениеПродажи;
					НоваяСтрока.СчетУчета = СтрокаТаблицаЗапасы.СчетУчетаСебестоимость;
					НоваяСтрока.СуммаДоходов = 0;
					НоваяСтрока.СуммаРасходов = СтрокаТаблицаЗапасы.СуммаВознаграждения;
					НоваяСтрока.Сумма = СтрокаТаблицаЗапасы.СуммаВознаграждения;
					НоваяСтрока.СодержаниеПроводки = ?(ЭтоОперацияВозврат, НСтр("ru = 'Сторнирование расходов'"), НСтр("ru='Отражение расходов'"));
					
					Если ЗначениеЗаполнено(ДокументСсылкаОтчетКомиссионера.Проект) Тогда
						НоваяСтрока.Проект = ДокументСсылкаОтчетКомиссионера.Проект;
					КонецЕсли;
				
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
			
	КонецЦикла;
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы = ВременнаяТаблицаЗапасы;
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений Тогда
		СформироватьТаблицаЗапасыРасходы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	КонецЕсли;
	
КонецПроцедуры // СформироватьТаблицаЗапасы()

Процедура СформироватьТаблицаЗапасы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, ЭтоОперацияВозврат = Ложь)
	
	ИмяТаблицаЗапасы = ?(ЭтоОперацияВозврат, "ТаблицаЗапасыВозвраты", "ТаблицаЗапасы");
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Если Не ЭтоОперацияВозврат Тогда
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОПродажахЗапасы();
		
		ТаблицаДокументовОснования = Новый СписокЗначений;
		ТаблицаДокументовОснования.Добавить(ДокументСсылкаОтчетКомиссионера);
		СебестоимостьПоОстаткам = Истина;
		
	Иначе
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОВозвратахЗапасы("ВременнаяТаблицаЗапасыВозвраты");
		Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		
		ЗапросОснования = Новый Запрос;
		ЗапросОснования.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
		
		ЗапросОснования.Текст =
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ТаблицаПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера
		|ИЗ
		|	ВременнаяТаблицаПокупателиВозвраты КАК ТаблицаПокупатели
		|ГДЕ
		|	НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|	И НЕ ТаблицаПокупатели.ОтчетКомиссионера = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаПокупатели.ОтчетКомиссионера";
		
		ЗапросОснования.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		
		ТаблицаДокументовОснования = ЗапросОснования.Выполнить().Выгрузить();
		ЭтоОперацияВозврат = Истина;
		
		СебестоимостьПоОстаткам = ?(ДокументСсылкаОтчетКомиссионера.Покупатели.Найти(Документы.ОтчетКомиссионера.ПустаяСсылка()) = Неопределено, Ложь, Истина);
		
	КонецЕсли;
	
	РезервированиеЗапасов = ПолучитьФункциональнуюОпцию("РезервированиеЗапасов");
	Запрос.УстановитьПараметр("РезервированиеЗапасов", РезервированиеЗапасов);
	
	Запрос.УстановитьПараметр("ОтчетОтКомиссионера", СодержанияПроводок.ОтчетОтКомиссионера());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить(ИмяТаблицаЗапасы, РезультатЗапроса.Выгрузить());
	
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	// Установка исключительной блокировки контролируемых остатков запасов.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаЗапасы.Организация КАК Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета КАК СчетУчета,
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ТаблицаЗапасы.ЗаказПокупателя КАК ЗаказПокупателя
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПокупателя";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.Запасы");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
	
	Для каждого КолонкаРезультатЗапроса Из РезультатЗапроса.Колонки Цикл
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных(КолонкаРезультатЗапроса.Имя, КолонкаРезультатЗапроса.Имя);
	КонецЦикла;
	Блокировка.Заблокировать();
	
	// Получение остатков запасов по стоимости.
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Запасы.Период КАК ДатаОстатка,
	|	Запасы.Регистратор КАК Регистратор,
	|	Запасы.Организация КАК Организация,
	|	Запасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	Запасы.СчетУчета КАК СчетУчета,
	|	Запасы.Номенклатура КАК Номенклатура,
	|	Запасы.Характеристика КАК Характеристика,
	|	Запасы.Партия КАК Партия,
	|	Запасы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	Запасы.Количество КАК КоличествоОстаток,
	|	Запасы.СуммаБезНДС КАК СуммаБезНДСОстаток,
	|	Запасы.Сумма КАК СуммаОстаток
	|ПОМЕСТИТЬ ДвиженияПоОснованиям
	|ИЗ
	|	РегистрНакопления.Запасы КАК Запасы
	|ГДЕ
	|	Запасы.Регистратор В(&ТаблицаДокументовОснования)
	|	И ВЫБОР
	|			КОГДА &ЭтоОперацияВозврат
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&ПериодКонтроля КАК ДатаОстатка,
	|	ЗапасыОстатки.Организация КАК Организация,
	|	ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ЗапасыОстатки.СчетУчета КАК СчетУчета,
	|	ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыОстатки.Партия КАК Партия,
	|	ЗапасыОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|	СУММА(ЗапасыОстатки.КоличествоОстаток) КАК КоличествоОстаток,
	|	СУММА(ЗапасыОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДСОстаток,
	|	СУММА(ЗапасыОстатки.СуммаОстаток) КАК СуммаОстаток,
	|	&ТекущийДокумент КАК Регистратор
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЗапасыОстатки.Организация КАК Организация,
	|		ЗапасыОстатки.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|		ЗапасыОстатки.СчетУчета КАК СчетУчета,
	|		ЗапасыОстатки.Номенклатура КАК Номенклатура,
	|		ЗапасыОстатки.Характеристика КАК Характеристика,
	|		ЗапасыОстатки.Партия КАК Партия,
	|		ЗапасыОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|		СУММА(ЗапасыОстатки.КоличествоОстаток) КАК КоличествоОстаток,
	|		СУММА(ЗапасыОстатки.СуммаБезНДСОстаток) КАК СуммаБезНДСОстаток,
	|		СУММА(ЗапасыОстатки.СуммаОстаток) КАК СуммаОстаток
	|	ИЗ
	|		РегистрНакопления.Запасы.Остатки(
	|				&МоментКонтроля,
	|				&СебестоимостьПоОстаткам
	|					И  ВЫБОР
	|						КОГДА &РезервированиеЗапасов
	|							ТОГДА (Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя) В
	|									(ВЫБРАТЬ
	|										ТаблицаЗапасы.Организация,
	|										ТаблицаЗапасы.СтруктурнаяЕдиница,
	|										ТаблицаЗапасы.СчетУчета,
	|										ТаблицаЗапасы.Номенклатура,
	|										ТаблицаЗапасы.Характеристика,
	|										ТаблицаЗапасы.Партия,
	|										ТаблицаЗапасы.ЗаказПокупателя
	|									ИЗ
	|										ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы)
	|						ИНАЧЕ (Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия) В
	|								(ВЫБРАТЬ
	|									ТаблицаЗапасы.Организация,
	|									ТаблицаЗапасы.СтруктурнаяЕдиница,
	|									ТаблицаЗапасы.СчетУчета,
	|									ТаблицаЗапасы.Номенклатура,
	|									ТаблицаЗапасы.Характеристика,
	|									ТаблицаЗапасы.Партия
	|								ИЗ
	|									ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы)
	|					КОНЕЦ) КАК ЗапасыОстатки
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ЗапасыОстатки.Организация,
	|		ЗапасыОстатки.СтруктурнаяЕдиница,
	|		ЗапасыОстатки.СчетУчета,
	|		ЗапасыОстатки.Номенклатура,
	|		ЗапасыОстатки.Характеристика,
	|		ЗапасыОстатки.Партия,
	|		ЗапасыОстатки.ЗаказПокупателя
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДвиженияДокументаЗапасы.Организация,
	|		ДвиженияДокументаЗапасы.СтруктурнаяЕдиница,
	|		ДвиженияДокументаЗапасы.СчетУчета,
	|		ДвиженияДокументаЗапасы.Номенклатура,
	|		ДвиженияДокументаЗапасы.Характеристика,
	|		ДвиженияДокументаЗапасы.Партия,
	|		ДвиженияДокументаЗапасы.ЗаказПокупателя,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Количество, 0)
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ДвиженияДокументаЗапасы.СуммаБезНДС
	|			ИНАЧЕ -ДвиженияДокументаЗапасы.СуммаБезНДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДвиженияДокументаЗапасы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|				ТОГДА ЕСТЬNULL(ДвиженияДокументаЗапасы.Сумма, 0)
	|			ИНАЧЕ -ЕСТЬNULL(ДвиженияДокументаЗапасы.Сумма, 0)
	|		КОНЕЦ
	|	ИЗ
	|		РегистрНакопления.Запасы КАК ДвиженияДокументаЗапасы
	|	ГДЕ
	|		ДвиженияДокументаЗапасы.Регистратор = &ТекущийДокумент
	|		И ВЫБОР
	|				КОГДА &СебестоимостьПоОстаткам
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ) КАК ЗапасыОстатки
	|ГДЕ
	|	ВЫБОР
	|			КОГДА &СебестоимостьПоОстаткам
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстатки.Организация,
	|	ЗапасыОстатки.СтруктурнаяЕдиница,
	|	ЗапасыОстатки.СчетУчета,
	|	ЗапасыОстатки.Номенклатура,
	|	ЗапасыОстатки.Характеристика,
	|	ЗапасыОстатки.Партия,
	|	ЗапасыОстатки.ЗаказПокупателя
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДвиженияПоОснованиям.ДатаОстатка,
	|	ДвиженияПоОснованиям.Организация,
	|	ДвиженияПоОснованиям.СтруктурнаяЕдиница,
	|	ДвиженияПоОснованиям.СчетУчета,
	|	ДвиженияПоОснованиям.Номенклатура,
	|	ДвиженияПоОснованиям.Характеристика,
	|	ДвиженияПоОснованиям.Партия,
	|	ДвиженияПоОснованиям.ЗаказПокупателя,
	|	ДвиженияПоОснованиям.КоличествоОстаток,
	|	ДвиженияПоОснованиям.СуммаБезНДСОстаток,
	|	ДвиженияПоОснованиям.СуммаОстаток,
	|	ДвиженияПоОснованиям.Регистратор
	|ИЗ
	|	ДвиженияПоОснованиям КАК ДвиженияПоОснованиям";
	
	Если ЭтоОперацияВозврат Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ДвиженияПоОснованиям", "ДвиженияПоОснованиямВозвраты");
	КонецЕсли;
	
	ПериодКонтроля = СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени.Дата;
	Запрос.УстановитьПараметр("РезервированиеЗапасов", ПолучитьФункциональнуюОпцию("РезервированиеЗапасов"));
	Запрос.УстановитьПараметр("ПериодКонтроля", ПериодКонтроля);
	Запрос.УстановитьПараметр("ТаблицаДокументовОснования", ТаблицаДокументовОснования);
	Запрос.УстановитьПараметр("СебестоимостьПоОстаткам", СебестоимостьПоОстаткам);
	Запрос.УстановитьПараметр("ЭтоОперацияВозврат", ЭтоОперацияВозврат);
	Запрос.УстановитьПараметр("ТекущийДокумент", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("МоментКонтроля", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ТаблицаЗапасыОстатки = РезультатЗапроса.Выгрузить();
	ТаблицаЗапасыОстатки.Индексы.Добавить("Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя, Регистратор");
	
	ВременнаяТаблицаЗапасы = СтруктураДополнительныеСвойства.ТаблицыДляДвижений[ИмяТаблицаЗапасы].СкопироватьКолонки();
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений Тогда
		ЗначениеКолонкиСтруктурнаяЕдиница = ВременнаяТаблицаЗапасы.ВыгрузитьКолонку("СтруктурнаяЕдиница");
		ВременнаяТаблицаЗапасы.Колонки.Удалить("СтруктурнаяЕдиница");
		
		МассивТипов = Новый Массив;
		МассивТипов.Добавить(Тип("Null"));
		МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
		МассивТипов.Добавить(Тип("СправочникСсылка.СтруктурныеЕдиницы"));
		ОписаниеТиповКолонки = Новый ОписаниеТипов(МассивТипов);
		
		НоваяКолонка = ВременнаяТаблицаЗапасы.Колонки.Добавить("СтруктурнаяЕдиница", ОписаниеТиповКолонки);
		
		ВременнаяТаблицаЗапасы.ЗагрузитьКолонку(ЗначениеКолонкиСтруктурнаяЕдиница, "СтруктурнаяЕдиница");
	КонецЕсли;

	Для н = 0 По СтруктураДополнительныеСвойства.ТаблицыДляДвижений[ИмяТаблицаЗапасы].Количество() - 1 Цикл
		
		СтрокаТаблицаЗапасы = СтруктураДополнительныеСвойства.ТаблицыДляДвижений[ИмяТаблицаЗапасы][н];
		
		СтруктураДляПоиска = Новый Структура;
		СтруктураДляПоиска.Вставить("Регистратор", СтрокаТаблицаЗапасы.Документ);
		СтруктураДляПоиска.Вставить("Организация", СтрокаТаблицаЗапасы.Организация);
		СтруктураДляПоиска.Вставить("СтруктурнаяЕдиница", СтрокаТаблицаЗапасы.СтруктурнаяЕдиница);
		СтруктураДляПоиска.Вставить("СчетУчета", СтрокаТаблицаЗапасы.СчетУчета);
		СтруктураДляПоиска.Вставить("Номенклатура", СтрокаТаблицаЗапасы.Номенклатура);
		СтруктураДляПоиска.Вставить("Характеристика", СтрокаТаблицаЗапасы.Характеристика);
		СтруктураДляПоиска.Вставить("Партия", СтрокаТаблицаЗапасы.Партия);
		СтруктураДляПоиска.Вставить("ЗаказПокупателя", СтрокаТаблицаЗапасы.ЗаказПокупателя);
		
		КоличествоТребуется = ?(ЭтоОперацияВозврат, -СтрокаТаблицаЗапасы.Количество, СтрокаТаблицаЗапасы.Количество);
		
		Если КоличествоТребуется > 0  Тогда
			
			МесяцПродажиИВозвратаСовпадает = Истина;
			
			Если ЭтоОперацияВозврат И СтрокаТаблицаЗапасы.РучнаяСебестоимость > 0 Тогда
				
				// Себестоимость указана явно в документе
				СуммаКСписанию = СтрокаТаблицаЗапасы.РучнаяСебестоимость;
				СуммаБезНДСКСписанию = 0;
				
			Иначе
				
				МассивСтрокОстатков = ТаблицаЗапасыОстатки.НайтиСтроки(СтруктураДляПоиска);
				
				КоличествоОстаток = 0;
				СуммаОстаток = 0;
				СуммаБезНДСОстаток = 0;
				
				Если МассивСтрокОстатков.Количество() > 0 Тогда
					КоличествоОстаток = МассивСтрокОстатков[0].КоличествоОстаток;
					СуммаОстаток = МассивСтрокОстатков[0].СуммаОстаток;
					СуммаБезНДСОстаток = МассивСтрокОстатков[0].СуммаБезНДСОстаток;
				КонецЕсли;
				
				Если ЭтоОперацияВозврат И МассивСтрокОстатков.Количество() > 0 Тогда
					МесяцПродажиИВозвратаСовпадает = (НачалоМесяца(ПериодКонтроля) = НачалоМесяца(МассивСтрокОстатков[0].ДатаОстатка));
				КонецЕсли; 
				
				Если КоличествоОстаток > 0 И КоличествоОстаток > КоличествоТребуется Тогда
					
					СуммаКСписанию = Окр(СуммаОстаток * КоличествоТребуется / КоличествоОстаток , 2, 1);
					СуммаБезНДСКСписанию = Окр(СуммаБезНДСОстаток * КоличествоТребуется / КоличествоОстаток , 2, 1);
					
					МассивСтрокОстатков[0].КоличествоОстаток = МассивСтрокОстатков[0].КоличествоОстаток - КоличествоТребуется;
					МассивСтрокОстатков[0].СуммаОстаток = МассивСтрокОстатков[0].СуммаОстаток - СуммаКСписанию;
					МассивСтрокОстатков[0].СуммаБезНДСОстаток = МассивСтрокОстатков[0].СуммаБезНДСОстаток - СуммаБезНДСКСписанию;
					
				ИначеЕсли КоличествоОстаток = КоличествоТребуется Тогда
					
					СуммаКСписанию = СуммаОстаток;
					СуммаБезНДСКСписанию = СуммаБезНДСОстаток;
					
					МассивСтрокОстатков[0].КоличествоОстаток = 0;
					МассивСтрокОстатков[0].СуммаОстаток = 0;
					МассивСтрокОстатков[0].СуммаБезНДСОстаток = 0;
					
				Иначе
					СуммаКСписанию = 0;
					СуммаБезНДСКСписанию = 0;
				КонецЕсли;
				
			КонецЕсли;
			
			// Добавим строку по заказу.
			СтрокаТаблицыРасход = ВременнаяТаблицаЗапасы.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТаблицыРасход, СтрокаТаблицаЗапасы);
			
			СтрокаТаблицыРасход.Сумма = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
			СтрокаТаблицыРасход.СуммаБезНДС = ?(ЭтоОперацияВозврат, -СуммаБезНДСКСписанию, СуммаБезНДСКСписанию);
			СтрокаТаблицыРасход.Количество = ?(ЭтоОперацияВозврат, -КоличествоТребуется, КоличествоТребуется);
			
			Если ЭтоОперацияВозврат И НЕ МесяцПродажиИВозвратаСовпадает Тогда
				СтрокаТаблицыРасход.ФиксированнаяСтоимость = Истина;
			КонецЕсли; 
			
			Если Окр(СуммаКСписанию, 2, 1) <> 0
				Или Окр(СуммаБезНДСКСписанию, 2, 1) <> 0 Тогда
				
				// Сформируем проводки.
				СтрокаТаблицаУправленческий = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаУправленческий.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицаУправленческий, СтрокаТаблицаЗапасы);
				СтрокаТаблицаУправленческий.Содержание = ?(ЭтоОперацияВозврат, СодержанияПроводок.СторнированиеСебестоимости(), СодержанияПроводок.СебестоимостьПродажи());
				СтрокаТаблицаУправленческий.Сумма = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				
				// Продвигаем себестоимость продаж.
				СтрокаТаблицаПродажи = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПродажи.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицаПродажи, СтрокаТаблицаЗапасы);
				
				СтрокаТаблицаПродажи.Количество = 0;
				СтрокаТаблицаПродажи.Сумма = 0;
				СтрокаТаблицаПродажи.СуммаНДС = 0;
				СтрокаТаблицаПродажи.Себестоимость = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				СтрокаТаблицаПродажи.СебестоимостьБезНДС = ?(ЭтоОперацияВозврат, -СуммаБезНДСКСписанию, СуммаБезНДСКСписанию); 
				
				// Продвигаем доходы и расходы.
				СтрокаДоходыИРасходы = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаДоходыИРасходы.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаДоходыИРасходы, СтрокаТаблицаЗапасы);
				
				СтрокаДоходыИРасходы.СтруктурнаяЕдиница = СтрокаТаблицаЗапасы.ПодразделениеПродажи;
				СтрокаДоходыИРасходы.СчетУчета = СтрокаТаблицаЗапасы.СчетУчетаСебестоимость;
				СтрокаДоходыИРасходы.СуммаДоходов = 0;
				СтрокаДоходыИРасходы.СуммаРасходов = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				СтрокаДоходыИРасходы.Сумма = ?(ЭтоОперацияВозврат, -СуммаКСписанию, СуммаКСписанию);
				СтрокаДоходыИРасходы.СодержаниеПроводки = ?(ЭтоОперацияВозврат, СодержанияПроводок.СторнированиеРасходов(), СодержанияПроводок.ОтражениеРасходов());
				
				Если ЗначениеЗаполнено(ДокументСсылкаОтчетКомиссионера.Проект) Тогда
					СтрокаДоходыИРасходы.Проект = ДокументСсылкаОтчетКомиссионера.Проект;
				КонецЕсли;
				
			КонецЕсли;
			
			Если СтрокаТаблицаЗапасы.УдержатьКомиссионноеВознаграждение Тогда
				
				СтрокаТаблицаУправленческий = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаУправленческий.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТаблицаУправленческий, СтрокаТаблицаЗапасы);
				СтрокаТаблицаУправленческий.СчетКт = ПланыСчетов.Управленческий.РасчетыСПокупателями;
				СтрокаТаблицаУправленческий.Содержание = ?(ЭтоОперацияВозврат, СодержанияПроводок.СторнированиеКомиссионногоВознаграждения(), СодержанияПроводок.КомиссионноеВознаграждение());
				СтрокаТаблицаУправленческий.Сумма = СтрокаТаблицаЗапасы.СуммаВознаграждения;
				
				Если СтрокаТаблицаУправленческий.СчетКт.Валютный Тогда
					СтрокаТаблицаУправленческий.СуммаВалКт = СтрокаТаблицаЗапасы.СуммаВознаграждения;
					СтрокаТаблицаУправленческий.ВалютаКт = ДокументСсылкаОтчетКомиссионера.Договор.ВалютаРасчетов;
				КонецЕсли;
				
				Если НЕ СтрокаТаблицаЗапасы.НДСВключатьВСтоимость Тогда
					
					// Корректировка суммы вознаграждения
					СтрокаТаблицаУправленческий.Сумма = СтрокаТаблицаУправленческий.Сумма - СтрокаТаблицаЗапасы.СуммаНДСВознаграждения;
					Если ЗначениеЗаполнено(СтрокаТаблицаУправленческий.ВалютаКт) Тогда
						СтрокаТаблицаУправленческий.СуммаВалКт = СтрокаТаблицаУправленческий.СуммаВалКт - СтрокаТаблицаЗапасы.СуммаНДСВознагражденияВал;
					КонецЕсли;
					Если ЗначениеЗаполнено(СтрокаТаблицаУправленческий.ВалютаДт) Тогда
						СтрокаТаблицаУправленческий.СуммаВалДт = СтрокаТаблицаУправленческий.СуммаВалДт - СтрокаТаблицаЗапасы.СуммаНДСВознагражденияВал;
					КонецЕсли;
					
					// Движения по НДС
					СтрокаТаблицаНДС = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаУправленческий.Добавить();
					ЗаполнитьЗначенияСвойств(СтрокаТаблицаНДС, СтрокаТаблицаЗапасы);
					СтрокаТаблицаНДС.Содержание = СодержанияПроводок.ОтражениеНДСПриобретения();
					СтрокаТаблицаНДС.СчетДт = СтрокаТаблицаЗапасы.СчетУчетаНДСПоПриобретеннымЦенностям;
					СтрокаТаблицаНДС.СчетКт = ПланыСчетов.Управленческий.РасчетыСПокупателями;
					
					Если СтрокаТаблицаНДС.СчетКт.Валютный Тогда
						СтрокаТаблицаНДС.СуммаВалКт = СтрокаТаблицаЗапасы.СуммаНДСВознагражденияВал;
						СтрокаТаблицаНДС.ВалютаКт = ДокументСсылкаОтчетКомиссионера.Договор.ВалютаРасчетов;
					КонецЕсли;
					
					Если СтрокаТаблицаНДС.СчетДт.Валютный Тогда
						СтрокаТаблицаНДС.СуммаВалДт = СтрокаТаблицаЗапасы.СуммаНДСВознагражденияВал;
						СтрокаТаблицаНДС.ВалютаДт = ДокументСсылкаОтчетКомиссионера.Договор.ВалютаРасчетов;
					КонецЕсли;
					
					СтрокаТаблицаНДС.Сумма = СтрокаТаблицаЗапасы.СуммаНДСВознаграждения;
					
				КонецЕсли;
				
				// Нужно увеличить себестоимость продажи на сумму вознаграждения.
				НоваяСтрока	= СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПродажи.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицаЗапасы);
				
				НоваяСтрока.Количество		= 0;
				НоваяСтрока.Сумма			= 0;
				НоваяСтрока.СуммаНДС		= 0;
				НоваяСтрока.Себестоимость	= СтрокаТаблицаЗапасы.СуммаВознаграждения;
				
				// Нужно увеличить себестоимость продажи на сумму вознаграждения.
				НоваяСтрока= СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаДоходыИРасходы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицаЗапасы);
				
				НоваяСтрока.СтруктурнаяЕдиница = СтрокаТаблицаЗапасы.ПодразделениеПродажи;
				НоваяСтрока.СчетУчета = СтрокаТаблицаЗапасы.СчетУчетаСебестоимость;
				НоваяСтрока.СуммаДоходов = 0;
				НоваяСтрока.СуммаРасходов = СтрокаТаблицаЗапасы.СуммаВознаграждения;
				НоваяСтрока.Сумма = СтрокаТаблицаЗапасы.СуммаВознаграждения;
				НоваяСтрока.СодержаниеПроводки = ?(ЭтоОперацияВозврат, СодержанияПроводок.СторнированиеРасходов(), СодержанияПроводок.ОтражениеРасходов());
				
				Если ЗначениеЗаполнено(ДокументСсылкаОтчетКомиссионера.Проект) Тогда
					НоваяСтрока.Проект = ДокументСсылкаОтчетКомиссионера.Проект;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
			
	КонецЦикла;
	
	Если Не ЭтоОперацияВозврат Тогда
		СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы = ВременнаяТаблицаЗапасы;
	Иначе
		Для Каждого СтрокаЗапасов Из ВременнаяТаблицаЗапасы Цикл
			НоваяСтрока = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаЗапасов);
		КонецЦикла
	КонецЕсли;
	
КонецПроцедуры // СформироватьТаблицаЗапасы()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаЗапасыРасходы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаЗапасы.НомерСтроки КАК НомерСтроки,
	|	ТаблицаЗапасы.ВидДвижения КАК ВидДвижения,
	|	ТаблицаЗапасы.ВидОперации КАК ВидОперации,
	|	ТаблицаЗапасы.ТипСчета КАК ТипСчета,
	|	ТаблицаЗапасы.ВключатьРасходыВСебестоимость КАК ВключатьРасходыВСебестоимость,
	|	ТаблицаЗапасы.Период КАК Период,
	|	ТаблицаЗапасы.Организация КАК Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета КАК СчетУчета,
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ТаблицаЗапасы.ЗаказПоставщику КАК ИсточникОбеспечения,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|			ТОГДА ТаблицаЗапасы.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ КАК ЗаказПокупателя,
	|	ТаблицаЗапасы.Заказ КАК ЗаказРазмещения,
	|	ТаблицаЗапасы.Количество КАК Количество,
	|	ТаблицаЗапасы.Сумма КАК Сумма,
	|	ИСТИНА КАК ФиксированнаяСтоимость,
	|	&ПрочиеРасходы КАК СодержаниеПроводки,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|				И ТИПЗНАЧЕНИЯ(ТаблицаЗапасы.Заказ) = ТИП(Документ.ЗаказПокупателя)
	|				И ТаблицаЗапасы.Заказ <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Порядок
	|ИЗ
	|	ВременнаяТаблицаРасходы КАК ТаблицаЗапасы,
	|	Константа.ФункциональнаяОпцияРезервированиеЗапасов КАК ФункциональнаяОпцияРезервированиеЗапасов
	|ГДЕ
	|	ТаблицаЗапасы.Сумма > 0
	|	И НЕ ТаблицаЗапасы.УдержатьКомиссионноеВознаграждение
	|	И НЕ ТаблицаЗапасы.ЭтоВозврат
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасы.Период,
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПоставщику,
	|	ТаблицаЗапасы.Заказ,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|			ТОГДА ТаблицаЗапасы.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаЗапасы.ВидДвижения,
	|	ТаблицаЗапасы.ВидОперации,
	|	ТаблицаЗапасы.ТипСчета,
	|	ТаблицаЗапасы.ВключатьРасходыВСебестоимость,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|				И ТИПЗНАЧЕНИЯ(ТаблицаЗапасы.Заказ) = ТИП(Документ.ЗаказПокупателя)
	|				И ТаблицаЗапасы.Заказ <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ,
	|	ТаблицаЗапасы.НомерСтроки,
	|	ТаблицаЗапасы.Количество,
	|	ТаблицаЗапасы.Сумма
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаЗапасы.НомерСтроки,
	|	ТаблицаЗапасы.ВидДвижения,
	|	ТаблицаЗапасы.ВидОперации,
	|	ТаблицаЗапасы.ТипСчета,
	|	ТаблицаЗапасы.ВключатьРасходыВСебестоимость,
	|	ТаблицаЗапасы.Период,
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПоставщику,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|			ТОГДА ТаблицаЗапасы.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаЗапасы.Заказ,
	|	-ТаблицаЗапасы.Количество,
	|	ТаблицаЗапасы.Сумма,
	|	ИСТИНА,
	|	&ПрочиеРасходы,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|				И ТИПЗНАЧЕНИЯ(ТаблицаЗапасы.Заказ) = ТИП(Документ.ЗаказПокупателя)
	|				И ТаблицаЗапасы.Заказ <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ
	|ИЗ
	|	ВременнаяТаблицаРасходы КАК ТаблицаЗапасы,
	|	Константа.ФункциональнаяОпцияРезервированиеЗапасов КАК ФункциональнаяОпцияРезервированиеЗапасов
	|ГДЕ
	|	ТаблицаЗапасы.Сумма > 0
	|	И НЕ ТаблицаЗапасы.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И ТаблицаЗапасы.ЭтоВозврат
	|	И ТаблицаЗапасы.ИспользоватьНовуюСхемуДвижений
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасы.Период,
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПоставщику,
	|	ТаблицаЗапасы.Заказ,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|			ТОГДА ТаблицаЗапасы.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаЗапасы.ВидДвижения,
	|	ТаблицаЗапасы.ВидОперации,
	|	ТаблицаЗапасы.ТипСчета,
	|	ТаблицаЗапасы.ВключатьРасходыВСебестоимость,
	|	ВЫБОР
	|		КОГДА ФункциональнаяОпцияРезервированиеЗапасов.Значение
	|				И ТИПЗНАЧЕНИЯ(ТаблицаЗапасы.Заказ) = ТИП(Документ.ЗаказПокупателя)
	|				И ТаблицаЗапасы.Заказ <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ,
	|	ТаблицаЗапасы.НомерСтроки,
	|	-ТаблицаЗапасы.Количество,
	|	ТаблицаЗапасы.Сумма
	|
	|УПОРЯДОЧИТЬ ПО
	|	Порядок,
	|	НомерСтроки";
	
	Запрос.УстановитьПараметр("ПрочиеРасходы", НСтр("ru = 'Отражение затрат'"));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.ТипСчета <> Перечисления.ТипыСчетов.НезавершенноеПроизводство
			И Выборка.ТипСчета <> Перечисления.ТипыСчетов.КосвенныеЗатраты Тогда
			Продолжить
		КонецЕсли;
		ДобавитьСтрокиЗапасыПоРазмещению(СтруктураДополнительныеСвойства, СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаЗапасы, Выборка);
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьСтрокиЗапасыПоРазмещению(СтруктураДополнительныеСвойства, ТаблицаЗапасы, ИсточникЗаполнения)
	
	СтрокаТаблицаЗапасы = ТаблицаЗапасы.Добавить();
	СтрокаТаблицаЗапасы.СтруктурнаяЕдиница = ИсточникЗаполнения.СтруктурнаяЕдиница;
	ЗаполнитьЗначенияСвойств(СтрокаТаблицаЗапасы, ИсточникЗаполнения);
	
	СтрокаТаблицаЗапасы.Номенклатура = Справочники.Номенклатура.ПустаяСсылка();
	СтрокаТаблицаЗапасы.Количество = 0;

КонецПроцедуры

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаПродажи(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, ИмяТаблицы = "ТаблицаПродажи") 
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Если ИмяТаблицы = "ТаблицаПродажиВозвраты" Тогда 
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОВозвратах(ИмяТаблицы);
		Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	Иначе
		
		Если СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионера Тогда
			Запрос.Текст = ТекстЗапросаОтчетКомиссионераОПродажах();
		Иначе
			Запрос.Текст = ТекстЗапросаОтчетКомиссионераОВозвратах();
			Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		КонецЕсли;
		
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если ИмяТаблицы = "ТаблицаПродажи" Тогда  
		СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаПродажи", РезультатЗапроса.Выгрузить());
	Иначе
		
		Если Не СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Свойство("ТаблицаПродажи") Тогда
			СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаПродажи", РезультатЗапроса.Выгрузить());
		Иначе
			
			ВыборкаЗапроса = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаЗапроса.Следующий() Цикл
				НоваяСтрока = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаПродажи.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаЗапроса);
			КонецЦикла;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // СформироватьТаблицаПродажи()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаЗакупки(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВидОперации", СтруктураДополнительныеСвойства.ВидОперации);
	Запрос.УстановитьПараметр("ИспользоватьНовуюСхемуДвижений", СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений);
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаЗакупки.Период КАК Период,
	|	ТаблицаЗакупки.Организация КАК Организация,
	|	ТаблицаЗакупки.УслугаКомиссионногоВознаграждения КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО КАК Характеристика,
	|	НЕОПРЕДЕЛЕНО КАК Партия,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка) КАК ЗаказПоставщику,
	|	ТаблицаЗакупки.Документ КАК Документ,
	|	ТаблицаЗакупки.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	1 КАК Количество,
	|	СУММА(ТаблицаЗакупки.СуммаНДСВознагражденияДляУслуги) КАК СуммаНДС,
	|	СУММА(ТаблицаЗакупки.СуммаВознаграждения) КАК Сумма,
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете КАК ИспользоватьНовуюСхемуДвиженийВОтчете
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗакупки
	|ГДЕ
	|	(&ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионера)
	|			ИЛИ &ИспользоватьНовыйВидДокумента)
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаЗакупки.СуммаВознаграждения = 0
	|	И НЕ ТаблицаЗакупки.УдержатьКомиссионноеВознаграждение
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗакупки.Период,
	|	ТаблицаЗакупки.Организация,
	|	ТаблицаЗакупки.УслугаКомиссионногоВознаграждения,
	|	ТаблицаЗакупки.Документ,
	|	ТаблицаЗакупки.СтавкаНДСВознаграждения,
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаЗакупки.Период,
	|	ТаблицаЗакупки.Организация,
	|	ТаблицаЗакупки.УслугаКомиссионногоВознаграждения,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаЗакупки.ОтчетКомиссионера,
	|	ТаблицаЗакупки.СтавкаНДСВознаграждения,
	|	-1,
	|	СУММА(ТаблицаЗакупки.СуммаНДСВознагражденияДляУслуги),
	|	СУММА(ТаблицаЗакупки.СуммаВознаграждения),
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗакупки
	|ГДЕ
	|	&ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|	И ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаЗакупки.СуммаВознаграждения = 0
	|	И НЕ ТаблицаЗакупки.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И НЕ &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗакупки.Период,
	|	ТаблицаЗакупки.Организация,
	|	ТаблицаЗакупки.УслугаКомиссионногоВознаграждения,
	|	ТаблицаЗакупки.ОтчетКомиссионера,
	|	ТаблицаЗакупки.СтавкаНДСВознаграждения,
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаЗакупки.Период,
	|	ТаблицаЗакупки.Организация,
	|	ТаблицаЗакупки.УслугаКомиссионногоВознаграждения,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаЗакупки.ОтчетКомиссионера,
	|	ТаблицаЗакупки.СтавкаНДСВознаграждения,
	|	-1,
	|	СУММА(ТаблицаЗакупки.СуммаНДСВознагражденияДляУслуги),
	|	СУММА(ТаблицаЗакупки.СуммаВознаграждения),
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаЗакупки
	|ГДЕ
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаЗакупки.СуммаВознаграждения = 0
	|	И НЕ ТаблицаЗакупки.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗакупки.Период,
	|	ТаблицаЗакупки.Организация,
	|	ТаблицаЗакупки.УслугаКомиссионногоВознаграждения,
	|	ТаблицаЗакупки.ОтчетКомиссионера,
	|	ТаблицаЗакупки.СтавкаНДСВознаграждения,
	|	ТаблицаЗакупки.ИспользоватьНовуюСхемуДвиженийВОтчете";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаЗакупки", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры // СформироватьТаблицаЗакупки()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаЗапасыПереданные(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасыПереданные.НомерСтроки) КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ТаблицаЗапасыПереданные.Период КАК Период,
	|	ТаблицаЗапасыПереданные.Организация КАК Организация,
	|	ТаблицаЗапасыПереданные.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасыПереданные.Характеристика КАК Характеристика,
	|	ТаблицаЗапасыПереданные.Контрагент КАК Контрагент,
	|	ТаблицаЗапасыПереданные.Договор КАК Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаЗапасыПереданные.ЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА ТаблицаЗапасыПереданные.ЗаказПокупателя
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Заказ,
	|	ТаблицаЗапасыПереданные.Партия КАК Партия,
	|	ТаблицаЗапасыПереданные.ТипПриемаПередачи КАК ТипПриемаПередачи,
	|	СУММА(ТаблицаЗапасыПереданные.Количество) КАК Количество,
	|	СУММА(ТаблицаЗапасыПереданные.СуммаРасчетовПринятыеПереданные) КАК СуммаРасчетов
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасыПереданные
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасыПереданные.Период,
	|	ТаблицаЗапасыПереданные.Организация,
	|	ТаблицаЗапасыПереданные.Номенклатура,
	|	ТаблицаЗапасыПереданные.Характеристика,
	|	ТаблицаЗапасыПереданные.Партия,
	|	ТаблицаЗапасыПереданные.Контрагент,
	|	ТаблицаЗапасыПереданные.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаЗапасыПереданные.ЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА ТаблицаЗапасыПереданные.ЗаказПокупателя
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаЗапасыПереданные.ТипПриемаПередачи
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасыПереданныеВозвраты.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаЗапасыПереданныеВозвраты.Период,
	|	ТаблицаЗапасыПереданныеВозвраты.Организация,
	|	ТаблицаЗапасыПереданныеВозвраты.Номенклатура,
	|	ТаблицаЗапасыПереданныеВозвраты.Характеристика,
	|	ТаблицаЗапасыПереданныеВозвраты.Контрагент,
	|	ТаблицаЗапасыПереданныеВозвраты.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаЗапасыПереданныеВозвраты.ЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА ТаблицаЗапасыПереданныеВозвраты.ЗаказПокупателя
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаЗапасыПереданныеВозвраты.Партия,
	|	ТаблицаЗапасыПереданныеВозвраты.ТипПриемаПередачи,
	|	СУММА(ТаблицаЗапасыПереданныеВозвраты.Количество),
	|	СУММА(ТаблицаЗапасыПереданныеВозвраты.СуммаРасчетовПринятыеПереданные)
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаЗапасыПереданныеВозвраты
	|ГДЕ
	|	&ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасыПереданныеВозвраты.Период,
	|	ТаблицаЗапасыПереданныеВозвраты.Организация,
	|	ТаблицаЗапасыПереданныеВозвраты.Номенклатура,
	|	ТаблицаЗапасыПереданныеВозвраты.Характеристика,
	|	ТаблицаЗапасыПереданныеВозвраты.Партия,
	|	ТаблицаЗапасыПереданныеВозвраты.Контрагент,
	|	ТаблицаЗапасыПереданныеВозвраты.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаЗапасыПереданныеВозвраты.ЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ТОГДА ТаблицаЗапасыПереданныеВозвраты.ЗаказПокупателя
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаЗапасыПереданныеВозвраты.ТипПриемаПередачи";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаЗапасыПереданные", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры // СформироватьТаблицаЗапасыПереданные()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаДоходыИРасходы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	1 КАК Порядок,
	|	МАКСИМУМ(ТаблицаДоходыИРасходы.НомерСтроки) КАК НомерСтроки,
	|	ТаблицаДоходыИРасходы.Период КАК Период,
	|	ТаблицаДоходыИРасходы.Организация КАК Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи КАК СтруктурнаяЕдиница,
	|	ТаблицаДоходыИРасходы.Проект КАК Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи КАК НаправлениеДеятельности,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаПродажи КАК СчетУчета,
	|	НЕОПРЕДЕЛЕНО КАК Аналитика,
	|	ВЫРАЗИТЬ(&ОтражениеДоходов КАК СТРОКА(100)) КАК СодержаниеПроводки,
	|	СУММА(ТаблицаДоходыИРасходы.Сумма) КАК СуммаДоходов,
	|	0 КАК СуммаРасходов,
	|	СУММА(ТаблицаДоходыИРасходы.Сумма) КАК Сумма
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДоходыИРасходы
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаПродажи
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	ТаблицаДоходыИРасходы.НомерСтроки,
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаНДСПоРеализации,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫРАЗИТЬ(&ОтражениеНДС КАК СТРОКА(100)),
	|	0,
	|	СУММА(ТаблицаДоходыИРасходы.СуммаНДС),
	|	СУММА(ТаблицаДоходыИРасходы.СуммаНДС)
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДоходыИРасходы
	|ГДЕ
	|	ТаблицаДоходыИРасходы.СуммаНДС <> 0
	|	И НЕ ТаблицаДоходыИРасходы.НДСВключатьВСтоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.НомерСтроки,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаНДСПоРеализации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	1,
	|	ТаблицаДокумента.Дата,
	|	ТаблицаДокумента.Организация,
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.Прочее),
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СуммаКурсовойРазницы > 0
	|			ТОГДА &ПоложительнаяКурсоваяРазницаСчетУчета
	|		ИНАЧЕ &ОтрицательнаяКурсоваяРазницаСчетУчета
	|	КОНЕЦ,
	|	ТаблицаДокумента.Валюта,
	|	ВЫРАЗИТЬ(&КурсоваяРазница КАК СТРОКА(100)),
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СуммаКурсовойРазницы > 0
	|			ТОГДА ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СуммаКурсовойРазницы > 0
	|			ТОГДА 0
	|		ИНАЧЕ -ТаблицаДокумента.СуммаКурсовойРазницы
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СуммаКурсовойРазницы > 0
	|			ТОГДА ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИНАЧЕ -ТаблицаДокумента.СуммаКурсовойРазницы
	|	КОНЕЦ
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Дата КАК Дата,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Организация КАК Организация,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Валюта КАК Валюта,
	|		СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) КАК СуммаКурсовойРазницы
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ТаблицаДокумента.Дата КАК Дата,
	|			ТаблицаДокумента.Организация КАК Организация,
	|			ТаблицаДокумента.Валюта КАК Валюта,
	|			ТаблицаДокумента.СуммаКурсовойРазницы КАК СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг)
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ТаблицаДокумента.Дата,
	|			ТаблицаДокумента.Организация,
	|			ТаблицаДокумента.Валюта,
	|			ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)) КАК ТаблицаКурсовыхРазницРасчетыСПокупателями
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Дата,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Организация,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Валюта
	|	
	|	ИМЕЮЩИЕ
	|		(СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) >= 0.005
	|			ИЛИ СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) <= -0.005)) КАК ТаблицаДокумента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	4,
	|	1,
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	НЕОПРЕДЕЛЕНО,
	|	ТаблицаДоходыИРасходы.СчетУчетаЗатрат,
	|	ТаблицаДоходыИРасходы.УслугаКомиссионногоВознаграждения,
	|	ВЫРАЗИТЬ(&ПрочиеРасходы КАК СТРОКА(100)),
	|	0,
	|	СУММА(ТаблицаДоходыИРасходы.СуммаВознаграждения),
	|	СУММА(ТаблицаДоходыИРасходы.СуммаВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДоходыИРасходы
	|ГДЕ
	|	(ТаблицаДоходыИРасходы.СчетУчетаЗатратТипСчета = ЗНАЧЕНИЕ(Перечисление.ТипыСчетов.Расходы)
	|			ИЛИ ТаблицаДоходыИРасходы.СчетУчетаЗатратТипСчета = ЗНАЧЕНИЕ(Перечисление.ТипыСчетов.ПрочиеРасходы))
	|	И НЕ ТаблицаДоходыИРасходы.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаДоходыИРасходы.ЭтоВозврат
	|	И НЕ ТаблицаДоходыИРасходы.СуммаВознаграждения = 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.СчетУчетаЗатрат,
	|	ТаблицаДоходыИРасходы.УслугаКомиссионногоВознаграждения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	5,
	|	1,
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	НЕОПРЕДЕЛЕНО,
	|	ТаблицаДоходыИРасходы.СчетУчетаЗатрат,
	|	ТаблицаДоходыИРасходы.УслугаКомиссионногоВознаграждения,
	|	ВЫРАЗИТЬ(&ПрочиеРасходы КАК СТРОКА(100)),
	|	0,
	|	СУММА(ТаблицаДоходыИРасходы.СуммаВознаграждения),
	|	СУММА(ТаблицаДоходыИРасходы.СуммаВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДоходыИРасходы
	|ГДЕ
	|	(ТаблицаДоходыИРасходы.СчетУчетаЗатратТипСчета = ЗНАЧЕНИЕ(Перечисление.ТипыСчетов.Расходы)
	|			ИЛИ ТаблицаДоходыИРасходы.СчетУчетаЗатратТипСчета = ЗНАЧЕНИЕ(Перечисление.ТипыСчетов.ПрочиеРасходы))
	|	И ТаблицаДоходыИРасходы.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаДоходыИРасходы.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И ТаблицаДоходыИРасходы.ЭтоВозврат
	|	И НЕ ТаблицаДоходыИРасходы.СуммаВознаграждения = 0
	|	И НЕ &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.СчетУчетаЗатрат,
	|	ТаблицаДоходыИРасходы.УслугаКомиссионногоВознаграждения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	6,
	|	МАКСИМУМ(ТаблицаДоходыИРасходы.НомерСтроки),
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаПродажи,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫРАЗИТЬ(&ОтражениеДоходовВозвраты КАК СТРОКА(100)),
	|	СУММА(ТаблицаДоходыИРасходы.Сумма),
	|	0,
	|	СУММА(ТаблицаДоходыИРасходы.Сумма)
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДоходыИРасходы
	|ГДЕ
	|	&ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаПродажи
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	7,
	|	ТаблицаДоходыИРасходы.НомерСтроки,
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаНДСПоРеализации,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫРАЗИТЬ(&ОтражениеНДС КАК СТРОКА(100)),
	|	0,
	|	СУММА(ТаблицаДоходыИРасходы.СуммаНДС),
	|	СУММА(ТаблицаДоходыИРасходы.СуммаНДС)
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДоходыИРасходы
	|ГДЕ
	|	&ИспользоватьНовыйВидДокумента
	|	И ТаблицаДоходыИРасходы.СуммаНДС <> 0
	|	И НЕ ТаблицаДоходыИРасходы.НДСВключатьВСтоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.НомерСтроки,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.ЗаказПокупателя,
	|	ТаблицаДоходыИРасходы.СчетУчетаНДСПоРеализации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	8,
	|	1,
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	НЕОПРЕДЕЛЕНО,
	|	ТаблицаДоходыИРасходы.СчетУчетаЗатрат,
	|	ТаблицаДоходыИРасходы.УслугаКомиссионногоВознаграждения,
	|	ВЫРАЗИТЬ(&ПрочиеРасходы КАК СТРОКА(100)),
	|	0,
	|	СУММА(ТаблицаДоходыИРасходы.СуммаВознаграждения),
	|	СУММА(ТаблицаДоходыИРасходы.СуммаВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДоходыИРасходы
	|ГДЕ
	|	(ТаблицаДоходыИРасходы.СчетУчетаЗатратТипСчета = ЗНАЧЕНИЕ(Перечисление.ТипыСчетов.Расходы)
	|			ИЛИ ТаблицаДоходыИРасходы.СчетУчетаЗатратТипСчета = ЗНАЧЕНИЕ(Перечисление.ТипыСчетов.ПрочиеРасходы))
	|	И ТаблицаДоходыИРасходы.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаДоходыИРасходы.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаДоходыИРасходы.СуммаВознаграждения = 0
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДоходыИРасходы.Период,
	|	ТаблицаДоходыИРасходы.Организация,
	|	ТаблицаДоходыИРасходы.ПодразделениеПродажи,
	|	ТаблицаДоходыИРасходы.Проект,
	|	ТаблицаДоходыИРасходы.НаправлениеДеятельностиПродажи,
	|	ТаблицаДоходыИРасходы.СчетУчетаЗатрат,
	|	ТаблицаДоходыИРасходы.УслугаКомиссионногоВознаграждения
	|
	|УПОРЯДОЧИТЬ ПО
	|	Порядок,
	|	НомерСтроки";
	
	ЭтоОперацияВозврат = ?(СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах, Истина, Ложь);
	
	Запрос.УстановитьПараметр("ПоложительнаяКурсоваяРазницаСчетУчета", ПланыСчетов.Управленческий.ПрочиеДоходы);
	Запрос.УстановитьПараметр("ОтрицательнаяКурсоваяРазницаСчетУчета", ПланыСчетов.Управленческий.ПрочиеРасходы);
	Запрос.УстановитьПараметр("ОтражениеДоходов", ?(ЭтоОперацияВозврат, СодержанияПроводок.СторнированиеДоходов(), СодержанияПроводок.ОтражениеДоходов()));
	Запрос.УстановитьПараметр("ПрочиеРасходы", СодержанияПроводок.ОтражениеЗатрат());
	Запрос.УстановитьПараметр("КурсоваяРазница", ?(ЭтоОперацияВозврат, СодержанияПроводок.СторнированиеКурсовойРазницы(), СодержанияПроводок.КурсоваяРазница()));
	Запрос.УстановитьПараметр("ОтражениеДоходовВозвраты",  СодержанияПроводок.СторнированиеДоходов());
	Запрос.УстановитьПараметр("ОтражениеНДС", СодержанияПроводок.ОтражениеНДСПродажи());
	Запрос.УстановитьПараметр("ИспользоватьНовуюСхемуДвижений", СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений);
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаДоходыИРасходы", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры // СформироватьТаблицаДоходыИРасходы()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаРасчетыСПокупателями(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, ИмяТаблицы = "ТаблицаРасчетыСПокупателями") 
	
	Если ИмяТаблицы = "ТаблицаРасчетыСПокупателямиВозвраты" Тогда 
		ВидОперацииВозврат = Истина;
		ИспользоватьНовыйВидДокумента = Истина;
	ИначеЕсли СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда
		ВидОперацииВозврат = Ложь;
	Иначе
		ВидОперацииВозврат = СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("МоментВремени", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ПериодКонтроля", СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени.Дата);
	Запрос.УстановитьПараметр("Организация", СтруктураДополнительныеСвойства.ДляПроведения.Организация);
	Запрос.УстановитьПараметр("ВозникновениеОбязательствПокупателя", ?(ВидОперацииВозврат, НСтр("ru='Сторнирование обязательств покупателя'"), НСтр("ru='Возникновение обязательств покупателя'")));
	Запрос.УстановитьПараметр("ЗачетАванса", НСтр("ru='Зачет предоплаты'"));
	Запрос.УстановитьПараметр("КурсоваяРазница", НСтр("ru='Курсовая разница'"));
	Запрос.УстановитьПараметр("УчетВалютныхОпераций", СтруктураДополнительныеСвойства.УчетВалютныхОпераций);
	Запрос.УстановитьПараметр("ИспользоватьНовуюСхемуДвижений", СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений);
	
	Если Не ВидОперацииВозврат Тогда
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОПродажахРасчетыСПокупателями();
	Иначе
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераОВозвратахРасчетыСПокупателями(ИмяТаблицы); 
	КонецЕсли;
	
	Запрос.Выполнить();
	
	// Установка исключительной блокировки контролируемых остатков расчетов с контрагентами.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВременнаяТаблицаРасчетыСПокупателями.Организация КАК Организация,
	|	ВременнаяТаблицаРасчетыСПокупателями.Контрагент КАК Контрагент,
	|	ВременнаяТаблицаРасчетыСПокупателями.Договор КАК Договор,
	|	ВременнаяТаблицаРасчетыСПокупателями.Документ КАК Документ,
	|	ВременнаяТаблицаРасчетыСПокупателями.Заказ КАК Заказ,
	|	ВременнаяТаблицаРасчетыСПокупателями.ТипРасчетов КАК ТипРасчетов
	|ИЗ
	|	ВременнаяТаблицаРасчетыСПокупателями";
	
	Если ИмяТаблицы = "ТаблицаРасчетыСПокупателямиВозвраты" Тогда 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВременнаяТаблицаРасчетыСПокупателями", "ВременнаяТаблицаРасчетыСПокупателямиВозвраты");
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.РасчетыСПокупателями");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
	
	Для каждого КолонкаРезультатЗапроса Из РезультатЗапроса.Колонки Цикл
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных(КолонкаРезультатЗапроса.Имя, КолонкаРезультатЗапроса.Имя);
	КонецЦикла;
	Блокировка.Заблокировать();
	
	Если Не ВидОперацииВозврат Тогда
		РасчетыПроведениеДокументов.ПодготовитьТаблицуВзаиморасчетовСУчетомАвансов(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, Ложь);
	КонецЕсли;
	
	Если ИмяТаблицы = "ТаблицаРасчетыСПокупателями" Тогда 
		
		НомерЗапроса = 0;
		Запрос.Текст = КурсовыеРазницыУНФ.ПолучитьТекстЗапросаКурсовыеРазницыРасчетыСПокупателями(Запрос.МенеджерВременныхТаблиц, Истина, НомерЗапроса);
		МассивРезультатов = Запрос.ВыполнитьПакет();
		
		СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаРасчетыСПокупателями", МассивРезультатов[НомерЗапроса].Выгрузить());
		
	Иначе // Дополним таблицу данными прочих таблиц
		
		НомерЗапроса = 0;
		Запрос.Текст = КурсовыеРазницыУНФ.ПолучитьТекстЗапросаКурсовыеРазницыРасчетыСПокупателямиВозвраты(Запрос.МенеджерВременныхТаблиц, Истина, НомерЗапроса);
		МассивРезультатов = Запрос.ВыполнитьПакет();
		
		Если Не СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Свойство("ТаблицаРасчетыСПокупателями") Тогда
			СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаРасчетыСПокупателями", МассивРезультатов[НомерЗапроса].Выгрузить());
		Иначе
			
			ВыборкаЗапроса = МассивРезультатов[НомерЗапроса].Выбрать();
			
			Пока ВыборкаЗапроса.Следующий() Цикл
				НоваяСтрока = СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаРасчетыСПокупателями.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаЗапроса);
			КонецЦикла;
			
		КонецЕсли;
		
		Если СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаРасчетыСПокупателями.Итог("Сумма") = 0 Тогда
			СтруктураДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаРасчетыСПокупателями.Очистить();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // СформироватьТаблицаРасчетыСПокупателями()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаРасчетыСПоставщиками(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("МоментВремени", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ПериодКонтроля", СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени.Дата);
	Запрос.УстановитьПараметр("Организация", СтруктураДополнительныеСвойства.ДляПроведения.Организация);
	Запрос.УстановитьПараметр("ВозникновениеОбязательствПередПоставщиком", НСтр("ru = 'Возникновение обязательств перед поставщиком'"));
	Запрос.УстановитьПараметр("ЗачетАванса", НСтр("ru='Зачет предоплаты'"));
	Запрос.УстановитьПараметр("КурсоваяРазница", НСтр("ru='Курсовая разница'"));
	Запрос.УстановитьПараметр("УчетВалютныхОпераций", СтруктураДополнительныеСвойства.УчетВалютныхОпераций);
	Запрос.УстановитьПараметр("ИспользоватьНовуюСхемуДвижений", СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений);
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.Период КАК Дата,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ТаблицаДокумента.Контрагент КАК Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком КАК СчетУчета,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения КАК Договор,
	|	ТаблицаДокумента.ЭтоВозврат КАК ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете КАК ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка) КАК Заказ,
	|	ТаблицаДокумента.ВалютаРасчетов КАК Валюта,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг) КАК ТипРасчетов,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения) КАК Сумма,
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал) КАК СуммаВал,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаВознагражденияРег
	|		КОНЕЦ) КАК СуммаРег,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения) КАК СуммаДляОстатка,
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал) КАК СуммаВалДляОстатка,
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПередПоставщиком КАК СТРОКА(100)) КАК СодержаниеПроводки,
	|	1 КАК ПорядокЗапросов
	|ПОМЕСТИТЬ ВременнаяТаблицаРасчетыСПоставщиками
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|ГДЕ
	|	НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|	И НЕ ТаблицаДокумента.ЭтоВозврат
	|	И НЕ ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПередПоставщиком КАК СТРОКА(100)),
	|	2
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|ГДЕ
	|	НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|	И ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаДокумента.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И ТаблицаДокумента.ЭтоВозврат
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПередПоставщиком КАК СТРОКА(100)),
	|	3
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|ГДЕ
	|	НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|	И ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И НЕ ТаблицаДокумента.ЭтоВозврат
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И ЛОЖЬ
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ -ТаблицаДокумента.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПередПоставщиком КАК СТРОКА(100)),
	|	4
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|ГДЕ
	|	НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|	И ТаблицаДокумента.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И ТаблицаДокумента.ЭтоВозврат
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И ЛОЖЬ
	|	И НЕ &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокумента.ЭтоВозврат,
	|	ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПоставщиком
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокументаВозвраты.Период,
	|	ТаблицаДокументаВозвраты.Организация,
	|	ТаблицаДокументаВозвраты.Контрагент,
	|	ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам,
	|	ТаблицаДокументаВозвраты.СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокументаВозвраты.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокументаВозвраты.ЭтоВозврат,
	|	ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокументаВозвраты.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаДокументаВозвраты.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознаграждения),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокументаВозвраты.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознаграждения),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПередПоставщиком КАК СТРОКА(100)),
	|	5
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокументаВозвраты
	|ГДЕ
	|	НЕ ТаблицаДокументаВозвраты.СуммаВознаграждения = 0
	|	И ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаДокументаВозвраты.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокументаВозвраты.Период,
	|	ТаблицаДокументаВозвраты.Организация,
	|	ТаблицаДокументаВозвраты.Контрагент,
	|	ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам,
	|	ТаблицаДокументаВозвраты.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокументаВозвраты.ЭтоВозврат,
	|	ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокументаВозвраты.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокументаВозвраты.ВалютаРасчетов,
	|	ТаблицаДокументаВозвраты.СчетУчетаРасчетовСПоставщиком
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаДокументаВозвраты.Период,
	|	ТаблицаДокументаВозвраты.Организация,
	|	ТаблицаДокументаВозвраты.Контрагент,
	|	ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам,
	|	ТаблицаДокументаВозвраты.СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокументаВозвраты.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокументаВозвраты.ЭтоВозврат,
	|	ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокументаВозвраты.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Документ.ЗаказПоставщику.ПустаяСсылка),
	|	ТаблицаДокументаВозвраты.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознаграждения),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ -ТаблицаДокументаВозвраты.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознаграждения),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПередПоставщиком КАК СТРОКА(100)),
	|	6
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокументаВозвраты
	|ГДЕ
	|	НЕ ТаблицаДокументаВозвраты.СуммаВознаграждения = 0
	|	И ТаблицаДокументаВозвраты.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И ЛОЖЬ
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокументаВозвраты.Период,
	|	ТаблицаДокументаВозвраты.Организация,
	|	ТаблицаДокументаВозвраты.Контрагент,
	|	ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам,
	|	ТаблицаДокументаВозвраты.ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ТаблицаДокументаВозвраты.ЭтоВозврат,
	|	ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокументаВозвраты.ОтчетКомиссионера
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокументаВозвраты.ВалютаРасчетов,
	|	ТаблицаДокументаВозвраты.СчетУчетаРасчетовСПоставщиком
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Контрагент,
	|	Договор,
	|	Валюта,
	|	Документ,
	|	Заказ,
	|	ТипРасчетов,
	|	СчетУчета";
	
	Запрос.Выполнить();
	
	// Установка исключительной блокировки контролируемых остатков расчетов с контрагентами.
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВременнаяТаблицаРасчетыСПоставщиками.Организация КАК Организация,
	|	ВременнаяТаблицаРасчетыСПоставщиками.Контрагент КАК Контрагент,
	|	ВременнаяТаблицаРасчетыСПоставщиками.Договор КАК Договор,
	|	ВременнаяТаблицаРасчетыСПоставщиками.Документ КАК Документ,
	|	ВременнаяТаблицаРасчетыСПоставщиками.Заказ КАК Заказ,
	|	ВременнаяТаблицаРасчетыСПоставщиками.ТипРасчетов КАК ТипРасчетов
	|ИЗ
	|	ВременнаяТаблицаРасчетыСПоставщиками";

	РезультатЗапроса = Запрос.Выполнить();
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.РасчетыСПоставщиками");
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;
	
	Для каждого КолонкаРезультатЗапроса Из РезультатЗапроса.Колонки Цикл
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных(КолонкаРезультатЗапроса.Имя, КолонкаРезультатЗапроса.Имя);
	КонецЦикла;
	Блокировка.Заблокировать();
	
	РасчетыПроведениеДокументов.ПодготовитьТаблицуВзаиморасчетовСУчетомАвансов(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, Истина);
	
	НомерЗапроса = 0;
	Запрос.Текст = КурсовыеРазницыУНФ.ПолучитьТекстЗапросаКурсовыеРазницыРасчетыСПоставщиками(Запрос.МенеджерВременныхТаблиц, Истина, НомерЗапроса);
	МассивРезультатов = Запрос.ВыполнитьПакет();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаРасчетыСПоставщиками", МассивРезультатов[НомерЗапроса].Выгрузить());
	
КонецПроцедуры

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаДоходыИРасходыОтложенные(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда 
		Запрос.Текст = ТекстЗапросаОтчетКомиссионераДоходыИРасходыОтложенные();
	Иначе
		
		Если СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионера Тогда
			Запрос.Текст = ТекстЗапросаОтчетКомиссионераОПродажахДоходыИРасходыОтложенные();
		Иначе
			Запрос.Текст = ТекстЗапросаОтчетКомиссионераОВозвратахДоходыИРасходыОтложенные();
		КонецЕсли;
		
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("Организация", СтруктураДополнительныеСвойства.ДляПроведения.Организация);
	Запрос.УстановитьПараметр("КассовыйМетодУчетаДоходовИРасходов", СтруктураДополнительныеСвойства.УчетнаяПолитика.КассовыйМетодУчетаДоходовИРасходов);
	Запрос.УстановитьПараметр("ИспользоватьНовуюСхемуДвижений", СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений);
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	
	ТаблицаЗапасыДоходыИРасходыОтложенные = МассивРезультатов[0].Выгрузить();
	
	ТаблицаПредоплатаДоходыИРасходыОтложенные = ТаблицаЗапасыДоходыИРасходыОтложенные.Скопировать(); 
	ТаблицаПредоплатаДоходыИРасходыОтложенные.Очистить(); 
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда 
		
		ВыборкаРезультатаЗапросаОбщая = МассивРезультатов[1].Выгрузить();
		
		// Выполним для продаж
		
		ПараметрыОтбора = Новый Структура("ЭтоВозврат", Ложь);
		
		ВыборкаРезультатаЗапросаПродажи = ВыборкаРезультатаЗапросаОбщая.НайтиСтроки(ПараметрыОтбора);
		
		Для Каждого ВыборкаРезультатаЗапроса Из ВыборкаРезультатаЗапросаПродажи Цикл
			СуммаКСписанию = ВыборкаРезультатаЗапроса.СуммаКСписанию;
			
			ТаблицаЗапасыДоходыИРасходыОтложенныеПродажи = ТаблицаЗапасыДоходыИРасходыОтложенные.НайтиСтроки(ПараметрыОтбора);
			
			Для каждого СтрокаЗапасыДоходыИРасходыОтложенные Из ТаблицаЗапасыДоходыИРасходыОтложенныеПродажи Цикл
				
				Если СуммаКСписанию = 0 Тогда
					Продолжить
				Иначе
					
					Если СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов <= СуммаКСписанию Тогда
						СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
						ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
						СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
						СуммаКСписанию = СуммаКСписанию - СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов;
					ИначеЕсли СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов > СуммаКСписанию Тогда
						СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
						ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
						СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
						СтрокаПредоплатаДоходыИРасходыОтложенные.СуммаДоходов = СуммаКСписанию;
						СуммаКСписанию = 0;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;
		КонецЦикла;
		
		// Выполним для возвратов
		
		ПараметрыОтбора = Новый Структура("ЭтоВозврат", Истина);
		
		ВыборкаРезультатаЗапросаВозвраты = ВыборкаРезультатаЗапросаОбщая.НайтиСтроки(ПараметрыОтбора);
		
		Для Каждого ВыборкаРезультатаЗапроса Из ВыборкаРезультатаЗапросаВозвраты Цикл
			СуммаКСписанию = ВыборкаРезультатаЗапроса.СуммаКСписанию;
			
			ТаблицаЗапасыДоходыИРасходыОтложенныеПродажи = ТаблицаЗапасыДоходыИРасходыОтложенные.НайтиСтроки(ПараметрыОтбора);
			
			Для каждого СтрокаЗапасыДоходыИРасходыОтложенные Из ТаблицаЗапасыДоходыИРасходыОтложенныеПродажи Цикл
				
				Если СуммаКСписанию = 0 Тогда
					Продолжить
				Иначе
					
					Если СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов > СуммаКСписанию Тогда
						СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
						ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
						СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
						СуммаКСписанию = СуммаКСписанию - СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов;
					ИначеЕсли СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов <= СуммаКСписанию Тогда
						СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
						ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
						СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
						СтрокаПредоплатаДоходыИРасходыОтложенные.СуммаДоходов = СуммаКСписанию;
						СуммаКСписанию = 0;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;
		КонецЦикла;
		
	Иначе
		ВыборкаРезультатаЗапроса = МассивРезультатов[1].Выбрать();
		
		Пока ВыборкаРезультатаЗапроса.Следующий() Цикл
			СуммаКСписанию = ВыборкаРезультатаЗапроса.СуммаКСписанию;
			Для каждого СтрокаЗапасыДоходыИРасходыОтложенные Из ТаблицаЗапасыДоходыИРасходыОтложенные Цикл
				
				Если СуммаКСписанию = 0 Тогда
					Продолжить
				Иначе
					
					Если СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионера Тогда
						
						Если СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов <= СуммаКСписанию Тогда
							СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
							ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
							СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
							СуммаКСписанию = СуммаКСписанию - СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов;
						ИначеЕсли СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов > СуммаКСписанию Тогда
							СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
							ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
							СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
							СтрокаПредоплатаДоходыИРасходыОтложенные.СуммаДоходов = СуммаКСписанию;
							СуммаКСписанию = 0;
						КонецЕсли;
						
					Иначе
						
						Если СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов > СуммаКСписанию Тогда
							СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
							ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
							СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
							СуммаКСписанию = СуммаКСписанию - СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов;
						ИначеЕсли СтрокаЗапасыДоходыИРасходыОтложенные.СуммаДоходов <= СуммаКСписанию Тогда
							СтрокаПредоплатаДоходыИРасходыОтложенные = ТаблицаПредоплатаДоходыИРасходыОтложенные.Добавить();
							ЗаполнитьЗначенияСвойств(СтрокаПредоплатаДоходыИРасходыОтложенные, СтрокаЗапасыДоходыИРасходыОтложенные);
							СтрокаПредоплатаДоходыИРасходыОтложенные.Период = ВыборкаРезультатаЗапроса.Период;
							СтрокаПредоплатаДоходыИРасходыОтложенные.СуммаДоходов = СуммаКСписанию;
							СуммаКСписанию = 0;
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;
		КонецЦикла;
		
	КонецЕсли;

	Для каждого СтрокаПредоплатаДоходыИРасходыОтложенные Из ТаблицаПредоплатаДоходыИРасходыОтложенные Цикл
		СтрокаЗапасыДоходыИРасходыОтложенные = ТаблицаЗапасыДоходыИРасходыОтложенные.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаЗапасыДоходыИРасходыОтложенные, СтрокаПредоплатаДоходыИРасходыОтложенные);
		СтрокаЗапасыДоходыИРасходыОтложенные.ВидДвижения = ВидДвиженияНакопления.Расход;
	КонецЦикла;

	ВыборкаРезультатаЗапроса = МассивРезультатов[2].Выбрать();
	
	Если ВыборкаРезультатаЗапроса.Следующий() Тогда
		Статья = ВыборкаРезультатаЗапроса.Статья;
	Иначе
		Статья = Справочники.СтатьиДвиженияДенежныхСредств.ОплатаОтПокупателей;
	КонецЕсли;

	Запрос.Текст =
	"ВЫБРАТЬ
	|	Таблица.НомерСтроки КАК НомерСтроки,
	|	Таблица.Период КАК Период,
	|	Таблица.Организация КАК Организация,
	|	Таблица.Документ КАК Документ,
	|	&Статья КАК Статья,
	|	Таблица.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Таблица.СуммаДоходов КАК СуммаДоходов
	|ПОМЕСТИТЬ ВременнаяТаблицаПредоплатаДоходыИРасходыОтложенные
	|ИЗ
	|	&Таблица КАК Таблица";
	Запрос.УстановитьПараметр("Таблица", ТаблицаПредоплатаДоходыИРасходыОтложенные);
	Запрос.УстановитьПараметр("Статья", Статья);
	
	Запрос.Выполнить();
	
	РасчетыПроведениеДокументов.ОбновитьДатыВТаблицеДоходыРасходыОтложенные(СтруктураДополнительныеСвойства, ТаблицаЗапасыДоходыИРасходыОтложенные);
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаДоходыИРасходыОтложенные", ТаблицаЗапасыДоходыИРасходыОтложенные);
	
КонецПроцедуры // СформироватьТаблицаДоходыИРасходыОтложенные()

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаДоходыИРасходыНераспределенные(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("КассовыйМетодУчетаДоходовИРасходов", СтруктураДополнительныеСвойства.УчетнаяПолитика.КассовыйМетодУчетаДоходовИРасходов);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ТаблицаДокумента.Период КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ТаблицаДокумента.Статья КАК Статья,
	|	ТаблицаДокумента.Сумма КАК СуммаДоходов
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаДоходыИРасходыНераспределенные", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры 

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаДоходыИРасходыКассовыйМетод(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("Организация", СтруктураДополнительныеСвойства.ДляПроведения.Организация);
	Запрос.УстановитьПараметр("МоментВремени", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	Запрос.УстановитьПараметр("КассовыйМетодУчетаДоходовИРасходов", СтруктураДополнительныеСвойства.УчетнаяПолитика.КассовыйМетодУчетаДоходовИРасходов);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаДокумента.ДокументДата КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	ТаблицаДокумента.Статья КАК Статья,
	|	-ТаблицаДокумента.Сумма КАК СуммаДоходов
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Таблица.Период,
	|	Таблица.Организация,
	|	Таблица.НаправлениеДеятельности,
	|	Таблица.Статья,
	|	Таблица.СуммаДоходов
	|ИЗ
	|	ВременнаяТаблицаПредоплатаДоходыИРасходыОтложенные КАК Таблица";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаДоходыИРасходыКассовыйМетод", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры // СформироватьТаблицаДоходыИРасходыКассовыйМетод()

// Формирует таблицу значений, содержащую данные для проведения по регистру "ОплатаДокументов".
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаОплатаДокументов(ДокументСсылка, СтруктураДополнительныеСвойства)
	
	МассивДоступныхОпераций = Неопределено;
	РасчетыПроведениеДокументов.СформироватьТаблицаОплатаДокументовНакладные(ДокументСсылка, СтруктураДополнительныеСвойства, МассивДоступныхОпераций);
	
КонецПроцедуры

Процедура СформироватьТаблицаОплатаСчетовИЗаказов(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Организация", СтруктураДополнительныеСвойства.ДляПроведения.Организация);
	Запрос.УстановитьПараметр("МоментВремени", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ИспользоватьЗаказыВРозничнойТорговле", ПолучитьФункциональнуюОпцию("ИспользоватьЗаказыВРозничнойТорговле"));
		
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаДокумента.Период КАК Период,
	|	&Организация КАК Организация,
	|	ТаблицаДокумента.ЗаказПокупателя КАК СчетНаОплату,
	|	0 КАК СуммаАванса,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения) КАК СуммаОплаты,
	|	ТаблицаДокумента.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	СУММА(ТаблицаДокумента.СуммаНДСВознаграждения) КАК СуммаНДСВознаграждения
	|ПОМЕСТИТЬ ВременнаяТаблицаОплатыСчетов
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&МоментВремени, ) КАК КурсыВалютСчета
	|		ПО ТаблицаДокумента.ЗаказПокупателя.ВалютаДокумента = КурсыВалютСчета.Валюта
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&МоментВремени, ) КАК КурсыВалютКассы
	|		ПО ТаблицаДокумента.ВалютаДокумента = КурсыВалютКассы.Валюта
	|ГДЕ
	|	ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|	И ТаблицаДокумента.ЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И ТаблицаДокумента.ЗаказПокупателя <> НЕОПРЕДЕЛЕНО
	|	И ТИПЗНАЧЕНИЯ(ТаблицаДокумента.ЗаказПокупателя) = ТИП(Документ.ЗаказПокупателя)
	|	И ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И ТаблицаДокумента.СуммаВознаграждения > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.ЗаказПокупателя,
	|	ТаблицаДокумента.СтавкаНДСВознаграждения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаДокумента.Период,
	|	&Организация,
	|	ТаблицаДокумента.ЗаказПокупателя,
	|	0,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	ТаблицаДокумента.СтавкаНДСВознаграждения,
	|	СУММА(ТаблицаДокумента.СуммаНДСВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&МоментВремени, ) КАК КурсыВалютСчета
	|		ПО ТаблицаДокумента.ЗаказПокупателя.ВалютаДокумента = КурсыВалютСчета.Валюта
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(&МоментВремени, ) КАК КурсыВалютКассы
	|		ПО ТаблицаДокумента.ВалютаДокумента = КурсыВалютКассы.Валюта
	|ГДЕ
	|	ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|	И ТаблицаДокумента.ЗаказПокупателя <> ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И ТаблицаДокумента.ЗаказПокупателя <> НЕОПРЕДЕЛЕНО
	|	И ТИПЗНАЧЕНИЯ(ТаблицаДокумента.ЗаказПокупателя) = ТИП(Документ.ЗаказПокупателя)
	|	И ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.ЗаказПокупателя,
	|	ТаблицаДокумента.СтавкаНДСВознаграждения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВременнаяТаблицаОплатыСчетов.Период КАК Период,
	|	ВременнаяТаблицаОплатыСчетов.Организация КАК Организация,
	|	ВременнаяТаблицаОплатыСчетов.СчетНаОплату КАК СчетНаОплату,
	|	ВременнаяТаблицаОплатыСчетов.СуммаАванса КАК СуммаАванса,
	|	ВременнаяТаблицаОплатыСчетов.СуммаОплаты КАК СуммаОплаты,
	|	ВременнаяТаблицаОплатыСчетов.СтавкаНДС КАК СтавкаНДС,
	|	ВременнаяТаблицаОплатыСчетов.СуммаНДСВознаграждения КАК СуммаНДС
	|ИЗ
	|	ВременнаяТаблицаОплатыСчетов КАК ВременнаяТаблицаОплатыСчетов
	|
	|СГРУППИРОВАТЬ ПО
	|	ВременнаяТаблицаОплатыСчетов.Период,
	|	ВременнаяТаблицаОплатыСчетов.Организация,
	|	ВременнаяТаблицаОплатыСчетов.СчетНаОплату,
	|	ВременнаяТаблицаОплатыСчетов.СуммаАванса,
	|	ВременнаяТаблицаОплатыСчетов.СуммаОплаты,
	|	ВременнаяТаблицаОплатыСчетов.СтавкаНДС,
	|	ВременнаяТаблицаОплатыСчетов.СуммаНДСВознаграждения";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаОплатаСчетовИЗаказов", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры

// Формирует таблицу значений, содержащую данные для проведения по регистру.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаРасчетыПоНалогам(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.Период КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.ВидыНалогов.НДС) КАК ВидНалога,
	|	ТаблицаДокумента.СуммаНДС КАК Сумма,
	|	&НачислениеНДСПродажи СодержаниеПроводки
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|ГДЕ
	|	ТаблицаДокумента.СуммаНДС <> 0
	|	И НЕ ТаблицаДокумента.НДСВключатьВСтоимость
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.Период КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.ВидыНалогов.НДС) КАК ВидНалога,
	|	ТаблицаДокумента.СуммаНДС КАК Сумма,
	|	&НачислениеНДСПродажи СодержаниеПроводки
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокумента
	|ГДЕ
	|	&ИспользоватьНовыйВидДокумента
	|	И ТаблицаДокумента.СуммаНДС <> 0
	|	И НЕ ТаблицаДокумента.НДСВключатьВСтоимость";
	
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	Запрос.УстановитьПараметр("НачислениеНДСПродажи", СодержанияПроводок.НачислениеНДСПродажи());
	РезультатЗапроса = Запрос.Выполнить();
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаРасчетыПоНалогам", РезультатЗапроса.Выгрузить());
	
КонецПроцедуры

// Инициализирует таблицы значений, содержащие данные табличных частей документа.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура ИнициализироватьДанныеДокумента(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства) Экспорт
	
	Запрос = Новый Запрос; 
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.Текст = ТекстЗапросаИнициализироватьДанныеДокумента(); 
	
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	Запрос.УстановитьПараметр("ВидОперации", СтруктураДополнительныеСвойства.ВидОперации);
	Запрос.УстановитьПараметр("ДатаНачалаКурса", СтруктураДополнительныеСвойства.ДатаНачалаКурса);
	Запрос.УстановитьПараметр("ДатаОкончанияКурса", СтруктураДополнительныеСвойства.ДатаОкончанияКурса);
	Запрос.УстановитьПараметр("Организация", СтруктураДополнительныеСвойства.ДляПроведения.Организация);
	Запрос.УстановитьПараметр("МоментВремени", Новый Граница(СтруктураДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая));
	Запрос.УстановитьПараметр("ИспользоватьХарактеристики", СтруктураДополнительныеСвойства.УчетнаяПолитика.ИспользоватьХарактеристики);
	Запрос.УстановитьПараметр("ИспользоватьПартии", СтруктураДополнительныеСвойства.УчетнаяПолитика.ИспользоватьПартии);
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	// Прослеживаемость
	Запрос.УстановитьПараметр("ВестиУчетПрослеживаемыхТоваров", СтруктураДополнительныеСвойства.УчетнаяПолитика.ВестиУчетПрослеживаемыхТоваров);
	
	ОтчетКомиссионераЗапасы = РаспределеннаяТаблицаЗапасы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	Запрос.УстановитьПараметр("ОтчетКомиссионераЗапасыРазвернутая", ОтчетКомиссионераЗапасы);
	Запрос.УстановитьПараметр("ИспользоватьСерииНоменклатуры", СтруктураДополнительныеСвойства.УчетнаяПолитика.ИспользоватьСерииНоменклатуры);
	
	ОтчетКомиссионераЗапасыВозвраты = РаспределеннаяТаблицаЗапасы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, "ЗапасыВозвраты"); 
	Запрос.УстановитьПараметр("ОтчетКомиссионераЗапасыВозвраты", ОтчетКомиссионераЗапасыВозвраты); 
	
	Запрос.ВыполнитьПакет(); 
	
	// Формирование проводок документа.
	ПроведениеДокументовУНФ.СформироватьТаблицуПроводок(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	СформироватьТаблицаРасчетыСПокупателями(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда
		СформироватьТаблицаРасчетыСПокупателями(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, "ТаблицаРасчетыСПокупателямиВозвраты");
	КонецЕсли;
	
	СформироватьТаблицаРасчетыСПоставщиками(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	СформироватьТаблицаПродажи(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда
		СформироватьТаблицаПродажи(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, "ТаблицаПродажиВозвраты");
	КонецЕсли;
	
	СформироватьТаблицаЗакупки(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	СформироватьТаблицаЗапасыПереданные(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	СформироватьТаблицаДоходыИРасходы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	СформироватьТаблицаДоходыИРасходыОтложенные(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	СформироватьТаблицаДоходыИРасходыНераспределенные(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	СформироватьТаблицаДоходыИРасходыКассовыйМетод(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда
		СформироватьТаблицаЗапасы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
		СформироватьТаблицаЗапасы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства, Истина);
		
		Если СтруктураДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений Тогда
			СформироватьТаблицаЗапасыРасходы(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
		КонецЕсли;
		
	Иначе
		СформироватьТаблицаЗапасыСтараяВерсия(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	КонецЕсли;
	
	СформироватьТаблицаЗапасыВРазрезеГТД(СтруктураДополнительныеСвойства);
	
	СформироватьТаблицаРасчетыПоНалогам(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	// Прослеживаемость
	ПрослеживаемостьУНФ.СформироватьДвиженияРеализацияТоваров(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	// Конец Прослеживаемость
	
	// Серии номенклатуры
	СформироватьТаблицаСерииНоменклатуры(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	СформироватьТаблицаОплатаДокументов(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	СформироватьТаблицаОплатаСчетовИЗаказов(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
	СформироватьТаблицаУправленческий(ДокументСсылкаОтчетКомиссионера, СтруктураДополнительныеСвойства);
	
КонецПроцедуры // ИнициализироватьДанныеДокумента()

// Возвращает распределенную таблицу Запасы, Отчета комиссионера, по Заказам
//
// Параметры:
//   ДокументСсылкаОтчетКомиссионера - Ссылка или объект документа Отчет комиссионера
//   ДополнительныеСвойства - Структура дополнительных свойств
//   КлючСвязи - Ключ связи строки для распределения
//
// Возвращаемое значение:
//   РаспределеннаяТаблица - Таблица Запасы распределенная по Заказам покупателя
//
Функция РаспределеннаяТаблицаЗапасы(ДокументСсылкаОтчетКомиссионера, ДополнительныеСвойства = Неопределено, ИмяТаблицы = "Запасы") Экспорт 
	
	ИспользоватьНовыйВидДокумента = Не ДополнительныеСвойства = Неопределено И ДополнительныеСвойства.ИспользоватьНовыйВидДокумента; 
	
	Если ИмяТаблицы = "ЗапасыВозвраты" И Не ИспользоватьНовыйВидДокумента Тогда 
		Возврат ДокументСсылкаОтчетКомиссионера[ИмяТаблицы];
	КонецЕсли;
	
	ПараметрыПоискаАвтоРаспределение = Новый Структура("СпособРаспределения", Перечисления.СпособыЗачетаИРаспределенияПлатежей.Авто);
	ЕстьАвтоРаспределение = ДокументСсылкаОтчетКомиссионера[ИмяТаблицы].НайтиСтроки(ПараметрыПоискаАвтоРаспределение).Количество();
	
	Если ЕстьАвтоРаспределение = 0 Тогда
		Возврат ДокументСсылкаОтчетКомиссионера[ИмяТаблицы].Выгрузить();
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
	
	Если ИмяТаблицы = "ЗапасыВозвраты" И ИспользоватьНовыйВидДокумента Тогда 
		ЭтоВозврат = Истина;
	Иначе
		ЭтоВозврат = ?(ДокументСсылкаОтчетКомиссионера.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах, Истина, Ложь);
	КонецЕсли;
	
	Если Не ЭтоВозврат Тогда
		
		Если ДополнительныеСвойства = Неопределено Тогда
			МоментКонтроля = Новый Граница(КонецДня(ДокументСсылкаОтчетКомиссионера.Дата), ВидГраницы.Включая);
		Иначе
			МоментКонтроля = Новый Граница(ДополнительныеСвойства.ДляПроведения.МоментВремени, ВидГраницы.Включая);
		КонецЕсли;
		
		Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(ДокументСсылкаОтчетКомиссионера.Организация));
		Запрос.УстановитьПараметр("Контрагент", ДокументСсылкаОтчетКомиссионера.Контрагент);
		Запрос.УстановитьПараметр("Договор", ДокументСсылкаОтчетКомиссионера.Договор);
		Запрос.УстановитьПараметр("МоментВремени", МоментКонтроля);
		
		Запрос.Текст = ТекстЗапросаРаспределениеОтчетКомиссионераОПродажах();
		ИндексОперации = 0;
		
	Иначе
		Запрос.Текст = ТекстЗапросаРаспределениеОтчетКомиссионераОВозвратах(ИспользоватьНовыйВидДокумента);
		ИндексОперации = 2;
	КонецЕсли;
	
	ВыборкаПакет = Запрос.ВыполнитьПакет();
	
	ТаблицаКРаспределению = ВыборкаПакет[0 + ИндексОперации].Выгрузить();
	ТаблицаРаспределенная = ВыборкаПакет[1 + ИндексОперации].Выгрузить();
	ОстаткиУКомиссионера  = ВыборкаПакет[3 + ИндексОперации].Выгрузить();

	ОтчетКомиссионераЗапасы = ДокументСсылкаОтчетКомиссионера[ИмяТаблицы].Выгрузить();
	
	Если Не ТаблицаКРаспределению.Количество() Тогда
		Возврат ОтчетКомиссионераЗапасы;
	КонецЕсли;
	
	ИспользоватьСерииНоменклатурыОстатки = СерииНоменклатурыУНФ.ИспользоватьСерииНоменклатурыОстатки();
	
	Если ЭтоВозврат Тогда
		ПараметрыОтбораОстатки = Новый Структура("Номенклатура, Характеристика, Партия, ОтчетКомиссионера, КлючСвязи");
		ПараметрыОтбораЗапасы = Новый Структура("Номенклатура, Характеристика, Партия, КлючСвязи");
	Иначе
		ПараметрыОтбораОстатки = Новый Структура("Номенклатура, Характеристика, Партия");
		ПараметрыОтбораЗапасы = Новый Структура("Номенклатура, Характеристика, Партия");
	КонецЕсли;
	
	СтрокиКУдалению = Новый СписокЗначений;
	
	Если ДополнительныеСвойства = Неопределено Тогда
		СтавкаНДСВознаграждения = УправлениеНебольшойФирмойПовтИсп.ПолучитьЗначениеСтавкиНДС(ДокументСсылкаОтчетКомиссионера.СтавкаНДСВознаграждения);
	Иначе
		СтавкаНДСВознаграждения = УправлениеНебольшойФирмойПовтИсп.ПолучитьЗначениеСтавкиНДС(ДополнительныеСвойства.СтавкаНДСВознаграждения);
	КонецЕсли;
	
	СуммаВключаетНДС = ДокументСсылкаОтчетКомиссионера.СуммаВключаетНДС;
	
	Для Каждого СтрокаКРаспределению Из ТаблицаКРаспределению Цикл
		
		ПараметрыОтбораОстатки.Номенклатура = СтрокаКРаспределению.Номенклатура;
		ПараметрыОтбораОстатки.Характеристика = СтрокаКРаспределению.Характеристика;
		ПараметрыОтбораОстатки.Партия = СтрокаКРаспределению.Партия;
		
		ПараметрыОтбораЗапасы.Номенклатура = СтрокаКРаспределению.Номенклатура;
		ПараметрыОтбораЗапасы.Характеристика = СтрокаКРаспределению.Характеристика;
		ПараметрыОтбораЗапасы.Партия = СтрокаКРаспределению.Партия;
		
		Если ЭтоВозврат Тогда
			ПараметрыОтбораОстатки.ОтчетКомиссионера = СтрокаКРаспределению.ОтчетКомиссионера;
			ПараметрыОтбораОстатки.КлючСвязи = СтрокаКРаспределению.КлючСвязи;
			
			ПараметрыОтбораЗапасы.КлючСвязи = СтрокаКРаспределению.КлючСвязи;
		КонецЕсли;
		
		// Если по комбинации есть строки с выбранным Заказом, значит пользователь сознательно
		// оставил эту строку без заказа.
		ЕстьРаспределение = ТаблицаРаспределенная.НайтиСтроки(ПараметрыОтбораОстатки);
		Если ЕстьРаспределение.Количество() > 0 Тогда Продолжить КонецЕсли;
		
		// Если нет доступных остатков в разрезе Заказов, тогда оставляем без изменения
		ДоступныеОстаткиПоНоменклатуре = ОстаткиУКомиссионера.НайтиСтроки(ПараметрыОтбораОстатки);
		Если Не ДоступныеОстаткиПоНоменклатуре.Количество() Тогда Продолжить КонецЕсли;
		
		СтрокиТаблицаЗапасы = ОтчетКомиссионераЗапасы.НайтиСтроки(ПараметрыОтбораЗапасы);
		
		Для Каждого СтрокаТаблицыЗапасы Из СтрокиТаблицаЗапасы Цикл
			
			Коэффициент = ?(ТипЗнч(СтрокаТаблицыЗапасы.ЕдиницаИзмерения) = Тип("СправочникСсылка.ЕдиницыИзмерения"), СтрокаТаблицыЗапасы.ЕдиницаИзмерения.Коэффициент, 1);
			РаспределяемоеКоличествоСтроки = СтрокаТаблицыЗапасы.Количество*Коэффициент;
			РаспределяемоеКоличествоСебестоимость = СтрокаТаблицыЗапасы.Себестоимость;
			РаспределяемаяСуммаПередачи = СтрокаТаблицыЗапасы.СуммаПередачи;
			
			СтавкаНДС = ?(ЗначениеЗаполнено(СтрокаТаблицыЗапасы.СтавкаНДС), СтрокаТаблицыЗапасы.СтавкаНДС.Ставка, 0);
			
			ИндексСтрокиОстатка = 0;
			
			ПолноеРаспределение = Ложь;
			СуммаВознаграждения = СтрокаТаблицыЗапасы.СуммаВознаграждения;
			Для Каждого СтрокаОстатка Из ДоступныеОстаткиПоНоменклатуре Цикл
				
				Если РаспределяемоеКоличествоСтроки <= СтрокаОстатка.Количество Тогда
					
					СтрокаТаблицыЗапасы.ЗаказПокупателя = СтрокаОстатка.ЗаказПокупателя;
					СтрокаТаблицыЗапасы.ЦенаПередачи = Окр(СтрокаОстатка.СуммаРасчетов/СтрокаОстатка.Количество, 2, РежимОкругления.Окр15как20)*Коэффициент;
					СтрокаОстатка.Количество = СтрокаОстатка.Количество - РаспределяемоеКоличествоСтроки;
					
					СтрокаТаблицыЗапасы.СуммаПередачи = Окр(СтрокаТаблицыЗапасы.ЦенаПередачи * СтрокаТаблицыЗапасы.Количество, 2, РежимОкругления.Окр15как20);
					РаспределяемаяСуммаПередачи = РаспределяемаяСуммаПередачи - СтрокаТаблицыЗапасы.СуммаПередачи;
					
					СуммаРасчетовОстаток = СтрокаОстатка.СуммаРасчетов;
					СтрокаОстатка.СуммаРасчетов = СтрокаОстатка.СуммаРасчетов - СтрокаТаблицыЗапасы.СуммаПередачи;
					
					Если СтрокаОстатка.СуммаРасчетов <= 0.1 Тогда
						СтрокаТаблицыЗапасы.СуммаПередачи = СуммаРасчетовОстаток;
						РаспределяемаяСуммаПередачи = 0;
					КонецЕсли;
					
					Если СтрокаОстатка.Количество = 0 Тогда 
						СтрокиКУдалению.Добавить(ИндексСтрокиОстатка) 
					КонецЕсли;
					
					ПолноеРаспределение = Истина;
					
					СтрокаТаблицыЗапасы.СуммаВознаграждения = СуммаВознаграждения;
					СтрокаТаблицыЗапасы.СуммаНДСВознаграждения = ?(СуммаВключаетНДС,
													СтрокаТаблицыЗапасы.СуммаВознаграждения - (СтрокаТаблицыЗапасы.СуммаВознаграждения) / ((СтавкаНДСВознаграждения + 100) / 100),
													СтрокаТаблицыЗапасы.СуммаВознаграждения * СтавкаНДСВознаграждения / 100); 
					
					Прервать;
					
				КонецЕсли;
				
				Если Не СтрокаОстатка.Количество > 0 Тогда
					Продолжить
				КонецЕсли;
				
				НоваяСтрока = ОтчетКомиссионераЗапасы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицыЗапасы);
				
				НоваяСтрока.СуммаВознаграждения = СуммаВознаграждения;
				
				ЕдиницаСебестоимости = ?(РаспределяемоеКоличествоСебестоимость <= 0, 0, РаспределяемоеКоличествоСебестоимость / НоваяСтрока.Количество);
				
				НоваяСтрока.Количество = СтрокаОстатка.Количество/Коэффициент;
				НоваяСтрока.СпособРаспределения = Перечисления.СпособыЗачетаИРаспределенияПлатежей.Авто;
				
				НоваяСтрока.Себестоимость = ЕдиницаСебестоимости * НоваяСтрока.Количество;
				РаспределяемоеКоличествоСебестоимость = РаспределяемоеКоличествоСебестоимость - НоваяСтрока.Себестоимость;
				
				СтрокиКУдалению.Добавить(ИндексСтрокиОстатка);
				НоваяСтрока.ЗаказПокупателя = СтрокаОстатка.ЗаказПокупателя;
				
				РаспределяемоеКоличествоСтроки = РаспределяемоеКоличествоСтроки - НоваяСтрока.Количество*Коэффициент;
				
				СтрокаТаблицыЗапасы.Количество = РаспределяемоеКоличествоСтроки/Коэффициент;
				
				РаботаСКомиссионерамиКомитентамиСервер.РассчитатьСуммуВСтрокеТабличнойЧастиЗапасыОтчетКомиссионера(ДокументСсылкаОтчетКомиссионера, ИспользоватьСерииНоменклатурыОстатки, СтрокаТаблицыЗапасы);
				РаботаСКомиссионерамиКомитентамиСервер.РассчитатьСуммуВСтрокеТабличнойЧастиЗапасыОтчетКомиссионера(ДокументСсылкаОтчетКомиссионера, ИспользоватьСерииНоменклатурыОстатки, НоваяСтрока);
				
				СтрокаТаблицыЗапасы.ЦенаПередачи = Окр(СтрокаОстатка.СуммаРасчетов/СтрокаОстатка.Количество, 2, РежимОкругления.Окр15как20)*Коэффициент;
				СтрокаТаблицыЗапасы.СуммаПередачи = Окр(СтрокаТаблицыЗапасы.ЦенаПередачи * СтрокаТаблицыЗапасы.Количество, 2, РежимОкругления.Окр15как20);
				
				СтрокаОстатка.Количество = 0;
				
				СтрокаТаблицыЗапасы.СуммаНДСПередачи = ?(СуммаВключаетНДС,
				СтрокаТаблицыЗапасы.СуммаПередачи - (СтрокаТаблицыЗапасы.СуммаПередачи) / ((СтавкаНДС + 100) / 100),
				СтрокаТаблицыЗапасы.СуммаПередачи * СтавкаНДС / 100);
				
				НоваяСтрока.ЦенаПередачи = ?(НоваяСтрока.ЦенаПередачи = 0, СтрокаТаблицыЗапасы.ЦенаПередачи, НоваяСтрока.ЦенаПередачи);
				СуммаПередачи = Окр(НоваяСтрока.ЦенаПередачи * НоваяСтрока.Количество, 2, РежимОкругления.Окр15как20);
				НоваяСтрока.СуммаПередачи = ?(СуммаПередачи > СтрокаОстатка.СуммаРасчетов, СтрокаОстатка.СуммаРасчетов, СуммаПередачи);
				
				РаспределяемаяСуммаПередачи = РаспределяемаяСуммаПередачи - НоваяСтрока.СуммаПередачи;
				
				НоваяСтрока.СуммаНДСПередачи = ?(СуммаВключаетНДС,
				НоваяСтрока.СуммаПередачи - (НоваяСтрока.СуммаПередачи) / ((СтавкаНДС + 100) / 100),
				НоваяСтрока.СуммаПередачи * СтавкаНДС / 100);
				
				РаботаСКомиссионерамиКомитентамиСервер.РассчитатьКомиссионноеВознаграждениеЗапасыОтчетКомиссионера(ДокументСсылкаОтчетКомиссионера, СтрокаТаблицыЗапасы);
				
				Если НоваяСтрока.СуммаВознаграждения > НоваяСтрока.Сумма Тогда
					НоваяСтрока.СуммаВознаграждения = НоваяСтрока.Сумма;
				Иначе
					НоваяСтрока.СуммаВознаграждения = СуммаВознаграждения
				КонецЕсли;
				
				НоваяСтрока.СуммаНДСВознаграждения = ?(СуммаВключаетНДС,
				НоваяСтрока.СуммаВознаграждения - (НоваяСтрока.СуммаВознаграждения) / ((СтавкаНДСВознаграждения + 100) / 100),
				НоваяСтрока.СуммаВознаграждения * СтавкаНДСВознаграждения / 100);
					
				СуммаВознаграждения = СуммаВознаграждения - НоваяСтрока.СуммаВознаграждения;
				
				РаботаСКомиссионерамиКомитентамиСервер.РассчитатьКомиссионноеВознаграждениеЗапасыОтчетКомиссионера(ДокументСсылкаОтчетКомиссионера, НоваяСтрока);
				
				ИндексСтрокиОстатка = ИндексСтрокиОстатка + 1;
				
			КонецЦикла;
			
			Если РаспределяемаяСуммаПередачи > 0 И Не ПолноеРаспределение Тогда
				СтрокаТаблицыЗапасы.СуммаПередачи = СтрокаТаблицыЗапасы.СуммаПередачи + РаспределяемаяСуммаПередачи;
				
				СтрокаТаблицыЗапасы.СуммаНДСПередачи = ?(СуммаВключаетНДС,
				СтрокаТаблицыЗапасы.СуммаПередачи - (СтрокаТаблицыЗапасы.СуммаПередачи) / ((СтавкаНДС + 100) / 100),
				СтрокаТаблицыЗапасы.СуммаПередачи * СтавкаНДС / 100);
				
				РаспределяемаяСуммаПередачи = 0;
			КонецЕсли;
			
			СтрокиКУдалению.СортироватьПоЗначению(НаправлениеСортировки.Убыв);
			
			Если СтрокиКУдалению.Количество() Тогда
				Для Каждого СтрокаКУдалению Из СтрокиКУдалению Цикл
					ДоступныеОстаткиПоНоменклатуре.Удалить(СтрокаКУдалению.Значение)
				КонецЦикла;
				СтрокиКУдалению.Очистить();
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат ОтчетКомиссионераЗапасы;
	
КонецФункции

Функция ТекстЗапросаИнициализироватьДанныеДокумента()
	ЗапросТекст =
	"ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Договор.ЭтоДоговорОбслуживания
	|				И ОтчетКомиссионера.Договор.ДоговорОбслуживанияНаправлениеДеятельности <> ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВестиУчетРасходовПоДоговорамОбслуживания,
	|	ОтчетКомиссионера.Договор.ДоговорОбслуживанияНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ОтчетКомиссионера.Контрагент КАК Контрагент,
	|	ОтчетКомиссионера.Дата КАК Дата,
	|	ОтчетКомиссионера.Договор КАК Договор,
	|	ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ОтчетКомиссионера.Подразделение КАК Подразделение,
	|	ОтчетКомиссионера.Ответственный КАК Ответственный,
	|	ОтчетКомиссионера.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ОтчетКомиссионера.ВалютаДокумента КАК ВалютаДокумента,
	|	ОтчетКомиссионера.Курс КАК Курс,
	|	ОтчетКомиссионера.Кратность КАК Кратность,
	|	ОтчетКомиссионера.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ОтчетКомиссионера.Проект КАК Проект,
	|	ОтчетКомиссионера.ВидОперации КАК ВидОперации,
	|	ОтчетКомиссионера.Ссылка КАК Ссылка,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И ОтчетКомиссионера.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионера
	|				И ОтчетКомиссионера.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионера.ДокументОснование
	|		КОГДА &ИспользоватьНовыйВидДокумента
	|				И ОтчетКомиссионера.ДокументОснование ССЫЛКА Документ.ОтчетКомиссионера
	|				И ОтчетКомиссионера.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионера.ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорректируемыйДокумент,
	|	ОтчетКомиссионера.Договор.УслугаКомиссионногоВознаграждения КАК УслугаКомиссионногоВознаграждения,
	|	ОтчетКомиссионера.СтавкаНДСВознаграждения КАК СтавкаНДСВознаграждения,
	|	ОтчетКомиссионера.СуммаВознаграждения КАК СуммаВознаграждения,
	|	ОтчетКомиссионера.Контрагент.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ОтчетКомиссионера.Договор.ДоговорУслугиКомиссионногоВознаграждения КАК ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ОтчетКомиссионера.Номер КАК Номер,
	|	ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений КАК ИспользоватьНовуюСхемуДвижений
	|ПОМЕСТИТЬ ВременнаяТаблицаШапка
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
	|ГДЕ
	|	ОтчетКомиссионера.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&Ссылка КАК Ссылка,
	|	ОтчетКомиссионераЗапасы.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.Количество * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Количество
	|	КОНЕЦ КАК Количество,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ОтчетКомиссионераЗапасы.Цена КАК Цена,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.Сумма * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Сумма
	|	КОНЕЦ КАК Сумма,
	|	ОтчетКомиссионераЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.СуммаНДС * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДС
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.Всего * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Всего
	|	КОНЕЦ КАК Всего,
	|	ОтчетКомиссионераЗапасы.ЦенаПередачи КАК ЦенаПередачи,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.СуммаПередачи * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаПередачи
	|	КОНЕЦ КАК СуммаПередачи,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСПередачи * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСПередачи
	|	КОНЕЦ КАК СуммаНДСПередачи,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаВознаграждения
	|	КОНЕЦ КАК СуммаВознаграждения,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * -1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения
	|	КОНЕЦ КАК СуммаНДСВознаграждения,
	|	ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ОтчетКомиссионераЗапасы.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость,
	|	ОтчетКомиссионераЗапасы.КлючСвязиСерииНоменклатуры КАК КлючСвязиСерииНоменклатуры,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ОтчетКомиссионераЗапасы.НомерГТД КАК НомерГТД,
	|	ОтчетКомиссионераЗапасы.ПрямоеСписаниеГТД КАК ПрямоеСписаниеГТД,
	|	ОтчетКомиссионераЗапасы.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераЗапасы.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ОтчетКомиссионераЗапасы.КодТНВЭД КАК КодТНВЭД
	|ПОМЕСТИТЬ ОтчетКомиссионераЗапасы
	|ИЗ
	|	&ОтчетКомиссионераЗапасыРазвернутая КАК ОтчетКомиссионераЗапасы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДанныеПроизводственногоКалендаря.Дата КАК ДатаКалендаря
	|ПОМЕСТИТЬ ПроизводственныйКалендарь
	|ИЗ
	|	РегистрСведений.ДанныеПроизводственногоКалендаря КАК ДанныеПроизводственногоКалендаря
	|ГДЕ
	|	ДанныеПроизводственногоКалендаря.Дата МЕЖДУ &ДатаНачалаКурса И &ДатаОкончанияКурса
	|	И (&ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|			ИЛИ &ИспользоватьНовыйВидДокумента)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПроизводственныйКалендарь.ДатаКалендаря КАК Период,
	|	КурсыВалют.Валюта КАК Валюта,
	|	КурсыВалют.Курс КАК Курс,
	|	КурсыВалют.Кратность КАК Кратность
	|ПОМЕСТИТЬ КурсыУпрВалютПоДатам
	|ИЗ
	|	РегистрСведений.КурсыВалют КАК КурсыВалют
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПроизводственныйКалендарь КАК ПроизводственныйКалендарь
	|		ПО КурсыВалют.Период <= ПроизводственныйКалендарь.ДатаКалендаря
	|ГДЕ
	|	КурсыВалют.Период В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				КурсыВалютВыборка.Период
	|			ИЗ
	|				РегистрСведений.КурсыВалют КАК КурсыВалютВыборка
	|			ГДЕ
	|				КурсыВалютВыборка.Период <= ПроизводственныйКалендарь.ДатаКалендаря
	|				И КурсыВалютВыборка.Валюта = КурсыВалют.Валюта
	|			УПОРЯДОЧИТЬ ПО
	|				КурсыВалютВыборка.Период УБЫВ)
	|	И КурсыВалют.Валюта В
	|			(ВЫБРАТЬ
	|				КонстантаВалютаУчета.Значение
	|			ИЗ
	|				Константа.ВалютаУчета КАК КонстантаВалютаУчета)
	|	И (&ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|			ИЛИ &ИспользоватьНовыйВидДокумента)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасы.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераЗапасы.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераЗапасы.КлючСвязиСерииНоменклатуры КАК КлючСвязиСерииНоменклатуры,
	|	ОтчетКомиссионераЗапасы.Ссылка КАК Документ,
	|	ВременнаяТаблицаШапка.Дата КАК Период,
	|	&Организация КАК Организация,
	|	ВременнаяТаблицаШапка.Контрагент КАК Контрагент,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиРасчетыПоДоговорам КАК ВестиРасчетыПоДоговорам,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиРасчетыПоЗаказам КАК ВестиРасчетыПоЗаказам,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиУчетОплатыПоСчетам КАК ВестиУчетОплатыПоСчетам,
	|	ВременнаяТаблицаШапка.Контрагент.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|	ВременнаяТаблицаШапка.Договор.ВалютаРасчетов КАК ВалютаРасчетов,
	|	ВременнаяТаблицаШапка.Договор КАК Договор,
	|	ВременнаяТаблицаШапка.Контрагент КАК СтруктурнаяЕдиница,
	|	ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПриемаПередачиТоваров.ПередачаКомиссионеру) КАК ТипПриемаПередачи,
	|	ВременнаяТаблицаШапка.Подразделение КАК ПодразделениеПродажи,
	|	ВременнаяТаблицаШапка.Ответственный КАК Ответственный,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|			ТОГДА ВременнаяТаблицаШапка.НаправлениеДеятельности
	|		ИНАЧЕ НоменклатураЗапасов.НаправлениеДеятельности
	|	КОНЕЦ КАК НаправлениеДеятельностиПродажи,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|			ТОГДА ВременнаяТаблицаШапка.НаправлениеДеятельности.СчетУчетаВыручкиОтПродаж
	|		ИНАЧЕ НоменклатураЗапасов.НаправлениеДеятельности.СчетУчетаВыручкиОтПродаж
	|	КОНЕЦ КАК СчетУчетаПродажи,
	|	ВЫБОР
	|		КОГДА НоменклатураЗапасов.СчетУчетаНДСПоРеализации = ЗНАЧЕНИЕ(ПланСчетов.Управленческий.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Управленческий.Продажи_НДС)
	|		ИНАЧЕ НоменклатураЗапасов.СчетУчетаНДСПоРеализации
	|	КОНЕЦ КАК СчетУчетаНДСПоРеализации,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|			ТОГДА ВременнаяТаблицаШапка.НаправлениеДеятельности.СчетУчетаСебестоимостиПродаж
	|		ИНАЧЕ НоменклатураЗапасов.НаправлениеДеятельности.СчетУчетаСебестоимостиПродаж
	|	КОНЕЦ КАК СчетУчетаСебестоимость,
	|	НоменклатураЗапасов.СчетУчетаЗапасов КАК СчетУчета,
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасы.НомерГТД КАК НомерГТД,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА &ИспользоватьХарактеристики
	|			ТОГДА ОтчетКомиссионераЗапасы.Характеристика
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК Характеристика,
	|	ВЫБОР
	|		КОГДА &ИспользоватьПартии
	|			ТОГДА ОтчетКомиссионераЗапасы.Партия
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПартииНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК Партия,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ОтчетКомиссионераЗапасы.ЕдиницаИзмерения) = ТИП(Справочник.КлассификаторЕдиницИзмерения)
	|			ТОГДА ОтчетКомиссионераЗапасы.Количество
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Количество * ЕдиницыИзмерения.Коэффициент
	|	КОНЕЦ КАК Количество,
	|	ВременнаяТаблицаШапка.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ОтчетКомиссионераЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасы.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ОтчетКомиссионераЗапасы.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасы.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСПродажи,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ОтчетКомиссионераЗапасы.Всего * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ ОтчетКомиссионераЗапасы.Всего * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасы.Всего * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.Всего * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК Сумма,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасы.СуммаНДС * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДС
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаНДСВал,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионераЗапасы.Всего * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|			ИНАЧЕ ОтчетКомиссионераЗапасы.Всего
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаВал,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионераЗапасы.Всего
	|			ИНАЧЕ ОтчетКомиссионераЗапасы.Всего * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаРег,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СебестоимостьНДС,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСРег,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ВЫБОР
	|									КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|										ТОГДА ОтчетКомиссионераЗапасы.СуммаПередачи * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|									ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаПередачи + ОтчетКомиссионераЗапасы.СуммаНДСПередачи) * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								КОНЕЦ
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаПередачи + ОтчетКомиссионераЗапасы.СуммаНДСПередачи) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаПередачи * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаПередачи + ОтчетКомиссионераЗапасы.СуммаНДСПередачи) * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							КОНЕЦ
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|								ТОГДА ОтчетКомиссионераЗапасы.СуммаПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|							ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаПередачи + ОтчетКомиссионераЗапасы.СуммаНДСПередачи) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК Себестоимость,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСВознаграждения,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСВознагражденияВал,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ВЫБОР
	|									КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|										ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|									ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения) * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								КОНЕЦ
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения) * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							КОНЕЦ
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|								ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|							ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаВознаграждения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|							ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения) * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|					КОНЕЦ
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|						ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаВознагражденияВал,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|							ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения
	|						ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения
	|					КОНЕЦ
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|						ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|					ИНАЧЕ (ОтчетКомиссионераЗапасы.СуммаВознаграждения + ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения) * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаВознагражденияРег,
	|	ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|				ТОГДА ОтчетКомиссионераЗапасы.СуммаПередачи
	|			ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаПередачи + ОтчетКомиссионераЗапасы.СуммаНДСПередачи
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаРасчетовПринятыеПереданные,
	|	ОтчетКомиссионераЗапасы.ПрямоеСписаниеГТД КАК ПрямоеСписаниеГТД,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК РучнаяСебестоимость,
	|	ВременнаяТаблицаШапка.Проект КАК Проект,
	|	ОтчетКомиссионераЗапасы.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераЗапасы.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ОтчетКомиссионераЗапасы.КодТНВЭД КАК КодТНВЭД,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ NULL
	|	КОНЕЦ КАК КорректируемыйДокумент,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ЕСТЬNULL(ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений, ЛОЖЬ) КАК ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Договор.УслугаКомиссионногоВознаграждения
	|		ИНАЧЕ ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения
	|	КОНЕЦ КАК УслугаКомиссионногоВознаграждения,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера.СтавкаНДСВознаграждения
	|		ИНАЧЕ ВременнаяТаблицаШапка.СтавкаНДСВознаграждения
	|	КОНЕЦ КАК СтавкаНДСВознаграждения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|			ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаНДСВознагражденияДляУслуги,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоВозврат,
	|	ВременнаяТаблицаШапка.Контрагент.СчетУчетаРасчетовСПоставщиком КАК СчетУчетаРасчетовСПоставщиком,
	|	ВременнаяТаблицаШапка.ДоговорДоговорУслугиКомиссионногоВознаграждения КАК ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат КАК СчетУчетаЗатрат,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение КАК ОтчетКомиссионераУдержатьКомиссионноеВознаграждение,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат.ТипСчета КАК СчетУчетаЗатратТипСчета,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям = ЗНАЧЕНИЕ(ПланСчетов.Управленческий.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Управленческий.НДСПоПриобретеннымЦенностям)
	|		ИНАЧЕ ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям
	|	КОНЕЦ КАК СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ВременнаяТаблицаШапка.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ ВременнаяТаблицаЗапасы
	|ИЗ
	|	ОтчетКомиссионераЗапасы КАК ОтчетКомиссионераЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаВалютаУчета.Значение
	|					ИЗ
	|						Константа.ВалютаУчета КАК КонстантаВалютаУчета)) КАК КурсыУпрВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаНациональнаяВалюта.Значение
	|					ИЗ
	|						Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта)) КАК КурсыРегВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК НоменклатураЗапасов
	|		ПО ОтчетКомиссионераЗапасы.Номенклатура = НоменклатураЗапасов.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
	|		ПО ОтчетКомиссионераЗапасы.ЕдиницаИзмерения = ЕдиницыИзмерения.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|			ЛЕВОЕ СОЕДИНЕНИЕ КурсыУпрВалютПоДатам КАК КурсыУпрВалютПоДатам
	|			ПО (НАЧАЛОПЕРИОДА(ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Дата, ДЕНЬ) = КурсыУпрВалютПоДатам.Период)
	|		ПО ОтчетКомиссионераЗапасы.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи,
	|	Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	1 КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ВременнаяТаблицаШапка.Дата КАК Период,
	|	ВременнаяТаблицаШапка.Ссылка КАК Документ,
	|	ВременнаяТаблицаШапка.ВидОперации КАК ВидОперации,
	|	&Организация КАК Организация,
	|	ВременнаяТаблицаШапка.Подразделение КАК СтруктурнаяЕдиница,
	|	ВременнаяТаблицаШапка.ВалютаДокумента КАК Валюта,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат КАК СчетУчета,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения КАК Номенклатура,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК ЗапасыНоменклатура,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.ПартииНоменклатуры.ПустаяСсылка) КАК Партия,
	|	НЕОПРЕДЕЛЕНО КАК Заказ,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказПоставщику,
	|	1 КАК Количество,
	|	ВременнаяТаблицаШапка.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	СУММА(ВЫРАЗИТЬ(ВЫБОР
	|				КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|					ТОГДА ОтчетКомиссионераЗапасы.СуммаВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|				ИНАЧЕ ОтчетКомиссионераЗапасы.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК Сумма,
	|	ЛОЖЬ КАК ВключатьРасходыВСебестоимость,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат.ТипСчета КАК ТипСчета,
	|	СУММА(ВЫРАЗИТЬ(ВЫБОР
	|				КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|					ТОГДА ОтчетКомиссионераЗапасы.Всего * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|				ИНАЧЕ ОтчетКомиссионераЗапасы.Всего
	|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК СуммаВал,
	|	СУММА(ВЫРАЗИТЬ(ВЫБОР
	|				КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|					ТОГДА ОтчетКомиссионераЗапасы.Всего
	|				ИНАЧЕ ОтчетКомиссионераЗапасы.Всего * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК СуммаРег,
	|	ВременнаяТаблицаШапка.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ВременнаяТаблицаШапка.Контрагент КАК Контрагент,
	|	ВременнаяТаблицаШапка.Дата КАК Дата,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение КАК ОтчетКомиссионераУдержатьКомиссионноеВознаграждение,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоВозврат,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений КАК ИспользоватьНовуюСхемуДвижений
	|ПОМЕСТИТЬ ВременнаяТаблицаРасходы
	|ИЗ
	|	Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка,
	|	ОтчетКомиссионераЗапасы КАК ОтчетКомиссионераЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаВалютаУчета.Значение
	|					ИЗ
	|						Константа.ВалютаУчета КАК КонстантаВалютаУчета)) КАК КурсыУпрВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаНациональнаяВалюта.Значение
	|					ИЗ
	|						Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта)) КАК КурсыРегВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|		ПО ОтчетКомиссионераЗапасы.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ВременнаяТаблицаШапка.ВидОперации,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения,
	|	ВременнаяТаблицаШапка.Дата,
	|	ВременнаяТаблицаШапка.Ссылка,
	|	ВременнаяТаблицаШапка.Подразделение,
	|	ВременнаяТаблицаШапка.ВалютаДокумента,
	|	ВременнаяТаблицаШапка.СтавкаНДСВознаграждения,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат.ТипСчета,
	|	ВременнаяТаблицаШапка.ВестиРасчетыПоДокументам,
	|	ВременнаяТаблицаШапка.Контрагент,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера,
	|	ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений,
	|	ВременнаяТаблицаШапка.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ОтчетКомиссионераЗапасы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки) КАК НомерСтроки,
	|	ТаблицаДокумента.Ссылка.Дата КАК Период,
	|	&Организация КАК Организация,
	|	ТаблицаДокумента.Ссылка.Контрагент КАК Контрагент,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДоговорам КАК ВестиРасчетыПоДоговорам,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоЗаказам КАК ВестиРасчетыПоЗаказам,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиУчетОплатыПоСчетам КАК ВестиУчетОплатыПоСчетам,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаАвансовПокупателя КАК СчетУчетаАвансовПокупателя,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаРасчетовСПоставщиком КАК СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаАвансовПоставщику КАК СчетУчетаАвансовПоставщику,
	|	ТаблицаДокумента.Ссылка.Договор КАК Договор,
	|	ТаблицаДокумента.Ссылка.Договор.ВалютаРасчетов КАК ВалютаРасчетов,
	|	ВЫБОР
	|		КОГДА НЕ ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДокументам
	|				ИЛИ ТИПЗНАЧЕНИЯ(ТаблицаДокумента.Документ) = ТИП(Документ.Взаимозачет)
	|				ИЛИ ТИПЗНАЧЕНИЯ(ТаблицаДокумента.Документ) = ТИП(Документ.ЧекККМ)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ОплатаОтПокупателей)
	|		ИНАЧЕ ТаблицаДокумента.Документ.Статья
	|	КОНЕЦ КАК Статья,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ.Дата
	|		ИНАЧЕ ТаблицаДокумента.Ссылка.Дата
	|	КОНЕЦ КАК ДокументДата,
	|	ТаблицаДокумента.Заказ КАК Заказ,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.Прочее) КАК НаправлениеДеятельностиПродажи,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс) КАК ТипРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг) КАК ТипРасчетовКуда,
	|	&Ссылка КАК ДокументКуда,
	|	ТаблицаДокумента.Документ КАК Документ,
	|	СУММА(ВЫБОР
	|			КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|						И НЕ &ИспользоватьНовыйВидДокумента
	|					ИЛИ НЕ ТаблицаДокумента.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				ТОГДА -1 * (ВЫРАЗИТЬ(ТаблицаДокумента.СуммаРасчетов * ТаблицаДокумента.Курс * КурсыВалютУчетаСрезПоследних.Кратность / (КурсыВалютУчетаСрезПоследних.Курс * ТаблицаДокумента.Кратность) КАК ЧИСЛО(15, 2)))
	|			ИНАЧЕ ВЫРАЗИТЬ(ТаблицаДокумента.СуммаРасчетов * ТаблицаДокумента.Курс * КурсыВалютУчетаСрезПоследних.Кратность / (КурсыВалютУчетаСрезПоследних.Курс * ТаблицаДокумента.Кратность) КАК ЧИСЛО(15, 2))
	|		КОНЕЦ) КАК Сумма,
	|	СУММА(ВЫБОР
	|			КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|						И НЕ &ИспользоватьНовыйВидДокумента
	|					ИЛИ НЕ ТаблицаДокумента.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				ТОГДА ТаблицаДокумента.СуммаРасчетов * -1
	|			ИНАЧЕ ТаблицаДокумента.СуммаРасчетов
	|		КОНЕЦ) КАК СуммаВал,
	|	СУММА(ВЫБОР
	|			КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|						И НЕ &ИспользоватьНовыйВидДокумента
	|					ИЛИ НЕ ТаблицаДокумента.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.Ссылка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ТаблицаДокумента.СуммаРасчетов * -1
	|						ИНАЧЕ -1 * (ВЫРАЗИТЬ(ТаблицаДокумента.СуммаРасчетов * ТаблицаДокумента.Курс / ТаблицаДокумента.Кратность КАК ЧИСЛО(15, 2)))
	|					КОНЕЦ
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ТаблицаДокумента.Ссылка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ТаблицаДокумента.СуммаРасчетов
	|					ИНАЧЕ ВЫРАЗИТЬ(ТаблицаДокумента.СуммаРасчетов * ТаблицаДокумента.Курс / ТаблицаДокумента.Кратность КАК ЧИСЛО(15, 2))
	|				КОНЕЦ
	|		КОНЕЦ) КАК СуммаРег,
	|	ТаблицаДокумента.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ТаблицаДокумента.ВидЗачетаПредоплаты КАК ВидЗачетаПредоплаты
	|ПОМЕСТИТЬ ВременнаяТаблицаПредоплата
	|ИЗ
	|	Документ.ОтчетКомиссионера.Предоплата КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаВалютаУчета.Значение
	|					ИЗ
	|						Константа.ВалютаУчета КАК КонстантаВалютаУчета)) КАК КурсыВалютУчетаСрезПоследних
	|		ПО (ИСТИНА),
	|	Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта
	|ГДЕ
	|	ТаблицаДокумента.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Ссылка,
	|	ТаблицаДокумента.Документ,
	|	ТаблицаДокумента.Ссылка.Дата,
	|	ТаблицаДокумента.Ссылка.Контрагент,
	|	ТаблицаДокумента.Ссылка.Договор,
	|	ТаблицаДокумента.Заказ,
	|	ТаблицаДокумента.Ссылка.Договор.ВалютаРасчетов,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаАвансовПокупателя,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаРасчетовСПоставщиком,
	|	ТаблицаДокумента.Ссылка.Контрагент.СчетУчетаАвансовПоставщику,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ.Дата
	|		ИНАЧЕ ТаблицаДокумента.Ссылка.Дата
	|	КОНЕЦ,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДоговорам,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоЗаказам,
	|	ТаблицаДокумента.Ссылка.Контрагент.ВестиУчетОплатыПоСчетам,
	|	ТаблицаДокумента.ОтчетКомиссионера,
	|	ВЫБОР
	|		КОГДА НЕ ТаблицаДокумента.Ссылка.Контрагент.ВестиРасчетыПоДокументам
	|				ИЛИ ТИПЗНАЧЕНИЯ(ТаблицаДокумента.Документ) = ТИП(Документ.Взаимозачет)
	|				ИЛИ ТИПЗНАЧЕНИЯ(ТаблицаДокумента.Документ) = ТИП(Документ.ЧекККМ)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтатьиДвиженияДенежныхСредств.ОплатаОтПокупателей)
	|		ИНАЧЕ ТаблицаДокумента.Документ.Статья
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВидЗачетаПредоплаты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераСерииНоменклатуры.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераСерииНоменклатуры.Серия КАК Серия,
	|	ОтчетКомиссионераСерииНоменклатуры.Количество КАК Количество
	|ПОМЕСТИТЬ ВременнаяТаблицаСерииНоменклатуры
	|ИЗ
	|	Документ.ОтчетКомиссионера.СерииНоменклатуры КАК ОтчетКомиссионераСерииНоменклатуры
	|ГДЕ
	|	ОтчетКомиссионераСерииНоменклатуры.Ссылка = &Ссылка
	|	И &ИспользоватьСерииНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераПокупатели.Ссылка КАК Ссылка,
	|	ОтчетКомиссионераПокупатели.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераПокупатели.Покупатель КАК Покупатель,
	|	ОтчетКомиссионераПокупатели.Всего КАК Всего,
	|	ОтчетКомиссионераПокупатели.ВыставленСФ КАК ВыставленСФ,
	|	ОтчетКомиссионераПокупатели.ДатаСФ КАК ДатаСФ,
	|	ОтчетКомиссионераПокупатели.СчетФактура КАК СчетФактура,
	|	ОтчетКомиссионераПокупатели.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера
	|ПОМЕСТИТЬ ВременнаяТаблицаПокупатели
	|ИЗ
	|	Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|	КОНЕЦ КАК ОтчетКомиссионера
	|ПОМЕСТИТЬ ВременнаяТаблицаПокупателиДокументыВозврата
	|ИЗ
	|	Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ОтчетКомиссионераСведенияПрослеживаемости.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.РНПТ КАК РНПТ,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА -ОтчетКомиссионераСведенияПрослеживаемости.Количество
	|		ИНАЧЕ ОтчетКомиссионераСведенияПрослеживаемости.Количество
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА -ОтчетКомиссионераСведенияПрослеживаемости.КоличествоПрослеживаемости
	|		ИНАЧЕ ОтчетКомиссионераСведенияПрослеживаемости.КоличествоПрослеживаемости
	|	КОНЕЦ КАК КоличествоПрослеживаемости,
	|	ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.Номенклатура КАК Комплектующие,
	|	ВЫБОР
	|		КОГДА &ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|				И НЕ &ИспользоватьНовыйВидДокумента
	|			ТОГДА -ОтчетКомиссионераСведенияПрослеживаемости.Сумма
	|		ИНАЧЕ ОтчетКомиссионераСведенияПрослеживаемости.Сумма
	|	КОНЕЦ КАК Сумма,
	|	ОтчетКомиссионераСведенияПрослеживаемости.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ ТаблицаСведенияПрослеживаемости
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.СведенияПрослеживаемости КАК ОтчетКомиссионераСведенияПрослеживаемости
	|		ПО ОтчетКомиссионераЗапасы.ИдентификаторСтроки = ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки
	|ГДЕ
	|	&ВестиУчетПрослеживаемыхТоваров
	|	И ОтчетКомиссионераСведенияПрослеживаемости.Ссылка = &Ссылка
	|	И ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСведенияПрослеживаемости.ВидДвижения КАК ВидДвижения,
	|	ТаблицаСведенияПрослеживаемости.НомерСтроки КАК НомерСтроки,
	|	ТаблицаСведенияПрослеживаемости.РНПТ КАК РНПТ,
	|	ТаблицаСведенияПрослеживаемости.Количество КАК Количество,
	|	ТаблицаСведенияПрослеживаемости.КоличествоПрослеживаемости КАК КоличествоПрослеживаемости,
	|	ТаблицаСведенияПрослеживаемости.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТаблицаСведенияПрослеживаемости.Комплектующие КАК Комплектующие,
	|	ТаблицаСведенияПрослеживаемости.Сумма КАК Сумма,
	|	ТаблицаСведенияПрослеживаемости.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ТаблицаСведенияПрослеживаемости.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ ВременнаяТаблицаСведенияПрослеживаемости
	|ИЗ
	|	ТаблицаСведенияПрослеживаемости КАК ТаблицаСведенияПрослеживаемости
	|ГДЕ
	|	&ВестиУчетПрослеживаемыхТоваров
	|	И ЕСТЬNULL(ТаблицаСведенияПрослеживаемости.Количество, 0) > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСведенияПрослеживаемости
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&Ссылка КАК Ссылка,
	|	ОтчетКомиссионераЗапасыВозвраты.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасыВозвраты.Количество * -1 КАК Количество,
	|	ОтчетКомиссионераЗапасыВозвраты.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасыВозвраты.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ОтчетКомиссионераЗапасыВозвраты.Цена КАК Цена,
	|	ОтчетКомиссионераЗапасыВозвраты.Сумма * -1 КАК Сумма,
	|	ОтчетКомиссионераЗапасыВозвраты.СтавкаНДС КАК СтавкаНДС,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * -1 КАК СуммаНДС,
	|	ОтчетКомиссионераЗапасыВозвраты.Всего * -1 КАК Всего,
	|	ОтчетКомиссионераЗапасыВозвраты.ЦенаПередачи КАК ЦенаПередачи,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи * -1 КАК СуммаПередачи,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * -1 КАК СуммаНДСПередачи,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * -1 КАК СуммаВознаграждения,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * -1 КАК СуммаНДСВознаграждения,
	|	ОтчетКомиссионераЗапасыВозвраты.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ОтчетКомиссионераЗапасыВозвраты.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ОтчетКомиссионераЗапасыВозвраты.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераЗапасыВозвраты.Себестоимость КАК Себестоимость,
	|	ОтчетКомиссионераЗапасыВозвраты.КлючСвязиСерииНоменклатуры КАК КлючСвязиСерииНоменклатуры,
	|	ОтчетКомиссионераЗапасыВозвраты.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ОтчетКомиссионераЗапасыВозвраты.НомерГТД КАК НомерГТД,
	|	ОтчетКомиссионераЗапасыВозвраты.ПрямоеСписаниеГТД КАК ПрямоеСписаниеГТД,
	|	ОтчетКомиссионераЗапасыВозвраты.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераЗапасыВозвраты.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ОтчетКомиссионераЗапасыВозвраты.КодТНВЭД КАК КодТНВЭД
	|ПОМЕСТИТЬ ОтчетКомиссионераЗапасыВозвраты
	|ИЗ
	|	&ОтчетКомиссионераЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
	|ГДЕ
	|	&ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасыВозвраты.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераЗапасыВозвраты.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераЗапасыВозвраты.КлючСвязиСерииНоменклатуры КАК КлючСвязиСерииНоменклатуры,
	|	ОтчетКомиссионераЗапасыВозвраты.Ссылка КАК Документ,
	|	ВременнаяТаблицаШапка.Дата КАК Период,
	|	&Организация КАК Организация,
	|	ВременнаяТаблицаШапка.Контрагент КАК Контрагент,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиРасчетыПоДоговорам КАК ВестиРасчетыПоДоговорам,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиРасчетыПоЗаказам КАК ВестиРасчетыПоЗаказам,
	|	ВременнаяТаблицаШапка.Контрагент.ВестиУчетОплатыПоСчетам КАК ВестиУчетОплатыПоСчетам,
	|	ВременнаяТаблицаШапка.Контрагент.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|	ВременнаяТаблицаШапка.Договор.ВалютаРасчетов КАК ВалютаРасчетов,
	|	ВременнаяТаблицаШапка.Договор КАК Договор,
	|	ВременнаяТаблицаШапка.Контрагент КАК СтруктурнаяЕдиница,
	|	ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПриемаПередачиТоваров.ПередачаКомиссионеру) КАК ТипПриемаПередачи,
	|	ВременнаяТаблицаШапка.Подразделение КАК ПодразделениеПродажи,
	|	ВременнаяТаблицаШапка.Ответственный КАК Ответственный,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|			ТОГДА ВременнаяТаблицаШапка.НаправлениеДеятельности
	|		ИНАЧЕ НоменклатураЗапасов.НаправлениеДеятельности
	|	КОНЕЦ КАК НаправлениеДеятельностиПродажи,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|			ТОГДА ВременнаяТаблицаШапка.НаправлениеДеятельности.СчетУчетаВыручкиОтПродаж
	|		ИНАЧЕ НоменклатураЗапасов.НаправлениеДеятельности.СчетУчетаВыручкиОтПродаж
	|	КОНЕЦ КАК СчетУчетаПродажи,
	|	ВЫБОР
	|		КОГДА НоменклатураЗапасов.СчетУчетаНДСПоРеализации = ЗНАЧЕНИЕ(ПланСчетов.Управленческий.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Управленческий.Продажи_НДС)
	|		ИНАЧЕ НоменклатураЗапасов.СчетУчетаНДСПоРеализации
	|	КОНЕЦ КАК СчетУчетаНДСПоРеализации,
	|	ВЫБОР
	|		КОГДА ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|			ТОГДА ВременнаяТаблицаШапка.НаправлениеДеятельности.СчетУчетаСебестоимостиПродаж
	|		ИНАЧЕ НоменклатураЗапасов.НаправлениеДеятельности.СчетУчетаСебестоимостиПродаж
	|	КОНЕЦ КАК СчетУчетаСебестоимость,
	|	НоменклатураЗапасов.СчетУчетаЗапасов КАК СчетУчета,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасыВозвраты.НомерГТД КАК НомерГТД,
	|	ОтчетКомиссионераЗапасыВозвраты.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА &ИспользоватьХарактеристики
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Характеристика
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК Характеристика,
	|	ВЫБОР
	|		КОГДА &ИспользоватьПартии
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Партия
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПартииНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК Партия,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения) = ТИП(Справочник.КлассификаторЕдиницИзмерения)
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Количество
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Количество * ЕдиницыИзмерения.Коэффициент
	|	КОНЕЦ КАК Количество,
	|	ОтчетКомиссионераЗапасыВозвраты.СтавкаНДС КАК СтавкаНДС,
	|	ВременнаяТаблицаШапка.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСПродажи,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ОтчетКомиссионераЗапасыВозвраты.Всего * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Всего * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасыВозвраты.Всего * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Всего * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК Сумма,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|				ТОГДА 0
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДС
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаНДСВал,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионераЗапасыВозвраты.Всего * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|			ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Всего
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаВал,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионераЗапасыВозвраты.Всего
	|			ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Всего * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаРег,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СебестоимостьНДС,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|					ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСРег,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ВЫБОР
	|									КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|										ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|									ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи) * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								КОНЕЦ
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи) * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							КОНЕЦ
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|								ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|							ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК Себестоимость,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСВознаграждения,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|							ТОГДА ВЫБОР
	|									КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|										ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|									ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения) * КурсыРегВалюты.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * КурсыРегВалюты.Кратность)
	|								КОНЕЦ
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалютПоДатам.Кратность / (КурсыУпрВалютПоДатам.Курс * ВременнаяТаблицаШапка.Кратность)
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|						ТОГДА ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения) * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|							КОНЕЦ
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|								ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|							ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения) * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаВознаграждения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|							ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|						ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения) * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|					КОНЕЦ
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|						ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения
	|					ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаВознагражденияВал,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|							ТОГДА 0
	|						ИНАЧЕ ВЫБОР
	|								КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|									ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|								ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения
	|							КОНЕЦ
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.НДСВключатьВСтоимость
	|						ТОГДА 0
	|					ИНАЧЕ ВЫБОР
	|							КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|								ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|							ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения
	|						КОНЕЦ
	|				КОНЕЦ КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаНДСВознагражденияВал,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|							ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения
	|						ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения
	|					КОНЕЦ
	|			ИНАЧЕ ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|						ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|					ИНАЧЕ (ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения) * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|				КОНЕЦ
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаВознагражденияРег,
	|	ОтчетКомиссионераЗапасыВозвраты.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.СуммаВключаетНДС
	|				ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи
	|			ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаПередачи + ОтчетКомиссионераЗапасыВозвраты.СуммаНДСПередачи
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаРасчетовПринятыеПереданные,
	|	ОтчетКомиссионераЗапасыВозвраты.ПрямоеСписаниеГТД КАК ПрямоеСписаниеГТД,
	|	ОтчетКомиссионераЗапасыВозвраты.Себестоимость КАК РучнаяСебестоимость,
	|	ВременнаяТаблицаШапка.Проект КАК Проект,
	|	ОтчетКомиссионераЗапасыВозвраты.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераЗапасыВозвраты.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ОтчетКомиссионераЗапасыВозвраты.КодТНВЭД КАК КодТНВЭД,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА &Ссылка
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|	КОНЕЦ КАК КорректируемыйДокумент,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА &Ссылка
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|	КОНЕЦ КАК ОтчетКомиссионера,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.ИспользоватьНовуюСхемуДвижений
	|		ИНАЧЕ ЕСТЬNULL(ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений, ЛОЖЬ)
	|	КОНЕЦ КАК ИспользоватьНовуюСхемуДвиженийВОтчете,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения
	|		ИНАЧЕ ВЫБОР
	|				КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|					ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Договор.УслугаКомиссионногоВознаграждения
	|				ИНАЧЕ ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения
	|			КОНЕЦ
	|	КОНЕЦ КАК УслугаКомиссионногоВознаграждения,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВЫБОР
	|					КОГДА ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям = ЗНАЧЕНИЕ(ПланСчетов.Управленческий.ПустаяСсылка)
	|						ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Управленческий.НДСПоПриобретеннымЦенностям)
	|					ИНАЧЕ ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям
	|				КОНЕЦ
	|		ИНАЧЕ ВЫБОР
	|				КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|					ТОГДА ВЫБОР
	|							КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Договор.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям = ЗНАЧЕНИЕ(ПланСчетов.Управленческий.ПустаяСсылка)
	|								ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Управленческий.НДСПоПриобретеннымЦенностям)
	|							ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Договор.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям
	|						КОНЕЦ
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям = ЗНАЧЕНИЕ(ПланСчетов.Управленческий.ПустаяСсылка)
	|							ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Управленческий.НДСПоПриобретеннымЦенностям)
	|						ИНАЧЕ ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаНДСПоПриобретеннымЦенностям
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.СтавкаНДСВознаграждения
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.СтавкаНДСВознаграждения
	|	КОНЕЦ КАК СтавкаНДСВознаграждения,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|			ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаНДСВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|		КОНЕЦ КАК ЧИСЛО(15, 2)) КАК СуммаНДСВознагражденияДляУслуги,
	|	ИСТИНА КАК ЭтоВозврат,
	|	ВременнаяТаблицаШапка.Контрагент.СчетУчетаРасчетовСПоставщиком КАК СчетУчетаРасчетовСПоставщиком,
	|	ВременнаяТаблицаШапка.ДоговорДоговорУслугиКомиссионногоВознаграждения КАК ДоговорДоговорУслугиКомиссионногоВознаграждения,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат КАК СчетУчетаЗатрат,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение
	|	КОНЕЦ КАК ОтчетКомиссионераУдержатьКомиссионноеВознаграждение,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат.ТипСчета КАК СчетУчетаЗатратТипСчета,
	|	ВременнаяТаблицаШапка.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ ВременнаяТаблицаЗапасыВозвраты
	|ИЗ
	|	ОтчетКомиссионераЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаВалютаУчета.Значение
	|					ИЗ
	|						Константа.ВалютаУчета КАК КонстантаВалютаУчета)) КАК КурсыУпрВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаНациональнаяВалюта.Значение
	|					ИЗ
	|						Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта)) КАК КурсыРегВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК НоменклатураЗапасов
	|		ПО ОтчетКомиссионераЗапасыВозвраты.Номенклатура = НоменклатураЗапасов.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
	|		ПО ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения = ЕдиницыИзмерения.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|			ЛЕВОЕ СОЕДИНЕНИЕ КурсыУпрВалютПоДатам КАК КурсыУпрВалютПоДатам
	|			ПО (ВЫБОР
	|					КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА НАЧАЛОПЕРИОДА(ОтчетКомиссионераПокупателиВозвраты.Ссылка.Дата, ДЕНЬ) = КурсыУпрВалютПоДатам.Период
	|					ИНАЧЕ НАЧАЛОПЕРИОДА(ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Дата, ДЕНЬ) = КурсыУпрВалютПоДатам.Период
	|				КОНЕЦ)
	|		ПО ОтчетКомиссионераЗапасыВозвраты.КлючСвязи = ОтчетКомиссионераПокупателиВозвраты.КлючСвязи,
	|	Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
	|	И &ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	1 КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ВременнаяТаблицаШапка.Дата КАК Период,
	|	ВременнаяТаблицаШапка.Ссылка КАК Документ,
	|	ВременнаяТаблицаШапка.ВидОперации КАК ВидОперации,
	|	&Организация КАК Организация,
	|	ВременнаяТаблицаШапка.Подразделение КАК СтруктурнаяЕдиница,
	|	ВременнаяТаблицаШапка.ВалютаДокумента КАК Валюта,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат КАК СчетУчета,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения КАК Номенклатура,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК ЗапасыНоменклатура,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.ПартииНоменклатуры.ПустаяСсылка) КАК Партия,
	|	НЕОПРЕДЕЛЕНО КАК Заказ,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказПоставщику,
	|	1 КАК Количество,
	|	ВременнаяТаблицаШапка.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	СУММА(ВЫРАЗИТЬ(ВЫБОР
	|				КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|					ТОГДА ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * КурсыРегВалюты.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * КурсыРегВалюты.Кратность)
	|				ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.СуммаВознаграждения * ВременнаяТаблицаШапка.Курс * КурсыУпрВалюты.Кратность / (КурсыУпрВалюты.Курс * ВременнаяТаблицаШапка.Кратность)
	|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК Сумма,
	|	ЛОЖЬ КАК ВключатьРасходыВСебестоимость,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат.ТипСчета КАК ТипСчета,
	|	СУММА(ВЫРАЗИТЬ(ВЫБОР
	|				КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|					ТОГДА ОтчетКомиссионераЗапасыВозвраты.Всего * КурсыРегВалюты.Курс * ВременнаяТаблицаШапка.Кратность / (ВременнаяТаблицаШапка.Курс * КурсыРегВалюты.Кратность)
	|				ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Всего
	|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК СуммаВал,
	|	СУММА(ВЫРАЗИТЬ(ВЫБОР
	|				КОГДА ВременнаяТаблицаШапка.ВалютаДокумента = КонстантаНациональнаяВалюта.Значение
	|					ТОГДА ОтчетКомиссионераЗапасыВозвраты.Всего
	|				ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Всего * ВременнаяТаблицаШапка.Курс / ВременнаяТаблицаШапка.Кратность
	|			КОНЕЦ КАК ЧИСЛО(15, 2))) КАК СуммаРег,
	|	ВременнаяТаблицаШапка.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ВременнаяТаблицаШапка.Контрагент КАК Контрагент,
	|	ВременнаяТаблицаШапка.Дата КАК Дата,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА &Ссылка
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|	КОНЕЦ КАК ОтчетКомиссионера,
	|	ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение
	|	КОНЕЦ КАК ОтчетКомиссионераУдержатьКомиссионноеВознаграждение,
	|	ИСТИНА КАК ЭтоВозврат,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.ИспользоватьНовуюСхемуДвижений
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений
	|	КОНЕЦ КАК ИспользоватьНовуюСхемуДвижений
	|ПОМЕСТИТЬ ВременнаяТаблицаРасходыВозвраты
	|ИЗ
	|	Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка,
	|	ОтчетКомиссионераЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаВалютаУчета.Значение
	|					ИЗ
	|						Константа.ВалютаУчета КАК КонстантаВалютаУчета)) КАК КурсыУпрВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют.СрезПоследних(
	|				&МоментВремени,
	|				Валюта В
	|					(ВЫБРАТЬ
	|						КонстантаНациональнаяВалюта.Значение
	|					ИЗ
	|						Константа.НациональнаяВалюта КАК КонстантаНациональнаяВалюта)) КАК КурсыРегВалюты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|		ПО ОтчетКомиссионераЗапасыВозвраты.КлючСвязи = ОтчетКомиссионераПокупателиВозвраты.КлючСвязи
	|ГДЕ
	|	ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ВременнаяТаблицаШапка.ВидОперации,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения,
	|	ВременнаяТаблицаШапка.Дата,
	|	ВременнаяТаблицаШапка.Ссылка,
	|	ВременнаяТаблицаШапка.Подразделение,
	|	ВременнаяТаблицаШапка.ВалютаДокумента,
	|	ВременнаяТаблицаШапка.СтавкаНДСВознаграждения,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат,
	|	ВременнаяТаблицаШапка.УслугаКомиссионногоВознаграждения.СчетУчетаЗатрат.ТипСчета,
	|	ВременнаяТаблицаШапка.ВестиРасчетыПоДокументам,
	|	ВременнаяТаблицаШапка.Контрагент,
	|	ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА &Ссылка
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.УдержатьКомиссионноеВознаграждение
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.УдержатьКомиссионноеВознаграждение
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ВременнаяТаблицаШапка.ИспользоватьНовуюСхемуДвижений
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений
	|	КОНЕЦ,
	|	ВременнаяТаблицаШапка.Дата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|		ИНАЧЕ &Ссылка
	|	КОНЕЦ КАК ОтчетКомиссионера
	|ПОМЕСТИТЬ ВременнаяТаблицаПокупателиДокументыВозвратаВозвраты
	|ИЗ
	|	Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|ГДЕ
	|	ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
	|	И &ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераСерииНоменклатурыВозвраты.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераСерииНоменклатурыВозвраты.Серия КАК Серия,
	|	ОтчетКомиссионераСерииНоменклатурыВозвраты.Количество КАК Количество
	|ПОМЕСТИТЬ ВременнаяТаблицаСерииНоменклатурыВозвраты
	|ИЗ
	|	Документ.ОтчетКомиссионера.СерииНоменклатурыВозвраты КАК ОтчетКомиссионераСерииНоменклатурыВозвраты
	|ГДЕ
	|	ОтчетКомиссионераСерииНоменклатурыВозвраты.Ссылка = &Ссылка
	|	И &ИспользоватьСерииНоменклатуры
	|	И &ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераПокупателиВозвраты.Ссылка КАК Ссылка,
	|	ОтчетКомиссионераПокупателиВозвраты.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераПокупателиВозвраты.Покупатель КАК Покупатель,
	|	ОтчетКомиссионераПокупателиВозвраты.Всего КАК Всего,
	|	ОтчетКомиссионераПокупателиВозвраты.ВыставленСФ КАК ВыставленСФ,
	|	ОтчетКомиссионераПокупателиВозвраты.ДатаСФ КАК ДатаСФ,
	|	ОтчетКомиссионераПокупателиВозвраты.СчетФактура КАК СчетФактура,
	|	ОтчетКомиссионераПокупателиВозвраты.КлючСвязи КАК КлючСвязи,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|			ТОГДА &Ссылка
	|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|	КОНЕЦ КАК ОтчетКомиссионера
	|ПОМЕСТИТЬ ВременнаяТаблицаПокупателиВозвраты
	|ИЗ
	|	Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|ГДЕ
	|	ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
	|	И &ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ОтчетКомиссионераЗапасыВозвраты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ОтчетКомиссионераСведенияПрослеживаемости.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.РНПТ КАК РНПТ,
	|	-ОтчетКомиссионераСведенияПрослеживаемости.Количество КАК Количество,
	|	-ОтчетКомиссионераСведенияПрослеживаемости.КоличествоПрослеживаемости КАК КоличествоПрослеживаемости,
	|	ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.Номенклатура КАК Комплектующие,
	|	-ОтчетКомиссионераСведенияПрослеживаемости.Сумма КАК Сумма,
	|	ОтчетКомиссионераСведенияПрослеживаемости.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ ТаблицаСведенияПрослеживаемостиВозвраты
	|ИЗ
	|	Документ.ОтчетКомиссионера.ЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.СведенияПрослеживаемости КАК ОтчетКомиссионераСведенияПрослеживаемости
	|		ПО ОтчетКомиссионераЗапасыВозвраты.ИдентификаторСтроки = ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки
	|ГДЕ
	|	&ВестиУчетПрослеживаемыхТоваров
	|	И ОтчетКомиссионераСведенияПрослеживаемости.Ссылка = &Ссылка
	|	И &ИспользоватьНовыйВидДокумента
	|	И ОтчетКомиссионераЗапасыВозвраты.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСведенияПрослеживаемостиВозвраты.ВидДвижения КАК ВидДвижения,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.НомерСтроки КАК НомерСтроки,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.РНПТ КАК РНПТ,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.Количество КАК Количество,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.КоличествоПрослеживаемости КАК КоличествоПрослеживаемости,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.Комплектующие КАК Комплектующие,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.Сумма КАК Сумма,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ТаблицаСведенияПрослеживаемостиВозвраты.Номенклатура КАК Номенклатура
	|ПОМЕСТИТЬ ВременнаяТаблицаСведенияПрослеживаемостиВозвраты
	|ИЗ
	|	ТаблицаСведенияПрослеживаемостиВозвраты КАК ТаблицаСведенияПрослеживаемостиВозвраты
	|ГДЕ
	|	&ВестиУчетПрослеживаемыхТоваров
	|	И &ИспользоватьНовыйВидДокумента
	|	И ЕСТЬNULL(ТаблицаСведенияПрослеживаемостиВозвраты.Количество, 0) > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТаблицаСведенияПрослеживаемостиВозвраты";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаТаблицаУправленческий() 
	ЗапросТекст =
	"ВЫБРАТЬ
	|	1 КАК Порядок,
	|	ТаблицаУправленческий.НомерСтроки КАК НомерСтроки,
	|	ТаблицаУправленческий.Период КАК Период,
	|	ТаблицаУправленческий.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический) КАК СценарийПланирования,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем КАК СчетДт,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ВалютаДт,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаВалДт,
	|	ТаблицаУправленческий.СчетУчетаПродажи КАК СчетКт,
	|	НЕОПРЕДЕЛЕНО КАК ВалютаКт,
	|	0 КАК СуммаВалКт,
	|	ТаблицаУправленческий.Сумма КАК Сумма,
	|	&ОтражениеВыручки КАК Содержание
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаНДСПоРеализации,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	&СчетУчетаНДСКУплате,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаНДС,
	|	&ОтражениеНДС
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	ТаблицаУправленческий.СуммаНДС <> 0
	|	И НЕ ТаблицаУправленческий.НДСВключатьВСтоимость
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	1,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный
	|			ТОГДА ТаблицаДокумента.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный
	|			ТОГДА ТаблицаДокумента.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный
	|			ТОГДА ТаблицаДокумента.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный
	|			ТОГДА ТаблицаДокумента.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаДокумента.Сумма,
	|	&ЗачетПредоплаты
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаДокумента.Период КАК Период,
	|		ТаблицаДокумента.Организация КАК Организация,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателя КАК СчетУчетаАвансовПокупателя,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный КАК СчетУчетаАвансовПокупателяВалютный,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный КАК СчетУчетаРасчетовСПокупателемВалютный,
	|		ТаблицаДокумента.ВалютаРасчетов КАК ВалютаРасчетов,
	|		СУММА(ТаблицаДокумента.СуммаВал) КАК СуммаВал,
	|		СУММА(ТаблицаДокумента.Сумма) КАК Сумма
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ТаблицаДокумента.Период КАК Период,
	|			ТаблицаДокумента.Организация КАК Организация,
	|			ТаблицаДокумента.СчетУчетаАвансовПокупателя КАК СчетУчетаАвансовПокупателя,
	|			ТаблицаДокумента.СчетУчетаАвансовПокупателя.Валютный КАК СчетУчетаАвансовПокупателяВалютный,
	|			ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчетаРасчетовСПокупателем,
	|			ТаблицаДокумента.СчетУчетаРасчетовСПокупателем.Валютный КАК СчетУчетаРасчетовСПокупателемВалютный,
	|			ТаблицаДокумента.ВалютаРасчетов КАК ВалютаРасчетов,
	|			ТаблицаДокумента.СуммаВал КАК СуммаВал,
	|			ТаблицаДокумента.Сумма КАК Сумма
	|		ИЗ
	|			ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ТаблицаДокумента.Дата,
	|			ТаблицаДокумента.Организация,
	|			ТаблицаДокумента.Контрагент.СчетУчетаАвансовПокупателя,
	|			ТаблицаДокумента.Контрагент.СчетУчетаАвансовПокупателя.Валютный,
	|			ТаблицаДокумента.Контрагент.СчетУчетаРасчетовСПокупателем,
	|			ТаблицаДокумента.Контрагент.СчетУчетаРасчетовСПокупателем.Валютный,
	|			ТаблицаДокумента.Валюта,
	|			0,
	|			ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)) КАК ТаблицаДокумента
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаДокумента.Период,
	|		ТаблицаДокумента.Организация,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|		ТаблицаДокумента.СчетУчетаАвансовПокупателяВалютный,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|		ТаблицаДокумента.СчетУчетаРасчетовСПокупателемВалютный,
	|		ТаблицаДокумента.ВалютаРасчетов
	|	
	|	ИМЕЮЩИЕ
	|		(СУММА(ТаблицаДокумента.Сумма) >= 0.005
	|			ИЛИ СУММА(ТаблицаДокумента.Сумма) <= -0.005
	|			ИЛИ СУММА(ТаблицаДокумента.СуммаВал) >= 0.005
	|			ИЛИ СУММА(ТаблицаДокумента.СуммаВал) <= -0.005)) КАК ТаблицаДокумента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	4,
	|	1,
	|	ТаблицаУправленческий.Дата,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|			ТОГДА ТаблицаУправленческий.СчетУчета
	|		ИНАЧЕ &ОтрицательнаяКурсоваяРазницаСчетУчета
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|				И ТаблицаУправленческий.СчетУчетаВалютный
	|			ТОГДА ТаблицаУправленческий.Валюта
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	0,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|			ТОГДА &ПоложительнаяКурсоваяРазницаСчетУчета
	|		ИНАЧЕ ТаблицаУправленческий.СчетУчета
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы < 0
	|				И ТаблицаУправленческий.СчетУчетаВалютный
	|			ТОГДА ТаблицаУправленческий.Валюта
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	0,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СуммаКурсовойРазницы > 0
	|			ТОГДА ТаблицаУправленческий.СуммаКурсовойРазницы
	|		ИНАЧЕ -ТаблицаУправленческий.СуммаКурсовойРазницы
	|	КОНЕЦ,
	|	&КурсоваяРазница
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Дата КАК Дата,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Организация КАК Организация,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчета КАК СчетУчета,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчетаВалютный КАК СчетУчетаВалютный,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Валюта КАК Валюта,
	|		СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) КАК СуммаКурсовойРазницы
	|	ИЗ
	|		(ВЫБРАТЬ
	|			ТаблицаДокумента.Дата КАК Дата,
	|			ТаблицаДокумента.Организация КАК Организация,
	|			ТаблицаДокумента.СчетУчета КАК СчетУчета,
	|			ТаблицаДокумента.СчетУчета.Валютный КАК СчетУчетаВалютный,
	|			ТаблицаДокумента.Валюта КАК Валюта,
	|			ТаблицаДокумента.СуммаКурсовойРазницы КАК СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг)
	|		
	|		ОБЪЕДИНИТЬ ВСЕ
	|		
	|		ВЫБРАТЬ
	|			ТаблицаДокумента.Дата,
	|			ТаблицаДокумента.Организация,
	|			ТаблицаДокумента.СчетУчета,
	|			ТаблицаДокумента.СчетУчета.Валютный,
	|			ТаблицаДокумента.Валюта,
	|			ТаблицаДокумента.СуммаКурсовойРазницы
	|		ИЗ
	|			ВременнаяТаблицаКурсовыхРазницРасчетыСПокупателями КАК ТаблицаДокумента
	|		ГДЕ
	|			ТаблицаДокумента.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)) КАК ТаблицаКурсовыхРазницРасчетыСПокупателями
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Дата,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Организация,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчета,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.СчетУчетаВалютный,
	|		ТаблицаКурсовыхРазницРасчетыСПокупателями.Валюта
	|	
	|	ИМЕЮЩИЕ
	|		(СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) >= 0.005
	|			ИЛИ СУММА(ТаблицаКурсовыхРазницРасчетыСПокупателями.СуммаКурсовойРазницы) <= -0.005)) КАК ТаблицаУправленческий
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	5,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаЗатрат,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаЗатрат.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаЗатрат.Валютный
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаУправленческий.НДСВключатьВСтоимость
	|						ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|					ИНАЧЕ ТаблицаУправленческий.СуммаВознагражденияВал - ТаблицаУправленческий.СуммаНДСВознагражденияВал
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаУправленческий.НДСВключатьВСтоимость
	|						ТОГДА ТаблицаУправленческий.СуммаВознагражденияВал
	|					ИНАЧЕ ТаблицаУправленческий.СуммаВознагражденияВал - ТаблицаУправленческий.СуммаНДСВознагражденияВал
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.НДСВключатьВСтоимость
	|			ТОГДА ТаблицаУправленческий.СуммаВознаграждения
	|		ИНАЧЕ ТаблицаУправленческий.СуммаВознаграждения - ТаблицаУправленческий.СуммаНДСВознаграждения
	|	КОНЕЦ,
	|	&ПрочиеРасходы
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	НЕ ТаблицаУправленческий.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.СуммаВознаграждения = 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	6,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаНДСВознаграждения,
	|	&ОтражениеНДСПриобретения
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаУправленческий
	|ГДЕ
	|	НЕ ТаблицаУправленческий.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.НДСВключатьВСтоимость
	|	И ТаблицаУправленческий.СуммаНДСВознаграждения <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	7,
	|	ТаблицаУправленческийВозвраты.НомерСтроки,
	|	ТаблицаУправленческийВозвраты.Период,
	|	ТаблицаУправленческийВозвраты.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческийВозвраты.СчетУчетаЗатрат,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческийВозвраты.СчетУчетаЗатрат.Валютный
	|			ТОГДА ТаблицаУправленческийВозвраты.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческийВозвраты.СчетУчетаЗатрат.Валютный
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаУправленческийВозвраты.НДСВключатьВСтоимость
	|						ТОГДА ТаблицаУправленческийВозвраты.СуммаВознагражденияВал
	|					ИНАЧЕ ТаблицаУправленческийВозвраты.СуммаВознагражденияВал - ТаблицаУправленческийВозвраты.СуммаНДСВознагражденияВал
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческийВозвраты.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческийВозвраты.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ТаблицаУправленческийВозвраты.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческийВозвраты.СчетУчетаРасчетовСПоставщиком.Валютный
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаУправленческийВозвраты.НДСВключатьВСтоимость
	|						ТОГДА ТаблицаУправленческийВозвраты.СуммаВознагражденияВал
	|					ИНАЧЕ ТаблицаУправленческийВозвраты.СуммаВознагражденияВал - ТаблицаУправленческийВозвраты.СуммаНДСВознагражденияВал
	|				КОНЕЦ
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческийВозвраты.НДСВключатьВСтоимость
	|			ТОГДА ТаблицаУправленческийВозвраты.СуммаВознаграждения
	|		ИНАЧЕ ТаблицаУправленческийВозвраты.СуммаВознаграждения - ТаблицаУправленческийВозвраты.СуммаНДСВознаграждения
	|	КОНЕЦ,
	|	&ПрочиеРасходы
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаУправленческийВозвраты
	|ГДЕ
	|	ТаблицаУправленческийВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаУправленческийВозвраты.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческийВозвраты.СуммаВознаграждения = 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	8,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПоставщиком,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоПриобретеннымЦенностям.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВознагражденияВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаНДСВознаграждения,
	|	&ОтражениеНДСПриобретения
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаУправленческий
	|ГДЕ
	|	ТаблицаУправленческий.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаУправленческий.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаУправленческий.НДСВключатьВСтоимость
	|	И ТаблицаУправленческий.СуммаНДСВознаграждения <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	9,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаРасчетовСПокупателем.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СчетУчетаПродажи,
	|	НЕОПРЕДЕЛЕНО,
	|	0,
	|	ТаблицаУправленческий.Сумма,
	|	&ОтражениеВыручки
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаУправленческий
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	10,
	|	ТаблицаУправленческий.НомерСтроки,
	|	ТаблицаУправленческий.Период,
	|	ТаблицаУправленческий.Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический),
	|	ТаблицаУправленческий.СчетУчетаНДСПоРеализации,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	&СчетУчетаНДСКУплате,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.ВалютаРасчетов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаУправленческий.СчетУчетаНДСПоРеализации.Валютный
	|			ТОГДА ТаблицаУправленческий.СуммаНДСВал
	|		ИНАЧЕ 0
	|	КОНЕЦ,
	|	ТаблицаУправленческий.СуммаНДС,
	|	&ОтражениеНДС
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаУправленческий
	|ГДЕ
	|	ТаблицаУправленческий.СуммаНДС <> 0
	|	И НЕ ТаблицаУправленческий.НДСВключатьВСтоимость
	|
	|УПОРЯДОЧИТЬ ПО
	|	Порядок,
	|	НомерСтроки";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаРаспределениеОтчетКомиссионераОПродажах() 
	
	ЗапросТекст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|ГДЕ
	|	ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
	|	И ОтчетКомиссионераЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И ОтчетКомиссионераЗапасы.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Авто)
	|	И НЕ ОтчетКомиссионераЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК Заказ,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|ГДЕ
	|	ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
	|	И (НЕ ОтчетКомиссионераЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ИЛИ ОтчетКомиссионераЗапасы.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Вручную))
	|	И НЕ ОтчетКомиссионераЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыПереданныеОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыПереданныеОстатки.Характеристика КАК Характеристика,
	|	ЗапасыПереданныеОстатки.Партия КАК Партия,
	|	ЗапасыПереданныеОстатки.Заказ КАК ЗаказПокупателя,
	|	ЗапасыПереданныеОстатки.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ЗапасыПереданныеОстатки.Заказ.ДатаОтгрузки ЕСТЬ NULL
	|			ТОГДА ДАТАВРЕМЯ(2099, 12, 31, 23, 59, 59)
	|		КОГДА ЗапасыПереданныеОстатки.Заказ.ДатаОтгрузки = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА ЗапасыПереданныеОстатки.Заказ.Дата
	|		ИНАЧЕ ЗапасыПереданныеОстатки.Заказ.ДатаОтгрузки
	|	КОНЕЦ КАК Дата,
	|	ЗапасыПереданныеОстатки.КоличествоОстаток КАК Количество,
	|	ЗапасыПереданныеОстатки.СуммаРасчетовОстаток КАК СуммаРасчетов,
	|	ЗапасыПереданныеОстатки.Заказ.Дата КАК ЗаказДата
	|ПОМЕСТИТЬ ВтОстатки
	|ИЗ
	|	РегистрНакопления.ЗапасыПереданные.Остатки(
	|			&МоментВремени,
	|			Организация = &Организация
	|				И Контрагент = &Контрагент
	|				И Договор = &Договор
	|				И НЕ Заказ = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|				И ТипПриемаПередачи = ЗНАЧЕНИЕ(Перечисление.ТипыПриемаПередачиТоваров.ПередачаКомиссионеру)
	|				И НЕ (Номенклатура, Характеристика, Партия, Заказ) В
	|						(ВЫБРАТЬ
	|							ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|							ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|							ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|							ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК Заказ
	|						ИЗ
	|							Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|						ГДЕ
	|							ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
	|							И (НЕ ОтчетКомиссионераЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|								ИЛИ ОтчетКомиссионераЗапасы.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Вручную)))) КАК ЗапасыПереданныеОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыПереданныеОстатки.Заказ,
	|	ЗапасыПереданныеОстатки.Номенклатура,
	|	ЗапасыПереданныеОстатки.Характеристика,
	|	ЗапасыПереданныеОстатки.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыПереданныеОстатки.Заказ.ДатаОтгрузки ЕСТЬ NULL
	|			ТОГДА ДАТАВРЕМЯ(2099, 12, 31, 23, 59, 59)
	|		КОГДА ЗапасыПереданныеОстатки.Заказ.ДатаОтгрузки = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА ЗапасыПереданныеОстатки.Заказ.Дата
	|		ИНАЧЕ ЗапасыПереданныеОстатки.Заказ.ДатаОтгрузки
	|	КОНЕЦ,
	|	ЗапасыПереданныеОстатки.Номенклатура.ЕдиницаИзмерения,
	|	ЗапасыПереданныеОстатки.КоличествоОстаток,
	|	ЗапасыПереданныеОстатки.СуммаРасчетовОстаток,
	|	ЗапасыПереданныеОстатки.Заказ.Дата
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыПереданные.Номенклатура,
	|	ЗапасыПереданные.Характеристика,
	|	ЗапасыПереданные.Партия,
	|	ЗапасыПереданные.Заказ,
	|	ЗапасыПереданные.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ЗапасыПереданные.Заказ.ДатаОтгрузки ЕСТЬ NULL
	|			ТОГДА ДАТАВРЕМЯ(2099, 12, 31, 23, 59, 59)
	|		КОГДА ЗапасыПереданные.Заказ.ДатаОтгрузки = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА ЗапасыПереданные.Заказ.Дата
	|		ИНАЧЕ ЗапасыПереданные.Заказ.ДатаОтгрузки
	|	КОНЕЦ,
	|	ЗапасыПереданные.Количество,
	|	ЗапасыПереданные.СуммаРасчетов,
	|	ЗапасыПереданные.Заказ.Дата
	|ИЗ
	|	РегистрНакопления.ЗапасыПереданные КАК ЗапасыПереданные
	|ГДЕ
	|	ЗапасыПереданные.Регистратор = &Ссылка
	|	И ЗапасыПереданные.ТипПриемаПередачи = ЗНАЧЕНИЕ(Перечисление.ТипыПриемаПередачиТоваров.ПередачаКомиссионеру)
	|	И ЗапасыПереданные.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтОстатки.Номенклатура КАК Номенклатура,
	|	ВтОстатки.Характеристика КАК Характеристика,
	|	ВтОстатки.Партия КАК Партия,
	|	ВтОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВтОстатки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВтОстатки.Дата КАК Дата,
	|	СУММА(ВтОстатки.Количество) КАК Количество,
	|	СУММА(ВтОстатки.СуммаРасчетов) КАК СуммаРасчетов,
	|	ЕСТЬNULL(ВтОстатки.ЗаказДата, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)) КАК ЗаказДата
	|ИЗ
	|	ВтОстатки КАК ВтОстатки
	|ГДЕ
	|	ВтОстатки.Количество > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтОстатки.Характеристика,
	|	ВтОстатки.Номенклатура,
	|	ВтОстатки.ЕдиницаИзмерения,
	|	ВтОстатки.Дата,
	|	ВтОстатки.Партия,
	|	ВтОстатки.ЗаказПокупателя,
	|	ЕСТЬNULL(ВтОстатки.ЗаказДата, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0))
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаказДата";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаРаспределениеОтчетКомиссионераОВозвратах(ИспользоватьНовыйВидДокумента = Ложь) 
	
	Если ИспользоватьНовыйВидДокумента Тогда
		ЗапросТекст = 
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|			ТОГДА &Ссылка
		|		ИНАЧЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
		|	КОНЕЦ КАК ОтчетКомиссионера,
		|	ОтчетКомиссионераПокупателиВозвраты.КлючСвязи КАК КлючСвязи
		|ПОМЕСТИТЬ ВТОтчетыКомиссионера
		|ИЗ
		|	Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
		|ГДЕ
		|	ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура КАК Номенклатура,
		|	ОтчетКомиссионераЗапасыВозвраты.Характеристика КАК Характеристика,
		|	ОтчетКомиссионераЗапасыВозвраты.Партия КАК Партия,
		|	ОтчетКомиссионераЗапасыВозвраты.Себестоимость КАК Себестоимость,
		|	ВТОтчетыКомиссионера.ОтчетКомиссионера КАК ОтчетКомиссионера,
		|	ОтчетКомиссионераЗапасыВозвраты.КлючСвязи КАК КлючСвязи
		|ПОМЕСТИТЬ КРаспределению
		|ИЗ
		|	Документ.ОтчетКомиссионера.ЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтчетыКомиссионера КАК ВТОтчетыКомиссионера
		|		ПО ОтчетКомиссионераЗапасыВозвраты.КлючСвязи = ВТОтчетыКомиссионера.КлючСвязи
		|ГДЕ
		|	ОтчетКомиссионераЗапасыВозвраты.Ссылка = &Ссылка
		|	И ОтчетКомиссионераЗапасыВозвраты.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	И ОтчетКомиссионераЗапасыВозвраты.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Авто)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КРаспределению.Номенклатура КАК Номенклатура,
		|	КРаспределению.Характеристика КАК Характеристика,
		|	КРаспределению.Партия КАК Партия,
		|	КРаспределению.Себестоимость КАК Себестоимость,
		|	КРаспределению.ОтчетКомиссионера КАК ОтчетКомиссионера,
		|	КРаспределению.КлючСвязи КАК КлючСвязи
		|ИЗ
		|	КРаспределению КАК КРаспределению
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура КАК Номенклатура,
		|	ОтчетКомиссионераЗапасыВозвраты.Характеристика КАК Характеристика,
		|	ОтчетКомиссионераЗапасыВозвраты.Партия КАК Партия,
		|	ОтчетКомиссионераЗапасыВозвраты.ЗаказПокупателя КАК Заказ,
		|	ОтчетКомиссионераЗапасыВозвраты.Себестоимость КАК Себестоимость,
		|	ВТОтчетыКомиссионера.ОтчетКомиссионера КАК ОтчетКомиссионера,
		|	ОтчетКомиссионераЗапасыВозвраты.КлючСвязи КАК КлючСвязи
		|ИЗ
		|	Документ.ОтчетКомиссионера.ЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОтчетыКомиссионера КАК ВТОтчетыКомиссионера
		|		ПО ОтчетКомиссионераЗапасыВозвраты.КлючСвязи = ВТОтчетыКомиссионера.КлючСвязи
		|ГДЕ
		|	ОтчетКомиссионераЗапасыВозвраты.Ссылка = &Ссылка
		|	И (НЕ ОтчетКомиссионераЗапасыВозвраты.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|			ИЛИ ОтчетКомиссионераЗапасыВозвраты.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Вручную))
		|
		|УПОРЯДОЧИТЬ ПО
		|	ОтчетКомиссионера
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗапасыПереданные.Номенклатура КАК Номенклатура,
		|	ЗапасыПереданные.Характеристика КАК Характеристика,
		|	ЗапасыПереданные.Партия КАК Партия,
		|	ЗапасыПереданные.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	СУММА(ЗапасыПереданные.Количество) КАК Количество,
		|	СУММА(ЗапасыПереданные.СуммаРасчетов) КАК СуммаРасчетов,
		|	КРаспределению.ОтчетКомиссионера КАК ОтчетКомиссионера,
		|	ЗапасыПереданные.Заказ КАК ЗаказПокупателя,
		|	КРаспределению.КлючСвязи КАК КлючСвязи
		|ПОМЕСТИТЬ ВтОстатки
		|ИЗ
		|	КРаспределению КАК КРаспределению
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыПереданные КАК ЗапасыПереданные
		|		ПО КРаспределению.ОтчетКомиссионера = ЗапасыПереданные.Регистратор
		|			И КРаспределению.Номенклатура = ЗапасыПереданные.Номенклатура
		|			И КРаспределению.Характеристика = ЗапасыПереданные.Характеристика
		|			И КРаспределению.Партия = ЗапасыПереданные.Партия
		|ГДЕ
		|	НЕ ЗапасыПереданные.Регистратор = &Ссылка
		|	И НЕ ЗапасыПереданные.Заказ = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	И ЗапасыПереданные.Регистратор В
		|			(ВЫБРАТЬ
		|				ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера КАК Документ
		|			ИЗ
		|				Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
		|			ГДЕ
		|				ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
		|				И НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка))
		|
		|СГРУППИРОВАТЬ ПО
		|	КРаспределению.ОтчетКомиссионера,
		|	КРаспределению.КлючСвязи,
		|	ЗапасыПереданные.Номенклатура,
		|	ЗапасыПереданные.Характеристика,
		|	ЗапасыПереданные.Партия,
		|	ЗапасыПереданные.Номенклатура.ЕдиницаИзмерения,
		|	ЗапасыПереданные.Заказ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ОтчетКомиссионераЗапасы.Номенклатура,
		|	ОтчетКомиссионераЗапасы.Характеристика,
		|	ОтчетКомиссионераЗапасы.Партия,
		|	ОтчетКомиссионераЗапасы.ЕдиницаИзмерения,
		|	ОтчетКомиссионераЗапасы.Количество,
		|	ОтчетКомиссионераЗапасы.СуммаПередачи,
		|	КРаспределению.ОтчетКомиссионера,
		|	ОтчетКомиссионераЗапасы.ЗаказПокупателя,
		|	КРаспределению.КлючСвязи
		|ИЗ
		|	КРаспределению КАК КРаспределению
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
		|		ПО КРаспределению.Номенклатура = ОтчетКомиссионераЗапасы.Номенклатура
		|			И КРаспределению.Характеристика = ОтчетКомиссионераЗапасы.Характеристика
		|			И КРаспределению.Партия = ОтчетКомиссионераЗапасы.Партия
		|			И КРаспределению.ОтчетКомиссионера = ОтчетКомиссионераЗапасы.Ссылка
		|ГДЕ
		|	ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
		|	И НЕ ОтчетКомиссионераЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|
		|СГРУППИРОВАТЬ ПО
		|	КРаспределению.ОтчетКомиссионера,
		|	КРаспределению.КлючСвязи,
		|	ОтчетКомиссионераЗапасы.Номенклатура,
		|	ОтчетКомиссионераЗапасы.Характеристика,
		|	ОтчетКомиссионераЗапасы.Партия,
		|	ОтчетКомиссионераЗапасы.ЕдиницаИзмерения,
		|	ОтчетКомиссионераЗапасы.Количество,
		|	ОтчетКомиссионераЗапасы.СуммаПередачи,
		|	ОтчетКомиссионераЗапасы.ЗаказПокупателя
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВтОстатки.Номенклатура КАК Номенклатура,
		|	ВтОстатки.Характеристика КАК Характеристика,
		|	ВтОстатки.Партия КАК Партия,
		|	ВтОстатки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	СУММА(ВтОстатки.Количество) КАК Количество,
		|	СУММА(ВтОстатки.СуммаРасчетов) КАК СуммаРасчетов,
		|	ВтОстатки.ОтчетКомиссионера КАК ОтчетКомиссионера,
		|	ВтОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
		|	ВтОстатки.КлючСвязи КАК КлючСвязи
		|ИЗ
		|	ВтОстатки КАК ВтОстатки
		|ГДЕ
		|	ВтОстатки.Количество > 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ВтОстатки.Партия,
		|	ВтОстатки.ЕдиницаИзмерения,
		|	ВтОстатки.Характеристика,
		|	ВтОстатки.ЗаказПокупателя,
		|	ВтОстатки.Номенклатура,
		|	ВтОстатки.ОтчетКомиссионера,
		|	ВтОстатки.КлючСвязи";
		
		Возврат ЗапросТекст;
	КонецЕсли;
	
	ЗапросТекст = 
	"ВЫБРАТЬ
	|	ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ОтчетКомиссионераПокупатели.КлючСвязи КАК КлючСвязи
	|ПОМЕСТИТЬ ВТОтчетыКомиссионера
	|ИЗ
	|	Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|	И НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость,
	|	ВТОтчетыКомиссионера.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ОтчетКомиссионераЗапасы.КлючСвязи КАК КлючСвязи
	|ПОМЕСТИТЬ КРаспределению
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтчетыКомиссионера КАК ВТОтчетыКомиссионера
	|		ПО ОтчетКомиссионераЗапасы.КлючСвязи = ВТОтчетыКомиссионера.КлючСвязи
	|ГДЕ
	|	ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
	|	И ОтчетКомиссионераЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И ОтчетКомиссионераЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|	И ОтчетКомиссионераЗапасы.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Авто)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КРаспределению.Номенклатура КАК Номенклатура,
	|	КРаспределению.Характеристика КАК Характеристика,
	|	КРаспределению.Партия КАК Партия,
	|	КРаспределению.Себестоимость КАК Себестоимость,
	|	КРаспределению.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	КРаспределению.КлючСвязи КАК КлючСвязи
	|ИЗ
	|	КРаспределению КАК КРаспределению
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК Заказ,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость,
	|	ВТОтчетыКомиссионера.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ОтчетКомиссионераЗапасы.КлючСвязи КАК КлючСвязи
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОтчетыКомиссионера КАК ВТОтчетыКомиссионера
	|		ПО ОтчетКомиссионераЗапасы.КлючСвязи = ВТОтчетыКомиссионера.КлючСвязи
	|ГДЕ
	|	ОтчетКомиссионераЗапасы.Ссылка = &Ссылка
	|	И (НЕ ОтчетКомиссионераЗапасы.ЗаказПокупателя = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|			ИЛИ ОтчетКомиссионераЗапасы.СпособРаспределения = ЗНАЧЕНИЕ(Перечисление.СпособыЗачетаИРаспределенияПлатежей.Вручную))
	|	И ОтчетКомиссионераЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОтчетКомиссионера
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыПереданные.Номенклатура КАК Номенклатура,
	|	ЗапасыПереданные.Характеристика КАК Характеристика,
	|	ЗапасыПереданные.Партия КАК Партия,
	|	ЗапасыПереданные.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЗапасыПереданные.Количество) КАК Количество,
	|	СУММА(ЗапасыПереданные.СуммаРасчетов) КАК СуммаРасчетов,
	|	КРаспределению.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ЗапасыПереданные.Заказ КАК ЗаказПокупателя,
	|	КРаспределению.КлючСвязи КАК КлючСвязи
	|ПОМЕСТИТЬ ВтОстатки
	|ИЗ
	|	КРаспределению КАК КРаспределению
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыПереданные КАК ЗапасыПереданные
	|		ПО КРаспределению.ОтчетКомиссионера = ЗапасыПереданные.Регистратор
	|			И КРаспределению.Номенклатура = ЗапасыПереданные.Номенклатура
	|			И КРаспределению.Характеристика = ЗапасыПереданные.Характеристика
	|			И КРаспределению.Партия = ЗапасыПереданные.Партия
	|ГДЕ
	|	НЕ ЗапасыПереданные.Регистратор = &Ссылка
	|	И НЕ ЗапасыПереданные.Заказ = ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	И ЗапасыПереданные.Регистратор В
	|			(ВЫБРАТЬ
	|				ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК Документ
	|			ИЗ
	|				Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|			ГДЕ
	|				ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|				И НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка))
	|
	|СГРУППИРОВАТЬ ПО
	|	КРаспределению.ОтчетКомиссионера,
	|	КРаспределению.КлючСвязи,
	|	ЗапасыПереданные.Номенклатура,
	|	ЗапасыПереданные.Характеристика,
	|	ЗапасыПереданные.Партия,
	|	ЗапасыПереданные.Номенклатура.ЕдиницаИзмерения,
	|	ЗапасыПереданные.Заказ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтОстатки.Номенклатура КАК Номенклатура,
	|	ВтОстатки.Характеристика КАК Характеристика,
	|	ВтОстатки.Партия КАК Партия,
	|	ВтОстатки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ВтОстатки.Количество) КАК Количество,
	|	СУММА(ВтОстатки.СуммаРасчетов) КАК СуммаРасчетов,
	|	ВтОстатки.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	ВтОстатки.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВтОстатки.КлючСвязи КАК КлючСвязи
	|ИЗ
	|	ВтОстатки КАК ВтОстатки
	|ГДЕ
	|	ВтОстатки.Количество > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ВтОстатки.Партия,
	|	ВтОстатки.ЕдиницаИзмерения,
	|	ВтОстатки.Характеристика,
	|	ВтОстатки.ЗаказПокупателя,
	|	ВтОстатки.Номенклатура,
	|	ВтОстатки.ОтчетКомиссионера,
	|	ВтОстатки.КлючСвязи";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОПродажах()
	
	ЗапросТекст =
	"ВЫБРАТЬ
	|	ТаблицаПродажи.Период КАК Период,
	|	ТаблицаПродажи.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка) КАК Склад,
	|	ТаблицаПродажи.Номенклатура КАК Номенклатура,
	|	ТаблицаПродажи.Характеристика КАК Характеристика,
	|	ТаблицаПродажи.Партия КАК Партия,
	|	ТаблицаПродажи.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ТаблицаПродажи.Документ КАК Документ,
	|	ТаблицаПродажи.СтавкаНДС КАК СтавкаНДС,
	|	ТаблицаПродажи.ПодразделениеПродажи КАК Подразделение,
	|	ТаблицаПродажи.Проект КАК Проект,
	|	ТаблицаПродажи.Ответственный КАК Ответственный,
	|	СУММА(ТаблицаПродажи.Количество) КАК Количество,
	|	СУММА(ТаблицаПродажи.СуммаНДСПродажи) КАК СуммаНДС,
	|	СУММА(ТаблицаПродажи.Сумма) КАК Сумма,
	|	0 КАК Себестоимость,
	|	0 КАК СебестоимостьБезНДС,
	|	СУММА(ТаблицаПродажи.Сумма) КАК СуммаБезСкидки
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаПродажи
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаПродажи.Период,
	|	ТаблицаПродажи.Организация,
	|	ТаблицаПродажи.Номенклатура,
	|	ТаблицаПродажи.Характеристика,
	|	ТаблицаПродажи.Партия,
	|	ТаблицаПродажи.ЗаказПокупателя,
	|	ТаблицаПродажи.Документ,
	|	ТаблицаПродажи.СтавкаНДС,
	|	ТаблицаПродажи.ПодразделениеПродажи,
	|	ТаблицаПродажи.Проект,
	|	ТаблицаПродажи.Ответственный";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОВозвратах(ИмяТаблицы = "ТаблицаПродажи") 
	
	Если ИмяТаблицы = "ТаблицаПродажиВозвраты" Тогда 
		
		ЗапросТекст =
		"ВЫБРАТЬ
		|	ТаблицаПродажи.Период КАК Период,
		|	ТаблицаПродажи.Организация КАК Организация,
		|	ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка) КАК Склад,
		|	ТаблицаПродажи.Номенклатура КАК Номенклатура,
		|	ТаблицаПродажи.Характеристика КАК Характеристика,
		|	ТаблицаПродажи.Партия КАК Партия,
		|	ТаблицаПродажи.ЗаказПокупателя КАК ЗаказПокупателя,
		|	ВЫБОР
		|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|				И ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Проведен
		|			ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
		|		ИНАЧЕ ТаблицаПродажи.Документ
		|	КОНЕЦ КАК Документ,
		|	ТаблицаПродажи.СтавкаНДС КАК СтавкаНДС,
		|	ТаблицаПродажи.ПодразделениеПродажи КАК Подразделение,
		|	ТаблицаПродажи.Проект КАК Проект,
		|	ТаблицаПродажи.Ответственный КАК Ответственный,
		|	СУММА(ТаблицаПродажи.Количество) КАК Количество,
		|	СУММА(ТаблицаПродажи.СуммаНДСПродажи) КАК СуммаНДС,
		|	СУММА(ТаблицаПродажи.Сумма) КАК Сумма,
		|	0 КАК Себестоимость,
		|	0 КАК СебестоимостьБезНДС,
		|	СУММА(ТаблицаПродажи.Сумма) КАК СуммаБезСкидки
		|ИЗ
		|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаПродажи
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
		|		ПО ТаблицаПродажи.КлючСвязи = ОтчетКомиссионераПокупателиВозвраты.КлючСвязи
		|ГДЕ
		|	ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаПродажи.Период,
		|	ТаблицаПродажи.Организация,
		|	ТаблицаПродажи.Номенклатура,
		|	ТаблицаПродажи.Характеристика,
		|	ТаблицаПродажи.Партия,
		|	ТаблицаПродажи.ЗаказПокупателя,
		|	ТаблицаПродажи.СтавкаНДС,
		|	ТаблицаПродажи.ПодразделениеПродажи,
		|	ТаблицаПродажи.Проект,
		|	ТаблицаПродажи.Ответственный,
		|	ВЫБОР
		|		КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|				И ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера.Проведен
		|			ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
		|		ИНАЧЕ ТаблицаПродажи.Документ
		|	КОНЕЦ";
		
		Возврат ЗапросТекст;
	
	КонецЕсли;
	
	ЗапросТекст =
	"ВЫБРАТЬ
	|	ТаблицаПродажи.Период КАК Период,
	|	ТаблицаПродажи.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка) КАК Склад,
	|	ТаблицаПродажи.Номенклатура КАК Номенклатура,
	|	ТаблицаПродажи.Характеристика КАК Характеристика,
	|	ТаблицаПродажи.Партия КАК Партия,
	|	ТаблицаПродажи.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ТаблицаПродажи.Документ
	|	КОНЕЦ КАК Документ,
	|	ТаблицаПродажи.СтавкаНДС КАК СтавкаНДС,
	|	ТаблицаПродажи.ПодразделениеПродажи КАК Подразделение,
	|	ТаблицаПродажи.Проект КАК Проект,
	|	ТаблицаПродажи.Ответственный КАК Ответственный,
	|	СУММА(ТаблицаПродажи.Количество) КАК Количество,
	|	СУММА(ТаблицаПродажи.СуммаНДСПродажи) КАК СуммаНДС,
	|	СУММА(ТаблицаПродажи.Сумма) КАК Сумма,
	|	0 КАК Себестоимость,
	|	0 КАК СебестоимостьБезНДС,
	|	СУММА(ТаблицаПродажи.Сумма) КАК СуммаБезСкидки
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаПродажи
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|		ПО ТаблицаПродажи.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаПродажи.Период,
	|	ТаблицаПродажи.Организация,
	|	ТаблицаПродажи.Номенклатура,
	|	ТаблицаПродажи.Характеристика,
	|	ТаблицаПродажи.Партия,
	|	ТаблицаПродажи.ЗаказПокупателя,
	|	ТаблицаПродажи.СтавкаНДС,
	|	ТаблицаПродажи.ПодразделениеПродажи,
	|	ТаблицаПродажи.Проект,
	|	ТаблицаПродажи.Ответственный,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ТаблицаПродажи.Документ
	|	КОНЕЦ";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОПродажахЗапасы()
	
	ЗапросТекст =
	"ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ТаблицаЗапасы.Период КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ТаблицаЗапасы.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический) КАК СценарийПланирования,
	|	ТаблицаЗапасы.Документ КАК Документ,
	|	ТаблицаЗапасы.Документ КАК ДокументПродажи,
	|	ТаблицаЗапасы.ЗаказПокупателя КАК ЗаказПродажи,
	|	ТаблицаЗапасы.ПодразделениеПродажи КАК Подразделение,
	|	ТаблицаЗапасы.Ответственный КАК Ответственный,
	|	ТаблицаЗапасы.НаправлениеДеятельностиПродажи КАК НаправлениеДеятельности,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость КАК СчетУчетаСебестоимость,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.ПодразделениеПродажи КАК ПодразделениеПродажи,
	|	ТаблицаЗапасы.СчетУчета КАК СчетУчета,
	|	ТаблицаЗапасы.СчетУчетаНДСПоПриобретеннымЦенностям КАК СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА &РезервированиеЗапасов
	|			ТОГДА ТаблицаЗапасы.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ КАК ЗаказПокупателя,
	|	ТаблицаЗапасы.УдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ТаблицаЗапасы.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ТаблицаЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	СУММА(ТаблицаЗапасы.Количество) КАК Количество,
	|	СУММА(ТаблицаЗапасы.Сумма - ТаблицаЗапасы.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(ТаблицаЗапасы.СуммаНДС) КАК СуммаНДС,
	|	СУММА(ТаблицаЗапасы.Сумма) КАК Сумма,
	|	0 КАК СебестоимостьБезНДС,
	|	СУММА(ТаблицаЗапасы.СуммаВознаграждения) КАК СуммаВознаграждения,
	|	СУММА(ТаблицаЗапасы.СуммаНДСВознаграждения) КАК СуммаНДСВознаграждения,
	|	СУММА(ТаблицаЗапасы.СуммаНДСВознагражденияВал) КАК СуммаНДСВознагражденияВал,
	|	ЛОЖЬ КАК ФиксированнаяСтоимость,
	|	ЛОЖЬ КАК Возврат,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость КАК СчетДт,
	|	ТаблицаЗапасы.СчетУчета КАК СчетКт,
	|	&ОтчетОтКомиссионера КАК Содержание,
	|	&ОтчетОтКомиссионера КАК СодержаниеПроводки
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасы.Период,
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.Документ,
	|	ТаблицаЗапасы.НаправлениеДеятельностиПродажи,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость,
	|	ТаблицаЗапасы.СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.ПодразделениеПродажи,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПокупателя,
	|	ТаблицаЗапасы.СтавкаНДС,
	|	ТаблицаЗапасы.УдержатьКомиссионноеВознаграждение,
	|	ТаблицаЗапасы.Ответственный,
	|	ТаблицаЗапасы.Документ,
	|	ТаблицаЗапасы.ПодразделениеПродажи,
	|	ТаблицаЗапасы.НДСВключатьВСтоимость,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость,
	|	ТаблицаЗапасы.СчетУчета";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОВозвратахЗапасы(ИмяТаблицыЗапасы = "ВременнаяТаблицаЗапасы") 
	
	ЗапросТекст =
	"ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ТаблицаЗапасы.Период КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ТаблицаЗапасы.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.Фактический) КАК СценарийПланирования,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ТаблицаЗапасы.Документ
	|	КОНЕЦ КАК Документ,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ТаблицаЗапасы.Документ
	|	КОНЕЦ КАК ДокументПродажи,
	|	ТаблицаЗапасы.ЗаказПокупателя КАК ЗаказПродажи,
	|	ТаблицаЗапасы.ПодразделениеПродажи КАК Подразделение,
	|	ТаблицаЗапасы.Ответственный КАК Ответственный,
	|	ТаблицаЗапасы.НаправлениеДеятельностиПродажи КАК НаправлениеДеятельности,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость КАК СчетУчетаСебестоимость,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.ПодразделениеПродажи КАК ПодразделениеПродажи,
	|	ТаблицаЗапасы.СчетУчета КАК СчетУчета,
	|	ТаблицаЗапасы.СчетУчетаНДСПоПриобретеннымЦенностям КАК СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ТаблицаЗапасы.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасы.Характеристика КАК Характеристика,
	|	ТаблицаЗапасы.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА &РезервированиеЗапасов
	|			ТОГДА ТаблицаЗапасы.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ КАК ЗаказПокупателя,
	|	ТаблицаЗапасы.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение КАК УдержатьКомиссионноеВознаграждение,
	|	ТаблицаЗапасы.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ТаблицаЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	СУММА(ТаблицаЗапасы.Количество) КАК Количество,
	|	СУММА(ТаблицаЗапасы.Сумма - ТаблицаЗапасы.СуммаНДС) КАК СуммаБезНДС,
	|	СУММА(ТаблицаЗапасы.СуммаНДС) КАК СуммаНДС,
	|	СУММА(ТаблицаЗапасы.Сумма) КАК Сумма,
	|	0 КАК СебестоимостьБезНДС,
	|	СУММА(ТаблицаЗапасы.СуммаВознаграждения) КАК СуммаВознаграждения,
	|	СУММА(ТаблицаЗапасы.СуммаНДСВознаграждения) КАК СуммаНДСВознаграждения,
	|	СУММА(ТаблицаЗапасы.СуммаНДСВознагражденияВал) КАК СуммаНДСВознагражденияВал,
	|	ЛОЖЬ КАК ФиксированнаяСтоимость,
	|	ИСТИНА КАК Возврат,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость КАК СчетДт,
	|	ТаблицаЗапасы.СчетУчета КАК СчетКт,
	|	&ОтчетОтКомиссионера КАК Содержание,
	|	&ОтчетОтКомиссионера КАК СодержаниеПроводки,
	|	ЕСТЬNULL(ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений, ИСТИНА) КАК ИспользоватьНовуюСхемуДвижений,
	|	СУММА(ТаблицаЗапасы.РучнаяСебестоимость) КАК РучнаяСебестоимость
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|		ПО ТаблицаЗапасы.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасы.Период,
	|	ТаблицаЗапасы.Организация,
	|	ТаблицаЗапасы.НаправлениеДеятельностиПродажи,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость,
	|	ТаблицаЗапасы.СтруктурнаяЕдиница,
	|	ТаблицаЗапасы.ПодразделениеПродажи,
	|	ТаблицаЗапасы.СчетУчета,
	|	ТаблицаЗапасы.СчетУчетаНДСПоПриобретеннымЦенностям,
	|	ТаблицаЗапасы.Номенклатура,
	|	ТаблицаЗапасы.Характеристика,
	|	ТаблицаЗапасы.Партия,
	|	ТаблицаЗапасы.ЗаказПокупателя,
	|	ТаблицаЗапасы.НДСВключатьВСтоимость,
	|	ТаблицаЗапасы.СтавкаНДС,
	|	ТаблицаЗапасы.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение,
	|	ТаблицаЗапасы.Ответственный,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ТаблицаЗапасы.Документ
	|	КОНЕЦ,
	|	ЕСТЬNULL(ОтчетКомиссионераПокупатели.ОтчетКомиссионера.ИспользоватьНовуюСхемуДвижений, ИСТИНА),
	|	ТаблицаЗапасы.ПодразделениеПродажи,
	|	ТаблицаЗапасы.СчетУчетаСебестоимость,
	|	ТаблицаЗапасы.СчетУчета,
	|	ВЫБОР
	|		КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|				И ОтчетКомиссионераПокупатели.ОтчетКомиссионера.Проведен
	|			ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|		ИНАЧЕ ТаблицаЗапасы.Документ
	|	КОНЕЦ";
	
	Если Не ИмяТаблицыЗапасы = "ВременнаяТаблицаЗапасы" Тогда 
		ЗапросТекст = СтрЗаменить(ЗапросТекст, "ВременнаяТаблицаЗапасы", ИмяТаблицыЗапасы);
		ЗапросТекст = СтрЗаменить(ЗапросТекст, "Документ.ОтчетКомиссионера.Покупатели", "Документ.ОтчетКомиссионера.ПокупателиВозвраты");
	КонецЕсли;
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОПродажахРасчетыСПокупателями()
	
	ЗапросТекст =
	"ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки) КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.Период КАК Дата,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ТаблицаДокумента.Контрагент КАК Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчета,
	|	ТаблицаДокумента.Договор КАК Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ КАК Заказ,
	|	ТаблицаДокумента.ВалютаРасчетов КАК Валюта,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг) КАК ТипРасчетов,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &ИспользоватьНовуюСхемуДвижений
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|						ИНАЧЕ ТаблицаДокумента.Сумма
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.Сумма
	|		КОНЕЦ) КАК Сумма,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &ИспользоватьНовуюСхемуДвижений
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.СуммаВал - ТаблицаДокумента.СуммаВознагражденияВал
	|						ИНАЧЕ ТаблицаДокумента.СуммаВал
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.СуммаВал
	|		КОНЕЦ) КАК СуммаВал,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			КОГДА НЕ &ИспользоватьНовуюСхемуДвижений
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.СуммаРег - ТаблицаДокумента.СуммаВознагражденияРег
	|						ИНАЧЕ ТаблицаДокумента.СуммаРег
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.СуммаРег
	|		КОНЕЦ) КАК СуммаРег,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &ИспользоватьНовуюСхемуДвижений
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|						ИНАЧЕ ТаблицаДокумента.Сумма
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.Сумма
	|		КОНЕЦ) КАК СуммаДляОстатка,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &ИспользоватьНовуюСхемуДвижений
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.СуммаВал - ТаблицаДокумента.СуммаВознагражденияВал
	|						ИНАЧЕ ТаблицаДокумента.СуммаВал
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.СуммаВал
	|		КОНЕЦ) КАК СуммаВалДляОстатка,
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПокупателя КАК СТРОКА(100)) КАК СодержаниеПроводки,
	|	NULL КАК ВидЗачетаПредоплаты
	|ПОМЕСТИТЬ ВременнаяТаблицаРасчетыСПокупателями
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(-ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(-ТаблицаДокумента.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ -ТаблицаДокумента.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(-ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(-ТаблицаДокумента.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПокупателя КАК СТРОКА(100)),
	|	NULL
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|ГДЕ
	|	ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.ТипРасчетов,
	|	СУММА(ТаблицаДокумента.Сумма),
	|	СУММА(ТаблицаДокумента.СуммаВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокумента.Сумма),
	|	СУММА(ТаблицаДокумента.СуммаВал),
	|	ВЫРАЗИТЬ(&ЗачетАванса КАК СТРОКА(100)),
	|	ТаблицаДокумента.ВидЗачетаПредоплаты
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
	|ГДЕ
	|	(ТаблицаДокумента.ВидЗачетаПредоплаты = ЗНАЧЕНИЕ(Перечисление.ВидыЗачетаПредоплаты.Продажа)
	|			ИЛИ ТаблицаДокумента.ВидЗачетаПредоплаты = ЗНАЧЕНИЕ(Перечисление.ВидыЗачетаПредоплаты.ПустаяСсылка))
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ТипРасчетов,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|	ТаблицаДокумента.ВидЗачетаПредоплаты
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.ДокументКуда
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.ТипРасчетовКуда,
	|	СУММА(ТаблицаДокумента.Сумма),
	|	СУММА(ТаблицаДокумента.СуммаВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаРег
	|		КОНЕЦ),
	|	-СУММА(ТаблицаДокумента.Сумма),
	|	-СУММА(ТаблицаДокумента.СуммаВал),
	|	ВЫРАЗИТЬ(&ЗачетАванса КАК СТРОКА(100)),
	|	ТаблицаДокумента.ВидЗачетаПредоплаты
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
	|ГДЕ
	|	(ТаблицаДокумента.ВидЗачетаПредоплаты = ЗНАЧЕНИЕ(Перечисление.ВидыЗачетаПредоплаты.Продажа)
	|			ИЛИ ТаблицаДокумента.ВидЗачетаПредоплаты = ЗНАЧЕНИЕ(Перечисление.ВидыЗачетаПредоплаты.ПустаяСсылка))
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.ДокументКуда
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.ТипРасчетовКуда,
	|	ТаблицаДокумента.ВидЗачетаПредоплаты
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Контрагент,
	|	Договор,
	|	Валюта,
	|	Документ,
	|	Заказ,
	|	ТипРасчетов,
	|	СчетУчета";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОВозвратахРасчетыСПокупателями(ИмяТаблицы = "ТаблицаРасчетыСПокупателями") 
	
	Если ИмяТаблицы = "ТаблицаРасчетыСПокупателямиВозвраты" Тогда 
		ЗапросТекст =
		"ВЫБРАТЬ
		|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки) КАК НомерСтроки,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
		|	ТаблицаДокумента.Период КАК Дата,
		|	ТаблицаДокумента.Организация КАК Организация,
		|	ТаблицаДокумента.Контрагент КАК Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчета,
		|	ТаблицаДокумента.Договор КАК Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ВЫБОР
		|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
		|					ИНАЧЕ ТаблицаДокумента.Документ
		|				КОНЕЦ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК Документ,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ КАК Заказ,
		|	ТаблицаДокумента.ВалютаРасчетов КАК Валюта,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг) КАК ТипРасчетов,
		|	СУММА(ВЫБОР
		|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
		|				ТОГДА ВЫБОР
		|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
		|							ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
		|						ИНАЧЕ ТаблицаДокумента.Сумма
		|					КОНЕЦ
		|			ИНАЧЕ ТаблицаДокумента.Сумма
		|		КОНЕЦ) КАК Сумма,
		|	СУММА(ВЫБОР
		|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
		|				ТОГДА ВЫБОР
		|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
		|							ТОГДА ТаблицаДокумента.СуммаВал - ТаблицаДокумента.СуммаВознагражденияВал
		|						ИНАЧЕ ТаблицаДокумента.СуммаВал
		|					КОНЕЦ
		|			ИНАЧЕ ТаблицаДокумента.СуммаВал
		|		КОНЕЦ) КАК СуммаВал,
		|	СУММА(ВЫБОР
		|			КОГДА НЕ &УчетВалютныхОпераций
		|				ТОГДА 0
		|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
		|				ТОГДА ВЫБОР
		|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
		|							ТОГДА ТаблицаДокумента.СуммаРег - ТаблицаДокумента.СуммаВознагражденияРег
		|						ИНАЧЕ ТаблицаДокумента.СуммаРег
		|					КОНЕЦ
		|			ИНАЧЕ ТаблицаДокумента.СуммаРег
		|		КОНЕЦ) КАК СуммаРег,
		|	СУММА(ВЫБОР
		|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
		|				ТОГДА ВЫБОР
		|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
		|							ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
		|						ИНАЧЕ ТаблицаДокумента.Сумма
		|					КОНЕЦ
		|			ИНАЧЕ ТаблицаДокумента.Сумма
		|		КОНЕЦ) КАК СуммаДляОстатка,
		|	СУММА(ВЫБОР
		|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
		|				ТОГДА ВЫБОР
		|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
		|							ТОГДА ТаблицаДокумента.СуммаВал - ТаблицаДокумента.СуммаВознагражденияВал
		|						ИНАЧЕ ТаблицаДокумента.СуммаВал
		|					КОНЕЦ
		|			ИНАЧЕ ТаблицаДокумента.СуммаВал
		|		КОНЕЦ) КАК СуммаВалДляОстатка,
		|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПокупателя КАК СТРОКА(100)) КАК СодержаниеПроводки
		|ПОМЕСТИТЬ ВременнаяТаблицаРасчетыСПокупателямиВозвраты
		|ИЗ
		|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПокупателиВозвраты КАК ТаблицаПокупатели
		|		ПО ТаблицаДокумента.КлючСвязи = ТаблицаПокупатели.КлючСвязи
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ВЫБОР
		|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
		|					ИНАЧЕ ТаблицаДокумента.Документ
		|				КОНЕЦ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ВЫБОР
		|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
		|					ИНАЧЕ ТаблицаДокумента.Документ
		|				КОНЕЦ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
		|	СУММА(-ТаблицаДокумента.СуммаВознаграждения),
		|	СУММА(-ТаблицаДокумента.СуммаВознагражденияВал),
		|	СУММА(ВЫБОР
		|			КОГДА НЕ &УчетВалютныхОпераций
		|				ТОГДА 0
		|			ИНАЧЕ -ТаблицаДокумента.СуммаВознагражденияРег
		|		КОНЕЦ),
		|	СУММА(-ТаблицаДокумента.СуммаВознаграждения),
		|	СУММА(-ТаблицаДокумента.СуммаВознагражденияВал),
		|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПокупателя КАК СТРОКА(100))
		|ИЗ
		|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПокупателиВозвраты КАК ТаблицаПокупатели
		|		ПО ТаблицаДокумента.КлючСвязи = ТаблицаПокупатели.КлючСвязи
		|ГДЕ
		|	ТаблицаДокумента.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
		|	И ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
		|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ВЫБОР
		|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
		|					ИНАЧЕ ТаблицаДокумента.Документ
		|				КОНЕЦ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ТаблицаДокумента.Документ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.Заказ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ТаблицаДокумента.ТипРасчетов,
		|	СУММА(ТаблицаДокумента.Сумма),
		|	СУММА(ТаблицаДокумента.СуммаВал),
		|	СУММА(ВЫБОР
		|			КОГДА НЕ &УчетВалютныхОпераций
		|				ТОГДА 0
		|			ИНАЧЕ ТаблицаДокумента.СуммаРег
		|		КОНЕЦ),
		|	СУММА(ТаблицаДокумента.Сумма),
		|	СУММА(ТаблицаДокумента.СуммаВал),
		|	ВЫРАЗИТЬ(&ЗачетАванса КАК СТРОКА(100))
		|ИЗ
		|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
		|ГДЕ
		|	ТаблицаДокумента.Сумма < 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.Заказ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.ТипРасчетов,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ТаблицаДокумента.Документ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ВЫБОР
		|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
		|					ИНАЧЕ ТаблицаДокумента.ДокументКуда
		|				КОНЕЦ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.Заказ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ТаблицаДокумента.ТипРасчетовКуда,
		|	СУММА(ТаблицаДокумента.Сумма),
		|	СУММА(ТаблицаДокумента.СуммаВал),
		|	СУММА(ВЫБОР
		|			КОГДА НЕ &УчетВалютныхОпераций
		|				ТОГДА 0
		|			ИНАЧЕ ТаблицаДокумента.СуммаРег
		|		КОНЕЦ),
		|	-СУММА(ТаблицаДокумента.Сумма),
		|	-СУММА(ТаблицаДокумента.СуммаВал),
		|	ВЫРАЗИТЬ(&ЗачетАванса КАК СТРОКА(100))
		|ИЗ
		|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПокупателиДокументыВозвратаВозвраты КАК ТаблицаПокупатели
		|		ПО ТаблицаДокумента.ОтчетКомиссионера = ТаблицаПокупатели.ОтчетКомиссионера
		|ГДЕ
		|	ТаблицаДокумента.Сумма < 0
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаДокумента.Период,
		|	ТаблицаДокумента.Организация,
		|	ТаблицаДокумента.Контрагент,
		|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
		|	ТаблицаДокумента.Договор,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
		|			ТОГДА ТаблицаДокумента.Заказ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
		|	КОНЕЦ,
		|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
		|	ТаблицаДокумента.ВалютаРасчетов,
		|	ТаблицаДокумента.ТипРасчетовКуда,
		|	ВЫБОР
		|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
		|			ТОГДА ВЫБОР
		|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
		|					ИНАЧЕ ТаблицаДокумента.ДокументКуда
		|				КОНЕЦ
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Организация,
		|	Контрагент,
		|	Договор,
		|	Валюта,
		|	Документ,
		|	Заказ,
		|	ТипРасчетов,
		|	СчетУчета";
		
		Возврат ЗапросТекст;
	КонецЕсли;
	
	ЗапросТекст =
	"ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки) КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.Период КАК Дата,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ТаблицаДокумента.Контрагент КАК Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам КАК ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем КАК СчетУчета,
	|	ТаблицаДокумента.Договор КАК Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ ТаблицаДокумента.Документ
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ КАК Заказ,
	|	ТаблицаДокумента.ВалютаРасчетов КАК Валюта,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг) КАК ТипРасчетов,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|						ИНАЧЕ ТаблицаДокумента.Сумма
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.Сумма
	|		КОНЕЦ) КАК Сумма,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.СуммаВал - ТаблицаДокумента.СуммаВознагражденияВал
	|						ИНАЧЕ ТаблицаДокумента.СуммаВал
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.СуммаВал
	|		КОНЕЦ) КАК СуммаВал,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.СуммаРег - ТаблицаДокумента.СуммаВознагражденияРег
	|						ИНАЧЕ ТаблицаДокумента.СуммаРег
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.СуммаРег
	|		КОНЕЦ) КАК СуммаРег,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|						ИНАЧЕ ТаблицаДокумента.Сумма
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.Сумма
	|		КОНЕЦ) КАК СуммаДляОстатка,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|				ТОГДА ВЫБОР
	|						КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|							ТОГДА ТаблицаДокумента.СуммаВал - ТаблицаДокумента.СуммаВознагражденияВал
	|						ИНАЧЕ ТаблицаДокумента.СуммаВал
	|					КОНЕЦ
	|			ИНАЧЕ ТаблицаДокумента.СуммаВал
	|		КОНЕЦ) КАК СуммаВалДляОстатка,
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПокупателя КАК СТРОКА(100)) КАК СодержаниеПроводки
	|ПОМЕСТИТЬ ВременнаяТаблицаРасчетыСПокупателями
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПокупатели КАК ТаблицаПокупатели
	|		ПО ТаблицаДокумента.КлючСвязи = ТаблицаПокупатели.КлючСвязи
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ ТаблицаДокумента.Документ
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ ТаблицаДокумента.Документ
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Долг),
	|	СУММА(-ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(-ТаблицаДокумента.СуммаВознагражденияВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ -ТаблицаДокумента.СуммаВознагражденияРег
	|		КОНЕЦ),
	|	СУММА(-ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(-ТаблицаДокумента.СуммаВознагражденияВал),
	|	ВЫРАЗИТЬ(&ВозникновениеОбязательствПокупателя КАК СТРОКА(100))
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПокупатели КАК ТаблицаПокупатели
	|		ПО ТаблицаДокумента.КлючСвязи = ТаблицаПокупатели.КлючСвязи
	|ГДЕ
	|	ТаблицаДокумента.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.ЗаказПокупателя
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ ТаблицаДокумента.Документ
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.ТипРасчетов,
	|	СУММА(ТаблицаДокумента.Сумма),
	|	СУММА(ТаблицаДокумента.СуммаВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаРег
	|		КОНЕЦ),
	|	СУММА(ТаблицаДокумента.Сумма),
	|	СУММА(ТаблицаДокумента.СуммаВал),
	|	ВЫРАЗИТЬ(&ЗачетАванса КАК СТРОКА(100))
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
	|ГДЕ
	|	ТаблицаДокумента.Сумма > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ТипРасчетов,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.СчетУчетаАвансовПокупателя,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ТаблицаДокумента.Документ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ТаблицаДокумента.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ ТаблицаДокумента.ДокументКуда
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.ТипРасчетовКуда,
	|	СУММА(ТаблицаДокумента.Сумма),
	|	СУММА(ТаблицаДокумента.СуммаВал),
	|	СУММА(ВЫБОР
	|			КОГДА НЕ &УчетВалютныхОпераций
	|				ТОГДА 0
	|			ИНАЧЕ ТаблицаДокумента.СуммаРег
	|		КОНЕЦ),
	|	-СУММА(ТаблицаДокумента.Сумма),
	|	-СУММА(ТаблицаДокумента.СуммаВал),
	|	ВЫРАЗИТЬ(&ЗачетАванса КАК СТРОКА(100))
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВременнаяТаблицаПокупателиДокументыВозврата КАК ТаблицаПокупатели
	|		ПО ТаблицаДокумента.ОтчетКомиссионера = ТаблицаПокупатели.ОтчетКомиссионера
	|ГДЕ
	|	ТаблицаДокумента.Сумма > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.Контрагент,
	|	ТаблицаДокумента.ВестиРасчетыПоДокументам,
	|	ТаблицаДокумента.Договор,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоЗаказам
	|			ТОГДА ТаблицаДокумента.Заказ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Документ.ЗаказПокупателя.ПустаяСсылка)
	|	КОНЕЦ,
	|	ТаблицаДокумента.СчетУчетаРасчетовСПокупателем,
	|	ТаблицаДокумента.ВалютаРасчетов,
	|	ТаблицаДокумента.ТипРасчетовКуда,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ТаблицаПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ТаблицаПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ ТаблицаДокумента.ДокументКуда
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Контрагент,
	|	Договор,
	|	Валюта,
	|	Документ,
	|	Заказ,
	|	ТипРасчетов,
	|	СчетУчета";
	
	Возврат ЗапросТекст;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОВозвратахДоходыИРасходыОтложенные()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокумента.Период КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ТаблицаДокумента.КлючСвязи КАК КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА &ИспользоватьНовуюСхемуДвижений
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|						ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|					ИНАЧЕ ТаблицаДокумента.Сумма
	|				КОНЕЦ
	|		ИНАЧЕ ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|	КОНЕЦ КАК СуммаДоходов,
	|	ТаблицаДокумента.СуммаВознаграждения КАК СуммаВознаграждения,
	|	0 КАК СуммаРасходов
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|		ПО ТаблицаДокумента.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	1,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	0,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|		ПО ТаблицаДокумента.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|	И НЕ ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И НЕ ТаблицаДокумента.ЭтоВозврат
	|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|	И &ИспользоватьНовуюСхемуДвижений
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	1,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	0,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|		ПО ТаблицаДокумента.КлючСвязи = ОтчетКомиссионераПокупатели.КлючСвязи,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И ОтчетКомиссионераПокупатели.Ссылка = &Ссылка
	|	И НЕ ТаблицаДокумента.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И ТаблицаДокумента.ЭтоВозврат
	|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И ТаблицаДокумента.ИспользоватьНовуюСхемуДвиженийВОтчете
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.ДокументДата КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	СУММА(ТаблицаДокумента.Сумма) КАК СуммаКСписанию
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.ДокументДата,
	|	ТаблицаДокумента.Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокумента.Статья КАК Статья
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераДоходыИРасходыОтложенные() 
		
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокументаВозвраты.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокументаВозвраты.Период КАК Период,
	|	ТаблицаДокументаВозвраты.Организация КАК Организация,
	|	ТаблицаДокументаВозвраты.КлючСвязи КАК КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ТаблицаДокументаВозвраты.НаправлениеДеятельностиПродажи КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА &ИспользоватьНовуюСхемуДвижений
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаДокументаВозвраты.УдержатьКомиссионноеВознаграждение
	|						ТОГДА ТаблицаДокументаВозвраты.Сумма - ТаблицаДокументаВозвраты.СуммаВознаграждения
	|					ИНАЧЕ ТаблицаДокументаВозвраты.Сумма
	|				КОНЕЦ
	|		ИНАЧЕ ТаблицаДокументаВозвраты.Сумма - ТаблицаДокументаВозвраты.СуммаВознаграждения
	|	КОНЕЦ КАК СуммаДоходов,
	|	0 КАК СуммаРасходов,
	|	ТаблицаДокументаВозвраты.СуммаВознаграждения КАК СуммаВознаграждения,
	|	ИСТИНА КАК ЭтоВозврат
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокументаВозвраты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|		ПО ТаблицаДокументаВозвраты.КлючСвязи = ОтчетКомиссионераПокупателиВозвраты.КлючСвязи,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	1,
	|	ТаблицаДокументаВозвраты.Период,
	|	ТаблицаДокументаВозвраты.Организация,
	|	ТаблицаДокументаВозвраты.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокументаВозвраты.НаправлениеДеятельностиПродажи,
	|	0,
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознаграждения),
	|	СУММА(ТаблицаДокументаВозвраты.СуммаВознаграждения),
	|	ИСТИНА
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаДокументаВозвраты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|		ПО ТаблицаДокументаВозвраты.КлючСвязи = ОтчетКомиссионераПокупателиВозвраты.КлючСвязи,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И ОтчетКомиссионераПокупателиВозвраты.Ссылка = &Ссылка
	|	И НЕ ТаблицаДокументаВозвраты.ОтчетКомиссионераУдержатьКомиссионноеВознаграждение
	|	И НЕ ТаблицаДокументаВозвраты.СуммаВознаграждения = 0
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И ТаблицаДокументаВозвраты.ИспользоватьНовуюСхемуДвиженийВОтчете
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокументаВозвраты.Организация,
	|	ТаблицаДокументаВозвраты.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокументаВозвраты.ВестиРасчетыПоДокументам
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
	|						ТОГДА ОтчетКомиссионераПокупателиВозвраты.ОтчетКомиссионера
	|					ИНАЧЕ &Ссылка
	|				КОНЕЦ
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокументаВозвраты.Период,
	|	ТаблицаДокументаВозвраты.НаправлениеДеятельностиПродажи
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	ТаблицаДокумента.НомерСтроки,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА &Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	ВЫБОР
	|		КОГДА &ИспользоватьНовуюСхемуДвижений
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|						ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|					ИНАЧЕ ТаблицаДокумента.Сумма
	|				КОНЕЦ
	|		ИНАЧЕ ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|	КОНЕЦ,
	|	0,
	|	ТаблицаДокумента.СуммаВознаграждения,
	|	ЛОЖЬ
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	1,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА &Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	0,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	ЛОЖЬ
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.КлючСвязи,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	ТаблицаДокумента.Период,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА &Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.ДокументДата КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	СУММА(ТаблицаДокумента.Сумма) КАК СуммаКСписанию,
	|	ЛОЖЬ КАК ЭтоВозврат
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.ДокументДата,
	|	ТаблицаДокумента.Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокумента.Статья КАК Статья,
	|	ЛОЖЬ КАК ЭтоВозврат
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаОтчетКомиссионераОПродажахДоходыИРасходыОтложенные()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	ТаблицаДокумента.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокумента.Период КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА &Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Документ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА &ИспользоватьНовуюСхемуДвижений
	|			ТОГДА ВЫБОР
	|					КОГДА ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|						ТОГДА ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|					ИНАЧЕ ТаблицаДокумента.Сумма
	|				КОНЕЦ
	|		ИНАЧЕ ТаблицаДокумента.Сумма - ТаблицаДокумента.СуммаВознаграждения
	|	КОНЕЦ КАК СуммаДоходов,
	|	0 КАК СуммаРасходов,
	|	ТаблицаДокумента.СуммаВознаграждения КАК СуммаВознаграждения
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	1,
	|	ТаблицаДокумента.Период,
	|	ТаблицаДокумента.Организация,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА &Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	0,
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения),
	|	СУММА(ТаблицаДокумента.СуммаВознаграждения)
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|	И &ИспользоватьНовуюСхемуДвижений
	|	И НЕ ТаблицаДокумента.УдержатьКомиссионноеВознаграждение
	|	И НЕ ТаблицаДокумента.СуммаВознаграждения = 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.Организация,
	|	ТаблицаДокумента.НаправлениеДеятельностиПродажи,
	|	ТаблицаДокумента.Период,
	|	ВЫБОР
	|		КОГДА ТаблицаДокумента.ВестиРасчетыПоДокументам
	|			ТОГДА &Ссылка
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.ДокументДата КАК Период,
	|	ТаблицаДокумента.Организация КАК Организация,
	|	СУММА(ТаблицаДокумента.Сумма) КАК СуммаКСписанию
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаДокумента.ДокументДата,
	|	ТаблицаДокумента.Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаДокумента.НомерСтроки КАК НомерСтроки,
	|	ТаблицаДокумента.Статья КАК Статья
	|ИЗ
	|	ВременнаяТаблицаПредоплата КАК ТаблицаДокумента,
	|	ВременнаяТаблицаШапка КАК ВременнаяТаблицаШапка
	|ГДЕ
	|	&КассовыйМетодУчетаДоходовИРасходов
	|	И НЕ ВременнаяТаблицаШапка.ВестиУчетРасходовПоДоговорамОбслуживания
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Выполняет контроль возникновения отрицательных остатков.
//
Процедура ВыполнитьКонтроль(ДокументСсылкаОтчетКомиссионера, ДополнительныеСвойства, Отказ, УдалениеПроведения = Ложь) Экспорт
	
	Если ПроведениеДокументовУНФ.КонтрольОстатковВыключен() Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураВременныеТаблицы = ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;
	
	// Если временные таблицы "ДвиженияЗапасыИзменение", "ДвиженияЗапасыПереданныеИзменение"
	// содержат записи, необходимо выполнить контроль реализации товаров.
	
	Если СтруктураВременныеТаблицы.ДвиженияЗапасыИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияЗапасыВРазрезеГТДИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияЗапасыПереданныеВРазрезеГТДИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияЗапасыПереданныеИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияРасчетыСПокупателямиИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияРасчетыСПоставщикамиИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияПрослеживаемыеТоварыИзменение Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	ДвиженияЗапасыИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиницаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.СчетУчета) КАК СчетУчетаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.ЗаказПокупателя) КАК ЗаказПокупателяПредставление,
		|	ЗапасыОстатки.СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы КАК ТипСтруктурнойЕдиницы,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасы,
		|	ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасы,
		|	ЕСТЬNULL(ЗапасыОстатки.СуммаОстаток, 0) КАК СуммаОстатокЗапасы
		|ИЗ
		|	ДвиженияЗапасыИзменение КАК ДвиженияЗапасыИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
		|				&МоментКонтроля,
		|				(Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыИзменение.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|						ДвиженияЗапасыИзменение.СчетУчета КАК СчетУчета,
		|						ДвиженияЗапасыИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыИзменение.ЗаказПокупателя КАК ЗаказПокупателя
		|					ИЗ
		|						ДвиженияЗапасыИзменение КАК ДвиженияЗапасыИзменение)) КАК ЗапасыОстатки
		|		ПО ДвиженияЗапасыИзменение.Организация = ЗапасыОстатки.Организация
		|			И ДвиженияЗапасыИзменение.СтруктурнаяЕдиница = ЗапасыОстатки.СтруктурнаяЕдиница
		|			И ДвиженияЗапасыИзменение.СчетУчета = ЗапасыОстатки.СчетУчета
		|			И ДвиженияЗапасыИзменение.Номенклатура = ЗапасыОстатки.Номенклатура
		|			И ДвиженияЗапасыИзменение.Характеристика = ЗапасыОстатки.Характеристика
		|			И ДвиженияЗапасыИзменение.Партия = ЗапасыОстатки.Партия
		|			И ДвиженияЗапасыИзменение.ЗаказПокупателя = ЗапасыОстатки.ЗаказПокупателя
		|ГДЕ
		|	ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыПереданныеИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи) КАК ТипПриемаПередачиПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыПереданныеОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыПереданныеОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ЗапасыПереданныеОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.СуммаРасчетовИзменение, 0) + ЕСТЬNULL(ЗапасыПереданныеОстатки.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовЗапасыПереданные,
		|	ЕСТЬNULL(ЗапасыПереданныеОстатки.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовОстатокЗапасыПереданные
		|ИЗ
		|	ДвиженияЗапасыПереданныеИзменение КАК ДвиженияЗапасыПереданныеИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыПереданные.Остатки(
		|				&МоментКонтроля,
		|				(Организация, Номенклатура, Характеристика, Партия, Контрагент, Договор, Заказ, ТипПриемаПередачи) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыПереданныеИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыПереданныеИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыПереданныеИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыПереданныеИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыПереданныеИзменение.Контрагент КАК Контрагент,
		|						ДвиженияЗапасыПереданныеИзменение.Договор КАК Договор,
		|						ДвиженияЗапасыПереданныеИзменение.Заказ КАК Заказ,
		|						ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи КАК ТипПриемаПередачи
		|					ИЗ
		|						ДвиженияЗапасыПереданныеИзменение КАК ДвиженияЗапасыПереданныеИзменение)) КАК ЗапасыПереданныеОстатки
		|		ПО ДвиженияЗапасыПереданныеИзменение.Организация = ЗапасыПереданныеОстатки.Организация
		|			И ДвиженияЗапасыПереданныеИзменение.Номенклатура = ЗапасыПереданныеОстатки.Номенклатура
		|			И ДвиженияЗапасыПереданныеИзменение.Характеристика = ЗапасыПереданныеОстатки.Характеристика
		|			И ДвиженияЗапасыПереданныеИзменение.Партия = ЗапасыПереданныеОстатки.Партия
		|			И ДвиженияЗапасыПереданныеИзменение.Контрагент = ЗапасыПереданныеОстатки.Контрагент
		|			И ДвиженияЗапасыПереданныеИзменение.Договор = ЗапасыПереданныеОстатки.Договор
		|			И ДвиженияЗапасыПереданныеИзменение.Заказ = ЗапасыПереданныеОстатки.Заказ
		|			И ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи = ЗапасыПереданныеОстатки.ТипПриемаПередачи
		|ГДЕ
		|	(ЕСТЬNULL(ЗапасыПереданныеОстатки.КоличествоОстаток, 0) < 0
		|			ИЛИ ЕСТЬNULL(ЗапасыПереданныеОстатки.СуммаРасчетовОстаток, 0) < 0)
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияРасчетыСПокупателямиИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Договор.ВалютаРасчетов) КАК ВалютаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Документ) КАК ДокументПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов) КАК ТипРасчетовПредставление,
		|	ЛОЖЬ КАК ДвиженияДенежныхДокументов,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаПередЗаписью КАК СуммаПередЗаписью,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаПриЗаписи КАК СуммаПриЗаписи,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаИзменение КАК СуммаИзменение,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПередЗаписью КАК СуммаВалПередЗаписью,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи КАК СуммаВалПриЗаписи,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалИзменение КАК СуммаВалИзменение,
		|	ВЫБОР
		|		КОГДА ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи >= 0
		|			ТОГДА ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи - ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0)
		|		ИНАЧЕ ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) + ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи
		|	КОНЕЦ КАК СуммаПолученныхАвансов,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалИзменение + ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) КАК СуммаНепогашеннойЗадолженности,
		|	ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
		|	ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) КАК СуммаВалОстаток,
		|	ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов КАК ТипРасчетов
		|ИЗ
		|	ДвиженияРасчетыСПокупателямиИзменение КАК ДвиженияРасчетыСПокупателямиИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПокупателями.Остатки(
		|				&МоментКонтроля,
		|				(Организация, Контрагент, Договор, Документ, Заказ, ТипРасчетов) В
		|					(ВЫБРАТЬ
		|						ДвиженияРасчетыСПокупателямиИзменение.Организация КАК Организация,
		|						ДвиженияРасчетыСПокупателямиИзменение.Контрагент КАК Контрагент,
		|						ДвиженияРасчетыСПокупателямиИзменение.Договор КАК Договор,
		|						ДвиженияРасчетыСПокупателямиИзменение.Документ КАК Документ,
		|						ДвиженияРасчетыСПокупателямиИзменение.Заказ КАК Заказ,
		|						ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов КАК ТипРасчетов
		|					ИЗ
		|						ДвиженияРасчетыСПокупателямиИзменение КАК ДвиженияРасчетыСПокупателямиИзменение)) КАК РасчетыСПокупателямиОстатки
		|		ПО ДвиженияРасчетыСПокупателямиИзменение.Организация = РасчетыСПокупателямиОстатки.Организация
		|			И ДвиженияРасчетыСПокупателямиИзменение.Контрагент = РасчетыСПокупателямиОстатки.Контрагент
		|			И ДвиженияРасчетыСПокупателямиИзменение.Договор = РасчетыСПокупателямиОстатки.Договор
		|			И ДвиженияРасчетыСПокупателямиИзменение.Документ = РасчетыСПокупателямиОстатки.Документ
		|			И ДвиженияРасчетыСПокупателямиИзменение.Заказ = РасчетыСПокупателямиОстатки.Заказ
		|			И ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов = РасчетыСПокупателямиОстатки.ТипРасчетов
		|ГДЕ
		|	ВЫБОР
		|			КОГДА &ЭтоВозврат
		|					И ДвиженияРасчетыСПокупателямиИзменение.Документ = &Ссылка
		|				ТОГДА ЛОЖЬ
		|			ИНАЧЕ ВЫБОР
		|					КОГДА ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)
		|						ТОГДА ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) > 0
		|					ИНАЧЕ ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) < 0
		|				КОНЕЦ
		|		КОНЕЦ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыВРазрезеГТДИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.НомерГТД) КАК НомерГТДПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.СтранаПроисхождения) КАК СтранаПроисхожденияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыВРазрезеГТДОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыВРазрезеГТДИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасыВРазрезеГТД,
		|	ЕСТЬNULL(ЗапасыВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыВРазрезеГТД
		|ИЗ
		|	ДвиженияЗапасыВРазрезеГТДИзменение КАК ДвиженияЗапасыВРазрезеГТДИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыВРазрезеГТД.Остатки(
		|				&МоментКонтроля,
		|				(Организация, НомерГТД, Номенклатура, Характеристика, Партия, СтранаПроисхождения) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.НомерГТД КАК НомерГТД,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.СтранаПроисхождения КАК СтранаПроисхождения
		|					ИЗ
		|						ДвиженияЗапасыВРазрезеГТДИзменение КАК ДвиженияЗапасыВРазрезеГТДИзменение)) КАК ЗапасыВРазрезеГТДОстатки
		|		ПО ДвиженияЗапасыВРазрезеГТДИзменение.Организация = ЗапасыВРазрезеГТДОстатки.Организация
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.НомерГТД = ЗапасыВРазрезеГТДОстатки.НомерГТД
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.Номенклатура = ЗапасыВРазрезеГТДОстатки.Номенклатура
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.Характеристика = ЗапасыВРазрезеГТДОстатки.Характеристика
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.Партия = ЗапасыВРазрезеГТДОстатки.Партия
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.СтранаПроисхождения = ЗапасыВРазрезеГТДОстатки.СтранаПроисхождения
		|ГДЕ
		|	ЕСТЬNULL(ЗапасыВРазрезеГТДОстатки.КоличествоОстаток, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерГТД) КАК НомерГТДПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.СтранаПроисхождения) КАК СтранаПроисхожденияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыПереданныеВРазрезеГТДОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыПереданныеВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасыВРазрезеГТД,
		|	ЕСТЬNULL(ЗапасыПереданныеВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыВРазрезеГТД
		|ИЗ
		|	ДвиженияЗапасыПереданныеВРазрезеГТДИзменение КАК ДвиженияЗапасыПереданныеВРазрезеГТДИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыПереданныеВРазрезеГТД.Остатки(
		|				&МоментКонтроля,
		|				(Организация, НомерГТД, Номенклатура, Характеристика, Партия, СтранаПроисхождения) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерГТД КАК НомерГТД,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.СтранаПроисхождения КАК СтранаПроисхождения
		|					ИЗ
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение КАК ДвиженияЗапасыПереданныеВРазрезеГТДИзменение)) КАК ЗапасыПереданныеВРазрезеГТДОстатки
		|		ПО ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Организация = ЗапасыПереданныеВРазрезеГТДОстатки.Организация
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерГТД = ЗапасыПереданныеВРазрезеГТДОстатки.НомерГТД
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Номенклатура = ЗапасыПереданныеВРазрезеГТДОстатки.Номенклатура
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Характеристика = ЗапасыПереданныеВРазрезеГТДОстатки.Характеристика
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Партия = ЗапасыПереданныеВРазрезеГТДОстатки.Партия
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.СтранаПроисхождения = ЗапасыПереданныеВРазрезеГТДОстатки.СтранаПроисхождения
		|ГДЕ
		|	ЕСТЬNULL(ЗапасыПереданныеВРазрезеГТДОстатки.КоличествоОстаток, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияПрослеживаемыеТоварыИзменение.НомерСтроки КАК НомерСтроки,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Организация КАК ОрганизацияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.РНПТ КАК РНПТПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения КАК СтранаПроисхожденияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура КАК НоменклатураПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Характеристика КАК ХарактеристикаПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Партия КАК ПартияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Комплектующие КАК Комплектующие,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ПрослеживаемыйКомплект КАК ПрослеживаемыйКомплект,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер КАК Комиссионер,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПрослеживаемостиПредставление,
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоОстаток, 0) КАК ОстатокКоличество,
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПрослеживаемостиИзменение, 0) + ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоПрослеживаемостиОстаток, 0) КАК ОстатокКоличествоПрослеживаемости,
		|	ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоОстаток, 0) КАК ОстатокКоличествоТекущий,
		|	ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоПрослеживаемостиОстаток, 0) КАК ОстатокКоличествоПрослеживаемостиТекущий
		|ИЗ
		|	ДвиженияПрослеживаемыеТоварыИзменение КАК ДвиженияПрослеживаемыеТоварыИзменение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПрослеживаемыеТовары.Остатки(&МоментКонтроля, ) КАК ПрослеживаемыеТоварыОстатки
		|		ПО ДвиженияПрослеживаемыеТоварыИзменение.Организация = ПрослеживаемыеТоварыОстатки.Организация
		|			И ДвиженияПрослеживаемыеТоварыИзменение.РНПТ = ПрослеживаемыеТоварыОстатки.РНПТ
		|			И ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения = ПрослеживаемыеТоварыОстатки.СтранаПроисхождения
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура = ПрослеживаемыеТоварыОстатки.Номенклатура
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Характеристика = ПрослеживаемыеТоварыОстатки.Характеристика
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Партия = ПрослеживаемыеТоварыОстатки.Партия
		|			И (ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоОстаток, 0) < 0
		|				ИЛИ ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоПрослеживаемостиОстаток, 0) < 0)
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер = ПрослеживаемыеТоварыОстатки.Комиссионер
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Комплектующие = ПрослеживаемыеТоварыОстатки.Комплектующие
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияРасчетыСПоставщикамиИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Договор.ВалютаРасчетов) КАК ВалютаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Документ) КАК ДокументПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов) КАК ТипРасчетовПредставление,
		|	ЛОЖЬ КАК ДвиженияДенежныхДокументов,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаПередЗаписью КАК СуммаПередЗаписью,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаПриЗаписи КАК СуммаПриЗаписи,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаИзменение КАК СуммаИзменение,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПередЗаписью КАК СуммаВалПередЗаписью,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПриЗаписи КАК СуммаВалПриЗаписи,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалИзменение КАК СуммаВалИзменение,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПриЗаписи - ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаВыданныхАвансов,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалИзменение + ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаНепогашеннойЗадолженности,
		|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
		|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаВалОстаток,
		|	ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов КАК ТипРасчетов
		|ИЗ
		|	ДвиженияРасчетыСПоставщикамиИзменение КАК ДвиженияРасчетыСПоставщикамиИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками.Остатки(
		|				&МоментКонтроля,
		|				(Организация, Контрагент, Договор, Документ, Заказ, ТипРасчетов) В
		|					(ВЫБРАТЬ
		|						ДвиженияРасчетыСПоставщикамиИзменение.Организация КАК Организация,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Контрагент КАК Контрагент,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Договор КАК Договор,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Документ КАК Документ,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Заказ КАК Заказ,
		|						ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов КАК ТипРасчетов
		|					ИЗ
		|						ДвиженияРасчетыСПоставщикамиИзменение КАК ДвиженияРасчетыСПоставщикамиИзменение)) КАК РасчетыСПоставщикамиОстатки
		|		ПО ДвиженияРасчетыСПоставщикамиИзменение.Организация = РасчетыСПоставщикамиОстатки.Организация
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Контрагент = РасчетыСПоставщикамиОстатки.Контрагент
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Договор = РасчетыСПоставщикамиОстатки.Договор
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Документ = РасчетыСПоставщикамиОстатки.Документ
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Заказ = РасчетыСПоставщикамиОстатки.Заказ
		|			И ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов = РасчетыСПоставщикамиОстатки.ТипРасчетов
		|ГДЕ
		|	ВЫБОР
		|			КОГДА ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)
		|				ТОГДА ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) > 0
		|			ИНАЧЕ ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) < 0
		|		КОНЕЦ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки");
		
		ЭтоВозврат =  ?(ДокументСсылкаОтчетКомиссионера.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах, Истина, Ложь);
		
		Запрос.МенеджерВременныхТаблиц = СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
		Запрос.УстановитьПараметр("МоментКонтроля", ДополнительныеСвойства.ДляПроведения.МоментКонтроля);
		Запрос.УстановитьПараметр("ЭтоВозврат", ЭтоВозврат);
		Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		
		МассивРезультатов = Запрос.ВыполнитьПакет();
		
		Если НЕ МассивРезультатов[0].Пустой()
			ИЛИ НЕ МассивРезультатов[1].Пустой()
			ИЛИ НЕ МассивРезультатов[2].Пустой()
			ИЛИ НЕ МассивРезультатов[3].Пустой()
			ИЛИ НЕ МассивРезультатов[4].Пустой()
			ИЛИ НЕ МассивРезультатов[5].Пустой()
			ИЛИ НЕ МассивРезультатов[6].Пустой()
			Тогда
			
			ДокументОбъектОтчетКомиссионера = ДокументСсылкаОтчетКомиссионера.ПолучитьОбъект();
			
		КонецЕсли;
		
		// Отрицательный остаток учета запасов.
		Если НЕ ЭтоВозврат И НЕ МассивРезультатов[0].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[0].Выбрать();
			КонтрольОстатковУНФ.Запасы(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		КонецЕсли;
		
		// Отрицательный остаток запасов переданных.
		Если НЕ ЭтоВозврат И НЕ МассивРезультатов[1].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[1].Выбрать();
			КонтрольОстатковУНФ.ЗапасыПереданные(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		КонецЕсли;
		
		Если Не ЭтоВозврат Тогда
			// Отрицательный остаток по расчетам с покупателями.
			Если Не ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения И НЕ МассивРезультатов[2].Пустой() Тогда
				ВыборкаИзРезультатаЗапроса = МассивРезультатов[2].Выбрать();
				КонтрольОстатковУНФ.РасчетыСПокупателями(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			КонецЕсли;
		КонецЕсли;
		
		// Отрицательный остаток по остаткам запасов в разрезе номеров ГТД.
		Если НЕ ЭтоВозврат И Константы.КонтролироватьОстаткиПоНомерамГТД.Получить()
			И НЕ МассивРезультатов[3].Пустой() Тогда
			
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[3].Выбрать();
			КонтрольОстатковУНФ.ЗапасыВРазрезеГТД(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			
		КонецЕсли;
		
		Если НЕ ЭтоВозврат И НЕ МассивРезультатов[4].Пустой() Тогда
				
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[4].Выбрать();
			КонтрольОстатковУНФ.ЗапасыПереданныеВРазрезеГТД(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
				
		КонецЕсли;
		
		Если НЕ ЭтоВозврат И НЕ МассивРезультатов[5].Пустой() Тогда
			
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[5].Выбрать();
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибкахПроведенияПоРегиструПрослеживаемыеТовары(
			ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		КонецЕсли;
		
		// Отрицательный остаток по расчетам с поставщиками.
		Если ДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений И НЕ ЭтоВозврат И НЕ МассивРезультатов[6].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[6].Выбрать();
			КонтрольОстатковУНФ.РасчетыСПоставщиками(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьКонтроль()

// Выполняет контроль возникновения отрицательных оборотов.
//
Процедура ВыполнитьКонтрольВозвраты(ДокументСсылкаОтчетКомиссионера, ДополнительныеСвойства, Отказ, УдалениеПроведения = Ложь) Экспорт
	
	Если ПроведениеДокументовУНФ.КонтрольОстатковВыключен() Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураВременныеТаблицы = ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;

	ЭтоВозврат = ?(ДокументСсылкаОтчетКомиссионера.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах, Истина, Ложь);
	Если Не ЭтоВозврат Тогда Возврат КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Продажи.Номенклатура КАК Номенклатура,
	|	Продажи.Характеристика КАК Характеристика,
	|	Продажи.Партия КАК Партия,
	|	Продажи.Контрагент КАК Контрагент,
	|	Продажи.Организация КАК Организация,
	|	Продажи.ЗаказПокупателя КАК ЗаказПокупателя,
	|	СУММА(Продажи.Количество) КАК Количество,
	|	СУММА(Продажи.Сумма) КАК Сумма,
	|	Продажи.Документ.Договор КАК ДокументДоговор,
	|	Продажи.Номенклатура.ЕдиницаИзмерения КАК НоменклатураЕдиницаИзмерения
	|ПОМЕСТИТЬ ВтОстатокОборот
	|ИЗ
	|	РегистрНакопления.Продажи КАК Продажи
	|ГДЕ
	|	Продажи.Период <= &МоментКонтроля
	|	И Продажи.Документ В
	|			(ВЫБРАТЬ
	|				ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера
	|			ИЗ
	|				Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|			ГДЕ
	|				ОтчетКомиссионераПокупатели.Ссылка = &Регистратор
	|				И НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка))
	|	И НЕ Продажи.Регистратор = &Регистратор
	|	И Продажи.Сумма <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Организация,
	|	Продажи.ЗаказПокупателя,
	|	Продажи.Характеристика,
	|	Продажи.Контрагент,
	|	Продажи.Номенклатура,
	|	Продажи.Партия,
	|	Продажи.Документ.Договор,
	|	Продажи.Номенклатура.ЕдиницаИзмерения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Продажи.Номенклатура КАК Номенклатура,
	|	Продажи.Характеристика КАК Характеристика,
	|	Продажи.Партия КАК Партия,
	|	Продажи.Контрагент КАК Контрагент,
	|	Продажи.Организация КАК Организация,
	|	Продажи.ЗаказПокупателя КАК ЗаказПокупателя,
	|	СУММА(Продажи.Количество) КАК Количество,
	|	СУММА(Продажи.Сумма) КАК Сумма,
	|	Продажи.Документ.Договор КАК ДокументДоговор,
	|	Продажи.Номенклатура.ЕдиницаИзмерения КАК НоменклатураЕдиницаИзмерения
	|ПОМЕСТИТЬ ВтОстатокОборотПоРегистратору
	|ИЗ
	|	РегистрНакопления.Продажи КАК Продажи
	|ГДЕ
	|	Продажи.Период <= &МоментКонтроля
	|	И Продажи.Регистратор = &Регистратор
	|	И Продажи.Сумма <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Организация,
	|	Продажи.ЗаказПокупателя,
	|	Продажи.Характеристика,
	|	Продажи.Контрагент,
	|	Продажи.Номенклатура,
	|	Продажи.Партия,
	|	Продажи.Документ.Договор,
	|	Продажи.Номенклатура.ЕдиницаИзмерения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыПереданные.Номенклатура КАК Номенклатура,
	|	ЗапасыПереданные.Характеристика КАК Характеристика,
	|	ЗапасыПереданные.Партия КАК Партия,
	|	ЗапасыПереданные.Контрагент КАК Контрагент,
	|	ЗапасыПереданные.Заказ КАК Заказ,
	|	СУММА(ЗапасыПереданные.Количество) КАК КоличествоОстаток,
	|	СУММА(ЗапасыПереданные.СуммаРасчетов) КАК СуммаРасчетовОстаток,
	|	ЗапасыПереданные.Договор КАК Договор
	|ПОМЕСТИТЬ ЗапасыПереданныеОборотПоРегистратору
	|ИЗ
	|	РегистрНакопления.ЗапасыПереданные КАК ЗапасыПереданные
	|ГДЕ
	|	ЗапасыПереданные.Период <= &МоментКонтроля
	|	И ЗапасыПереданные.Регистратор В
	|			(ВЫБРАТЬ
	|				ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера
	|			ИЗ
	|				Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|			ГДЕ
	|				ОтчетКомиссионераПокупатели.Ссылка = &Регистратор
	|				И НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка))
	|	И НЕ ЗапасыПереданные.Регистратор = &Регистратор
	|	И НЕ ЗапасыПереданные.СуммаРасчетов = 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыПереданные.Характеристика,
	|	ЗапасыПереданные.Партия,
	|	ЗапасыПереданные.Номенклатура,
	|	ЗапасыПереданные.Заказ,
	|	ЗапасыПереданные.Контрагент,
	|	ЗапасыПереданные.Договор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДвиженияЗапасыПереданныеИзменение.НомерСтроки КАК НомерСтроки,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Организация) КАК ОрганизацияПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Номенклатура) КАК НоменклатураПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Характеристика) КАК ХарактеристикаПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Партия) КАК ПартияПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Контрагент) КАК КонтрагентПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Договор) КАК ДоговорПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Заказ) КАК ЗаказПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи) КАК ТипПриемаПередачиПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыПереданныеОборотПоРегистратору.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
	|	ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.КоличествоОстаток, 0) КАК ОстатокЗапасыПереданные,
	|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыПереданные,
	|	ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовЗапасыПереданные,
	|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.СуммаРасчетовПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовОстатокЗапасыПереданные
	|ИЗ
	|	ДвиженияЗапасыПереданныеИзменение КАК ДвиженияЗапасыПереданныеИзменение
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЗапасыПереданныеОборотПоРегистратору КАК ЗапасыПереданныеОборотПоРегистратору
	|		ПО ДвиженияЗапасыПереданныеИзменение.Номенклатура = ЗапасыПереданныеОборотПоРегистратору.Номенклатура
	|			И ДвиженияЗапасыПереданныеИзменение.Характеристика = ЗапасыПереданныеОборотПоРегистратору.Характеристика
	|			И ДвиженияЗапасыПереданныеИзменение.Партия = ЗапасыПереданныеОборотПоРегистратору.Партия
	|			И ДвиженияЗапасыПереданныеИзменение.Контрагент = ЗапасыПереданныеОборотПоРегистратору.Контрагент
	|			И ДвиженияЗапасыПереданныеИзменение.Договор = ЗапасыПереданныеОборотПоРегистратору.Договор
	|			И ДвиженияЗапасыПереданныеИзменение.Заказ = ЗапасыПереданныеОборотПоРегистратору.Заказ
	|ГДЕ
	|	(ЕСТЬNULL(ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.КоличествоОстаток, 0), 0) < 0
	|			ИЛИ ЕСТЬNULL(ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.СуммаРасчетовПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.СуммаРасчетовОстаток, 0), 0) < 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Организация) КАК ОрганизацияПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Номенклатура) КАК НоменклатураПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Характеристика) КАК ХарактеристикаПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Партия) КАК ПартияПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Контрагент) КАК КонтрагентПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.ДокументДоговор) КАК ДоговорПредставление,
	|	ЕСТЬNULL(ВтОстатокОборот.Количество, 0) + ЕСТЬNULL(ВтОстатокОборотПоРегистратору.Количество, 0) КАК ОстатокЗапасыПереданные,
	|	ЕСТЬNULL(ВтОстатокОборот.Сумма, 0) + ЕСТЬNULL(ВтОстатокОборотПоРегистратору.Сумма, 0) КАК СуммаРасчетовЗапасыПереданные,
	|	ВтОстатокОборот.НоменклатураЕдиницаИзмерения КАК ЕдиницаИзмеренияПредставление,
	|	ЕСТЬNULL(ВтОстатокОборот.Количество, 0) КАК Количество,
	|	ЕСТЬNULL(ВтОстатокОборот.Сумма, 0) КАК Сумма,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.ЗаказПокупателя) КАК ЗаказПредставление,
	|	ЕСТЬNULL(ВтОстатокОборотПоРегистратору.Количество, 0) КАК КоличествоИзменение,
	|	ВтОстатокОборот.Количество КАК КоличествоОборот,
	|	ВтОстатокОборотПоРегистратору.Количество КАК КоличествоОборотРег
	|ПОМЕСТИТЬ ВТОборотПродажи
	|ИЗ
	|	ВтОстатокОборотПоРегистратору КАК ВтОстатокОборотПоРегистратору
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВтОстатокОборот КАК ВтОстатокОборот
	|		ПО ВтОстатокОборотПоРегистратору.Номенклатура = ВтОстатокОборот.Номенклатура
	|			И ВтОстатокОборотПоРегистратору.Характеристика = ВтОстатокОборот.Характеристика
	|			И ВтОстатокОборотПоРегистратору.Партия = ВтОстатокОборот.Партия
	|			И ВтОстатокОборотПоРегистратору.Контрагент = ВтОстатокОборот.Контрагент
	|			И ВтОстатокОборотПоРегистратору.Организация = ВтОстатокОборот.Организация
	|			И ВтОстатокОборотПоРегистратору.ЗаказПокупателя = ВтОстатокОборот.ЗаказПокупателя
	|			И ВтОстатокОборотПоРегистратору.ДокументДоговор = ВтОстатокОборот.ДокументДоговор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТОборотПродажи.ОрганизацияПредставление КАК ОрганизацияПредставление,
	|	ВТОборотПродажи.НоменклатураПредставление КАК НоменклатураПредставление,
	|	ВТОборотПродажи.ХарактеристикаПредставление КАК ХарактеристикаПредставление,
	|	ВТОборотПродажи.ПартияПредставление КАК ПартияПредставление,
	|	ВТОборотПродажи.КонтрагентПредставление КАК КонтрагентПредставление,
	|	ВТОборотПродажи.ДоговорПредставление КАК ДоговорПредставление,
	|	ВТОборотПродажи.ОстатокЗапасыПереданные КАК КоличествоОстатокЗапасыПереданные,
	|	ВТОборотПродажи.СуммаРасчетовЗапасыПереданные КАК СуммаРасчетовОстатокЗапасыПереданные,
	|	ВТОборотПродажи.ЕдиницаИзмеренияПредставление КАК ЕдиницаИзмеренияПредставление,
	|	"""" КАК ТипПриемаПередачиПредставление,
	|	ВТОборотПродажи.Количество КАК ОстатокЗапасыПереданные,
	|	ВТОборотПродажи.Сумма КАК СуммаРасчетовЗапасыПереданные,
	|	ВТОборотПродажи.ЗаказПредставление КАК ЗаказПредставление,
	|	ВТОборотПродажи.КоличествоИзменение КАК КоличествоИзменение,
	|	ВТОборотПродажи.КоличествоОборот КАК КоличествоОборот,
	|	ВТОборотПродажи.КоличествоОборотРег КАК КоличествоОборотРег
	|ИЗ
	|	ВТОборотПродажи КАК ВТОборотПродажи
	|ГДЕ
	|	(ЕСТЬNULL(ВТОборотПродажи.ОстатокЗапасыПереданные, 0) < 0
	|			ИЛИ ЕСТЬNULL(ВТОборотПродажи.СуммаРасчетовЗапасыПереданные, 0) < 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПрослеживаемыеТовары.Организация КАК Организация,
	|	ПрослеживаемыеТовары.РНПТ КАК РНПТ,
	|	ПрослеживаемыеТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ПрослеживаемыеТовары.Партия КАК Партия,
	|	ПрослеживаемыеТовары.Номенклатура КАК Номенклатура,
	|	ПрослеживаемыеТовары.Характеристика КАК Характеристика,
	|	ПрослеживаемыеТовары.Комиссионер КАК Комиссионер,
	|	СУММА(ПрослеживаемыеТовары.Количество) КАК Количество,
	|	СУММА(ПрослеживаемыеТовары.КоличествоПрослеживаемости) КАК КоличествоПрослеживаемости
	|ПОМЕСТИТЬ ПрослеживаемостьОборотПоРегистратору
	|ИЗ
	|	РегистрНакопления.ПрослеживаемыеТовары КАК ПрослеживаемыеТовары
	|ГДЕ
	|	ПрослеживаемыеТовары.Период <= &МоментКонтроля
	|	И ПрослеживаемыеТовары.Регистратор В
	|			(ВЫБРАТЬ
	|				ОтчетКомиссионераПокупатели.ОтчетКомиссионера КАК ОтчетКомиссионера
	|			ИЗ
	|				Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|			ГДЕ
	|				ОтчетКомиссионераПокупатели.Ссылка = &Регистратор
	|				И НЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка))
	|	И НЕ ПрослеживаемыеТовары.Регистратор = &Регистратор
	|
	|СГРУППИРОВАТЬ ПО
	|	ПрослеживаемыеТовары.Партия,
	|	ПрослеживаемыеТовары.Номенклатура,
	|	ПрослеживаемыеТовары.Характеристика,
	|	ПрослеживаемыеТовары.Комиссионер,
	|	ПрослеживаемыеТовары.Организация,
	|	ПрослеживаемыеТовары.РНПТ,
	|	ПрослеживаемыеТовары.СтранаПроисхождения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДвиженияПрослеживаемыеТоварыИзменение.НомерСтроки КАК НомерСтроки,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Организация КАК ОрганизацияПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.РНПТ КАК РНПТПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения КАК СтранаПроисхожденияПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура КАК НоменклатураПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Характеристика КАК ХарактеристикаПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Партия КАК ПартияПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер КАК Комиссионер,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПредставление,
	|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПрослеживаемостиПредставление,
	|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.Количество, 0) КАК ОстатокКоличество,
	|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПрослеживаемостиПриЗаписи, 0) + ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.КоличествоПрослеживаемости, 0) КАК ОстатокКоличествоПрослеживаемости,
	|	ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.Количество, 0) КАК ОстатокКоличествоТекущий,
	|	ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.КоличествоПрослеживаемости, 0) КАК ОстатокКоличествоПрослеживаемостиТекущий
	|ИЗ
	|	ДвиженияПрослеживаемыеТоварыИзменение КАК ДвиженияПрослеживаемыеТоварыИзменение
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрослеживаемостьОборотПоРегистратору КАК ПрослеживаемостьОборотПоРегистратору
	|		ПО ДвиженияПрослеживаемыеТоварыИзменение.Организация = ПрослеживаемостьОборотПоРегистратору.Организация
	|			И ДвиженияПрослеживаемыеТоварыИзменение.РНПТ = ПрослеживаемостьОборотПоРегистратору.РНПТ
	|			И ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения = ПрослеживаемостьОборотПоРегистратору.СтранаПроисхождения
	|			И ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура = ПрослеживаемостьОборотПоРегистратору.Номенклатура
	|			И ДвиженияПрослеживаемыеТоварыИзменение.Характеристика = ПрослеживаемостьОборотПоРегистратору.Характеристика
	|			И ДвиженияПрослеживаемыеТоварыИзменение.Партия = ПрослеживаемостьОборотПоРегистратору.Партия
	|			И ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер = ПрослеживаемостьОборотПоРегистратору.Комиссионер
	|ГДЕ
	|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.Количество, 0) < 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДвиженияРасчетыСПоставщикамиИзменение.НомерСтроки КАК НомерСтроки,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Организация) КАК ОрганизацияПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Контрагент) КАК КонтрагентПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Договор) КАК ДоговорПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Договор.ВалютаРасчетов) КАК ВалютаПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Документ) КАК ДокументПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Заказ) КАК ЗаказПредставление,
	|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов) КАК ТипРасчетовПредставление,
	|	ЛОЖЬ КАК ДвиженияДенежныхДокументов,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаПередЗаписью КАК СуммаПередЗаписью,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаПриЗаписи КАК СуммаПриЗаписи,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаИзменение КАК СуммаИзменение,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПередЗаписью КАК СуммаВалПередЗаписью,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПриЗаписи КАК СуммаВалПриЗаписи,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалИзменение КАК СуммаВалИзменение,
	|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПриЗаписи - ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаВыданныхАвансов,
	|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаНепогашеннойЗадолженности,
	|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
	|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаВалОстаток,
	|	ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов КАК ТипРасчетов
	|ИЗ
	|	ДвиженияРасчетыСПоставщикамиИзменение КАК ДвиженияРасчетыСПоставщикамиИзменение
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками.Остатки(
	|				&МоментКонтроля,
	|				(Организация, Контрагент, Договор, Документ, Заказ, ТипРасчетов) В
	|					(ВЫБРАТЬ
	|						ДвиженияРасчетыСПоставщикамиИзменение.Организация КАК Организация,
	|						ДвиженияРасчетыСПоставщикамиИзменение.Контрагент КАК Контрагент,
	|						ДвиженияРасчетыСПоставщикамиИзменение.Договор КАК Договор,
	|						ДвиженияРасчетыСПоставщикамиИзменение.Документ КАК Документ,
	|						ДвиженияРасчетыСПоставщикамиИзменение.Заказ КАК Заказ,
	|						ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов КАК ТипРасчетов
	|					ИЗ
	|						ДвиженияРасчетыСПоставщикамиИзменение КАК ДвиженияРасчетыСПоставщикамиИзменение)) КАК РасчетыСПоставщикамиОстатки
	|		ПО ДвиженияРасчетыСПоставщикамиИзменение.Организация = РасчетыСПоставщикамиОстатки.Организация
	|			И ДвиженияРасчетыСПоставщикамиИзменение.Контрагент = РасчетыСПоставщикамиОстатки.Контрагент
	|			И ДвиженияРасчетыСПоставщикамиИзменение.Договор = РасчетыСПоставщикамиОстатки.Договор
	|			И ДвиженияРасчетыСПоставщикамиИзменение.Документ = РасчетыСПоставщикамиОстатки.Документ
	|			И ДвиженияРасчетыСПоставщикамиИзменение.Заказ = РасчетыСПоставщикамиОстатки.Заказ
	|			И ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов = РасчетыСПоставщикамиОстатки.ТипРасчетов
	|ГДЕ
	|	ЕСТЬNULL(ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0), 0) < 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Запрос.МенеджерВременныхТаблиц = СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("МоментКонтроля", КонецДня(ДокументСсылкаОтчетКомиссионера.Дата));
	Запрос.УстановитьПараметр("Регистратор", ДокументСсылкаОтчетКомиссионера);
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	
	Если НЕ МассивРезультатов[5].Пустой() Или Не МассивРезультатов[3].Пустой() Тогда
		ДокументОбъектОтчетКомиссионера = ДокументСсылкаОтчетКомиссионера.ПолучитьОбъект();
	КонецЕсли;
	
	// Отрицательный остаток оборотов по регистру Продажи.
	Если НЕ МассивРезультатов[5].Пустой() Тогда
		ВыборкаИзРезультатаЗапроса = МассивРезультатов[5].Выбрать();
		КонтрольОстатковУНФ.ЗапасыПереданные(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
	КонецЕсли;
	
	// Отрицательный остаток по регистру Товары переданные.
	Если НЕ МассивРезультатов[3].Пустой() Тогда
		ВыборкаИзРезультатаЗапроса = МассивРезультатов[3].Выбрать();
		КонтрольОстатковУНФ.ЗапасыПереданные(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
	КонецЕсли;
	
	Если НЕ МассивРезультатов[7].Пустой() Тогда
		
		ВыборкаИзРезультатаЗапроса = МассивРезультатов[7].Выбрать();
		
		УправлениеНебольшойФирмойСервер.СообщитьОбОшибкахПроведенияПоРегиструПрослеживаемыеТовары(
		ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		
	КонецЕсли;
	
	// Отрицательный остаток по расчетам с поставщиками.
	Если ДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений И НЕ МассивРезультатов[8].Пустой() Тогда
		ВыборкаИзРезультатаЗапроса = МассивРезультатов[8].Выбрать();
		КонтрольОстатковУНФ.РасчетыСПоставщиками(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьКонтроль()

// Выполняет контроль возникновения отрицательных остатков.
//
Процедура ВыполнитьКонтрольНовыйВидДокумента(ДокументСсылкаОтчетКомиссионера, ДополнительныеСвойства, Отказ, УдалениеПроведения = Ложь) Экспорт  
	
	Если ПроведениеДокументовУНФ.КонтрольОстатковВыключен() Тогда
		Возврат;
	КонецЕсли;
	
	СтруктураВременныеТаблицы = ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;
	
	// Если временные таблицы "ДвиженияЗапасыИзменение", "ДвиженияЗапасыПереданныеИзменение"
	// содержат записи, необходимо выполнить контроль реализации товаров.
	
	Если СтруктураВременныеТаблицы.ДвиженияЗапасыИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияЗапасыВРазрезеГТДИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияЗапасыПереданныеВРазрезеГТДИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияЗапасыПереданныеИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияРасчетыСПокупателямиИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияРасчетыСПоставщикамиИзменение
		ИЛИ СтруктураВременныеТаблицы.ДвиженияПрослеживаемыеТоварыИзменение Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	ДвиженияЗапасыИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиницаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.СчетУчета) КАК СчетУчетаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыИзменение.ЗаказПокупателя) КАК ЗаказПокупателяПредставление,
		|	ЗапасыОстатки.СтруктурнаяЕдиница.ТипСтруктурнойЕдиницы КАК ТипСтруктурнойЕдиницы,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасы,
		|	ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасы,
		|	ЕСТЬNULL(ЗапасыОстатки.СуммаОстаток, 0) КАК СуммаОстатокЗапасы
		|ИЗ
		|	ДвиженияЗапасыИзменение КАК ДвиженияЗапасыИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки(
		|				&МоментКонтроля,
		|				(Организация, СтруктурнаяЕдиница, СчетУчета, Номенклатура, Характеристика, Партия, ЗаказПокупателя) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыИзменение.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|						ДвиженияЗапасыИзменение.СчетУчета КАК СчетУчета,
		|						ДвиженияЗапасыИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыИзменение.ЗаказПокупателя КАК ЗаказПокупателя
		|					ИЗ
		|						ДвиженияЗапасыИзменение КАК ДвиженияЗапасыИзменение)) КАК ЗапасыОстатки
		|		ПО ДвиженияЗапасыИзменение.Организация = ЗапасыОстатки.Организация
		|			И ДвиженияЗапасыИзменение.СтруктурнаяЕдиница = ЗапасыОстатки.СтруктурнаяЕдиница
		|			И ДвиженияЗапасыИзменение.СчетУчета = ЗапасыОстатки.СчетУчета
		|			И ДвиженияЗапасыИзменение.Номенклатура = ЗапасыОстатки.Номенклатура
		|			И ДвиженияЗапасыИзменение.Характеристика = ЗапасыОстатки.Характеристика
		|			И ДвиженияЗапасыИзменение.Партия = ЗапасыОстатки.Партия
		|			И ДвиженияЗапасыИзменение.ЗаказПокупателя = ЗапасыОстатки.ЗаказПокупателя
		|ГДЕ
		|	ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыПереданныеИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи) КАК ТипПриемаПередачиПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыПереданныеОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыПереданныеОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ЗапасыПереданныеОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.СуммаРасчетовИзменение, 0) + ЕСТЬNULL(ЗапасыПереданныеОстатки.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовЗапасыПереданные,
		|	ЕСТЬNULL(ЗапасыПереданныеОстатки.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовОстатокЗапасыПереданные
		|ИЗ
		|	ДвиженияЗапасыПереданныеИзменение КАК ДвиженияЗапасыПереданныеИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыПереданные.Остатки(
		|				&МоментКонтроля,
		|				(Организация, Номенклатура, Характеристика, Партия, Контрагент, Договор, Заказ, ТипПриемаПередачи) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыПереданныеИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыПереданныеИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыПереданныеИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыПереданныеИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыПереданныеИзменение.Контрагент КАК Контрагент,
		|						ДвиженияЗапасыПереданныеИзменение.Договор КАК Договор,
		|						ДвиженияЗапасыПереданныеИзменение.Заказ КАК Заказ,
		|						ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи КАК ТипПриемаПередачи
		|					ИЗ
		|						ДвиженияЗапасыПереданныеИзменение КАК ДвиженияЗапасыПереданныеИзменение)) КАК ЗапасыПереданныеОстатки
		|		ПО ДвиженияЗапасыПереданныеИзменение.Организация = ЗапасыПереданныеОстатки.Организация
		|			И ДвиженияЗапасыПереданныеИзменение.Номенклатура = ЗапасыПереданныеОстатки.Номенклатура
		|			И ДвиженияЗапасыПереданныеИзменение.Характеристика = ЗапасыПереданныеОстатки.Характеристика
		|			И ДвиженияЗапасыПереданныеИзменение.Партия = ЗапасыПереданныеОстатки.Партия
		|			И ДвиженияЗапасыПереданныеИзменение.Контрагент = ЗапасыПереданныеОстатки.Контрагент
		|			И ДвиженияЗапасыПереданныеИзменение.Договор = ЗапасыПереданныеОстатки.Договор
		|			И ДвиженияЗапасыПереданныеИзменение.Заказ = ЗапасыПереданныеОстатки.Заказ
		|			И ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи = ЗапасыПереданныеОстатки.ТипПриемаПередачи
		|ГДЕ
		|	(ЕСТЬNULL(ЗапасыПереданныеОстатки.КоличествоОстаток, 0) < 0
		|			ИЛИ ЕСТЬNULL(ЗапасыПереданныеОстатки.СуммаРасчетовОстаток, 0) < 0)
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияРасчетыСПокупателямиИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Договор.ВалютаРасчетов) КАК ВалютаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Документ) КАК ДокументПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов) КАК ТипРасчетовПредставление,
		|	ЛОЖЬ КАК ДвиженияДенежныхДокументов,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаПередЗаписью КАК СуммаПередЗаписью,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаПриЗаписи КАК СуммаПриЗаписи,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаИзменение КАК СуммаИзменение,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПередЗаписью КАК СуммаВалПередЗаписью,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи КАК СуммаВалПриЗаписи,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалИзменение КАК СуммаВалИзменение,
		|	ВЫБОР
		|		КОГДА ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи >= 0
		|			ТОГДА ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи - ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0)
		|		ИНАЧЕ ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) + ДвиженияРасчетыСПокупателямиИзменение.СуммаВалПриЗаписи
		|	КОНЕЦ КАК СуммаПолученныхАвансов,
		|	ДвиженияРасчетыСПокупателямиИзменение.СуммаВалИзменение + ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) КАК СуммаНепогашеннойЗадолженности,
		|	ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
		|	ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) КАК СуммаВалОстаток,
		|	ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов КАК ТипРасчетов
		|ИЗ
		|	ДвиженияРасчетыСПокупателямиИзменение КАК ДвиженияРасчетыСПокупателямиИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПокупателями.Остатки(
		|				&МоментКонтроля,
		|				(Организация, Контрагент, Договор, Документ, Заказ, ТипРасчетов) В
		|					(ВЫБРАТЬ
		|						ДвиженияРасчетыСПокупателямиИзменение.Организация КАК Организация,
		|						ДвиженияРасчетыСПокупателямиИзменение.Контрагент КАК Контрагент,
		|						ДвиженияРасчетыСПокупателямиИзменение.Договор КАК Договор,
		|						ДвиженияРасчетыСПокупателямиИзменение.Документ КАК Документ,
		|						ДвиженияРасчетыСПокупателямиИзменение.Заказ КАК Заказ,
		|						ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов КАК ТипРасчетов
		|					ИЗ
		|						ДвиженияРасчетыСПокупателямиИзменение КАК ДвиженияРасчетыСПокупателямиИзменение)) КАК РасчетыСПокупателямиОстатки
		|		ПО ДвиженияРасчетыСПокупателямиИзменение.Организация = РасчетыСПокупателямиОстатки.Организация
		|			И ДвиженияРасчетыСПокупателямиИзменение.Контрагент = РасчетыСПокупателямиОстатки.Контрагент
		|			И ДвиженияРасчетыСПокупателямиИзменение.Договор = РасчетыСПокупателямиОстатки.Договор
		|			И ДвиженияРасчетыСПокупателямиИзменение.Документ = РасчетыСПокупателямиОстатки.Документ
		|			И ДвиженияРасчетыСПокупателямиИзменение.Заказ = РасчетыСПокупателямиОстатки.Заказ
		|			И ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов = РасчетыСПокупателямиОстатки.ТипРасчетов
		|ГДЕ
		|	ВЫБОР
		|			КОГДА ДвиженияРасчетыСПокупателямиИзменение.СуммаИзменение < 0
		|					И ДвиженияРасчетыСПокупателямиИзменение.Документ = &Ссылка
		|				ТОГДА ЛОЖЬ
		|			ИНАЧЕ ВЫБОР
		|					КОГДА ДвиженияРасчетыСПокупателямиИзменение.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)
		|						ТОГДА ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) > 0
		|					ИНАЧЕ ЕСТЬNULL(РасчетыСПокупателямиОстатки.СуммаВалОстаток, 0) < 0
		|				КОНЕЦ
		|		КОНЕЦ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыВРазрезеГТДИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.НомерГТД) КАК НомерГТДПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыВРазрезеГТДИзменение.СтранаПроисхождения) КАК СтранаПроисхожденияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыВРазрезеГТДОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыВРазрезеГТДИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасыВРазрезеГТД,
		|	ЕСТЬNULL(ЗапасыВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыВРазрезеГТД
		|ИЗ
		|	ДвиженияЗапасыВРазрезеГТДИзменение КАК ДвиженияЗапасыВРазрезеГТДИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыВРазрезеГТД.Остатки(
		|				&МоментКонтроля,
		|				(Организация, НомерГТД, Номенклатура, Характеристика, Партия, СтранаПроисхождения) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.НомерГТД КАК НомерГТД,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыВРазрезеГТДИзменение.СтранаПроисхождения КАК СтранаПроисхождения
		|					ИЗ
		|						ДвиженияЗапасыВРазрезеГТДИзменение КАК ДвиженияЗапасыВРазрезеГТДИзменение)) КАК ЗапасыВРазрезеГТДОстатки
		|		ПО ДвиженияЗапасыВРазрезеГТДИзменение.Организация = ЗапасыВРазрезеГТДОстатки.Организация
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.НомерГТД = ЗапасыВРазрезеГТДОстатки.НомерГТД
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.Номенклатура = ЗапасыВРазрезеГТДОстатки.Номенклатура
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.Характеристика = ЗапасыВРазрезеГТДОстатки.Характеристика
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.Партия = ЗапасыВРазрезеГТДОстатки.Партия
		|			И ДвиженияЗапасыВРазрезеГТДИзменение.СтранаПроисхождения = ЗапасыВРазрезеГТДОстатки.СтранаПроисхождения
		|ГДЕ
		|	ЕСТЬNULL(ЗапасыВРазрезеГТДОстатки.КоличествоОстаток, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерГТД) КАК НомерГТДПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.СтранаПроисхождения) КАК СтранаПроисхожденияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыПереданныеВРазрезеГТДОстатки.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ЗапасыПереданныеВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК ОстатокЗапасыВРазрезеГТД,
		|	ЕСТЬNULL(ЗапасыПереданныеВРазрезеГТДОстатки.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыВРазрезеГТД
		|ИЗ
		|	ДвиженияЗапасыПереданныеВРазрезеГТДИзменение КАК ДвиженияЗапасыПереданныеВРазрезеГТДИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыПереданныеВРазрезеГТД.Остатки(
		|				&МоментКонтроля,
		|				(Организация, НомерГТД, Номенклатура, Характеристика, Партия, СтранаПроисхождения) В
		|					(ВЫБРАТЬ
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Организация КАК Организация,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерГТД КАК НомерГТД,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Номенклатура КАК Номенклатура,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Характеристика КАК Характеристика,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Партия КАК Партия,
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.СтранаПроисхождения КАК СтранаПроисхождения
		|					ИЗ
		|						ДвиженияЗапасыПереданныеВРазрезеГТДИзменение КАК ДвиженияЗапасыПереданныеВРазрезеГТДИзменение)) КАК ЗапасыПереданныеВРазрезеГТДОстатки
		|		ПО ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Организация = ЗапасыПереданныеВРазрезеГТДОстатки.Организация
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.НомерГТД = ЗапасыПереданныеВРазрезеГТДОстатки.НомерГТД
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Номенклатура = ЗапасыПереданныеВРазрезеГТДОстатки.Номенклатура
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Характеристика = ЗапасыПереданныеВРазрезеГТДОстатки.Характеристика
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.Партия = ЗапасыПереданныеВРазрезеГТДОстатки.Партия
		|			И ДвиженияЗапасыПереданныеВРазрезеГТДИзменение.СтранаПроисхождения = ЗапасыПереданныеВРазрезеГТДОстатки.СтранаПроисхождения
		|ГДЕ
		|	ЕСТЬNULL(ЗапасыПереданныеВРазрезеГТДОстатки.КоличествоОстаток, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияПрослеживаемыеТоварыИзменение.НомерСтроки КАК НомерСтроки,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Организация КАК ОрганизацияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.РНПТ КАК РНПТПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения КАК СтранаПроисхожденияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура КАК НоменклатураПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Характеристика КАК ХарактеристикаПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Партия КАК ПартияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Комплектующие КАК Комплектующие,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ПрослеживаемыйКомплект КАК ПрослеживаемыйКомплект,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер КАК Комиссионер,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПрослеживаемостиПредставление,
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоИзменение, 0) + ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоОстаток, 0) КАК ОстатокКоличество,
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПрослеживаемостиИзменение, 0) + ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоПрослеживаемостиОстаток, 0) КАК ОстатокКоличествоПрослеживаемости,
		|	ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоОстаток, 0) КАК ОстатокКоличествоТекущий,
		|	ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоПрослеживаемостиОстаток, 0) КАК ОстатокКоличествоПрослеживаемостиТекущий
		|ИЗ
		|	ДвиженияПрослеживаемыеТоварыИзменение КАК ДвиженияПрослеживаемыеТоварыИзменение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПрослеживаемыеТовары.Остатки(&МоментКонтроля, ) КАК ПрослеживаемыеТоварыОстатки
		|		ПО ДвиженияПрослеживаемыеТоварыИзменение.Организация = ПрослеживаемыеТоварыОстатки.Организация
		|			И ДвиженияПрослеживаемыеТоварыИзменение.РНПТ = ПрослеживаемыеТоварыОстатки.РНПТ
		|			И ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения = ПрослеживаемыеТоварыОстатки.СтранаПроисхождения
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура = ПрослеживаемыеТоварыОстатки.Номенклатура
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Характеристика = ПрослеживаемыеТоварыОстатки.Характеристика
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Партия = ПрослеживаемыеТоварыОстатки.Партия
		|			И (ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоОстаток, 0) < 0
		|				ИЛИ ЕСТЬNULL(ПрослеживаемыеТоварыОстатки.КоличествоПрослеживаемостиОстаток, 0) < 0)
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер = ПрослеживаемыеТоварыОстатки.Комиссионер
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Комплектующие = ПрослеживаемыеТоварыОстатки.Комплектующие
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияРасчетыСПоставщикамиИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Договор.ВалютаРасчетов) КАК ВалютаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Документ) КАК ДокументПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов) КАК ТипРасчетовПредставление,
		|	ЛОЖЬ КАК ДвиженияДенежныхДокументов,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаПередЗаписью КАК СуммаПередЗаписью,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаПриЗаписи КАК СуммаПриЗаписи,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаИзменение КАК СуммаИзменение,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПередЗаписью КАК СуммаВалПередЗаписью,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПриЗаписи КАК СуммаВалПриЗаписи,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалИзменение КАК СуммаВалИзменение,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалПриЗаписи - ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаВыданныхАвансов,
		|	ДвиженияРасчетыСПоставщикамиИзменение.СуммаВалИзменение + ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаНепогашеннойЗадолженности,
		|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаОстаток, 0) КАК СуммаОстаток,
		|	ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) КАК СуммаВалОстаток,
		|	ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов КАК ТипРасчетов
		|ИЗ
		|	ДвиженияРасчетыСПоставщикамиИзменение КАК ДвиженияРасчетыСПоставщикамиИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСПоставщиками.Остатки(
		|				&МоментКонтроля,
		|				(Организация, Контрагент, Договор, Документ, Заказ, ТипРасчетов) В
		|					(ВЫБРАТЬ
		|						ДвиженияРасчетыСПоставщикамиИзменение.Организация КАК Организация,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Контрагент КАК Контрагент,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Договор КАК Договор,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Документ КАК Документ,
		|						ДвиженияРасчетыСПоставщикамиИзменение.Заказ КАК Заказ,
		|						ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов КАК ТипРасчетов
		|					ИЗ
		|						ДвиженияРасчетыСПоставщикамиИзменение КАК ДвиженияРасчетыСПоставщикамиИзменение)) КАК РасчетыСПоставщикамиОстатки
		|		ПО ДвиженияРасчетыСПоставщикамиИзменение.Организация = РасчетыСПоставщикамиОстатки.Организация
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Контрагент = РасчетыСПоставщикамиОстатки.Контрагент
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Договор = РасчетыСПоставщикамиОстатки.Договор
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Документ = РасчетыСПоставщикамиОстатки.Документ
		|			И ДвиженияРасчетыСПоставщикамиИзменение.Заказ = РасчетыСПоставщикамиОстатки.Заказ
		|			И ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов = РасчетыСПоставщикамиОстатки.ТипРасчетов
		|ГДЕ
		|	ВЫБОР
		|			КОГДА ДвиженияРасчетыСПоставщикамиИзменение.ТипРасчетов = ЗНАЧЕНИЕ(Перечисление.ТипыРасчетов.Аванс)
		|				ТОГДА ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) > 0
		|			ИНАЧЕ ЕСТЬNULL(РасчетыСПоставщикамиОстатки.СуммаВалОстаток, 0) < 0
		|		КОНЕЦ
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Продажи.Номенклатура КАК Номенклатура,
		|	Продажи.Характеристика КАК Характеристика,
		|	Продажи.Партия КАК Партия,
		|	Продажи.Контрагент КАК Контрагент,
		|	Продажи.Организация КАК Организация,
		|	Продажи.ЗаказПокупателя КАК ЗаказПокупателя,
		|	СУММА(Продажи.Количество) КАК Количество,
		|	СУММА(Продажи.Сумма) КАК Сумма,
		|	Продажи.Документ.Договор КАК ДокументДоговор,
		|	Продажи.Номенклатура.ЕдиницаИзмерения КАК НоменклатураЕдиницаИзмерения
		|ПОМЕСТИТЬ ВтОстатокОборот
		|ИЗ
		|	РегистрНакопления.Продажи КАК Продажи
		|ГДЕ
		|	Продажи.Период <= &МоментКонтроляВозвраты
		|	И Продажи.Документ В
		|			(ВЫБРАТЬ
		|				ВЫБОР
		|					КОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА &Ссылка
		|					ИНАЧЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера
		|				КОНЕЦ КАК ОтчетКомиссионера
		|			ИЗ
		|				Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупатели
		|			ГДЕ
		|				ОтчетКомиссионераПокупатели.Ссылка = &Ссылка)
		|	И Продажи.Сумма <> 0
		|	И Продажи.Количество > 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Продажи.Организация,
		|	Продажи.ЗаказПокупателя,
		|	Продажи.Характеристика,
		|	Продажи.Контрагент,
		|	Продажи.Номенклатура,
		|	Продажи.Партия,
		|	Продажи.Документ.Договор,
		|	Продажи.Номенклатура.ЕдиницаИзмерения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Продажи.Номенклатура КАК Номенклатура,
		|	Продажи.Характеристика КАК Характеристика,
		|	Продажи.Партия КАК Партия,
		|	Продажи.Контрагент КАК Контрагент,
		|	Продажи.Организация КАК Организация,
		|	Продажи.ЗаказПокупателя КАК ЗаказПокупателя,
		|	СУММА(Продажи.Количество) КАК Количество,
		|	СУММА(Продажи.Сумма) КАК Сумма,
		|	Продажи.Документ.Договор КАК ДокументДоговор,
		|	Продажи.Номенклатура.ЕдиницаИзмерения КАК НоменклатураЕдиницаИзмерения
		|ПОМЕСТИТЬ ВтОстатокОборотПоРегистратору
		|ИЗ
		|	РегистрНакопления.Продажи КАК Продажи
		|ГДЕ
		|	Продажи.Период <= &МоментКонтроляВозвраты
		|	И Продажи.Регистратор = &Ссылка
		|	И Продажи.Сумма <> 0
		|	И Продажи.Количество < 0
		|
		|СГРУППИРОВАТЬ ПО
		|	Продажи.Организация,
		|	Продажи.ЗаказПокупателя,
		|	Продажи.Характеристика,
		|	Продажи.Контрагент,
		|	Продажи.Номенклатура,
		|	Продажи.Партия,
		|	Продажи.Документ.Договор,
		|	Продажи.Номенклатура.ЕдиницаИзмерения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗапасыПереданные.Номенклатура КАК Номенклатура,
		|	ЗапасыПереданные.Характеристика КАК Характеристика,
		|	ЗапасыПереданные.Партия КАК Партия,
		|	ЗапасыПереданные.Контрагент КАК Контрагент,
		|	ЗапасыПереданные.Заказ КАК Заказ,
		|	СУММА(ЗапасыПереданные.Количество) КАК КоличествоОстаток,
		|	СУММА(ЗапасыПереданные.СуммаРасчетов) КАК СуммаРасчетовОстаток,
		|	ЗапасыПереданные.Договор КАК Договор
		|ПОМЕСТИТЬ ЗапасыПереданныеОборотПоРегистратору
		|ИЗ
		|	РегистрНакопления.ЗапасыПереданные КАК ЗапасыПереданные
		|ГДЕ
		|	ЗапасыПереданные.Период <= &МоментКонтроляВозвраты
		|	И ЗапасыПереданные.Регистратор В
		|			(ВЫБРАТЬ
		|				ВЫБОР
		|					КОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА &Ссылка
		|					ИНАЧЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера
		|				КОНЕЦ КАК ОтчетКомиссионера
		|			ИЗ
		|				Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупатели
		|			ГДЕ
		|				ОтчетКомиссионераПокупатели.Ссылка = &Ссылка)
		|	И НЕ ЗапасыПереданные.Регистратор = &Ссылка
		|	И (НЕ ЗапасыПереданные.СуммаРасчетов = 0
		|			ИЛИ НЕ ЗапасыПереданные.Количество = 0)
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗапасыПереданные.Характеристика,
		|	ЗапасыПереданные.Партия,
		|	ЗапасыПереданные.Номенклатура,
		|	ЗапасыПереданные.Заказ,
		|	ЗапасыПереданные.Контрагент,
		|	ЗапасыПереданные.Договор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияЗапасыПереданныеИзменение.НомерСтроки КАК НомерСтроки,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Договор) КАК ДоговорПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.Заказ) КАК ЗаказПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ДвиженияЗапасыПереданныеИзменение.ТипПриемаПередачи) КАК ТипПриемаПередачиПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ЗапасыПереданныеОборотПоРегистратору.Номенклатура.ЕдиницаИзмерения) КАК ЕдиницаИзмеренияПредставление,
		|	ДвиженияЗапасыПереданныеИзменение.КоличествоИзменение КАК КоличествоИзменение,
		|	ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.КоличествоОстаток, 0) КАК ОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.КоличествоОстаток, 0) КАК КоличествоОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовЗапасыПереданные,
		|	ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.СуммаРасчетовПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.СуммаРасчетовОстаток, 0) КАК СуммаРасчетовОстатокЗапасыПереданные
		|ИЗ
		|	ДвиженияЗапасыПереданныеИзменение КАК ДвиженияЗапасыПереданныеИзменение
		|		ЛЕВОЕ СОЕДИНЕНИЕ ЗапасыПереданныеОборотПоРегистратору КАК ЗапасыПереданныеОборотПоРегистратору
		|		ПО ДвиженияЗапасыПереданныеИзменение.Номенклатура = ЗапасыПереданныеОборотПоРегистратору.Номенклатура
		|			И ДвиженияЗапасыПереданныеИзменение.Характеристика = ЗапасыПереданныеОборотПоРегистратору.Характеристика
		|			И ДвиженияЗапасыПереданныеИзменение.Партия = ЗапасыПереданныеОборотПоРегистратору.Партия
		|			И ДвиженияЗапасыПереданныеИзменение.Контрагент = ЗапасыПереданныеОборотПоРегистратору.Контрагент
		|			И ДвиженияЗапасыПереданныеИзменение.Договор = ЗапасыПереданныеОборотПоРегистратору.Договор
		|			И ДвиженияЗапасыПереданныеИзменение.Заказ = ЗапасыПереданныеОборотПоРегистратору.Заказ
		|ГДЕ
		|	(ЕСТЬNULL(ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.КоличествоОстаток, 0), 0) < 0
		|			ИЛИ ЕСТЬNULL(ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.СуммаРасчетовПриЗаписи, 0) + ЕСТЬNULL(ЗапасыПереданныеОборотПоРегистратору.СуммаРасчетовОстаток, 0), 0) < 0)
		|	И ЕСТЬNULL(ДвиженияЗапасыПереданныеИзменение.КоличествоИзменение, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Организация) КАК ОрганизацияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Номенклатура) КАК НоменклатураПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Характеристика) КАК ХарактеристикаПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Партия) КАК ПартияПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.Контрагент) КАК КонтрагентПредставление,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.ДокументДоговор) КАК ДоговорПредставление,
		|	ЕСТЬNULL(ВтОстатокОборот.Количество, 0) + ЕСТЬNULL(ВтОстатокОборотПоРегистратору.Количество, 0) КАК ОстатокЗапасыПереданные,
		|	ЕСТЬNULL(ВтОстатокОборот.Сумма, 0) + ЕСТЬNULL(ВтОстатокОборотПоРегистратору.Сумма, 0) КАК СуммаРасчетовЗапасыПереданные,
		|	ВтОстатокОборот.НоменклатураЕдиницаИзмерения КАК ЕдиницаИзмеренияПредставление,
		|	ЕСТЬNULL(ВтОстатокОборот.Количество, 0) КАК Количество,
		|	ЕСТЬNULL(ВтОстатокОборот.Сумма, 0) КАК Сумма,
		|	ПРЕДСТАВЛЕНИЕССЫЛКИ(ВтОстатокОборотПоРегистратору.ЗаказПокупателя) КАК ЗаказПредставление,
		|	ЕСТЬNULL(ВтОстатокОборотПоРегистратору.Количество, 0) КАК КоличествоИзменение,
		|	ВтОстатокОборот.Количество КАК КоличествоОборот,
		|	ВтОстатокОборотПоРегистратору.Количество КАК КоличествоОборотРег
		|ПОМЕСТИТЬ ВТОборотПродажи
		|ИЗ
		|	ВтОстатокОборотПоРегистратору КАК ВтОстатокОборотПоРегистратору
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВтОстатокОборот КАК ВтОстатокОборот
		|		ПО ВтОстатокОборотПоРегистратору.Номенклатура = ВтОстатокОборот.Номенклатура
		|			И ВтОстатокОборотПоРегистратору.Характеристика = ВтОстатокОборот.Характеристика
		|			И ВтОстатокОборотПоРегистратору.Партия = ВтОстатокОборот.Партия
		|			И ВтОстатокОборотПоРегистратору.Контрагент = ВтОстатокОборот.Контрагент
		|			И ВтОстатокОборотПоРегистратору.Организация = ВтОстатокОборот.Организация
		|			И ВтОстатокОборотПоРегистратору.ЗаказПокупателя = ВтОстатокОборот.ЗаказПокупателя
		|			И ВтОстатокОборотПоРегистратору.ДокументДоговор = ВтОстатокОборот.ДокументДоговор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТОборотПродажи.ОрганизацияПредставление КАК ОрганизацияПредставление,
		|	ВТОборотПродажи.НоменклатураПредставление КАК НоменклатураПредставление,
		|	ВТОборотПродажи.ХарактеристикаПредставление КАК ХарактеристикаПредставление,
		|	ВТОборотПродажи.ПартияПредставление КАК ПартияПредставление,
		|	ВТОборотПродажи.КонтрагентПредставление КАК КонтрагентПредставление,
		|	ВТОборотПродажи.ДоговорПредставление КАК ДоговорПредставление,
		|	ВТОборотПродажи.ОстатокЗапасыПереданные КАК КоличествоОстатокЗапасыПереданные,
		|	ВТОборотПродажи.СуммаРасчетовЗапасыПереданные КАК СуммаРасчетовОстатокЗапасыПереданные,
		|	ВТОборотПродажи.ЕдиницаИзмеренияПредставление КАК ЕдиницаИзмеренияПредставление,
		|	"""" КАК ТипПриемаПередачиПредставление,
		|	ВТОборотПродажи.Количество КАК ОстатокЗапасыПереданные,
		|	ВТОборотПродажи.Сумма КАК СуммаРасчетовЗапасыПереданные,
		|	ВТОборотПродажи.ЗаказПредставление КАК ЗаказПредставление,
		|	ВТОборотПродажи.КоличествоИзменение КАК КоличествоИзменение,
		|	ВТОборотПродажи.КоличествоОборот КАК КоличествоОборот,
		|	ВТОборотПродажи.КоличествоОборотРег КАК КоличествоОборотРег
		|ИЗ
		|	ВТОборотПродажи КАК ВТОборотПродажи
		|ГДЕ
		|	(ЕСТЬNULL(ВТОборотПродажи.ОстатокЗапасыПереданные, 0) < 0
		|			ИЛИ ЕСТЬNULL(ВТОборотПродажи.СуммаРасчетовЗапасыПереданные, 0) < 0)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПрослеживаемыеТовары.Организация КАК Организация,
		|	ПрослеживаемыеТовары.РНПТ КАК РНПТ,
		|	ПрослеживаемыеТовары.СтранаПроисхождения КАК СтранаПроисхождения,
		|	ПрослеживаемыеТовары.Партия КАК Партия,
		|	ПрослеживаемыеТовары.Номенклатура КАК Номенклатура,
		|	ПрослеживаемыеТовары.Характеристика КАК Характеристика,
		|	ПрослеживаемыеТовары.Комиссионер КАК Комиссионер,
		|	СУММА(ПрослеживаемыеТовары.Количество) КАК Количество,
		|	СУММА(ПрослеживаемыеТовары.КоличествоПрослеживаемости) КАК КоличествоПрослеживаемости
		|ПОМЕСТИТЬ ПрослеживаемостьОборотПоРегистратору
		|ИЗ
		|	РегистрНакопления.ПрослеживаемыеТовары КАК ПрослеживаемыеТовары
		|ГДЕ
		|	ПрослеживаемыеТовары.Период <= &МоментКонтроляВозвраты
		|	И ПрослеживаемыеТовары.Регистратор В
		|			(ВЫБРАТЬ
		|				ВЫБОР
		|					КОГДА ОтчетКомиссионераПокупатели.ОтчетКомиссионера = ЗНАЧЕНИЕ(Документ.ОтчетКомиссионера.ПустаяСсылка)
		|						ТОГДА &Ссылка
		|					ИНАЧЕ ОтчетКомиссионераПокупатели.ОтчетКомиссионера
		|				КОНЕЦ КАК ОтчетКомиссионера
		|			ИЗ
		|				Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупатели
		|			ГДЕ
		|				ОтчетКомиссионераПокупатели.Ссылка = &Ссылка)
		|	И НЕ ПрослеживаемыеТовары.Регистратор = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	ПрослеживаемыеТовары.Партия,
		|	ПрослеживаемыеТовары.Номенклатура,
		|	ПрослеживаемыеТовары.Характеристика,
		|	ПрослеживаемыеТовары.Комиссионер,
		|	ПрослеживаемыеТовары.Организация,
		|	ПрослеживаемыеТовары.РНПТ,
		|	ПрослеживаемыеТовары.СтранаПроисхождения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДвиженияПрослеживаемыеТоварыИзменение.НомерСтроки КАК НомерСтроки,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Организация КАК ОрганизацияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.РНПТ КАК РНПТПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения КАК СтранаПроисхожденияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура КАК НоменклатураПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Характеристика КАК ХарактеристикаПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Партия КАК ПартияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер КАК Комиссионер,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПредставление,
		|	ДвиженияПрослеживаемыеТоварыИзменение.КоличествоИзменение КАК КоличествоИзменение,
		|	ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПрослеживаемостиПредставление,
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.Количество, 0) КАК ОстатокКоличество,
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПрослеживаемостиПриЗаписи, 0) + ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.КоличествоПрослеживаемости, 0) КАК ОстатокКоличествоПрослеживаемости,
		|	ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.Количество, 0) КАК ОстатокКоличествоТекущий,
		|	ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.КоличествоПрослеживаемости, 0) КАК ОстатокКоличествоПрослеживаемостиТекущий
		|ИЗ
		|	ДвиженияПрослеживаемыеТоварыИзменение КАК ДвиженияПрослеживаемыеТоварыИзменение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПрослеживаемостьОборотПоРегистратору КАК ПрослеживаемостьОборотПоРегистратору
		|		ПО ДвиженияПрослеживаемыеТоварыИзменение.Организация = ПрослеживаемостьОборотПоРегистратору.Организация
		|			И ДвиженияПрослеживаемыеТоварыИзменение.РНПТ = ПрослеживаемостьОборотПоРегистратору.РНПТ
		|			И ДвиженияПрослеживаемыеТоварыИзменение.СтранаПроисхождения = ПрослеживаемостьОборотПоРегистратору.СтранаПроисхождения
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Номенклатура = ПрослеживаемостьОборотПоРегистратору.Номенклатура
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Характеристика = ПрослеживаемостьОборотПоРегистратору.Характеристика
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Партия = ПрослеживаемостьОборотПоРегистратору.Партия
		|			И ДвиженияПрослеживаемыеТоварыИзменение.Комиссионер = ПрослеживаемостьОборотПоРегистратору.Комиссионер
		|ГДЕ
		|	ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоПриЗаписи, 0) + ЕСТЬNULL(ПрослеживаемостьОборотПоРегистратору.Количество, 0) < 0
		|	И ЕСТЬNULL(ДвиженияПрослеживаемыеТоварыИзменение.КоличествоИзменение, 0) < 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки");
		
		Запрос.МенеджерВременныхТаблиц = СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
		Запрос.УстановитьПараметр("МоментКонтроля", ДополнительныеСвойства.ДляПроведения.МоментКонтроля);
		Запрос.УстановитьПараметр("МоментКонтроляВозвраты", КонецДня(ДокументСсылкаОтчетКомиссионера.Дата));
		Запрос.УстановитьПараметр("Ссылка", ДокументСсылкаОтчетКомиссионера);
		
		МассивРезультатов = Запрос.ВыполнитьПакет();
		
		Если НЕ МассивРезультатов[0].Пустой()
			ИЛИ НЕ МассивРезультатов[1].Пустой()
			ИЛИ НЕ МассивРезультатов[2].Пустой()
			ИЛИ НЕ МассивРезультатов[3].Пустой()
			ИЛИ НЕ МассивРезультатов[4].Пустой()
			ИЛИ НЕ МассивРезультатов[5].Пустой()
			ИЛИ НЕ МассивРезультатов[6].Пустой()
			ИЛИ НЕ МассивРезультатов[10].Пустой()
			ИЛИ НЕ МассивРезультатов[12].Пустой()
			ИЛИ НЕ МассивРезультатов[14].Пустой()
			Тогда
			
			ДокументОбъектОтчетКомиссионера = ДокументСсылкаОтчетКомиссионера.ПолучитьОбъект();
			
		КонецЕсли;
		
		// Отрицательный остаток учета запасов.
		Если НЕ МассивРезультатов[0].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[0].Выбрать();
			
			//+mega
			//КонтрольОстатковУНФ.Запасы(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			//-mega
		КонецЕсли;
		
		// Отрицательный остаток запасов переданных.
		Если НЕ МассивРезультатов[1].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[1].Выбрать();
			//+mega
			//КонтрольОстатковУНФ.ЗапасыПереданные(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			//-mega
		КонецЕсли;
		
			// Отрицательный остаток по расчетам с покупателями.
			Если Не ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения И НЕ МассивРезультатов[2].Пустой() Тогда
				ВыборкаИзРезультатаЗапроса = МассивРезультатов[2].Выбрать();
				КонтрольОстатковУНФ.РасчетыСПокупателями(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			КонецЕсли;
		
		// Отрицательный остаток по остаткам запасов в разрезе номеров ГТД.
		Если Константы.КонтролироватьОстаткиПоНомерамГТД.Получить() И НЕ МассивРезультатов[3].Пустой() Тогда
			
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[3].Выбрать();
			КонтрольОстатковУНФ.ЗапасыВРазрезеГТД(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			
		КонецЕсли;
		
		Если НЕ МассивРезультатов[4].Пустой() Тогда
				
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[4].Выбрать();
			КонтрольОстатковУНФ.ЗапасыПереданныеВРазрезеГТД(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
				
		КонецЕсли;
		
		Если НЕ МассивРезультатов[5].Пустой() Тогда
			
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[5].Выбрать();
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибкахПроведенияПоРегиструПрослеживаемыеТовары(
			ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		КонецЕсли;
		
		// Отрицательный остаток по расчетам с поставщиками.
		Если ДополнительныеСвойства.ИспользоватьНовуюСхемуДвижений И НЕ МассивРезультатов[6].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[6].Выбрать();
			КонтрольОстатковУНФ.РасчетыСПоставщиками(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
		КонецЕсли;
		
		// Отрицательный остаток оборотов по регистру Продажи.
		Если НЕ МассивРезультатов[12].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[12].Выбрать();
			//+mega
			//КонтрольОстатковУНФ.ЗапасыПереданные(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			//-mega
		КонецЕсли;
		
		// Отрицательный остаток Товарам переданным комиссионеру для возвратов.
		Если НЕ МассивРезультатов[10].Пустой() Тогда
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[10].Выбрать();
			//+mega
			//КонтрольОстатковУНФ.ЗапасыПереданные(ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			//-mega
		КонецЕсли;
		
		// Отрицательный остаток по переданным прослеживаемым товарам комиссионеру для возвратов.
		Если НЕ МассивРезультатов[14].Пустой() Тогда
			
			ВыборкаИзРезультатаЗапроса = МассивРезультатов[14].Выбрать();
			
			УправлениеНебольшойФирмойСервер.СообщитьОбОшибкахПроведенияПоРегиструПрослеживаемыеТовары(
			ДокументОбъектОтчетКомиссионера, ВыборкаИзРезультатаЗапроса, Отказ);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьКонтроль()

#Область ИнтерфейсПечати

Функция ДанныеДокументовРегУчет(МассивОбъектов, ИспользоватьФаксимиле, ПечатнаяФормаТолькоВРублях = Истина, Ошибки = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	Запрос.УстановитьПараметр("НациональнаяВалюта", Константы.НациональнаяВалюта.Получить());
	Запрос.УстановитьПараметр("ПечатнаяФормаТолькоВРублях", ПечатнаяФормаТолькоВРублях);
	Запрос.УстановитьПараметр("ИспользоватьФаксимиле", ИспользоватьФаксимиле);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтчетКомиссионера.Ссылка КАК Ссылка,
	|	ОтчетКомиссионера.Дата КАК ДатаДокумента,
	|	ВЫРАЗИТЬ(ОтчетКомиссионера.Номер КАК СТРОКА(12)) КАК Номер,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправления,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправления,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеПустая,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыОперацийСчетФактура.Продажа) КАК ВидОперации,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|		ИНАЧЕ ОтчетКомиссионера.Организация
	|	КОНЕЦ КАК Организация,
	|	ОтчетКомиссионера.Организация.Префикс КАК Префикс,
	|	ОтчетКомиссионера.Организация.ФайлЛоготип КАК Логотип,
	|	ОтчетКомиссионера.Организация.ФайлФаксимильнаяПечать КАК ФаксимилеПечати,
	|	ВЫБОР
	|		КОГДА &ИспользоватьФаксимиле = ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ДаНет.Да)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ДаНет.Нет)
	|	КОНЕЦ КАК ИспользоватьФаксимиле,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ЦифровойИндексОбособленногоПодразделения
	|		КОГДА ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация = ОтчетКомиссионера.Организация
	|			ТОГДА ОтчетКомиссионера.Подразделение.ЦифровойИндексОбособленногоПодразделения
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК ЦифровойИндексОбособленногоПодразделения,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация
	|		КОГДА ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация = ОтчетКомиссионера.Организация
	|			ТОГДА ОтчетКомиссионера.Подразделение
	|		ИНАЧЕ ОтчетКомиссионера.Организация
	|	КОНЕЦ КАК ОбособленноеПодразделениеПоставщика,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоФизическоеЛицо,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС)
	|			ТОГДА 2
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК СтатусУПД,
	|	ЛОЖЬ КАК ЭтоСводныйСчетФактура,
	|	ЛОЖЬ КАК ЭтоКорректировка,
	|	ОтчетКомиссионера.Организация.БанковскийСчетПоУмолчанию КАК БанковскийСчет,
	|	ПРЕДСТАВЛЕНИЕ(ОтчетКомиссионера.Подразделение) КАК ПредставлениеПодразделения,
	|	НЕОПРЕДЕЛЕНО КАК ПредставлениеСкладаСписания,
	|	ОтчетКомиссионера.Организация КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент
	|		ИНАЧЕ ОтчетКомиссионера.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ОтчетКомиссионера.Контрагент КАК ОбособленноеПодразделениеПокупателя,
	|	ОтчетКомиссионера.Контрагент КАК Грузополучатель,
	|	ОтчетКомиссионера.Контрагент.БанковскийСчетПоУмолчанию КАК БанковскийСчетКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК АдресДоставки,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьНомер,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьДата,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьВыдана,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьЛицо,
	|	НЕОПРЕДЕЛЕНО КАК Основание,
	|	ВЫБОР
	|		КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|			ТОГДА НациональнаяВалюта.Значение
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента
	|	КОНЕЦ КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|			ТОГДА НациональнаяВалюта.Значение.НаименованиеПолное
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента.НаименованиеПолное
	|	КОНЕЦ КАК ВалютаНаименование,
	|	ВЫБОР
	|		КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|			ТОГДА НациональнаяВалюта.Значение.Код
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента.Код
	|	КОНЕЦ КАК ВалютаКод,
	|	ОтчетКомиссионера.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ОтчетКомиссионера.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ОтчетКомиссионера.Курс КАК Курс,
	|	ОтчетКомиссионера.Кратность КАК Кратность,
	|	ПРЕДСТАВЛЕНИЕ(ОтчетКомиссионера.Договор) КАК ПредставлениеОснования,
	|	ОтчетКомиссионера.Договор КАК ОснованиеПечатиСсылка,
	|	НЕОПРЕДЕЛЕНО КАК ОснованиеНомер,
	|	НЕОПРЕДЕЛЕНО КАК ОснованиеДата,
	|	НЕОПРЕДЕЛЕНО КАК ТранспортнаяНакладнаяНомер,
	|	НЕОПРЕДЕЛЕНО КАК ТранспортнаяНакладнаяДата,
	|	НЕОПРЕДЕЛЕНО КАК ДолжностьРуководителя,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиРуководителя,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеРуководителя,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиГлавногоБухгалтера,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеГлавногоБухгалтера,
	|	НЕОПРЕДЕЛЕНО КАК ДолжностьКладовщика,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиКладовщика,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеКладовщика,
	|	0 КАК Вес,
	|	0 КАК Объем,
	|	ОтчетКомиссионера.Запасы.(
	|		НомерСтроки КАК НомерСтроки,
	|		Ссылка КАК Ссылка,
	|		Номенклатура КАК Номенклатура,
	|		НЕОПРЕДЕЛЕНО КАК Содержание,
	|		ВЫБОР
	|			КОГДА (ВЫРАЗИТЬ(ОтчетКомиссионера.Запасы.Номенклатура.НаименованиеПолное КАК СТРОКА(1000))) = """"
	|				ТОГДА ОтчетКомиссионера.Запасы.Номенклатура.Наименование
	|			ИНАЧЕ ВЫРАЗИТЬ(ОтчетКомиссионера.Запасы.Номенклатура.НаименованиеПолное КАК СТРОКА(1000))
	|		КОНЕЦ КАК ПредставлениеНоменклатуры,
	|		Номенклатура.ТипНоменклатуры КАК ТипНоменклатуры,
	|		Номенклатура.Код КАК ЗапасКод,
	|		Номенклатура.Код КАК Код,
	|		Номенклатура.Артикул КАК Артикул,
	|		Характеристика КАК Характеристика,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|					И ПечатьПользовательскихЕдиницИзмерения.Значение = ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|					И ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|				ТОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору.Наименование
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.Номенклатура.ЕдиницаИзмерения.Наименование
	|		КОНЕЦ КАК ЕдиницаИзмеренияПоОКЕИ_Наименование,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|					И ПечатьПользовательскихЕдиницИзмерения.Значение = ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|					И ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|				ТОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору.Код
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.Номенклатура.ЕдиницаИзмерения.Код
	|		КОНЕЦ КАК ЕдиницаИзмеренияПоОКЕИ_Код,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|					И ПечатьПользовательскихЕдиницИзмерения.Значение <> ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|				ТОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.Коэффициент
	|			ИНАЧЕ 1
	|		КОНЕЦ КАК КоэффициентЕдиницыИзмерения,
	|		Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		Количество КАК Количество,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|					И ПечатьПользовательскихЕдиницИзмерения.Значение = ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|					И ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|				ТОГДА 1
	|			КОГДА ОтчетКомиссионера.Запасы.ЕдиницаИзмерения ССЫЛКА Справочник.КлассификаторЕдиницИзмерения
	|				ТОГДА 1
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.ЕдиницаИзмерения.Коэффициент
	|		КОНЕЦ КАК КоличествоВОдномМесте,
	|		Количество КАК КоличествоМест,
	|		СтавкаНДС КАК СтавкаНДС,
	|		0 КАК МассаБрутто,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях
	|				ТОГДА ВЫБОР
	|						КОГДА ОтчетКомиссионера.Ссылка.Договор.РасчетыВУсловныхЕдиницах
	|								И ОтчетКомиссионера.Ссылка.ВалютаДокумента <> &НациональнаяВалюта
	|							ТОГДА ВЫРАЗИТЬ(ОтчетКомиссионера.Запасы.Цена * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.Цена
	|					КОНЕЦ
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.Цена
	|		КОНЕЦ КАК Цена,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях
	|				ТОГДА ВЫБОР
	|						КОГДА ОтчетКомиссионера.Ссылка.Договор.РасчетыВУсловныхЕдиницах
	|								И ОтчетКомиссионера.Ссылка.ВалютаДокумента <> &НациональнаяВалюта
	|							ТОГДА ВЫРАЗИТЬ(ОтчетКомиссионера.Запасы.Сумма * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.Сумма
	|					КОНЕЦ
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.Сумма
	|		КОНЕЦ КАК Сумма,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях
	|				ТОГДА ВЫБОР
	|						КОГДА ОтчетКомиссионера.Ссылка.Договор.РасчетыВУсловныхЕдиницах
	|								И ОтчетКомиссионера.Ссылка.ВалютаДокумента <> &НациональнаяВалюта
	|							ТОГДА ВЫРАЗИТЬ(ОтчетКомиссионера.Запасы.СуммаНДС * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаНДС
	|					КОНЕЦ
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаНДС
	|		КОНЕЦ КАК СуммаНДС,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях
	|				ТОГДА ВЫБОР
	|						КОГДА ОтчетКомиссионера.Ссылка.Договор.РасчетыВУсловныхЕдиницах
	|								И ОтчетКомиссионера.Ссылка.ВалютаДокумента <> &НациональнаяВалюта
	|							ТОГДА ВЫРАЗИТЬ(ОтчетКомиссионера.Запасы.Всего * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.Всего
	|					КОНЕЦ
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.Всего
	|		КОНЕЦ КАК Всего,
	|		Ссылка.Дата КАК ДатаОтгрузочногоДокумента,
	|		Ссылка.Номер КАК НомерОтгрузочногоДокумента,
	|		СтранаПроисхождения КАК СтранаСсылка,
	|		ПРЕДСТАВЛЕНИЕ(ОтчетКомиссионера.Запасы.СтранаПроисхождения) КАК СтранаПредставление,
	|		СтранаПроисхождения.Код КАК СтранаКод,
	|		НомерГТД.РегистрационныйНомер КАК ПредставлениеГТД,
	|		КлючСвязи КАК КлючСвязи,
	|		ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|		КодТНВЭД КАК КодТНВЭД,
	|		ИдентификаторСтроки КАК ИдентификаторСтроки,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.ПрослеживаемыйТовар
	|				ТОГДА 1
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК ПрослеживаемыйТоварЧисло,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас)
	|				ТОГДА ВЫБОР
	|						КОГДА ОтчетКомиссионера.Запасы.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|								ИЛИ ОтчетКомиссионера.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС)
	|								ИЛИ НЕ ОтчетКомиссионера.Ссылка.Контрагент.СтранаРегистрации.УчастникЕАЭС
	|							ТОГДА ОтчетКомиссионера.Запасы.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Код
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.КодТНВЭД.ЕдиницаИзмерения.Код
	|					КОНЕЦ
	|			ИНАЧЕ """"
	|		КОНЕЦ КАК КодТНВЭДЕдиницаИзмеренияКод,
	|		ВЫБОР
	|			КОГДА ОтчетКомиссионера.Запасы.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас)
	|				ТОГДА ВЫБОР
	|						КОГДА ОтчетКомиссионера.Запасы.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|								ИЛИ ОтчетКомиссионера.Запасы.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС)
	|								ИЛИ НЕ ОтчетКомиссионера.Запасы.Ссылка.Контрагент.СтранаРегистрации.УчастникЕАЭС
	|							ТОГДА ОтчетКомиссионера.Запасы.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Наименование
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.КодТНВЭД.ЕдиницаИзмерения.Наименование
	|					КОНЕЦ
	|			ИНАЧЕ """"
	|		КОНЕЦ КАК КодТНВЭДЕдиницаИзмеренияНаименование
	|	) КАК ТаблицаЗапасы,
	|	ОтчетКомиссионера.Покупатели.(
	|		Покупатель КАК Покупатель,
	|		СчетФактура КАК СчетФактура,
	|		НЕОПРЕДЕЛЕНО КАК СведенияОПокупателе,
	|		НЕОПРЕДЕЛЕНО КАК СведенияОГрузополучателе,
	|		Всего КАК Всего,
	|		КлючСвязи КАК КлючСвязи
	|	) КАК ТаблицаПокупателей,
	|	ЛОЖЬ КАК ЕстьПрослеживаемыеТовары,
	|	ОтчетКомиссионера.ВыписыватьСчетаФактурыСводно КАК ВыписыватьСчетаФактурыСводно,
	|	ОтчетКомиссионера.СведенияПрослеживаемости.(
	|		Ссылка КАК Ссылка,
	|		НомерСтроки КАК НомерСтроки,
	|		РНПТ КАК РНПТ,
	|		Количество КАК Количество,
	|		КоличествоПрослеживаемости КАК КоличествоПрослеживаемости,
	|		ИдентификаторСтроки КАК ИдентификаторСтроки
	|	) КАК СведенияПрослеживаемости
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	Константа.НациональнаяВалюта КАК НациональнаяВалюта,
	|	Константа.ПечатьПользовательскихЕдиницИзмерения КАК ПечатьПользовательскихЕдиницИзмерения
	|ГДЕ
	|	ОтчетКомиссионера.Ссылка В(&МассивОбъектов)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОтчетКомиссионера.Запасы.НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасы.Ссылка КАК Ссылка,
	|	ОтчетКомиссионераЗапасы.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ОтчетКомиссионераЗапасы.Количество КАК Количество,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ОтчетКомиссионераЗапасы.Цена КАК Цена,
	|	ОтчетКомиссионераЗапасы.Сумма КАК Сумма,
	|	ОтчетКомиссионераЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	ОтчетКомиссионераЗапасы.СуммаНДС КАК СуммаНДС,
	|	ОтчетКомиссионераЗапасы.Всего КАК Всего,
	|	ОтчетКомиссионераЗапасы.ЦенаПередачи КАК ЦенаПередачи,
	|	ОтчетКомиссионераЗапасы.СуммаПередачи КАК СуммаПередачи,
	|	ОтчетКомиссионераЗапасы.СуммаНДСПередачи КАК СуммаНДСПередачи,
	|	ОтчетКомиссионераЗапасы.СуммаВознаграждения КАК СуммаВознаграждения,
	|	ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения КАК СуммаНДСВознаграждения,
	|	ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ОтчетКомиссионераЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ОтчетКомиссионераЗапасы.КлючСвязи КАК КлючСвязи,
	|	ОтчетКомиссионераЗапасы.КлючСвязиСерииНоменклатуры КАК КлючСвязиСерииНоменклатуры,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ОтчетКомиссионераЗапасы.НомерГТД КАК НомерГТД,
	|	ОтчетКомиссионераЗапасы.ПрямоеСписаниеГТД КАК ПрямоеСписаниеГТД,
	|	ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость,
	|	ОтчетКомиссионераЗапасы.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ОтчетКомиссионераЗапасы.КодТНВЭД КАК КодТНВЭД,
	|	ОтчетКомиссионераЗапасы.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ПрослеживаемыйТовар
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ПрослеживаемыйТоварЧисло,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас)
	|			ТОГДА ВЫБОР
	|					КОГДА ОтчетКомиссионераЗапасы.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|							ИЛИ ОтчетКомиссионераЗапасы.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС)
	|							ИЛИ НЕ ОтчетКомиссионераЗапасы.Ссылка.Контрагент.СтранаРегистрации.УчастникЕАЭС
	|						ТОГДА ОтчетКомиссионераЗапасы.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Код
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.КодТНВЭД.ЕдиницаИзмерения.Код
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КодТНВЭДЕдиницаИзмеренияКод,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас)
	|			ТОГДА ВЫБОР
	|					КОГДА ОтчетКомиссионераЗапасы.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|							ИЛИ ОтчетКомиссионераЗапасы.Ссылка.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС)
	|							ИЛИ НЕ ОтчетКомиссионераЗапасы.Ссылка.Контрагент.СтранаРегистрации.УчастникЕАЭС
	|						ТОГДА ОтчетКомиссионераЗапасы.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Наименование
	|					ИНАЧЕ ОтчетКомиссионераЗапасы.КодТНВЭД.ЕдиницаИзмерения.Наименование
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КодТНВЭДЕдиницаИзмеренияНаименование,
	|	ОтчетКомиссионераЗапасы.Ссылка.Дата КАК ДатаОтгрузочногоДокумента,
	|	ОтчетКомиссионераЗапасы.Ссылка.Номер КАК НомерОтгрузочногоДокумента,
	|	"""" КАК Содержание,
	|	ОтчетКомиссионераЗапасы.Номенклатура.Наименование КАК ПредставлениеНоменклатуры,
	|	ОтчетКомиссионераЗапасы.Номенклатура.ТипНоменклатуры КАК ТипНоменклатуры,
	|	ОтчетКомиссионераЗапасы.Номенклатура.Код КАК ЗапасКод,
	|	ОтчетКомиссионераЗапасы.Номенклатура.Артикул КАК Артикул,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору.Наименование
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Номенклатура.ЕдиницаИзмерения.Наименование
	|	КОНЕЦ КАК ЕдиницаИзмеренияПоОКЕИ_Наименование,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору.Код
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Номенклатура.ЕдиницаИзмерения.Код
	|	КОНЕЦ КАК ЕдиницаИзмеренияПоОКЕИ_Код,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения.Наименование КАК СтранаПредставление,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения.Код КАК СтранаКод,
	|	ОтчетКомиссионераЗапасы.НомерГТД.РегистрационныйНомер КАК ПредставлениеГТД,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения КАК СтранаСсылка,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|			ТОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.Коэффициент
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК КоэффициентЕдиницыИзмерения,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|			ТОГДА 1
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.КлассификаторЕдиницИзмерения
	|			ТОГДА 1
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.Коэффициент
	|	КОНЕЦ КАК КоличествоВОдномМесте,
	|	ОтчетКомиссионераЗапасы.Количество КАК КоличествоМест,
	|	ОтчетКомиссионераЗапасы.Ссылка.СуммаВключаетНДС КАК СуммаВключаетНДС
	|ПОМЕСТИТЬ ВременнаяТаблица_ОтчетКомиссионераЗапасы
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|ГДЕ
	|	ОтчетКомиссионераЗапасы.Ссылка В(&МассивОбъектов)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Ссылка КАК Ссылка,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.НомерСтроки КАК НомерСтроки,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Номенклатура КАК Номенклатура,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Количество КАК Количество,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Цена КАК Цена,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Сумма КАК Сумма,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаНДС КАК СуммаНДС,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Всего КАК Всего,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ЦенаПередачи КАК ЦенаПередачи,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаПередачи КАК СуммаПередачи,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаНДСПередачи КАК СуммаНДСПередачи,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаВознаграждения КАК СуммаВознаграждения,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаНДСВознаграждения КАК СуммаНДСВознаграждения,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ЗаказПокупателя КАК ЗаказПокупателя,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Партия КАК Партия,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КлючСвязи КАК КлючСвязи,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КлючСвязиСерииНоменклатуры КАК КлючСвязиСерииНоменклатуры,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.НомерГТД КАК НомерГТД,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ПрямоеСписаниеГТД КАК ПрямоеСписаниеГТД,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Себестоимость КАК Себестоимость,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КодТНВЭД КАК КодТНВЭД,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ПрослеживаемыйТоварЧисло КАК ПрослеживаемыйТоварЧисло,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КодТНВЭДЕдиницаИзмеренияКод КАК КодТНВЭДЕдиницаИзмеренияКод,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КодТНВЭДЕдиницаИзмеренияНаименование КАК КодТНВЭДЕдиницаИзмеренияНаименование,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ДатаОтгрузочногоДокумента КАК ДатаОтгрузочногоДокумента,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.НомерОтгрузочногоДокумента КАК НомерОтгрузочногоДокумента,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Содержание КАК Содержание,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ПредставлениеНоменклатуры КАК ПредставлениеНоменклатуры,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ТипНоменклатуры КАК ТипНоменклатуры,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ЗапасКод КАК ЗапасКод,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.Артикул КАК Артикул,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ЕдиницаИзмеренияПоОКЕИ_Наименование КАК ЕдиницаИзмеренияПоОКЕИ_Наименование,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ЕдиницаИзмеренияПоОКЕИ_Код КАК ЕдиницаИзмеренияПоОКЕИ_Код,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СтранаПредставление КАК СтранаПредставление,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СтранаКод КАК СтранаКод,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.ПредставлениеГТД КАК ПредставлениеГТД,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.СтранаСсылка КАК СтранаСсылка,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КоэффициентЕдиницыИзмерения КАК КоэффициентЕдиницыИзмерения,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КоличествоВОдномМесте КАК КоличествоВОдномМесте,
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы.КоличествоМест КАК КоличествоМест,
	|	0 КАК СтоимостьБезНалога
	|ИЗ
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы КАК ВременнаяТаблица_ОтчетКомиссионераЗапасы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераСведенияПрослеживаемости.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.РНПТ КАК РНПТ,
	|	ОтчетКомиссионераСведенияПрослеживаемости.Количество КАК Количество,
	|	ОтчетКомиссионераСведенияПрослеживаемости.КоличествоПрослеживаемости КАК КоличествоПрослеживаемости,
	|	ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ОтчетКомиссионераСведенияПрослеживаемости.Номенклатура КАК Номенклатура,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераСведенияПрослеживаемости.Сумма = 0
	|			ТОГДА ОтчетКомиссионераСведенияПрослеживаемости.Количество * ВЫБОР
	|					КОГДА ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаВключаетНДС
	|						ТОГДА ВЫРАЗИТЬ((ВременнаяТаблица_ОтчетКомиссионераЗапасы.Сумма - ВременнаяТаблица_ОтчетКомиссионераЗапасы.СуммаНДС) / ВременнаяТаблица_ОтчетКомиссионераЗапасы.Количество КАК ЧИСЛО(15, 2))
	|					ИНАЧЕ ВременнаяТаблица_ОтчетКомиссионераЗапасы.Цена
	|				КОНЕЦ
	|		ИНАЧЕ ОтчетКомиссионераСведенияПрослеживаемости.Сумма
	|	КОНЕЦ КАК СтоимостьБезНалога
	|ИЗ
	|	ВременнаяТаблица_ОтчетКомиссионераЗапасы КАК ВременнаяТаблица_ОтчетКомиссионераЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионера.СведенияПрослеживаемости КАК ОтчетКомиссионераСведенияПрослеживаемости
	|		ПО ВременнаяТаблица_ОтчетКомиссионераЗапасы.Ссылка = ОтчетКомиссионераСведенияПрослеживаемости.Ссылка
	|			И ВременнаяТаблица_ОтчетКомиссионераЗапасы.ИдентификаторСтроки = ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки";
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	Результат = МассивРезультатов[0].Выгрузить();
	
	ТЗСтрок = МассивРезультатов[2].Выгрузить();
	ТзСтрокСведенияПрослеживаемости = МассивРезультатов[3].Выгрузить();
	Для Каждого ТекущаяСтрока Из Результат Цикл
		
		НайденныеСтроки = ТЗСтрок.НайтиСтроки(Новый Структура("Ссылка", ТекущаяСтрока.Ссылка));
		Если НайденныеСтроки.Количество() > 0 Тогда
			ТекущаяСтрока.ТаблицаЗапасы = ТЗСтрок.Скопировать(НайденныеСтроки);
			ТекущаяСтрока.ЕстьПрослеживаемыеТовары = (ТекущаяСтрока.ТаблицаЗапасы.Итог("ПрослеживаемыйТоварЧисло") > 0);
			Если ТекущаяСтрока.ЕстьПрослеживаемыеТовары Тогда
				ДополнитьСведениямиОПрослеживаемости(ТзСтрокСведенияПрослеживаемости, ТекущаяСтрока.ТаблицаЗапасы);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Процедура ДополнитьСведениямиОПрослеживаемости(СведенияОПрослеживаемости, ТаблицаДокумента)
	
	МассивИдентифицирующихРеквизитов = Новый Массив();
	МассивИдентифицирующихРеквизитов.Добавить("ИдентификаторСтроки");
	
	ТаблицаДокумента.Колонки.Добавить("СведенияОПрослеживаемости");
	
	Для Каждого СтрокаТаблицыДокумента Из ТаблицаДокумента Цикл
		
		ТаблицаСведенийОПрослеживаемости = НовыйТаблицаСведенийОПрослеживаемости();
		
		ПараметрыОтбора = ПараметрыОтбораСтрокДляРНПТ(МассивИдентифицирующихРеквизитов, СтрокаТаблицыДокумента);
		СтрокиСРНПТ = СведенияОПрослеживаемости.НайтиСтроки(ПараметрыОтбора);
		Для Каждого НайденнаяСтрока Из СтрокиСРНПТ Цикл
			СтрокаСведенийОПрослеживаемости = ТаблицаСведенийОПрослеживаемости.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаСведенийОПрослеживаемости, НайденнаяСтрока);
		КонецЦикла;
		
		Если ЗначениеЗаполнено(ТаблицаСведенийОПрослеживаемости) Тогда
			СтрокаТаблицыДокумента.СведенияОПрослеживаемости = ТаблицаСведенийОПрослеживаемости;
		Иначе
			СтрокаТаблицыДокумента.СведенияОПрослеживаемости = Неопределено;;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПараметрыОтбораСтрокДляРНПТ(ИдентифицирующиеРеквизитыСтроки, СтрокаСчетаФактуры)
	
	СтруктураОтбора = Новый Структура;
	Для Каждого ИдентифицирующийРеквизит Из ИдентифицирующиеРеквизитыСтроки Цикл
		СтруктураОтбора.Вставить(ИдентифицирующийРеквизит,СтрокаСчетаФактуры[ИдентифицирующийРеквизит]); 
	КонецЦикла;
	
	Возврат СтруктураОтбора;
	
КонецФункции

Функция НовыйТаблицаСведенийОПрослеживаемости()
	
	ТаблицаСведенийОПрослеживаемости = Новый ТаблицаЗначений();
	ТаблицаСведенийОПрослеживаемости.Колонки.Добавить("ИдентификаторСтроки");
	ТаблицаСведенийОПрослеживаемости.Колонки.Добавить("РНПТ");
	ТаблицаСведенийОПрослеживаемости.Колонки.Добавить("Количество");
	ТаблицаСведенийОПрослеживаемости.Колонки.Добавить("КоличествоПрослеживаемости");
	ТаблицаСведенийОПрослеживаемости.Колонки.Добавить("СтоимостьБезНалога");
	
	Возврат ТаблицаСведенийОПрослеживаемости;
	
КонецФункции

Функция ДанныеПолученныхДокументовРегУчет(МассивОбъектов, ИспользоватьФаксимиле, ПечатнаяФормаТолькоВРублях = Истина, Ошибки = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	Запрос.УстановитьПараметр("ИспользоватьФаксимиле", ИспользоватьФаксимиле);
	Запрос.УстановитьПараметр("ПечатнаяФормаТолькоВРублях", ПечатнаяФормаТолькоВРублях);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОтчетКомиссионера.Ссылка КАК Ссылка,
	|	НЕОПРЕДЕЛЕНО КАК ДатаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК Номер,
	|	НЕОПРЕДЕЛЕНО КАК ЦифровойИндексОбособленногоПодразделения,
	|	НЕОПРЕДЕЛЕНО КАК НомерИсправления,
	|	НЕОПРЕДЕЛЕНО КАК ДатаИсправления,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеПустая,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыОперацийСчетФактура.Продажа) КАК ВидОперации,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент
	|		ИНАЧЕ ОтчетКомиссионера.Контрагент
	|	КОНЕЦ КАК Организация,
	|	ОтчетКомиссионера.Контрагент КАК ОбособленноеПодразделениеПоставщика,
	|	ОтчетКомиссионера.Контрагент КАК Грузоотправитель,
	|	НЕОПРЕДЕЛЕНО КАК Префикс,
	|	НЕОПРЕДЕЛЕНО КАК Логотип,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеПечати,
	|	ВЫБОР
	|		КОГДА &ИспользоватьФаксимиле = ИСТИНА
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ДаНет.Да)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ДаНет.Нет)
	|	КОНЕЦ КАК ИспользоватьФаксимиле,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Контрагент.ВидКонтрагента = ЗНАЧЕНИЕ(Перечисление.ВидыКонтрагентов.ФизическоеЛицо)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоФизическоеЛицо,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.НеОблагаетсяНДС)
	|			ТОГДА 2
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК СтатусУПД,
	|	ЛОЖЬ КАК ЭтоСводныйСчетФактура,
	|	ЛОЖЬ КАК ЭтоКорректировка,
	|	ОтчетКомиссионера.Контрагент.БанковскийСчетПоУмолчанию КАК БанковскийСчет,
	|	НЕОПРЕДЕЛЕНО КАК ПредставлениеПодразделения,
	|	НЕОПРЕДЕЛЕНО КАК ПредставлениеСкладаСписания,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|		ИНАЧЕ ОтчетКомиссионера.Организация
	|	КОНЕЦ КАК Контрагент,
	|	ОтчетКомиссионера.Организация КАК ОбособленноеПодразделениеПокупателя,
	|	ОтчетКомиссионера.Организация КАК Грузополучатель,
	|	ОтчетКомиссионера.Организация.БанковскийСчетПоУмолчанию КАК БанковскийСчетКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК АдресДоставки,
	|	ОтчетКомиссионера.Организация.ПодписьРуководителя.РасшифровкаПодписи КАК РасшифровкаПодписиКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьНомер,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьДата,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьВыдана,
	|	НЕОПРЕДЕЛЕНО КАК ДоверенностьЛицо,
	|	ОтчетКомиссионера.Договор.Представление КАК Основание,
	|	ОтчетКомиссионера.Договор.Представление КАК ПредставлениеОснования,
	|	ОтчетКомиссионера.Договор КАК ОснованиеПечатиСсылка,
	|	ВЫБОР
	|		КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|			ТОГДА НациональнаяВалюта.Значение
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента
	|	КОНЕЦ КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|			ТОГДА НациональнаяВалюта.Значение.НаименованиеПолное
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента.НаименованиеПолное
	|	КОНЕЦ КАК ВалютаНаименование,
	|	ВЫБОР
	|		КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|			ТОГДА НациональнаяВалюта.Значение.Код
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента.Код
	|	КОНЕЦ КАК ВалютаКод,
	|	ОтчетКомиссионера.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ОтчетКомиссионера.НДСВключатьВСтоимость КАК НДСВключатьВСтоимость,
	|	ОтчетКомиссионера.Курс КАК Курс,
	|	ОтчетКомиссионера.Кратность КАК Кратность,
	|	ОтчетКомиссионера.Договор.НомерДоговора КАК ОснованиеНомер,
	|	ОтчетКомиссионера.Договор.ДатаДоговора КАК ОснованиеДата,
	|	НЕОПРЕДЕЛЕНО КАК ТранспортнаяНакладнаяНомер,
	|	НЕОПРЕДЕЛЕНО КАК ТранспортнаяНакладнаяДата,
	|	НЕОПРЕДЕЛЕНО КАК ДолжностьРуководителя,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиРуководителя,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеРуководителя,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиГлавногоБухгалтера,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеГлавногоБухгалтера,
	|	НЕОПРЕДЕЛЕНО КАК ДолжностьКладовщика,
	|	НЕОПРЕДЕЛЕНО КАК РасшифровкаПодписиКладовщика,
	|	НЕОПРЕДЕЛЕНО КАК ФаксимилеКладовщика,
	|	0 КАК Вес,
	|	0 КАК Объем,
	|	НЕОПРЕДЕЛЕНО КАК НоменклатураДоставки,
	|	НЕОПРЕДЕЛЕНО КАК ПредставлениеНоменклатурыДоставки,
	|	НЕОПРЕДЕЛЕНО КАК КодНоменклатурыДоставки,
	|	НЕОПРЕДЕЛЕНО КАК АртикулНоменклатурыДоставки,
	|	НЕОПРЕДЕЛЕНО КАК СтоимостьДоставки,
	|	НЕОПРЕДЕЛЕНО КАК СтавкаНДСДоставки,
	|	НЕОПРЕДЕЛЕНО КАК СуммаНДСДоставки,
	|	НЕОПРЕДЕЛЕНО КАК ИдентификаторГосКонтракта,
	|	ОтчетКомиссионера.Запасы.(
	|		1 КАК НомерСтроки,
	|		НЕОПРЕДЕЛЕНО КАК Номенклатура,
	|		""Комиссионное вознаграждение"" КАК Содержание,
	|		НЕОПРЕДЕЛЕНО КАК ПредставлениеНоменклатуры,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга) КАК ТипНоменклатуры,
	|		НЕОПРЕДЕЛЕНО КАК ЗапасКод,
	|		НЕОПРЕДЕЛЕНО КАК Код,
	|		НЕОПРЕДЕЛЕНО КАК Артикул,
	|		НЕОПРЕДЕЛЕНО КАК КодТНВЭД,
	|		НЕОПРЕДЕЛЕНО КАК ЕдиницаИзмеренияПоОКЕИ_Наименование,
	|		НЕОПРЕДЕЛЕНО КАК ЕдиницаИзмеренияПоОКЕИ_Код,
	|		НЕОПРЕДЕЛЕНО КАК Характеристика,
	|		НЕОПРЕДЕЛЕНО КАК ЕдиницаИзмерения,
	|		НЕОПРЕДЕЛЕНО КАК ВидУпаковки,
	|		1 КАК КоэффициентЕдиницыИзмерения,
	|		НЕОПРЕДЕЛЕНО КАК Количество,
	|		НЕОПРЕДЕЛЕНО КАК КоличествоВОдномМесте,
	|		НЕОПРЕДЕЛЕНО КАК КоличествоМест,
	|		ОтчетКомиссионера.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|		0 КАК МассаБрутто,
	|		НЕОПРЕДЕЛЕНО КАК Цена,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|					ИЛИ ОтчетКомиссионера.Запасы.Ссылка.Договор.РасчетыВУсловныхЕдиницах = ИСТИНА
	|						И ОтчетКомиссионера.Запасы.Ссылка.ВалютаДокумента <> НациональнаяВалюта.Значение
	|				ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|							КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|								ТОГДА ОтчетКомиссионера.Запасы.СуммаВознаграждения
	|							ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаВознаграждения
	|						КОНЕЦ * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|			ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|							ТОГДА ОтчетКомиссионера.Запасы.СуммаВознаграждения / ((ОтчетКомиссионера.Запасы.СтавкаНДС.Ставка + 100) / 100)
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаВознаграждения
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		КОНЕЦ КАК Сумма,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|					ИЛИ ОтчетКомиссионера.Запасы.Ссылка.Договор.РасчетыВУсловныхЕдиницах = ИСТИНА
	|						И ОтчетКомиссионера.Запасы.Ссылка.ВалютаДокумента <> НациональнаяВалюта.Значение
	|				ТОГДА ОтчетКомиссионера.Запасы.СуммаНДСВознаграждения * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность
	|			ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаНДСВознаграждения
	|		КОНЕЦ КАК СуммаНДС,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|					ИЛИ ОтчетКомиссионера.Запасы.Ссылка.Договор.РасчетыВУсловныхЕдиницах = ИСТИНА
	|						И ОтчетКомиссионера.Запасы.Ссылка.ВалютаДокумента <> НациональнаяВалюта.Значение
	|				ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|							КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|								ТОГДА ОтчетКомиссионера.Запасы.СуммаВознаграждения
	|							ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаВознаграждения + ОтчетКомиссионера.Запасы.СуммаНДСВознаграждения
	|						КОНЕЦ * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|			ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|							ТОГДА ОтчетКомиссионера.Запасы.СуммаВознаграждения
	|						ИНАЧЕ ОтчетКомиссионера.Запасы.СуммаВознаграждения + ОтчетКомиссионера.Запасы.СуммаНДСВознаграждения
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		КОНЕЦ КАК Всего,
	|		Ссылка КАК Ссылка,
	|		Ссылка.Дата КАК ДатаОтгрузочногоДокумента,
	|		Ссылка.Номер КАК НомерОтгрузочногоДокумента,
	|		НЕОПРЕДЕЛЕНО КАК СтранаСсылка,
	|		НЕОПРЕДЕЛЕНО КАК СтранаКод,
	|		НЕОПРЕДЕЛЕНО КАК СтранаПредставление,
	|		НЕОПРЕДЕЛЕНО КАК ПредставлениеГТД
	|	) КАК ТаблицаЗапасы,
	|	ОтчетКомиссионера.ЗапасыВозвраты.(
	|		1 КАК НомерСтроки,
	|		НЕОПРЕДЕЛЕНО КАК Номенклатура,
	|		""Комиссионное вознаграждение"" КАК Содержание,
	|		НЕОПРЕДЕЛЕНО КАК ПредставлениеНоменклатуры,
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга) КАК ТипНоменклатуры,
	|		НЕОПРЕДЕЛЕНО КАК ЗапасКод,
	|		НЕОПРЕДЕЛЕНО КАК Код,
	|		НЕОПРЕДЕЛЕНО КАК Артикул,
	|		НЕОПРЕДЕЛЕНО КАК КодТНВЭД,
	|		НЕОПРЕДЕЛЕНО КАК ЕдиницаИзмеренияПоОКЕИ_Наименование,
	|		НЕОПРЕДЕЛЕНО КАК ЕдиницаИзмеренияПоОКЕИ_Код,
	|		НЕОПРЕДЕЛЕНО КАК Характеристика,
	|		НЕОПРЕДЕЛЕНО КАК ЕдиницаИзмерения,
	|		НЕОПРЕДЕЛЕНО КАК ВидУпаковки,
	|		1 КАК КоэффициентЕдиницыИзмерения,
	|		НЕОПРЕДЕЛЕНО КАК Количество,
	|		НЕОПРЕДЕЛЕНО КАК КоличествоВОдномМесте,
	|		НЕОПРЕДЕЛЕНО КАК КоличествоМест,
	|		ОтчетКомиссионера.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|		0 КАК МассаБрутто,
	|		НЕОПРЕДЕЛЕНО КАК Цена,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|					ИЛИ ОтчетКомиссионера.ЗапасыВозвраты.Ссылка.Договор.РасчетыВУсловныхЕдиницах = ИСТИНА
	|						И ОтчетКомиссионера.ЗапасыВозвраты.Ссылка.ВалютаДокумента <> НациональнаяВалюта.Значение
	|				ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|							КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|								ТОГДА -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения
	|							ИНАЧЕ -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения
	|						КОНЕЦ * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|			ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|							ТОГДА -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения / ((ОтчетКомиссионера.ЗапасыВозвраты.СтавкаНДС.Ставка + 100) / 100)
	|						ИНАЧЕ -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		КОНЕЦ КАК Сумма,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|					ИЛИ ОтчетКомиссионера.ЗапасыВозвраты.Ссылка.Договор.РасчетыВУсловныхЕдиницах = ИСТИНА
	|						И ОтчетКомиссионера.ЗапасыВозвраты.Ссылка.ВалютаДокумента <> НациональнаяВалюта.Значение
	|				ТОГДА -ОтчетКомиссионера.ЗапасыВозвраты.СуммаНДСВознаграждения * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность
	|			ИНАЧЕ -ОтчетКомиссионера.ЗапасыВозвраты.СуммаНДСВознаграждения
	|		КОНЕЦ КАК СуммаНДС,
	|		ВЫБОР
	|			КОГДА &ПечатнаяФормаТолькоВРублях = ИСТИНА
	|					ИЛИ ОтчетКомиссионера.ЗапасыВозвраты.Ссылка.Договор.РасчетыВУсловныхЕдиницах = ИСТИНА
	|						И ОтчетКомиссионера.ЗапасыВозвраты.Ссылка.ВалютаДокумента <> НациональнаяВалюта.Значение
	|				ТОГДА ВЫРАЗИТЬ(ВЫБОР
	|							КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|								ТОГДА -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения
	|							ИНАЧЕ -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионера.ЗапасыВозвраты.СуммаНДСВознаграждения
	|						КОНЕЦ * ОтчетКомиссионера.Курс / ОтчетКомиссионера.Кратность КАК ЧИСЛО(15, 2))
	|			ИНАЧЕ ВЫРАЗИТЬ(ВЫБОР
	|						КОГДА ОтчетКомиссионера.СуммаВключаетНДС
	|							ТОГДА -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения
	|						ИНАЧЕ -ОтчетКомиссионера.ЗапасыВозвраты.СуммаВознаграждения + ОтчетКомиссионера.ЗапасыВозвраты.СуммаНДСВознаграждения
	|					КОНЕЦ КАК ЧИСЛО(15, 2))
	|		КОНЕЦ КАК Всего,
	|		Ссылка КАК Ссылка,
	|		Ссылка.Дата КАК ДатаОтгрузочногоДокумента,
	|		Ссылка.Номер КАК НомерОтгрузочногоДокумента,
	|		НЕОПРЕДЕЛЕНО КАК СтранаСсылка,
	|		НЕОПРЕДЕЛЕНО КАК СтранаКод,
	|		НЕОПРЕДЕЛЕНО КАК СтранаПредставление,
	|		НЕОПРЕДЕЛЕНО КАК ПредставлениеГТД
	|	) КАК ТаблицаЗапасыВозвраты,
	|	ЛОЖЬ КАК ЕстьПрослеживаемыеТовары,
	|	НЕОПРЕДЕЛЕНО КАК ПлатежныеДокументы
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера,
	|	Константа.НациональнаяВалюта КАК НациональнаяВалюта
	|ГДЕ
	|	ОтчетКомиссионера.Ссылка В(&МассивОбъектов)";
	
	ДанныеПечати = Запрос.Выполнить().Выгрузить();
	
	ИменаКолонокТЧ =
	"НомерСтроки
	|,Ссылка
	|,Номенклатура
	|,Содержание
	|,ПредставлениеНоменклатуры
	|,ТипНоменклатуры
	|,ЗапасКод
	|,Код
	|,Артикул
	|,КодТНВЭД
	|,ЕдиницаИзмерения
	|,ЕдиницаИзмеренияПоОКЕИ_Наименование
	|,ЕдиницаИзмеренияПоОКЕИ_Код
	|,Характеристика
	|,ВидУпаковки
	|,КоэффициентЕдиницыИзмерения
	|,Количество
	|,КоличествоВОдномМесте
	|,КоличествоМест
	|,СтавкаНДС
	|,МассаБрутто
	|,ДатаОтгрузочногоДокумента
	|,НомерОтгрузочногоДокумента
	|,СтранаСсылка
	|,СтранаКод
	|,СтранаПредставление
	|,ПредставлениеГТД";
	
	Для каждого ДанныеОбъекта Из ДанныеПечати Цикл
		
		Для Каждого СтрокаТаблицыВозвраты Из ДанныеОбъекта.ТаблицаЗапасыВозвраты Цикл
			
			НоваяСтрока = ДанныеОбъекта.ТаблицаЗапасы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицыВозвраты);
			
		КонецЦикла;
		
		ДанныеОбъекта.ТаблицаЗапасы.Свернуть(ИменаКолонокТЧ, "Цена, Сумма, СуммаНДС, Всего");
		
	КонецЦикла;
	
	Возврат ДанныеПечати;
	
КонецФункции

// Заполняет список команд печати.
// 
// Параметры:
//   КомандыПечати - ТаблицаЗначений - состав полей см. в функции УправлениеПечатью.СоздатьКоллекциюКомандПечати.
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "Обработка.ПечатьСчетФактура.СчетФактураПолученный";
	КомандаПечати.Представление = НСтр("ru = 'Счет-фактура (полученный)'");;
	КомандаПечати.ПроверкаПроведенияПередПечатью = Ложь;
	КомандаПечати.Порядок = 1;
	
	// Отчет комиссионера
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "Накладная";
	КомандаПечати.Представление = НСтр("ru = 'Отчет комиссионера о продажах'");
	КомандаПечати.Картинка = БиблиотекаКартинок.Печать;
	
	//+mega
	// Отчет комиссионера
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "ДанныеДокументаПродажи";
	КомандаПечати.Представление = НСтр("ru = 'Данные документа (продажи)'");
	КомандаПечати.Картинка = БиблиотекаКартинок.Печать;
	КомандаПечати.Порядок = 5;
	
	КомандаПечати = КомандыПечати.Добавить();
	КомандаПечати.Идентификатор = "ДанныеДокументаВозвраты";
	КомандаПечати.Представление = НСтр("ru = 'Данные документа (возвраты)'");
	КомандаПечати.Картинка = БиблиотекаКартинок.Печать;
	КомандаПечати.Порядок = 6;
	//-mega
	
	
КонецПроцедуры

Функция ПечатьОтчетаКомиссионера(МассивОбъектов, ОбъектыПечати)

	УстановитьПривилегированныйРежим(Истина);
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.АвтоМасштаб			= Истина;
	ТабличныйДокумент.ОриентацияСтраницы	= ОриентацияСтраницы.Портрет;
	ТабличныйДокумент.КлючПараметровПечати	= "ПАРАМЕТРЫ_ПЕЧАТИ_ОтчетКомиссионера_Накладная";

	ДополнительнаяКолонкаПечатныхФормДокументов = Константы.ПредставлениеКодовВПечатныхФормах.Получить();
	Если НЕ ЗначениеЗаполнено(ДополнительнаяКолонкаПечатныхФормДокументов) Тогда
		ДополнительнаяКолонкаПечатныхФормДокументов = Перечисления.КодыНоменклатурыВДокументах.ПустоеЗначение;
	КонецЕсли;
 	ВыводитьКоды = Истина;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	Запрос.УстановитьПараметр("ДополнительнаяКолонкаПечатныхФормДокументов", ДополнительнаяКолонкаПечатныхФормДокументов);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтчетКомиссионера.Ссылка КАК Ссылка,
	|	ОтчетКомиссионера.Номер КАК Номер,
	|	ОтчетКомиссионера.ВидОперации КАК ВидОперации,
	|	ОтчетКомиссионера.Дата КАК Дата,
	|	ОтчетКомиссионера.Договор КАК Договор,
	|	ОтчетКомиссионера.Контрагент КАК Контрагент,
	|	ОтчетКомиссионера.Организация КАК Организация,
	|	ОтчетКомиссионера.СуммаДокумента + ОтчетКомиссионера.СуммаДокументаВозврат КАК СуммаДокумента,
	|	ОтчетКомиссионера.ВалютаДокумента КАК ВалютаДокумента,
	|	ОтчетКомиссионера.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ОтчетКомиссионера.Запасы.(
	|		НомерСтроки КАК НомерСтроки,
	|		Номенклатура КАК Номенклатура,
	|		Номенклатура.НаименованиеПолное КАК Товар,
	|		ВЫБОР
	|			КОГДА &ДополнительнаяКолонкаПечатныхФормДокументов = ЗНАЧЕНИЕ(Перечисление.КодыНоменклатурыВДокументах.Артикул)
	|				ТОГДА ОтчетКомиссионера.Запасы.Номенклатура.Артикул
	|			КОГДА &ДополнительнаяКолонкаПечатныхФормДокументов = ЗНАЧЕНИЕ(Перечисление.КодыНоменклатурыВДокументах.Код)
	|				ТОГДА ОтчетКомиссионера.Запасы.Номенклатура.Код
	|			КОГДА &ДополнительнаяКолонкаПечатныхФормДокументов = ЗНАЧЕНИЕ(Перечисление.КодыНоменклатурыВДокументах.Штрихкод)
	|				ТОГДА ОтчетКомиссионера.Запасы.Номенклатура.Штрихкод
	|			КОГДА &ДополнительнаяКолонкаПечатныхФормДокументов = ЗНАЧЕНИЕ(Перечисление.КодыНоменклатурыВДокументах.ПустоеЗначение)
	|				ТОГДА """"
	|		КОНЕЦ КАК КодАртикул,
	|		Количество КАК Количество,
	|		Количество КАК КоличествоМест,
	|		ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	|		Номенклатура.ЕдиницаИзмерения КАК ЕдиницаХранения,
	|		Цена КАК Цена,
	|		Сумма КАК Сумма,
	|		СуммаВознаграждения КАК Вознаграждение,
	|		СуммаНДС КАК СуммаНДС
	|	) КАК Запасы,
	|	ОтчетКомиссионера.Дата КАК ДатаДокумента,
	|	ОтчетКомиссионера.Организация.Префикс КАК Префикс
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
	|ГДЕ
	|	ОтчетКомиссионера.Ссылка В(&МассивОбъектов)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОтчетКомиссионера.Дата,
	|	ОтчетКомиссионера.Ссылка,
	|	НомерСтроки";


	Шапка = Запрос.Выполнить().Выбрать();

	ПервыйДокумент = Истина;

	Пока Шапка.Следующий() Цикл

		Если Не ПервыйДокумент Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;

		ПервыйДокумент = Ложь;
		// Запомним номер строки, с которой начали выводить текущий документ.
		НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;

		Макет = УправлениеПечатью.МакетПечатнойФормы("Документ.ОтчетКомиссионера.ПФ_MXL_Накладная");

		// Выводим шапку накладной

		ОбластьМакета = Макет.ПолучитьОбласть("Заголовок");
		НомерДокумента = ПечатьДокументовУНФ.ПолучитьНомерНаПечатьСУчетомДатыДокумента(Шапка.ДатаДокумента,
		Шапка.Номер, Шапка.Префикс);
		
		ОбластьМакета.Параметры.ТекстЗаголовка = СтрШаблон(НСтр("ru = 'Отчет комиссионера о продажах № %1 от %2'"),
			НомерДокумента, Формат(Шапка.ДатаДокумента, "ДЛФ=DD"));
		ТабличныйДокумент.Вывести(ОбластьМакета);

		СведенияОбОрганизации    = ПечатьДокументовУНФ.СведенияОЮрФизЛице(Шапка.Организация, Шапка.ДатаДокумента, ,);
		ПредставлениеОрганизации =  ПечатьДокументовУНФ.ОписаниеОрганизации(СведенияОбОрганизации, "ПолноеНаименование,ИНН,КПП,РегистрационныйНомер,ЮридическийАдрес,Телефоны,");

		СведенияОКонтрагенте     = ПечатьДокументовУНФ.СведенияОЮрФизЛице(Шапка.Контрагент, Шапка.ДатаДокумента, ,);
		ПредставлениеКонтрагента = ПечатьДокументовУНФ.ОписаниеОрганизации(СведенияОКонтрагенте, "ПолноеНаименование,ИНН,КПП,РегистрационныйНомер,ЮридическийАдрес,Телефоны,");

		ОбластьМакета = Макет.ПолучитьОбласть("Поставщик");
		ОбластьМакета.Параметры.ПредставлениеПоставщика = ПредставлениеОрганизации;
		ОбластьМакета.Параметры.Поставщик = Шапка.Организация;
		ТабличныйДокумент.Вывести(ОбластьМакета);

		ОбластьМакета = Макет.ПолучитьОбласть("Покупатель");
		ОбластьМакета.Параметры.ПредставлениеПолучателя = ПредставлениеКонтрагента;
		ОбластьМакета.Параметры.Получатель = Шапка.Контрагент;
		ТабличныйДокумент.Вывести(ОбластьМакета);

		ОбластьШапки = ?(ВыводитьКоды, "ШапкаСКодом", "ШапкаТаблицы");

		ОбластьМакета = Макет.ПолучитьОбласть(ОбластьШапки);
		Если ДополнительнаяКолонкаПечатныхФормДокументов = Перечисления.КодыНоменклатурыВДокументах.Артикул Тогда
			ОбластьМакета.Параметры.ИмяКодАртикул = "Артикул";
		ИначеЕсли ДополнительнаяКолонкаПечатныхФормДокументов = Перечисления.КодыНоменклатурыВДокументах.Код Тогда
			ОбластьМакета.Параметры.ИмяКодАртикул = "Код";
		ИначеЕсли ДополнительнаяКолонкаПечатныхФормДокументов = Перечисления.КодыНоменклатурыВДокументах.Штрихкод Тогда
			ОбластьМакета.Параметры.ИмяКодАртикул = "Штрихкод";
		КонецЕсли;
		ТабличныйДокумент.Вывести(ОбластьМакета);

		ОбластьСтроки = ?(ВыводитьКоды,	"СтрокаСКодом", "Строка");
		ОбластьМакета = Макет.ПолучитьОбласть(ОбластьСтроки);
		
		Сумма       = 0;
		СуммаНДС    = 0;
		НомерСтроки = 0;

		ВыборкаСтрокТовары = Шапка.Запасы.Выбрать();
		Пока ВыборкаСтрокТовары.Следующий() Цикл

			НомерСтроки = НомерСтроки + 1;
			
			ОбластьМакета.Параметры.Заполнить(ВыборкаСтрокТовары);
			ОбластьМакета.Параметры.НомерСтроки = НомерСтроки;
			ТабличныйДокумент.Вывести(ОбластьМакета);

			Сумма    = Сумма    + ВыборкаСтрокТовары.Сумма;
			СуммаНДС = СуммаНДС + ВыборкаСтрокТовары.СуммаНДС;

		КонецЦикла;
		
		// Вывести Итого
		ОбластьМакета = Макет.ПолучитьОбласть("Итого");
		ОбластьМакета.Параметры.Всего = ПечатьДокументовУНФ.ФорматСумм(Шапка.СуммаДокумента);
		ТабличныйДокумент.Вывести(ОбластьМакета);

		// Вывести ИтогоНДС
		ОбластьМакета = Макет.ПолучитьОбласть("ИтогоНДС");
		ОбластьМакета.Параметры.ВсегоНДС = ПечатьДокументовУНФ.ФорматСумм(СуммаНДС);
		ОбластьМакета.Параметры.НДС = ?(Шапка.СуммаВключаетНДС, НСтр("ru = 'В том числе НДС:'"), НСтр("ru = 'Сумма НДС:'"));
		ТабличныйДокумент.Вывести(ОбластьМакета);
		
		// Вывести Сумму прописью
		ОбластьМакета = Макет.ПолучитьОбласть("СуммаПрописью");
		СуммаКПрописи = Сумма + ?(Шапка.СуммаВключаетНДС, 0, СуммаНДС);
		ИтоговаяСтрока = НСтр("ru = 'Всего наименований %Количество%, на сумму'") + " " + ПечатьДокументовУНФ.ФорматСумм(СуммаКПрописи, Шапка.ВалютаДокумента);
		ИтоговаяСтрока = СтрЗаменить(ИтоговаяСтрока,"%Количество%", ВыборкаСтрокТовары.Количество());
		ОбластьМакета.Параметры.ИтоговаяСтрока = ИтоговаяСтрока;
		ОбластьМакета.Параметры.СуммаПрописью = ПечатьДокументовУНФ.СформироватьСуммуПрописью(СуммаКПрописи, Шапка.ВалютаДокумента);
		ТабличныйДокумент.Вывести(ОбластьМакета);

		// Вывести подписи
		ОбластьМакета = Макет.ПолучитьОбласть("Подписи");
		ТабличныйДокумент.Вывести(ОбластьМакета);

		// В табличном документе зададим имя области, в которую был
		// выведен объект. Нужно для возможности печати покомплектно.
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабличныйДокумент,
			НомерСтрокиНачало, ОбъектыПечати, Шапка.Ссылка);

	КонецЦикла;

	Возврат ТабличныйДокумент;

КонецФункции

//+mega
Процедура ВыводДанныхТабличнойЧасти(ТабличныйДокумент, Макет, Реквизиты, ВыборкаДанных)
	
	ПерваяСтрока = Истина;
	Для Каждого ТекРеквизит Из Реквизиты Цикл 
		
		ОбластьМакета = Макет.ПолучитьОбласть("Строка|Столбец");
		ОбластьМакета.Параметры.Значение = ТекРеквизит;
		
		Если ПерваяСтрока Тогда 
			
			ТабличныйДокумент.Вывести(ОбластьМакета);
			ПерваяСтрока = Ложь;
		Иначе
			ТабличныйДокумент.Присоединить(ОбластьМакета);
		КонецЕсли;
	КонецЦикла;
		
	Пока ВыборкаДанных.Следующий() Цикл
		
		
		ПерваяСтрока = Истина;
		Для Каждого ТекРеквизит Из Реквизиты Цикл 
			
			ОбластьМакета = Макет.ПолучитьОбласть("Строка|Столбец");
			ОбластьМакета.Параметры.Значение = ВыборкаДанных[ТекРеквизит];
			
			Если ПерваяСтрока Тогда 
				
				ТабличныйДокумент.Вывести(ОбластьМакета);
				ПерваяСтрока = Ложь;
			Иначе
				ТабличныйДокумент.Присоединить(ОбластьМакета);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

Функция ПечатьДанныеДокумента(МассивОбъектов, ОбъектыПечати, Операция)

	УстановитьПривилегированныйРежим(Истина);
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.АвтоМасштаб			= Истина;
	ТабличныйДокумент.ОриентацияСтраницы	= ОриентацияСтраницы.Ландшафт;
	ТабличныйДокумент.КлючПараметровПечати	= "ПАРАМЕТРЫ_ПЕЧАТИ_ОтчетКомиссионера_ДанныеДокумента";

		
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтчетКомиссионера.Ссылка КАК Ссылка,
	|	ОтчетКомиссионера.Номер КАК Номер,
	|	ОтчетКомиссионера.ВидОперации КАК ВидОперации,
	|	ОтчетКомиссионера.Дата КАК Дата,
	|	ОтчетКомиссионера.Договор КАК Договор,
	|	ОтчетКомиссионера.Контрагент КАК Контрагент,
	|	ОтчетКомиссионера.Организация КАК Организация,
	|	ОтчетКомиссионера.СуммаДокумента + ОтчетКомиссионера.СуммаДокументаВозврат КАК СуммаДокумента,
	|	ОтчетКомиссионера.ВалютаДокумента КАК ВалютаДокумента,
	|	ОтчетКомиссионера.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ОтчетКомиссионера.Запасы.(
	|		НомерСтроки КАК НомерСтроки,
	|		Номенклатура КАК Номенклатура,
	|		Номенклатура.НаименованиеПолное КАК Товар,
	|		Запасы.Номенклатура.Артикул КАК Артикул,
	|		Количество КАК Количество,
	|		Количество КАК КоличествоМест,
	|		ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	|		Номенклатура.ЕдиницаИзмерения КАК ЕдиницаХранения,
	|		Цена КАК Цена,
	|		Сумма КАК Сумма,
	|		СуммаВознаграждения КАК Вознаграждение,	
	|		СтавкаНДС КАК СтавкаНДС,
	|		СуммаНДС КАК СуммаНДС,
	|		ЦенаПередачи КАК ЦенаПередачи,
	|		СуммаПередачи КАК СуммаПередачи,
	|		СуммаНДСПередачи КАК СуммаНДСПередачи,
	|		УНИКАЛЬНЫЙИДЕНТИФИКАТОР(Запасы.Номенклатура) КАК УникальныйИдентификатор,
	|		
	|	) КАК Запасы,
	|	ОтчетКомиссионера.ЗапасыВозвраты.(
	|		НомерСтроки КАК НомерСтроки,
	|		Номенклатура КАК Номенклатура,
	|		Номенклатура.НаименованиеПолное КАК Товар,
	|		ЗапасыВозвраты.Номенклатура.Артикул КАК Артикул,
	|		Количество КАК Количество,
	|		Количество КАК КоличествоМест,
	|		ЕдиницаИзмерения.Представление КАК ЕдиницаИзмерения,
	|		Номенклатура.ЕдиницаИзмерения КАК ЕдиницаХранения,
	|		Цена КАК Цена,
	|		Сумма КАК Сумма,
	|		СуммаВознаграждения КАК Вознаграждение,
	|		СтавкаНДС КАК СтавкаНДС,
	|		СуммаНДС КАК СуммаНДС,
	|		ЦенаПередачи КАК ЦенаПередачи,
	|		СуммаПередачи КАК СуммаПередачи,
	|		СуммаНДСПередачи КАК СуммаНДСПередачи,
	|		УНИКАЛЬНЫЙИДЕНТИФИКАТОР(ЗапасыВозвраты.Номенклатура) КАК УникальныйИдентификатор,
	|	) КАК ЗапасыВозвраты,
	|	ОтчетКомиссионера.Дата КАК ДатаДокумента,
	|	ОтчетКомиссионера.Организация.Префикс КАК Префикс
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
	|ГДЕ
	|	ОтчетКомиссионера.Ссылка В(&МассивОбъектов)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОтчетКомиссионера.Дата,
	|	ОтчетКомиссионера.Ссылка";


	Шапка = Запрос.Выполнить().Выбрать();

	ПервыйДокумент = Истина;

	Пока Шапка.Следующий() Цикл

		Если Не ПервыйДокумент Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;

		ПервыйДокумент = Ложь;
		// Запомним номер строки, с которой начали выводить текущий документ.
		НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;

		Макет = УправлениеПечатью.МакетПечатнойФормы("Документ.ОтчетКомиссионера.mega_ПФ_MXL_ДанныеДокумента");
        
		
		Реквизиты = Новый Массив;
		Реквизиты.Добавить("УникальныйИдентификатор");
		Реквизиты.Добавить("Артикул");
		Реквизиты.Добавить("Количество");
		Реквизиты.Добавить("Цена");
		Реквизиты.Добавить("Сумма");
		Реквизиты.Добавить("СуммаНДС");
		Реквизиты.Добавить("СтавкаНДС");
		Реквизиты.Добавить("ЦенаПередачи");
		Реквизиты.Добавить("СуммаПередачи");
		Реквизиты.Добавить("СуммаНДСПередачи");
		
		Если Операция = "Продажи" Тогда 
			
			ОбластьМакета = Макет.ПолучитьОбласть("Строка|Столбец");
			ОбластьМакета.Параметры.Значение = СтрШаблон("Продажи %1", Шапка.Ссылка);
			ТабличныйДокумент.Вывести(ОбластьМакета);
			
			ВыборкаДанных = Шапка.Запасы.Выбрать();
			ВыводДанныхТабличнойЧасти(ТабличныйДокумент, Макет, Реквизиты, ВыборкаДанных);			
		КонецЕсли;
		
		
		
		Если Операция = "Возвраты" Тогда 
			
			ОбластьМакета = Макет.ПолучитьОбласть("Строка|Столбец");
			ОбластьМакета.Параметры.Значение = СтрШаблон("Возвраты %1", Шапка.Ссылка);
			ТабличныйДокумент.Вывести(ОбластьМакета);
			
			ВыборкаДанных = Шапка.ЗапасыВозвраты.Выбрать();
			ВыводДанныхТабличнойЧасти(ТабличныйДокумент, Макет, Реквизиты, ВыборкаДанных);
		КонецЕсли;
		
		// В табличном документе зададим имя области, в которую был
		// выведен объект. Нужно для возможности печати покомплектно.
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабличныйДокумент,
			НомерСтрокиНачало, ОбъектыПечати, Шапка.Ссылка);

	КонецЦикла;

	Возврат ТабличныйДокумент;

КонецФункции
//-mega

Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм,ОбъектыПечати, ПараметрыВывода) Экспорт
	
	// Проверяем, нужно ли для макета ОтчетККМ формировать табличный документ.
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "Накладная") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Накладная", НСтр("ru = 'Отчет комиссионера'"), ПечатьОтчетаКомиссионера(МассивОбъектов, ОбъектыПечати), , "Документ.ОтчетКомиссионера.ПФ_MXL_Накладная");
	КонецЕсли;
	
	//+mega
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "ДанныеДокументаПродажи") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(
		КоллекцияПечатныхФорм,
		"ДанныеДокументаПродажи",
		НСтр("ru = 'Данные документа (продажи)'"),
		ПечатьДанныеДокумента(МассивОбъектов, ОбъектыПечати, "Продажи"), , "Документ.ОтчетКомиссионера.mega_ПФ_MXL_ДанныеДокумента");
	КонецЕсли;
	
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "ДанныеДокументаВозвраты") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(
		КоллекцияПечатныхФорм,
		"ДанныеДокументаВозвраты",
		НСтр("ru = 'Данные документа (возвраты)'"),
		ПечатьДанныеДокумента(МассивОбъектов, ОбъектыПечати, "Возвраты"), , "Документ.ОтчетКомиссионера.mega_ПФ_MXL_ДанныеДокумента");
	КонецЕсли;
	//-mega
	
	// Параметры отправки печатных форм по электронной почте
	ЭлектроннаяПочтаУНФ.ЗаполнитьПараметрыОтправки(ПараметрыВывода.ПараметрыОтправки, МассивОбъектов, 
		КоллекцияПечатныхФорм);

КонецПроцедуры

Функция ТекстЗапросаДанныеДляПечатиКорректировочныхСчетовФактур(НомераТаблиц) Экспорт 

	НомераТаблиц.Вставить("ВалютаРегламентированногоУчета",    НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаРеквизиты",         НомераТаблиц.Количество());
	НомераТаблиц.Вставить("Реквизиты",                         НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаНоменклатуры",      НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаДокумента",         НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаСведенияПрослеживаемости", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаСведенияПрослеживаемостиДоИзменения", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблицаПокупатели", НомераТаблиц.Количество());
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонстантаВалютаРегламентированногоУчета.Значение КАК ВалютаРеглУчета
	|ПОМЕСТИТЬ КонстантаВалютаРегламентированногоУчета
	|ИЗ
	|	Константа.НациональнаяВалюта КАК КонстантаВалютаРегламентированногоУчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионера.Ссылка КАК Ссылка,
	|	ОтчетКомиссионера.Дата КАК Дата,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|		ИНАЧЕ ОтчетКомиссионера.Организация
	|	КОНЕЦ КАК Организация,
	|	ОтчетКомиссионера.Организация КАК ОбособленноеПодразделениеПоставщика,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ЦифровойИндексОбособленногоПодразделения
	|		КОГДА ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация = ОтчетКомиссионера.Организация
	|			ТОГДА ОтчетКомиссионера.Подразделение.ЦифровойИндексОбособленногоПодразделения
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК ЦифровойИндексОбособленногоПодразделения,
	|	ОтчетКомиссионера.Подразделение КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент
	|		ИНАЧЕ ОтчетКомиссионера.Контрагент
	|	КОНЕЦ КАК Контрагент,
	|	ОтчетКомиссионера.Контрагент КАК ОбособленноеПодразделениеПокупателя,
	|	ВЫБОР
	|		КОГДА КонстантаВалютаРегламентированногоУчета.ВалютаРеглУчета <> ОтчетКомиссионера.ВалютаДокумента
	|				И ОтчетКомиссионера.Договор.РасчетыВУсловныхЕдиницах
	|			ТОГДА КонстантаВалютаРегламентированногоУчета.ВалютаРеглУчета
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента
	|	КОНЕЦ КАК ВалютаДокумента,
	|	ОтчетКомиссионера.Договор КАК Договор,
	|	ОтчетКомиссионера.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА КонстантаВалютаРегламентированногоУчета.ВалютаРеглУчета <> ОтчетКомиссионера.ВалютаДокумента
	|				И ОтчетКомиссионера.Договор.РасчетыВУсловныхЕдиницах
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ИспользоватьПересчет,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Исправление,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Курс = 0
	|			ТОГДА 1
	|		ИНАЧЕ ОтчетКомиссионера.Курс
	|	КОНЕЦ КАК Курс,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Кратность = 0
	|			ТОГДА 1
	|		ИНАЧЕ ОтчетКомиссионера.Кратность
	|	КОНЕЦ КАК Кратность,
	|	НЕОПРЕДЕЛЕНО КАК ИдентификаторГосКонтракта,
	|	МАКСИМУМ(ВложенныйЗапрос.МаксНомерСтроки) КАК МаксНомерСтроки
	|ПОМЕСТИТЬ ВременнаяТаблицаРеквизиты
	|ИЗ
	|	Документ.ОтчетКомиссионера КАК ОтчетКомиссионера
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонстантаВалютаРегламентированногоУчета КАК КонстантаВалютаРегламентированногоУчета
	|		ПО (ИСТИНА),
	|	(ВЫБРАТЬ
	|		ОтчетКомиссионераЗапасы.НомерСтроки КАК МаксНомерСтроки
	|	ИЗ
	|		Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|	ГДЕ
	|		ОтчетКомиссионераЗапасы.Ссылка = &ДокументОснование
	|		И НЕ ОтчетКомиссионераЗапасы.Ссылка.ИспользоватьНовыйВидДокумента
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ОтчетКомиссионераЗапасыВозвраты.НомерСтроки
	|	ИЗ
	|		Документ.ОтчетКомиссионера.ЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
	|	ГДЕ
	|		ОтчетКомиссионераЗапасыВозвраты.Ссылка = &ДокументОснование
	|		И ОтчетКомиссионераЗапасыВозвраты.Ссылка.ИспользоватьНовыйВидДокумента) КАК ВложенныйЗапрос
	|ГДЕ
	|	ОтчетКомиссионера.Ссылка = &ДокументОснование
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетКомиссионера.Ссылка,
	|	ОтчетКомиссионера.Дата,
	|	ОтчетКомиссионера.Организация,
	|	ОтчетКомиссионера.Подразделение,
	|	ОтчетКомиссионера.Контрагент,
	|	ОтчетКомиссионера.Договор,
	|	ОтчетКомиссионера.СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|				И ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ОтчетКомиссионера.Контрагент.ГоловнойКонтрагент
	|		ИНАЧЕ ОтчетКомиссионера.Контрагент
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонстантаВалютаРегламентированногоУчета.ВалютаРеглУчета <> ОтчетКомиссионера.ВалютаДокумента
	|				И ОтчетКомиссионера.Договор.РасчетыВУсловныхЕдиницах
	|			ТОГДА КонстантаВалютаРегламентированногоУчета.ВалютаРеглУчета
	|		ИНАЧЕ ОтчетКомиссионера.ВалютаДокумента
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КонстантаВалютаРегламентированногоУчета.ВалютаРеглУчета <> ОтчетКомиссионера.ВалютаДокумента
	|				И ОтчетКомиссионера.Договор.РасчетыВУсловныхЕдиницах
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.ИсправлениеОшибки)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Курс = 0
	|			ТОГДА 1
	|		ИНАЧЕ ОтчетКомиссионера.Курс
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Кратность = 0
	|			ТОГДА 1
	|		ИНАЧЕ ОтчетКомиссионера.Кратность
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|		ИНАЧЕ ОтчетКомиссионера.Организация
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионера.Организация.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И НЕ ОтчетКомиссионера.Организация = ОтчетКомиссионера.Организация.ГоловнаяОрганизация
	|			ТОГДА ОтчетКомиссионера.Организация.ЦифровойИндексОбособленногоПодразделения
	|		КОГДА ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				И ОтчетКомиссионера.Подразделение.ГоловнаяОрганизация = ОтчетКомиссионера.Организация
	|			ТОГДА ОтчетКомиссионера.Подразделение.ЦифровойИндексОбособленногоПодразделения
	|		ИНАЧЕ """"
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реквизиты.Дата КАК ДатаОснования,
	|	Реквизиты.Организация КАК Организация,
	|	Реквизиты.Подразделение КАК Подразделение,
	|	Реквизиты.ЦифровойИндексОбособленногоПодразделения КАК ЦифровойИндексОбособленногоПодразделения,
	|	Реквизиты.Организация КАК Поставщик,
	|	ВЫБОР
	|		КОГДА &АдресПоставщика <> """"
	|			ТОГДА &АдресПоставщика
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК АдресПоставщика,
	|	ВЫБОР
	|		КОГДА &ИННКПППоставщика <> """"
	|			ТОГДА &ИННКПППоставщика
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК ИННКПППоставщика,
	|	Реквизиты.Организация.ИНН КАК ИННПоставщика,
	|	Реквизиты.Организация.КПП КАК КПППоставщика,
	|	Реквизиты.ОбособленноеПодразделениеПоставщика КАК ОбособленноеПодразделениеПоставщика,
	|	Реквизиты.Контрагент КАК Покупатель,
	|	Реквизиты.Контрагент.ИНН КАК ИННПокупателя,
	|	Реквизиты.Контрагент.КПП КАК КПППокупателя,
	|	Реквизиты.ОбособленноеПодразделениеПокупателя КАК ОбособленноеПодразделениеПокупателя,
	|	Реквизиты.ВалютаДокумента КАК Валюта,
	|	Реквизиты.Договор.ВалютаРасчетов КАК ВалютаВзаиморасчетов,
	|	Реквизиты.Договор.РасчетыВУсловныхЕдиницах КАК РасчетыВУсловныхЕдиницах,
	|	Реквизиты.Договор.Представление КАК Основание,
	|	Реквизиты.ИдентификаторГосКонтракта КАК ИдентификаторГосКонтракта
	|ИЗ
	|	ВременнаяТаблицаРеквизиты КАК Реквизиты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасы.Ссылка КАК Ссылка,
	|	1 КАК НомерТабЧасти,
	|	ОтчетКомиссионераЗапасы.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераЗапасы.Номенклатура КАК Товар,
	|	ОтчетКомиссионераЗапасы.Номенклатура.ТоварнаяНоменклатураВЭД.Код КАК ТоварКодТНВЭД,
	|	ОтчетКомиссионераЗапасы.Номенклатура.Код КАК ТоварКод,
	|	ОтчетКомиссионераЗапасы.Номенклатура.Артикул КАК ТоварАртикул,
	|	ОтчетКомиссионераЗапасы.Номенклатура.НаименованиеПолное КАК ТоварНаименование,
	|	ОтчетКомиссионераЗапасы.Характеристика КАК Характеристика,
	|	ОтчетКомиссионераЗапасы.СтранаПроисхождения КАК СтранаПроисхождения,
	|	НЕОПРЕДЕЛЕНО КАК ПредставлениеСтраны,
	|	ОтчетКомиссионераЗапасы.НомерГТД КАК НомерГТД,
	|	НЕОПРЕДЕЛЕНО КАК ПредставлениеГТД,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ПечатьПользовательскихЕдиницИзмерения.Значение = ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|				И ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Номенклатура.ЕдиницаИзмерения
	|	КОНЕЦ КАК ЕдиницаИзмерения,
	|	ОтчетКомиссионераЗапасы.СтавкаНДС КАК СтавкаНДС,
	|	ЛОЖЬ КАК ЭтоУслуга,
	|	ОтчетКомиссионераЗапасы.Цена * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК ЦенаПослеИзменения,
	|	ОтчетКомиссионераЗапасы.Цена КАК ЦенаПослеИзмененияВалДокумента,
	|	0 КАК СуммаНДСПослеИзменения,
	|	0 КАК СуммаНДСПослеИзмененияВалДокумента,
	|	0 КАК СтоимостьБезНДСПослеИзменения,
	|	0 КАК СтоимостьБезНДСПослеИзмененияВалДокумента,
	|	0 КАК СтоимостьСНДСПослеИзменения,
	|	ОтчетКомиссионераЗапасы.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасы.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Код
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.КодТНВЭД.ЕдиницаИзмерения.Код
	|	КОНЕЦ КАК КодТНВЭДЕдиницаИзмеренияКод,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасы.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Наименование
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.КодТНВЭД.ЕдиницаИзмерения.Наименование
	|	КОНЕЦ КАК КодТНВЭДЕдиницаИзмеренияНаименование,
	|	ОтчетКомиссионераЗапасы.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасы.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ПечатьПользовательскихЕдиницИзмерения.Значение <> ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|			ТОГДА ОтчетКомиссионераЗапасы.Количество * ОтчетКомиссионераЗапасы.ЕдиницаИзмерения.Коэффициент
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Количество
	|	КОНЕЦ КАК КоличествоДоИзменения,
	|	0 КАК КоличествоПослеИзменения,
	|	ОтчетКомиссионераЗапасы.Цена * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК ЦенаДоИзменения,
	|	ОтчетКомиссионераЗапасы.Цена КАК ЦенаДоИзмененияВалДокумента,
	|	ОтчетКомиссионераЗапасы.СуммаНДС * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК СуммаНДСДоИзменения,
	|	ОтчетКомиссионераЗапасы.СуммаНДС КАК СуммаНДСДоИзмененияВалДокумента,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераЗапасы.Сумма - ОтчетКомиссионераЗапасы.СуммаНДС
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Сумма
	|	КОНЕЦ * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК СтоимостьБезНДСДоИзменения,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераЗапасы.Сумма - ОтчетКомиссионераЗапасы.СуммаНДС
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Сумма
	|	КОНЕЦ КАК СтоимостьБезНДСДоИзмененияВалДокумента,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераЗапасы.Сумма
	|		ИНАЧЕ ОтчетКомиссионераЗапасы.Сумма + ОтчетКомиссионераЗапасы.СуммаНДС
	|	КОНЕЦ * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК СтоимостьСНДСДоИзменения,
	|	ОтчетКомиссионераЗапасы.Номенклатура.Штрихкод КАК Штрихкод
	|ПОМЕСТИТЬ ТаблицаНоменклатуры
	|ИЗ
	|	Документ.ОтчетКомиссионера.Запасы КАК ОтчетКомиссионераЗапасы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаРеквизиты КАК Реквизиты
	|		ПО (Реквизиты.Ссылка = ОтчетКомиссионераЗапасы.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СуммыДокументовРегламентированныйУчет КАК СуммыДокументовРегламентированныйУчет
	|		ПО ОтчетКомиссионераЗапасы.Ссылка.ДокументОснование = СуммыДокументовРегламентированныйУчет.Регистратор
	|			И ОтчетКомиссионераЗапасы.КлючСвязи = СуммыДокументовРегламентированныйУчет.НомерСтрокиДокумента,
	|	Константа.ПечатьПользовательскихЕдиницИзмерения КАК ПечатьПользовательскихЕдиницИзмерения
	|ГДЕ
	|	ОтчетКомиссионераЗапасы.Ссылка = &ДокументОснование
	|	И ОтчетКомиссионераЗапасы.КлючСвязи = &КлючСвязи
	|	И НЕ ОтчетКомиссионераЗапасы.Ссылка.ИспользоватьНовыйВидДокумента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОтчетКомиссионераЗапасыВозвраты.Ссылка,
	|	1,
	|	ОтчетКомиссионераЗапасыВозвраты.НомерСтроки,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура.ТоварнаяНоменклатураВЭД.Код,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура.Код,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура.Артикул,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура.НаименованиеПолное,
	|	ОтчетКомиссионераЗапасыВозвраты.Характеристика,
	|	ОтчетКомиссионераЗапасыВозвраты.СтранаПроисхождения,
	|	НЕОПРЕДЕЛЕНО,
	|	ОтчетКомиссионераЗапасыВозвраты.НомерГТД,
	|	НЕОПРЕДЕЛЕНО,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ПечатьПользовательскихЕдиницИзмерения.Значение = ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|				И ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору <> ЗНАЧЕНИЕ(Справочник.КлассификаторЕдиницИзмерения.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения.ЕдиницаИзмеренияПоКлассификатору
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Номенклатура.ЕдиницаИзмерения
	|	КОНЕЦ,
	|	ОтчетКомиссионераЗапасыВозвраты.СтавкаНДС,
	|	ЛОЖЬ,
	|	ОтчетКомиссионераЗапасыВозвраты.Цена * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ОтчетКомиссионераЗапасыВозвраты.Цена,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	ОтчетКомиссионераЗапасыВозвраты.ПрослеживаемыйТовар,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасыВозвраты.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Код
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.КодТНВЭД.ЕдиницаИзмерения.Код
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасыВозвраты.КодТНВЭД = ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Номенклатура.ТоварнаяНоменклатураВЭД.ЕдиницаИзмерения.Наименование
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.КодТНВЭД.ЕдиницаИзмерения.Наименование
	|	КОНЕЦ,
	|	ОтчетКомиссионераЗапасыВозвраты.ИдентификаторСтроки,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения ССЫЛКА Справочник.ЕдиницыИзмерения
	|				И ПечатьПользовательскихЕдиницИзмерения.Значение <> ЗНАЧЕНИЕ(Перечисление.ПечатьПользовательскихЕдиницИзмерения.ФормироватьПечатныйДокументВПользовательскойЕдинице)
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Количество * ОтчетКомиссионераЗапасыВозвраты.ЕдиницаИзмерения.Коэффициент
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Количество
	|	КОНЕЦ,
	|	0,
	|	ОтчетКомиссионераЗапасыВозвраты.Цена * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ОтчетКомиссионераЗапасыВозвраты.Цена,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаНДС * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ОтчетКомиссионераЗапасыВозвраты.СуммаНДС,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Сумма - ОтчетКомиссионераЗапасыВозвраты.СуммаНДС
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Сумма
	|	КОНЕЦ * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Сумма - ОтчетКомиссионераЗапасыВозвраты.СуммаНДС
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Сумма
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА Реквизиты.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераЗапасыВозвраты.Сумма
	|		ИНАЧЕ ОтчетКомиссионераЗапасыВозвраты.Сумма + ОтчетКомиссионераЗапасыВозвраты.СуммаНДС
	|	КОНЕЦ * ВЫБОР
	|		КОГДА Реквизиты.ИспользоватьПересчет
	|			ТОГДА Реквизиты.Курс / Реквизиты.Кратность
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ОтчетКомиссионераЗапасыВозвраты.Номенклатура.Штрихкод
	|ИЗ
	|	Документ.ОтчетКомиссионера.ЗапасыВозвраты КАК ОтчетКомиссионераЗапасыВозвраты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаРеквизиты КАК Реквизиты
	|		ПО (Реквизиты.Ссылка = ОтчетКомиссионераЗапасыВозвраты.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СуммыДокументовРегламентированныйУчет КАК СуммыДокументовРегламентированныйУчет
	|		ПО ОтчетКомиссионераЗапасыВозвраты.Ссылка.ДокументОснование = СуммыДокументовРегламентированныйУчет.Регистратор
	|			И ОтчетКомиссионераЗапасыВозвраты.КлючСвязи = СуммыДокументовРегламентированныйУчет.НомерСтрокиДокумента,
	|	Константа.ПечатьПользовательскихЕдиницИзмерения КАК ПечатьПользовательскихЕдиницИзмерения
	|ГДЕ
	|	ОтчетКомиссионераЗапасыВозвраты.Ссылка = &ДокументОснование
	|	И ОтчетКомиссионераЗапасыВозвраты.КлючСвязи = &КлючСвязи
	|	И ОтчетКомиссионераЗапасыВозвраты.Ссылка.ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаНоменклатуры.НомерТабЧасти КАК НомерТабЧасти,
	|	ТаблицаНоменклатуры.НомерСтроки КАК НомерСтроки,
	|	ТаблицаНоменклатуры.Товар КАК Товар,
	|	ТаблицаНоменклатуры.ТоварКодТНВЭД КАК ТоварКодТНВЭД,
	|	ТаблицаНоменклатуры.ТоварКод КАК ТоварКод,
	|	ТаблицаНоменклатуры.ТоварАртикул КАК ТоварАртикул,
	|	ТаблицаНоменклатуры.ТоварКод КАК Код,
	|	ТаблицаНоменклатуры.ТоварАртикул КАК Артикул,
	|	ТаблицаНоменклатуры.Характеристика КАК Характеристика,
	|	ТаблицаНоменклатуры.ТоварНаименование КАК ТоварНаименование,
	|	ТаблицаНоменклатуры.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ТаблицаНоменклатуры.ПредставлениеСтраны КАК ПредставлениеСтраны,
	|	ТаблицаНоменклатуры.НомерГТД КАК НомерГТД,
	|	ТаблицаНоменклатуры.ПредставлениеГТД КАК ПредставлениеГТД,
	|	ТаблицаНоменклатуры.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ТаблицаНоменклатуры.КоличествоПослеИзменения КАК КоличествоПослеИзменения,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.КоличествоПослеИзменения = 0
	|			ТОГДА 0
	|		ИНАЧЕ ТаблицаНоменклатуры.СтоимостьБезНДСПослеИзменения / ТаблицаНоменклатуры.КоличествоПослеИзменения
	|	КОНЕЦ КАК ЦенаПослеИзменения,
	|	ТаблицаНоменклатуры.СтоимостьБезНДСПослеИзменения КАК СтоимостьБезНДСПослеИзменения,
	|	ТаблицаНоменклатуры.СуммаНДСПослеИзменения КАК СуммаНДСПослеИзменения,
	|	ТаблицаНоменклатуры.СтоимостьСНДСПослеИзменения КАК СтоимостьСНДСПослеИзменения,
	|	ТаблицаНоменклатуры.СтавкаНДС КАК СтавкаНДС,
	|	ТаблицаНоменклатуры.ЭтоУслуга КАК ЭтоУслуга,
	|	ТаблицаНоменклатуры.Ссылка КАК Ссылка,
	|	ТаблицаНоменклатуры.ПрослеживаемыйТовар КАК ПрослеживаемыйТовар,
	|	ТаблицаНоменклатуры.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ТаблицаНоменклатуры.КодТНВЭДЕдиницаИзмеренияКод КАК КодТНВЭДЕдиницаИзмеренияКод,
	|	ТаблицаНоменклатуры.КодТНВЭДЕдиницаИзмеренияНаименование КАК КодТНВЭДЕдиницаИзмеренияНаименование,
	|	ТаблицаНоменклатуры.СтоимостьСНДСДоИзменения КАК СтоимостьСНДСДоИзменения,
	|	ТаблицаНоменклатуры.СтоимостьБезНДСДоИзмененияВалДокумента КАК СтоимостьБезНДСДоИзмененияВалДокумента,
	|	ТаблицаНоменклатуры.СтоимостьБезНДСДоИзменения КАК СтоимостьБезНДСДоИзменения,
	|	ТаблицаНоменклатуры.СуммаНДСДоИзмененияВалДокумента КАК СуммаНДСДоИзмененияВалДокумента,
	|	ТаблицаНоменклатуры.СуммаНДСДоИзменения КАК СуммаНДСДоИзменения,
	|	ТаблицаНоменклатуры.ЦенаДоИзмененияВалДокумента КАК ЦенаДоИзмененияВалДокумента,
	|	ТаблицаНоменклатуры.ЦенаДоИзменения КАК ЦенаДоИзменения,
	|	ТаблицаНоменклатуры.КоличествоДоИзменения КАК КоличествоДоИзменения,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.СтоимостьБезНДСДоИзменения > ТаблицаНоменклатуры.СтоимостьБезНДСПослеИзменения
	|			ТОГДА ТаблицаНоменклатуры.СтоимостьБезНДСДоИзменения - ТаблицаНоменклатуры.СтоимостьБезНДСПослеИзменения
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаБезНДСУменьшение,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.СтоимостьБезНДСПослеИзменения > ТаблицаНоменклатуры.СтоимостьБезНДСДоИзменения
	|			ТОГДА ТаблицаНоменклатуры.СтоимостьБезНДСПослеИзменения - ТаблицаНоменклатуры.СтоимостьБезНДСДоИзменения
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаБезНДСУвеличение,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.СуммаНДСДоИзменения > ТаблицаНоменклатуры.СуммаНДСПослеИзменения
	|			ТОГДА ТаблицаНоменклатуры.СуммаНДСДоИзменения - ТаблицаНоменклатуры.СуммаНДСПослеИзменения
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаНДСУменьшение,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.СуммаНДСПослеИзменения > ТаблицаНоменклатуры.СуммаНДСДоИзменения
	|			ТОГДА ТаблицаНоменклатуры.СуммаНДСПослеИзменения - ТаблицаНоменклатуры.СуммаНДСДоИзменения
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаНДСУвеличение,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.СтоимостьСНДСДоИзменения > ТаблицаНоменклатуры.СтоимостьСНДСПослеИзменения
	|			ТОГДА ТаблицаНоменклатуры.СтоимостьСНДСДоИзменения - ТаблицаНоменклатуры.СтоимостьСНДСПослеИзменения
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаСНДСУменьшение,
	|	ВЫБОР
	|		КОГДА ТаблицаНоменклатуры.СтоимостьСНДСПослеИзменения > ТаблицаНоменклатуры.СтоимостьСНДСДоИзменения
	|			ТОГДА ТаблицаНоменклатуры.СтоимостьСНДСПослеИзменения - ТаблицаНоменклатуры.СтоимостьСНДСДоИзменения
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК РазницаСНДСУвеличение,
	|	ТаблицаНоменклатуры.Штрихкод КАК Штрихкод,
	|	НЕОПРЕДЕЛЕНО КАК Содержание
	|ПОМЕСТИТЬ ТаблицаДокумента
	|ИЗ
	|	ТаблицаНоменклатуры КАК ТаблицаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераСведенияПрослеживаемости.Ссылка КАК Ссылка,
	|	ОтчетКомиссионераСведенияПрослеживаемости.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.РНПТ КАК РНПТ,
	|	ОтчетКомиссионераСведенияПрослеживаемости.Количество КАК Количество,
	|	ОтчетКомиссионераСведенияПрослеживаемости.КоличествоПрослеживаемости КАК КоличествоПрослеживаемости
	|ПОМЕСТИТЬ ТаблицаСведенияПрослеживаемости
	|ИЗ
	|	Документ.ОтчетКомиссионера.СведенияПрослеживаемости КАК ОтчетКомиссионераСведенияПрослеживаемости
	|ГДЕ
	|	ОтчетКомиссионераСведенияПрослеживаемости.Ссылка = &ДокументОснование
	|	И НЕ ОтчетКомиссионераСведенияПрослеживаемости.Ссылка.ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераСведенияПрослеживаемости.Ссылка КАК Ссылка,
	|	ОтчетКомиссионераСведенияПрослеживаемости.НомерСтроки КАК НомерСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ОтчетКомиссионераСведенияПрослеживаемости.РНПТ КАК РНПТ,
	|	ОтчетКомиссионераСведенияПрослеживаемости.Количество КАК Количество,
	|	ОтчетКомиссионераСведенияПрослеживаемости.КоличествоПрослеживаемости КАК КоличествоПрослеживаемости
	|ПОМЕСТИТЬ ТаблицаСведенияПрослеживаемостиДоИзменения
	|ИЗ
	|	Документ.ОтчетКомиссионера.СведенияПрослеживаемости КАК ОтчетКомиссионераСведенияПрослеживаемости
	|ГДЕ
	|	ОтчетКомиссионераСведенияПрослеживаемости.Ссылка = &ИсправляемыйДокументРеализации
	|	И НЕ ОтчетКомиссионераСведенияПрослеживаемости.Ссылка.ИспользоватьНовыйВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераПокупатели.НомерСФ КАК НомерСФ,
	|	ОтчетКомиссионераПокупатели.ДатаСФ КАК ДатаСФ
	|ИЗ
	|	Документ.ОтчетКомиссионера.Покупатели КАК ОтчетКомиссионераПокупатели
	|ГДЕ
	|	ОтчетКомиссионераПокупатели.Ссылка.Ссылка = &ДокументОснование
	|	И ОтчетКомиссионераПокупатели.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах)
	|	И ОтчетКомиссионераПокупатели.КлючСвязи = &КлючСвязи
	|	И НЕ ОтчетКомиссионераПокупатели.Ссылка.ИспользоватьНовыйВидДокумента
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОтчетКомиссионераПокупателиВозвраты.НомерСФ,
	|	ОтчетКомиссионераПокупателиВозвраты.ДатаСФ
	|ИЗ
	|	Документ.ОтчетКомиссионера.ПокупателиВозвраты КАК ОтчетКомиссионераПокупателиВозвраты
	|ГДЕ
	|	ОтчетКомиссионераПокупателиВозвраты.Ссылка.Ссылка = &ДокументОснование
	|	И ОтчетКомиссионераПокупателиВозвраты.КлючСвязи = &КлючСвязи
	|	И ОтчетКомиссионераПокупателиВозвраты.Ссылка.ИспользоватьНовыйВидДокумента";
	
	Возврат ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов();

КонецФункции

#КонецОбласти

#Область РаботаССериямиНоменклатуры

// Формирует таблицу значений, содержащую данные для проведения по регистру ДвиженияСерийНоменклатуры.
// Таблицы значений сохраняет в свойствах структуры "ДополнительныеСвойства".
//
Процедура СформироватьТаблицаСерииНоменклатуры(ДокументСсылка, СтруктураДополнительныеСвойства)
	
	Если ДокументСсылка.СерииНоменклатуры.Количество()=0 Тогда
		СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаСерииНоменклатурыГарантии", Новый ТаблицаЗначений);
		СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаДвиженияСерииНоменклатуры", Новый ТаблицаЗначений);
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	Если СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента Тогда 
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ВременнаяТаблицаЗапасы.Период КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
		|	ВременнаяТаблицаЗапасы.Период КАК ДатаСобытия,
		|	ЗНАЧЕНИЕ(Перечисление.ОперацииСерийНоменклатуры.Расход) КАК Операция,
		|	СерииНоменклатуры.Серия КАК Серия,
		|	ВЫБОР
		|		КОГДА СерииНоменклатуры.Количество = 0
		|			ТОГДА 1
		|		ИНАЧЕ СерииНоменклатуры.Количество
		|	КОНЕЦ КАК Количество,
		|	ВременнаяТаблицаЗапасы.Номенклатура КАК Номенклатура,
		|	ВременнаяТаблицаЗапасы.Характеристика КАК Характеристика,
		|	ВременнаяТаблицаЗапасы.Организация КАК Организация,
		|	ВременнаяТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	ВременнаяТаблицаЗапасы.Партия КАК Партия
		|ИЗ
		|	ВременнаяТаблицаЗапасы КАК ВременнаяТаблицаЗапасы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаСерииНоменклатуры КАК СерииНоменклатуры
		|		ПО ВременнаяТаблицаЗапасы.КлючСвязиСерииНоменклатуры = СерииНоменклатуры.КлючСвязи
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВременнаяТаблицаЗапасыВозвраты.Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
		|	ВременнаяТаблицаЗапасыВозвраты.Период,
		|	ЗНАЧЕНИЕ(Перечисление.ОперацииСерийНоменклатуры.Приход),
		|	ВременнаяТаблицаЗапасыВозвраты.СтруктурнаяЕдиница,
		|	СерииНоменклатурыВозвраты.Серия,
		|	ВЫБОР
		|		КОГДА СерииНоменклатурыВозвраты.Количество = 0
		|			ТОГДА 1
		|		ИНАЧЕ СерииНоменклатурыВозвраты.Количество
		|	КОНЕЦ,
		|	ВременнаяТаблицаЗапасыВозвраты.Номенклатура,
		|	ВременнаяТаблицаЗапасыВозвраты.Характеристика,
		|	ВременнаяТаблицаЗапасыВозвраты.Партия,
		|	ВременнаяТаблицаЗапасыВозвраты.Организация
		|ИЗ
		|	ВременнаяТаблицаЗапасыВозвраты КАК ВременнаяТаблицаЗапасыВозвраты
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаСерииНоменклатурыВозвраты КАК СерииНоменклатурыВозвраты
		|		ПО ВременнаяТаблицаЗапасыВозвраты.КлючСвязиСерииНоменклатуры = СерииНоменклатурыВозвраты.КлючСвязи";
		
	Иначе
		
		Если СтруктураДополнительныеСвойства.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионера Тогда
			Запрос.Текст =
			"ВЫБРАТЬ
			|	ВременнаяТаблицаЗапасы.Период КАК Период,
			|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
			|	ВременнаяТаблицаЗапасы.Период КАК ДатаСобытия,
			|	ЗНАЧЕНИЕ(Перечисление.ОперацииСерийНоменклатуры.Расход) КАК Операция,
			|	СерииНоменклатуры.Серия КАК Серия,
			|	ВЫБОР
			|		КОГДА СерииНоменклатуры.Количество = 0
			|			ТОГДА 1
			|		ИНАЧЕ СерииНоменклатуры.Количество
			|	КОНЕЦ КАК Количество,
			|	ВременнаяТаблицаЗапасы.Номенклатура КАК Номенклатура,
			|	ВременнаяТаблицаЗапасы.Характеристика КАК Характеристика,
			|	ВременнаяТаблицаЗапасы.Организация КАК Организация,
			|	ВременнаяТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	ВременнаяТаблицаЗапасы.Партия КАК Партия
			|ИЗ
			|	ВременнаяТаблицаЗапасы КАК ВременнаяТаблицаЗапасы
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаСерииНоменклатуры КАК СерииНоменклатуры
			|		ПО ВременнаяТаблицаЗапасы.КлючСвязиСерииНоменклатуры = СерииНоменклатуры.КлючСвязи";
			
		Иначе
			Запрос.Текст =
			"ВЫБРАТЬ
			|	ВременнаяТаблицаЗапасы.Период КАК Период,
			|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
			|	ВременнаяТаблицаЗапасы.Период КАК ДатаСобытия,
			|	ЗНАЧЕНИЕ(Перечисление.ОперацииСерийНоменклатуры.Приход) КАК Операция,
			|	ВременнаяТаблицаЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
			|	СерииНоменклатуры.Серия КАК Серия,
			|	ВЫБОР
			|		КОГДА СерииНоменклатуры.Количество = 0
			|			ТОГДА 1
			|		ИНАЧЕ СерииНоменклатуры.Количество
			|	КОНЕЦ КАК Количество,
			|	ВременнаяТаблицаЗапасы.Номенклатура КАК Номенклатура,
			|	ВременнаяТаблицаЗапасы.Характеристика КАК Характеристика,
			|	ВременнаяТаблицаЗапасы.Партия КАК Партия,
			|	ВременнаяТаблицаЗапасы.Организация КАК Организация
			|ИЗ
			|	ВременнаяТаблицаЗапасы КАК ВременнаяТаблицаЗапасы
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВременнаяТаблицаСерииНоменклатуры КАК СерииНоменклатуры
			|		ПО ВременнаяТаблицаЗапасы.КлючСвязиСерииНоменклатуры = СерииНоменклатуры.КлючСвязи";
		КонецЕсли; 
		
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаДвиженияСерииНоменклатуры", РезультатЗапроса.Выгрузить());
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаСерииНоменклатурыГарантии", Новый ТаблицаЗначений);
	
КонецПроцедуры // СформироватьТаблицаСерииНоменклатуры()

Процедура СформироватьТаблицаЗапасыВРазрезеГТД(СтруктураДополнительныеСвойства)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = СтруктураДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ИспользоватьНовыйВидДокумента", СтруктураДополнительныеСвойства.ИспользоватьНовыйВидДокумента); 
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасыНаСкладах.НомерСтроки) КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ТаблицаЗапасыНаСкладах.Период КАК Период,
	|	ТаблицаЗапасыНаСкладах.Организация КАК Организация,
	|	ТаблицаЗапасыНаСкладах.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасыНаСкладах.Характеристика КАК Характеристика,
	|	ТаблицаЗапасыНаСкладах.Партия КАК Партия,
	|	ТаблицаЗапасыНаСкладах.НомерГТД КАК НомерГТД,
	|	ТаблицаЗапасыНаСкладах.СтранаПроисхождения КАК СтранаПроисхождения,
	|	СУММА(ТаблицаЗапасыНаСкладах.Количество) КАК Количество
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасыНаСкладах
	|ГДЕ
	|	ТаблицаЗапасыНаСкладах.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|	И ТаблицаЗапасыНаСкладах.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|	И ТаблицаЗапасыНаСкладах.НомерГТД <> ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|	И ТаблицаЗапасыНаСкладах.ПрямоеСписаниеГТД
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасыНаСкладах.Период,
	|	ТаблицаЗапасыНаСкладах.Организация,
	|	ТаблицаЗапасыНаСкладах.Номенклатура,
	|	ТаблицаЗапасыНаСкладах.Характеристика,
	|	ТаблицаЗапасыНаСкладах.Партия,
	|	ТаблицаЗапасыНаСкладах.НомерГТД,
	|	ТаблицаЗапасыНаСкладах.СтранаПроисхождения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасыНаСкладахВозвраты.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаЗапасыНаСкладахВозвраты.Период,
	|	ТаблицаЗапасыНаСкладахВозвраты.Организация,
	|	ТаблицаЗапасыНаСкладахВозвраты.Номенклатура,
	|	ТаблицаЗапасыНаСкладахВозвраты.Характеристика,
	|	ТаблицаЗапасыНаСкладахВозвраты.Партия,
	|	ТаблицаЗапасыНаСкладахВозвраты.НомерГТД,
	|	ТаблицаЗапасыНаСкладахВозвраты.СтранаПроисхождения,
	|	СУММА(ТаблицаЗапасыНаСкладахВозвраты.Количество)
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаЗапасыНаСкладахВозвраты
	|ГДЕ
	|	ТаблицаЗапасыНаСкладахВозвраты.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|	И ТаблицаЗапасыНаСкладахВозвраты.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|	И ТаблицаЗапасыНаСкладахВозвраты.НомерГТД <> ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|	И ТаблицаЗапасыНаСкладахВозвраты.ПрямоеСписаниеГТД
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасыНаСкладахВозвраты.Период,
	|	ТаблицаЗапасыНаСкладахВозвраты.Организация,
	|	ТаблицаЗапасыНаСкладахВозвраты.Номенклатура,
	|	ТаблицаЗапасыНаСкладахВозвраты.Характеристика,
	|	ТаблицаЗапасыНаСкладахВозвраты.Партия,
	|	ТаблицаЗапасыНаСкладахВозвраты.НомерГТД,
	|	ТаблицаЗапасыНаСкладахВозвраты.СтранаПроисхождения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасыПереданныеНаСкладах.НомерСтроки) КАК НомерСтроки,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	ТаблицаЗапасыПереданныеНаСкладах.Период КАК Период,
	|	ТаблицаЗапасыПереданныеНаСкладах.Организация КАК Организация,
	|	ТаблицаЗапасыПереданныеНаСкладах.Номенклатура КАК Номенклатура,
	|	ТаблицаЗапасыПереданныеНаСкладах.Характеристика КАК Характеристика,
	|	ТаблицаЗапасыПереданныеНаСкладах.Партия КАК Партия,
	|	ТаблицаЗапасыПереданныеНаСкладах.НомерГТД КАК НомерГТД,
	|	ТаблицаЗапасыПереданныеНаСкладах.СтранаПроисхождения КАК СтранаПроисхождения,
	|	СУММА(ТаблицаЗапасыПереданныеНаСкладах.Количество) КАК Количество,
	|	ТаблицаЗапасыПереданныеНаСкладах.Документ КАК ДокументПередачи
	|ИЗ
	|	ВременнаяТаблицаЗапасы КАК ТаблицаЗапасыПереданныеНаСкладах
	|ГДЕ
	|	ТаблицаЗапасыПереданныеНаСкладах.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|	И ТаблицаЗапасыПереданныеНаСкладах.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|	И ТаблицаЗапасыПереданныеНаСкладах.НомерГТД <> ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|	И НЕ ТаблицаЗапасыПереданныеНаСкладах.ПрямоеСписаниеГТД
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасыПереданныеНаСкладах.Период,
	|	ТаблицаЗапасыПереданныеНаСкладах.Организация,
	|	ТаблицаЗапасыПереданныеНаСкладах.Номенклатура,
	|	ТаблицаЗапасыПереданныеНаСкладах.Характеристика,
	|	ТаблицаЗапасыПереданныеНаСкладах.Партия,
	|	ТаблицаЗапасыПереданныеНаСкладах.НомерГТД,
	|	ТаблицаЗапасыПереданныеНаСкладах.СтранаПроисхождения,
	|	ТаблицаЗапасыПереданныеНаСкладах.Документ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МИНИМУМ(ТаблицаЗапасыПереданныеНаСкладахВозвраты.НомерСтроки),
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Период,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Организация,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Номенклатура,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Характеристика,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Партия,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.НомерГТД,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.СтранаПроисхождения,
	|	СУММА(ТаблицаЗапасыПереданныеНаСкладахВозвраты.Количество),
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Документ
	|ИЗ
	|	ВременнаяТаблицаЗапасыВозвраты КАК ТаблицаЗапасыПереданныеНаСкладахВозвраты
	|ГДЕ
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|	И ТаблицаЗапасыПереданныеНаСкладахВозвраты.СтранаПроисхождения <> ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|	И ТаблицаЗапасыПереданныеНаСкладахВозвраты.НомерГТД <> ЗНАЧЕНИЕ(Справочник.НомераГТД.ПустаяСсылка)
	|	И НЕ ТаблицаЗапасыПереданныеНаСкладахВозвраты.ПрямоеСписаниеГТД
	|	И &ИспользоватьНовыйВидДокумента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Период,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Организация,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Номенклатура,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Характеристика,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Партия,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.НомерГТД,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.СтранаПроисхождения,
	|	ТаблицаЗапасыПереданныеНаСкладахВозвраты.Документ";
	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаЗапасыВРазрезеГТД", РезультатЗапроса[0].Выгрузить());
	СтруктураДополнительныеСвойства.ТаблицыДляДвижений.Вставить("ТаблицаЗапасыПереданныеВРазрезеГТД", РезультатЗапроса[1].Выгрузить());
	
КонецПроцедуры

Процедура ОбработкаПолученияПредставления(Данные, Представление, СтандартнаяОбработка)
	
	ДокументыУНФКлиентСервер.ПолучитьПредставлениеДокумента(Документы.ОтчетКомиссионера, Данные, Представление,
		СтандартнаяОбработка);
		
	Если ТипЗнч(Данные) = Тип("Структура") И Данные.Свойство("Ссылка") И Данные.Ссылка = Неопределено Тогда 
		Возврат
	КонецЕсли;
	
	Если Данные.Ссылка.ВидОперации = Перечисления.ВидыОперацийОтчетКомиссионера.ОтчетКомиссионераОВозвратах Тогда
		Представление = СтрЗаменить(Представление, НСтр("ru='Отчет комиссионера'"), НСтр("ru='Отчет комиссионера о возвратах'"));
	Иначе
		Представление = СтрЗаменить(Представление, НСтр("ru='Отчет комиссионера'"), НСтр("ru='Отчет комиссионера о продажах'"));
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаПолученияПолейПредставления(Поля, СтандартнаяОбработка)
	
	ДокументыУНФКлиентСервер.ПолучитьПредставлениеПолейДокумента(,Поля, СтандартнаяОбработка);
	
КонецПроцедуры

#КонецОбласти

#Область ЗагрузкаДанныхИзВнешнегоИсточника

// Поля загрузки данных из внешнего источника.
// 
// Параметры:
//  ТаблицаПолейЗагрузки - см. ЗагрузкаДанныхИзВнешнегоИсточника.СоздатьТаблицуПолейОписанияЗагрузки
//  НастройкиЗагрузкиДанных - см. ЗагрузкаДанныхИзВнешнегоИсточника.ПриСозданииНаСервере
//
Процедура ПоляЗагрузкиДанныхИзВнешнегоИсточника(ТаблицаПолейЗагрузки, НастройкиЗагрузкиДанных) Экспорт

	ОписанияТиповПолей = ЗагрузкаДанныхИзВнешнегоИсточника.НовыйОписанияТиповПолейЗагрузки();

	ОписаниеТиповКолонка = Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПоляНоменклатуры(ТаблицаПолейЗагрузки, ОписаниеТиповКолонка,
		ОписанияТиповПолей, НастройкиЗагрузкиДанных);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Содержание", НСтр(
		"ru = 'Содержание'"), ОписанияТиповПолей.ОписаниеТиповСтрока1000, ОписанияТиповПолей.ОписаниеТиповСтрока1000, ,
		, , , НастройкиЗагрузкиДанных.СодержаниеВидимо);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПоляГруппыНоменклатуры(ТаблицаПолейЗагрузки, ОписанияТиповПолей,
		ОписаниеТиповКолонка);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПоляХарактеристики(ТаблицаПолейЗагрузки, ОписанияТиповПолей);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "ЭтоУслуга", НСтр(
		"ru = 'Это услуга'", ОбщегоНазначения.КодОсновногоЯзыка()), ОписанияТиповПолей.ОписаниеТиповБулево,
		ОписанияТиповПолей.ОписаниеТиповБулево);
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Картинка", НСтр(
		"ru = 'Картинка'", ОбщегоНазначения.КодОсновногоЯзыка()), ОписанияТиповПолей.ОписаниеТиповСтрока1000,
		ОписанияТиповПолей.ОписаниеТиповСтрока1000, , , , , Ложь);

	Если ПолучитьФункциональнуюОпцию("ИспользоватьПартии") Тогда

		ОписаниеТиповКолонка = Новый ОписаниеТипов("СправочникСсылка.ПартииНоменклатуры");
		ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Партия", НСтр(
			"ru = 'Партия (наименование)'"), ОписанияТиповПолей.ОписаниеТиповСтрока150, ОписаниеТиповКолонка);

	КонецЕсли;

	Если ПолучитьФункциональнуюОпцию("ИспользоватьСерииНоменклатуры") Тогда

		ОписаниеТиповКолонка = Новый ОписаниеТипов("Булево");
		ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки,
			"ИспользоватьСерииНоменклатуры", НСтр("ru = 'Использовать Серии номенклатуры'",
			ОбщегоНазначения.КодОсновногоЯзыка()), ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписаниеТиповКолонка);

		ОписаниеТиповКолонка = Новый ОписаниеТипов("СправочникСсылка.СерииНоменклатуры");
		ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Серия", НСтр(
			"ru = 'Серийный номер'"), ОписанияТиповПолей.ОписаниеТиповСтрока1000, ОписаниеТиповКолонка);

	КонецЕсли;

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Количество", НСтр(
		"ru = 'Количество'"), ОписанияТиповПолей.ОписаниеТиповСтрока25,
		ОписанияТиповПолей.ОписаниеТиповЧисло15_3Отрицательный, , , Истина);

	ОписаниеТиповКолонка = Новый ОписаниеТипов("СправочникСсылка.КлассификаторЕдиницИзмерения, СправочникСсылка.ЕдиницыИзмерения");
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "ЕдиницаИзмерения", НСтр(
		"ru = 'Ед. изм.'"), ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписаниеТиповКолонка, , , , ,
		ПолучитьФункциональнуюОпцию("УчетВРазличныхЕдиницахИзмерения"));

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Цена", НСтр("ru = 'Цена'"),
		ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписанияТиповПолей.ОписаниеТиповЧисло15_2, , , Ложь);

	ОписаниеТиповКолонка = Новый ОписаниеТипов("СправочникСсылка.СтавкиНДС");
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "СтавкаНДС", НСтр(
		"ru = 'Ставка НДС'"), ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписаниеТиповКолонка, , , Ложь);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Сумма", НСтр("ru = 'Сумма'"),
		ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписанияТиповПолей.ОписаниеТиповЧисло15_2, , , Ложь);
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "ЦенаПередачи", НСтр(
		"ru = 'Цена передачи'"), ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписанияТиповПолей.ОписаниеТиповЧисло15_2, ,
		, Ложь);
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "СуммаПередачи", НСтр(
		"ru = 'Сумма передачи'"), ОписанияТиповПолей.ОписаниеТиповСтрока25, ОписанияТиповПолей.ОписаниеТиповЧисло15_2,
		, , Ложь);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "СуммаВознаграждения", НСтр(
		"ru = 'Сумма вознаграждения'"), ОписанияТиповПолей.ОписаниеТиповСтрока25,
		ОписанияТиповПолей.ОписаниеТиповЧисло15_2, , , Ложь);
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "СуммаНДСВознаграждения", НСтр(
		"ru = 'Сумма НДС вознаграждения'"), ОписанияТиповПолей.ОписаниеТиповСтрока25,
		ОписанияТиповПолей.ОписаниеТиповЧисло15_2, , , Ложь);

	МассивТипов = Новый Массив;
	МассивТипов.Добавить(Тип("ДокументСсылка.ЗаказПокупателя"));
	ОписаниеТиповКолонка = Новый ОписаниеТипов(МассивТипов);
	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "Заказ", НСтр("ru = 'Заказ'"),
		ОписанияТиповПолей.ОписаниеТиповСтрока50, ОписаниеТиповКолонка);

	ЗагрузкаДанныхИзВнешнегоИсточника.ДобавитьПолеОписанияЗагрузки(ТаблицаПолейЗагрузки, "ЭтоВозврат", НСтр(
		"ru = 'ЭтоВозврат'"), ОписанияТиповПолей.ОписаниеТиповСтрока11, ОписанияТиповПолей.ОписаниеТиповБулево, , ,
		Ложь, , Ложь);

КонецПроцедуры

Процедура ПриОпределенииОбразцовЗагрузкиДанных(НастройкиЗагрузкиДанных, УникальныйИдентификатор) Экспорт
	
	Образец_xlsx = ПолучитьМакет("ОбразецЗагрузкиДанных_xlsx");
	ОбразецЗагрузкиДанных_xlsx = ПоместитьВоВременноеХранилище(Образец_xlsx, УникальныйИдентификатор);
	НастройкиЗагрузкиДанных.Вставить("ОбразецЗагрузкиДанных_xlsx", ОбразецЗагрузкиДанных_xlsx);
	
	НастройкиЗагрузкиДанных.Вставить("ОбразецЗагрузкиДанных_mxl", "ОбразецЗагрузкиДанных_mxl");
	
	Образец_csv = ПолучитьМакет("ОбразецЗагрузкиДанных_csv");
	ОбразецЗагрузкиДанных_csv = ПоместитьВоВременноеХранилище(Образец_csv, УникальныйИдентификатор);
	НастройкиЗагрузкиДанных.Вставить("ОбразецЗагрузкиДанных_csv", ОбразецЗагрузкиДанных_csv);
	
КонецПроцедуры

Процедура СопоставитьЗагружаемыеДанныеИзВнешнегоИсточника(ПараметрыСопоставления, АдресРезультата) Экспорт
	
	ТаблицаСопоставленияДанных	= ПараметрыСопоставления.ТаблицаСопоставленияДанных;
	РазмерТаблицыДанных			= ТаблицаСопоставленияДанных.Количество();
	НастройкиЗагрузкиДанных		= ПараметрыСопоставления.НастройкиЗагрузкиДанных;
	НастройкиПоиска				= НастройкиЗагрузкиДанных.НастройкиПоиска;
	
	ТаблицаДублирующихСтрок = ЗагрузкаДанныхИзВнешнегоИсточника.ПустаяТаблицаДублирующихСтрокНоменклатуры();
	НастройкиПоиска.Вставить("ТаблицаДублирующихСтрок", ТаблицаДублирующихСтрок);
	
	ПолноеИмяОбъектаЗаполнения = НастройкиЗагрузкиДанных.ПолноеИмяОбъектаЗаполнения;
	
	// ТаблицаСопоставленияДанных - Тип ДанныеФормыКоллекция
	Для каждого СтрокаТаблицыФормы Из ТаблицаСопоставленияДанных Цикл
		
		// Номенклатура по ШтрихКоду, Артикулу, Наименованию, НаименованиеПолное
		ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьНоменклатуру(СтрокаТаблицыФормы, НастройкиПоиска);
		
		Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "КатегорияНоменклатуры_ВходящиеДанные")
			И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "КатегорияНоменклатуры") Тогда
		
			ЗначениеПоУмолчанию = Справочники.КатегорииНоменклатуры.БезКатегории;					
			ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьКатегориюНоменклатуры(СтрокаТаблицыФормы.КатегорияНоменклатуры, СтрокаТаблицыФормы.КатегорияНоменклатуры_ВходящиеДанные, ЗначениеПоУмолчанию);
			
		КонецЕсли;
		
		Если ПолноеИмяОбъектаЗаполнения = "Документ.ОтчетКомиссионера.ТабличнаяЧасть.Запасы" 
			Или ПолноеИмяОбъектаЗаполнения = "Документ.ОтчетКомиссионера.ТабличнаяЧасть.ЗапасыВозвраты" Тогда
			
			Если СтрокаТаблицыФормы.Номенклатура.ТипНоменклатуры <> Перечисления.ТипыНоменклатуры.Запас Тогда
				
				СтрокаТаблицыФормы.Номенклатура = Неопределено;
				
			КонецЕсли;
			
			СтрокаТаблицыФормы.СчетУчетаЗапасов = Справочники.Номенклатура.СчетУчетаЗапасов();
			СтрокаТаблицыФормы.СчетУчетаЗатрат = ?(ПолучитьФункциональнуюОпцию("ИспользоватьПодсистемуПроизводство"), 
				ПланыСчетов.Управленческий.НезавершенноеПроизводство, ПланыСчетов.Управленческий.КоммерческиеРасходы);
			СтрокаТаблицыФормы.СчетУчетаДоходов = ?(СтрокаТаблицыФормы.Номенклатура.ТипНоменклатуры = ПредопределенноеЗначение("Перечисление.ТипыНоменклатуры.ПодарочныйСертификат"), 
				ПланыСчетов.Управленческий.ПрочиеДоходы, ПланыСчетов.Управленческий.ПустаяСсылка());
				
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "НаправлениеДеятельности") Тогда
					
				ЗначениеПоУмолчанию = Справочники.НаправленияДеятельности.Прочее;
				ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьНаправлениеДеятельности(СтрокаТаблицыФормы.НаправлениеДеятельности, СтрокаТаблицыФормы.НаправлениеДеятельности_ВходящиеДанные, ЗначениеПоУмолчанию);
				
			КонецЕсли;
			
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "МетодОценки") Тогда
					
				ЗначениеПоУмолчанию = Перечисления.МетодОценкиЗапасов.ПоСредней;
				ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьМетодОценки(СтрокаТаблицыФормы.МетодОценки, СтрокаТаблицыФормы.МетодОценки_ВходящиеДанные, ЗначениеПоУмолчанию);
				
			КонецЕсли;
			
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "СпособПополнения") Тогда
					
				ЗначениеПоУмолчанию = Перечисления.СпособыПополненияЗапасов.Закупка;
				ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьСпособПополнения(СтрокаТаблицыФормы.СпособПополнения, СтрокаТаблицыФормы.СпособПополнения_ВходящиеДанные, ЗначениеПоУмолчанию);
				
			КонецЕсли;
			
			Если ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристики") Тогда
				
				Если ЗначениеЗаполнено(СтрокаТаблицыФормы.Номенклатура) Тогда
					
					// Характеристика по Владельцу и Наименованию
					ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьХарактеристику(СтрокаТаблицыФормы);
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "Родитель")
				И ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "РодительНаименование")
				И ЗначениеЗаполнено(СтрокаТаблицыФормы.РодительНаименование) Тогда
				
				ЗначениеПоУмолчанию = Справочники.Номенклатура.ПустаяСсылка();
				ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьРодителяНоменклатуры(СтрокаТаблицыФормы.Родитель, "", СтрокаТаблицыФормы.РодительНаименование, ЗначениеПоУмолчанию);
				
			КонецЕсли;
			
			Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(СтрокаТаблицыФормы, "ЭтоУслуга_ВходящиеДанные") Тогда
				
				СтрокаТаблицыФормы.ЭтоУслуга = СтрокаТаблицыФормы.ЭтоУслуга_ВходящиеДанные;
				
			КонецЕсли;
			
			Если ПолучитьФункциональнуюОпцию("ИспользоватьПартии") Тогда
				
				Если ЗначениеЗаполнено(СтрокаТаблицыФормы.Номенклатура) Тогда
					
					// Партия по Владельцу и Наименованию
					ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьПартию(СтрокаТаблицыФормы.Партия, СтрокаТаблицыФормы.Номенклатура, СтрокаТаблицыФормы.Штрихкод, СтрокаТаблицыФормы.Партия_ВходящиеДанные);
					
				КонецЕсли;
				
			КонецЕсли;
			
			// Серии номенклатуры
			Если ПолучитьФункциональнуюОпцию("ИспользоватьСерииНоменклатуры") Тогда
				
				Если ЗначениеЗаполнено(СтрокаТаблицыФормы.Номенклатура) 
					И  ЗначениеЗаполнено(СтрокаТаблицыФормы.Серия_ВходящиеДанные) Тогда
					
					ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьСерия(СтрокаТаблицыФормы.Номенклатура, СтрокаТаблицыФормы.Серия, СтрокаТаблицыФормы.Серия_ВходящиеДанные);
					
				КонецЕсли;
				
			КонецЕсли;  
			
		КонецЕсли;
		
		// Количество
		ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.ПреобразоватьСтрокуВЧисло(СтрокаТаблицыФормы.Количество, СтрокаТаблицыФормы.Количество_ВходящиеДанные, 1);
		
		Если СтрокаТаблицыФормы.Количество < 0 Тогда
			СтрокаТаблицыФормы.Количество = СтрокаТаблицыФормы.Количество * -1;
			СтрокаТаблицыФормы.ЭтоВозврат = Истина;
		КонецЕсли;
				
		// ЕдиницыИзмерения по Наименованию (так же рассмотреть возможность прикрутить пользовательские ЕИ)
		ЗначениеПоУмолчанию = ?(ЗначениеЗаполнено(СтрокаТаблицыФормы.Номенклатура), СтрокаТаблицыФормы.Номенклатура.ЕдиницаИзмерения, Справочники.КлассификаторЕдиницИзмерения.шт);
		ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьЕдиницыИзмерения(СтрокаТаблицыФормы.Номенклатура, СтрокаТаблицыФормы.ЕдиницаИзмерения, СтрокаТаблицыФормы.ЕдиницаИзмерения_ВходящиеДанные, ЗначениеПоУмолчанию);
		
		// Цена
		ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.ПреобразоватьСтрокуВЧисло(СтрокаТаблицыФормы.Цена, СтрокаТаблицыФормы.Цена_ВходящиеДанные, 1);
		
		// СтавкаНДС по наименованию
		ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьСтавкуНДС(СтрокаТаблицыФормы.СтавкаНДС, СтрокаТаблицыФормы.СтавкаНДС_ВходящиеДанные, Неопределено);
		
		// Заказ по номеру, дате, признаку
		ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.СопоставитьЗаказ(СтрокаТаблицыФормы.Заказ, СтрокаТаблицыФормы.Заказ_ВходящиеДанные);
		
		ПроверитьКорректностьДанныхВСтрокеТаблицы(СтрокаТаблицыФормы, ПолноеИмяОбъектаЗаполнения);
		
		ЗагрузкаДанныхИзВнешнегоИсточника.ПрогрессСопоставленияДанных(ТаблицаСопоставленияДанных.Индекс(СтрокаТаблицыФормы), РазмерТаблицыДанных);
		
	КонецЦикла;
	
	ТаблицаСопоставленияДанных.ЗагрузитьКолонку(ТаблицаДублирующихСтрок.ВыгрузитьКолонку("КлючСвязи"), "_КлючСвязи");
	ПоместитьВоВременноеХранилище(ТаблицаСопоставленияДанных, АдресРезультата);
	
КонецПроцедуры

Процедура ПроверитьКорректностьДанныхВСтрокеТаблицы(СтрокаТаблицыФормы, ПолноеИмяОбъектаЗаполнения = "") Экспорт
	
	ИмяСлужебногоПоля = ЗагрузкаДанныхИзВнешнегоИсточника.ИмяСлужебногоПоляЗагрузкаВПриложениеВозможна();
	
	НоменклатураЗаполнена = ЗначениеЗаполнено(СтрокаТаблицыФормы.Номенклатура);
	ЗагрузкаНоменклатурыВозможна = Ложь;
	Если НЕ НоменклатураЗаполнена Тогда
		ЗагрузкаНоменклатурыВозможна = (ЗначениеЗаполнено(СтрокаТаблицыФормы.НоменклатураНаименование) 
			ИЛИ ЗначениеЗаполнено(СтрокаТаблицыФормы.НоменклатураНаименованиеПолное));
	КонецЕсли;
	
	Если ПолноеИмяОбъектаЗаполнения = "Документ.ОтчетКомиссионера.ТабличнаяЧасть.Запасы"
		ИЛИ ПолноеИмяОбъектаЗаполнения = "Документ.ОтчетКомиссионера.ТабличнаяЧасть.ЗапасыВозвраты" Тогда
			
		Если НоменклатураЗаполнена Тогда
				
			СтрокаТаблицыФормы[ИмяСлужебногоПоля] = СтрокаТаблицыФормы.Номенклатура.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Запас
			И НЕ СтрокаТаблицыФормы.Номенклатура.ЭтоНабор // Исключая наборы
			И СтрокаТаблицыФормы.Количество <> 0;
			СтрокаТаблицыФормы._СтрокаСопоставлена = НоменклатураЗаполнена;
			
		Иначе
			
			СтрокаТаблицыФормы[ИмяСлужебногоПоля] = ЗагрузкаНоменклатурыВозможна И НЕ СтрокаТаблицыФормы.ЭтоУслуга;
			
		КонецЕсли;		
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли