#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

#Область ПроцедурыЗаполненияДокумента

// Обработчик заполнения на основании документа РасходныйОрдер.
//
// Параметры:
//  ДанныеЗаполнения - Данные заполнения документа.
//
Процедура ЗаполнитьПоСтруктуре(ДанныеЗаполнения) Экспорт 
	
	Если ДанныеЗаполнения.Свойство("ОткрытеИзАРМ") И ДанныеЗаполнения.ОткрытеИзАРМ = Истина Тогда
		СкладскойУчетСервер.ЗаполнитьОрдерСУчетомОстатковКлючевыеРеквизитыИдентичны(ЭтотОбъект, ДанныеЗаполнения.ДанныеЗаполнения, "ПриходныйОрдер");
	КонецЕсли;

КонецПроцедуры

// Обработчик заполнения на основании документа РасходныйОрдер.
//
// Параметры:
//  ДокументСсылкаРасходныйОрдер - ДокументСсылка.РасходныйОрдер.
//
Процедура ЗаполнитьПоРасходныйОрдер(ДокументСсылкаРасходныйОрдер) Экспорт
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылкаРасходныйОрдер;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаРасходныйОрдер,
		"Организация, СтруктурнаяЕдиница, Ячейка, ПоложениеЯчейки"); 
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ 
	|	МИНИМУМ(РасходныйОрдерЗапасы.НомерСтроки) КАК НомерСтроки,
	|	РасходныйОрдерЗапасы.Номенклатура КАК Номенклатура,
	|	РасходныйОрдерЗапасы.Характеристика КАК Характеристика,
	|	РасходныйОрдерЗапасы.Партия КАК Партия,
	|	РасходныйОрдерЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(РасходныйОрдерЗапасы.Количество) КАК Количество,
	|	РасходныйОрдерЗапасы.СерииНоменклатуры,
	|	РасходныйОрдерЗапасы.КлючСвязи,
	|	РасходныйОрдерЗапасы.Ячейка Как Ячейка
	|ИЗ
	|	Документ.РасходныйОрдер.Запасы КАК РасходныйОрдерЗапасы
	|ГДЕ
	|	РасходныйОрдерЗапасы.Ссылка = &ДокументОснование
	|СГРУППИРОВАТЬ ПО
	|	РасходныйОрдерЗапасы.Номенклатура,
	|	РасходныйОрдерЗапасы.Характеристика,
	|	РасходныйОрдерЗапасы.Партия,
	|	РасходныйОрдерЗапасы.ЕдиницаИзмерения,
	|	РасходныйОрдерЗапасы.СерииНоменклатуры,
	|	РасходныйОрдерЗапасы.КлючСвязи,
	|	РасходныйОрдерЗапасы.Ячейка
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаРасходныйОрдер);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = Запасы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		КонецЦикла;
	КонецЕсли;
	
	СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылкаРасходныйОрдер);
	
	
	
КонецПроцедуры

// Обработчик заполнения на основании документа ПриходнаяНакладная.
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.ПриходнаяНакладная.
//
Процедура ЗаполнитьПоПриходнаяНакладная(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"Организация, СтруктурнаяЕдиница, Ячейка, ПоложениеСклада, Контрагент");
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		
		СтруктураПроверки = ЕстьОрдерныйСкладВТабЧасти(ДокументСсылка.Запасы, Истина);
		
		ЕстьОрдерныйСклад = СтруктураПроверки.ЕстьОрдерныйСклад;
		
		Если ЕстьОрдерныйСклад Тогда
			СтруктурнаяЕдиница = СтруктураПроверки.СтруктурнаяЕдиница;
		КонецЕсли;
		
		Если НЕ ЕстьОрдерныйСклад Тогда
			ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
			|Документ ""%1"" не использует ордерную схему при поступлении'"), ДокументСсылка);
			
			ВызватьИсключениеВводНаОсновании(ДокументСсылка, ТекстИсключения);
		КонецЕсли;
	Иначе
		ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	КонецЕсли;
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	ПоложениеЯчейки = ДокументСсылка.ПоложениеСклада;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоПриходнаяНакладнаяВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПриходнаяНакладнаяЗапасы.Номенклатура КАК Номенклатура,
	|	ПриходнаяНакладнаяЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ПриходнаяНакладнаяЗапасы.Характеристика КАК Характеристика,
	|	ПриходнаяНакладнаяЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ПриходнаяНакладнаяЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПриходнаяНакладнаяЗапасы.Партия КАК Партия,
	|	ПриходнаяНакладнаяЗапасы.Количество КАК Количество,
	|	ПриходнаяНакладнаяЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ПриходнаяНакладнаяЗапасы.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ИЗ
	|	Документ.ПриходнаяНакладная.Запасы КАК ПриходнаяНакладнаяЗапасы
	|ГДЕ
	|	ПриходнаяНакладнаяЗапасы.Ссылка = &ДокументОснование
	|	И ПриходнаяНакладнаяЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|	И ВЫБОР
	|			КОГДА ПриходнаяНакладнаяЗапасы.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|				ТОГДА ПриходнаяНакладнаяЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПриходнаяНакладнаяЗапасы.Номенклатура КАК Номенклатура,
	|	ПриходнаяНакладнаяЗапасы.Характеристика КАК Характеристика,
	|	ПриходнаяНакладнаяЗапасы.Партия КАК Партия,
	|	ПриходнаяНакладнаяСерииНоменклатуры.Серия КАК Серия,
	|	ПриходнаяНакладнаяЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПриходнаяНакладнаяСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	Документ.ПриходнаяНакладная.Запасы КАК ПриходнаяНакладнаяЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриходнаяНакладная.СерииНоменклатуры КАК ПриходнаяНакладнаяСерииНоменклатуры
	|		ПО ПриходнаяНакладнаяЗапасы.КлючСвязи = ПриходнаяНакладнаяСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	ПриходнаяНакладнаяЗапасы.Ссылка = &ДокументОснование
	|	И ПриходнаяНакладнаяСерииНоменклатуры.Ссылка = &ДокументОснование
	|	И ВЫБОР
	|			КОГДА ПриходнаяНакладнаяЗапасы.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|				ТОГДА ПриходнаяНакладнаяЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);

КонецПроцедуры

// Обработчик заполнения на основании документа ПриходнаяНакладная.
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.ПриходнаяНакладная.
//
Процедура ЗаполнитьПоАвансовомуОтчету(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка, "Организация");
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	
	СтруктураПроверки = ЕстьОрдерныйСкладВТабЧасти(ДокументСсылка.Запасы, Истина);
	
	ЕстьОрдерныйСклад = СтруктураПроверки.ЕстьОрдерныйСклад;
	
	Если ЕстьОрдерныйСклад Тогда
		СтруктурнаяЕдиница = СтруктураПроверки.СтруктурнаяЕдиница;
	КонецЕсли;
	
	Если НЕ ЕстьОрдерныйСклад Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
		|Документ ""%1"" не использует ордерную схему при поступлении'"), ДокументСсылка);
		
		ВызватьИсключениеВводНаОсновании(ДокументСсылка, ТекстИсключения);
	КонецЕсли;
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Запасы.Очистить();
	
	ПоложениеЯчейки = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоАвансовомуОтчетуВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	АвансовыйОтчетЗапасы.Номенклатура КАК Номенклатура,
	|	АвансовыйОтчетЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	АвансовыйОтчетЗапасы.Характеристика КАК Характеристика,
	|	АвансовыйОтчетЗапасы.Партия КАК Партия,
	|	АвансовыйОтчетЗапасы.Количество КАК Количество,
	|	АвансовыйОтчетЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	АвансовыйОтчетЗапасы.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ИЗ
	|	Документ.АвансовыйОтчет.Запасы КАК АвансовыйОтчетЗапасы
	|ГДЕ
	|	АвансовыйОтчетЗапасы.Ссылка = &ДокументОснование
	|	И АвансовыйОтчетЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();

	Если РезультатыЗапроса[2].Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаОстаткиЗапасы = РезультатыЗапроса[2].Выгрузить();
	
	ВыборкаЗапасы = РезультатыЗапроса[0].Выбрать();
	
	Если СкладскойУчетСервер.КонтролироватьОстаткиПоЯчейкамКПоступлениюОтгрзуке(СтруктурнаяЕдиница) Тогда
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия, Ячейка");
	Иначе
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия");
	КонецЕсли;
	
	Пока ВыборкаЗапасы.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(ВыборкаЗапасы.Количество) Тогда
			Продолжить;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиЗапасы, ВыборкаЗапасы);
		НайденныеОстаткиЗапасы = ТаблицаОстаткиЗапасы.НайтиСтроки(ПараметрыПоискаОстаткиЗапасы);
		
		Если Не НайденныеОстаткиЗапасы.Количество() Или (НайденныеОстаткиЗапасы.Количество() И НайденныеОстаткиЗапасы[0].Количество = 0) Тогда
			Продолжить
		КонецЕсли;
		
		ОстатокЗапасов = НайденныеОстаткиЗапасы[0];
		
		НоваяСтрокаЗапасы = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаЗапасы, ВыборкаЗапасы);
		
		Если ТипЗнч(НоваяСтрокаЗапасы.ЕдиницаИзмерения) = ТИП("СправочникСсылка.КлассификаторЕдиницИзмерения") Тогда
			
			Если НоваяСтрокаЗапасы.Количество >= ОстатокЗапасов.Количество Тогда
				НоваяСтрокаЗапасы.Количество = ОстатокЗапасов.Количество;
				ОстатокЗапасов.Количество = 0;
			Иначе
				ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - НоваяСтрокаЗапасы.Количество;
			КонецЕсли;
			
		Иначе
			
			КоличествоСтрокиВЕдиницахХранения = НоваяСтрокаЗапасы.Количество * НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			Если КоличествоСтрокиВЕдиницахХранения >= ОстатокЗапасов.Количество Тогда
				КоличествоСтрокиВЕдиницахХранения = ОстатокЗапасов.Количество;
				ОстатокЗапасов.Количество = 0;
			Иначе
				ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоСтрокиВЕдиницахХранения;
			КонецЕсли;
			
			НоваяСтрокаЗапасы.Количество = КоличествоСтрокиВЕдиницахХранения/ НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			
		КонецЕсли;
	
	КонецЦикла;
	
КонецПроцедуры

// Обработчик заполнения на основании документа ПередачаТоваровМеждуОрганизациями.
//
// Параметры:
//  ДокументСсылка - ДокументСсылка.ПередачаТоваровМеждуОрганизациями.
//
Процедура ЗаполнитьПоПередачаТоваровМеждуОрганизациями(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"ОрганизацияПолучатель, СтруктурнаяЕдиница, Ячейка, ПоложениеСклада");
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		
		СтруктураПроверки = ЕстьОрдерныйСкладВТабЧасти(ДокументСсылка.Запасы, Истина);
		
		ЕстьОрдерныйСклад = СтруктураПроверки.ЕстьОрдерныйСклад;
		
		Если ЕстьОрдерныйСклад Тогда
			СтруктурнаяЕдиница = СтруктураПроверки.СтруктурнаяЕдиница;
		КонецЕсли;
		
		Если НЕ ЕстьОрдерныйСклад Тогда
			ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
			|Документ ""%1"" не использует ордерную схему при поступлении'"), ДокументСсылка);
			
			ВызватьИсключениеВводНаОсновании(ДокументСсылка, ТекстИсключения);
		КонецЕсли;
	Иначе
		ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	КонецЕсли;
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Организация = ЗначенияРеквизитов.ОрганизацияПолучатель;
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	ПоложениеЯчейки = ДокументСсылка.ПоложениеСклада;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоПередачаТоваровМеждуОрганизациямиВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура КАК Номенклатура,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика КАК Характеристика,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Партия КАК Партия,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Количество КАК Количество,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.Запасы КАК ПередачаТоваровМеждуОрганизациямиЗапасы
	|ГДЕ
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Ссылка = &ДокументОснование
	|	И ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|	И ПередачаТоваровМеждуОрганизациямиЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура КАК Номенклатура,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика КАК Характеристика,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Партия КАК Партия,
	|	ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Серия КАК Серия,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.Запасы КАК ПередачаТоваровМеждуОрганизациямиЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями.СерииНоменклатуры КАК ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры
	|		ПО ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи = ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Ссылка = &ДокументОснование
	|	И ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Ссылка = &ДокументОснование
	|	И ПередачаТоваровМеждуОрганизациямиЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);
	
КонецПроцедуры

// Обработчик заполнения на основании документа ОприходованиеЗапасов.
//
// Параметры:
//  ДокументСсылкаОприходованиеЗапасов	 - ДокументСсылка.ОприходованиеЗапасов.
//
Процедура ЗаполнитьПоОприходованиеЗапасов(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"Организация, СтруктурнаяЕдиница, Ячейка");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	ПоложениеЯчейки = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоОприходованиеЗапасовВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ОприходованиеЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	ОприходованиеЗапасовЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ОприходованиеЗапасовЗапасы.Характеристика КАК Характеристика,
	|	ОприходованиеЗапасовЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ОприходованиеЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	ОприходованиеЗапасовЗапасы.Партия КАК Партия,
	|	ОприходованиеЗапасовЗапасы.Количество КАК Количество,
	|	ОприходованиеЗапасовЗапасы.Ссылка.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ОприходованиеЗапасовЗапасы.Ссылка.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ИЗ
	|	Документ.ОприходованиеЗапасов.Запасы КАК ОприходованиеЗапасовЗапасы
	|ГДЕ
	|	ОприходованиеЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И ОприходованиеЗапасовЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОприходованиеЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	ОприходованиеЗапасовЗапасы.Характеристика КАК Характеристика,
	|	ОприходованиеЗапасовЗапасы.Партия КАК Партия,
	|	ОприходованиеЗапасовСерииНоменклатуры.Серия КАК Серия,
	|	ОприходованиеЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	ОприходованиеЗапасовСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	Документ.ОприходованиеЗапасов.Запасы КАК ОприходованиеЗапасовЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОприходованиеЗапасов.СерииНоменклатуры КАК ОприходованиеЗапасовСерииНоменклатуры
	|		ПО ОприходованиеЗапасовЗапасы.КлючСвязи = ОприходованиеЗапасовСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	ОприходованиеЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И ОприходованиеЗапасовСерииНоменклатуры.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);
	
КонецПроцедуры // ЗаполнитьПоОприходованиеЗапасов()

// Обработчик заполнения на основании документа ОприходованиеЗапасов.
//
// Параметры:
//  ДокументСсылкаПересортицаЗапасов	 - ДокументСсылка.ПересортицаЗапасов.
//
Процедура ЗаполнитьПоПересортицаЗапасов(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"Организация, СтруктурнаяЕдиница, Ячейка");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	ПоложениеЯчейки = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоПересортицаЗапасовВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПересортицаЗапасовЗапасы.НоменклатураОприходование КАК Номенклатура,
	|	ПересортицаЗапасовЗапасы.ЕдиницаИзмеренияОприходование КАК ЕдиницаИзмерения,
	|	ПересортицаЗапасовЗапасы.ХарактеристикаОприходование КАК Характеристика,
	|	ПересортицаЗапасовЗапасы.СерииНоменклатурыОприходование КАК СерииНоменклатуры,
	|	ПересортицаЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПересортицаЗапасовЗапасы.ПартияОприходование КАК Партия,
	|	ПересортицаЗапасовЗапасы.Количество КАК Количество,
	|	ПересортицаЗапасовЗапасы.Ссылка.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ПересортицаЗапасовЗапасы.Ссылка.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ИЗ
	|	Документ.ПересортицаЗапасов.Запасы КАК ПересортицаЗапасовЗапасы
	|ГДЕ
	|	ПересортицаЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И ПересортицаЗапасовЗапасы.НоменклатураОприходование.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПересортицаЗапасовЗапасы.НоменклатураОприходование КАК Номенклатура,
	|	ПересортицаЗапасовЗапасы.ХарактеристикаОприходование КАК Характеристика,
	|	ПересортицаЗапасовЗапасы.ПартияОприходование КАК Партия,
	|	ПересортицаЗапасовСерииНоменклатурыОприходование.Серия КАК Серия,
	|	ПересортицаЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПересортицаЗапасовСерииНоменклатурыОприходование.Количество КАК Количество
	|ИЗ
	|	Документ.ПересортицаЗапасов.Запасы КАК ПересортицаЗапасовЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПересортицаЗапасов.СерииНоменклатурыОприходование КАК ПересортицаЗапасовСерииНоменклатурыОприходование
	|		ПО ПересортицаЗапасовЗапасы.КлючСвязи = ПересортицаЗапасовСерииНоменклатурыОприходование.КлючСвязи
	|ГДЕ
	|	ПересортицаЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И ПересортицаЗапасовСерииНоменклатурыОприходование.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);
	
КонецПроцедуры // ЗаполнитьПоПересортицаЗапасов()

// Обработчик заполнения на основании документа ПеремещениеЗапасов
//
// Параметры:
//  ДокументСсылкаПеремещениеЗапасов - ДокументСсылка.ПеремещениеЗапасов.
//
Процедура ЗаполнитьПоПеремещениеЗапасов(ДокументСсылка) Экспорт
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"Организация, СтруктурнаяЕдиницаПолучатель, ЯчейкаПолучатель, ПоложениеЯчейкиПолучателя");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиницаПолучатель;
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	ПоложениеЯчейки = ЗначенияРеквизитов.ПоложениеЯчейкиПолучателя;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоПеремещениеЗапасовВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПеремещениеЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	ПеремещениеЗапасовЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ПеремещениеЗапасовЗапасы.Характеристика КАК Характеристика,
	|	ПеремещениеЗапасовЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ПеремещениеЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПеремещениеЗапасовЗапасы.Партия КАК Партия,
	|	ПеремещениеЗапасовЗапасы.Количество КАК Количество,
	|	ПеремещениеЗапасовЗапасы.Ссылка.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ПеремещениеЗапасовЗапасы.ЯчейкаПолучатель КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ИЗ
	|	Документ.ПеремещениеЗапасов.Запасы КАК ПеремещениеЗапасовЗапасы
	|ГДЕ
	|	ПеремещениеЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И ПеремещениеЗапасовЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПеремещениеЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	ПеремещениеЗапасовЗапасы.Характеристика КАК Характеристика,
	|	ПеремещениеЗапасовЗапасы.Партия КАК Партия,
	|	ПеремещениеЗапасовСерииНоменклатуры.Серия КАК Серия,
	|	ПеремещениеЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПеремещениеЗапасовСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	Документ.ПеремещениеЗапасов.Запасы КАК ПеремещениеЗапасовЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеЗапасов.СерииНоменклатуры КАК ПеремещениеЗапасовСерииНоменклатуры
	|		ПО ПеремещениеЗапасовЗапасы.КлючСвязи = ПеремещениеЗапасовСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	ПеремещениеЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И ПеремещениеЗапасовСерииНоменклатуры.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);
	
КонецПроцедуры // ЗаполнитьПоПеремещениеЗапасов()

// Обработчик заполнения на основании документа ОтчетПереработчика.
//
// Параметры:
//  ДокументСсылкаОтчетПереработчика - ДокументСсылка.ОтчетПереработчика.
//
Процедура ЗаполнитьПоОтчетПереработчика(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"Организация, СтруктурнаяЕдиница, Ячейка, Контрагент");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	ПоложениеЯчейки = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке;
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоОтчетПереработчикаВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ОтчетПереработчикаПродукция.Номенклатура КАК Номенклатура,
	|	ОтчетПереработчикаПродукция.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ОтчетПереработчикаПродукция.Характеристика КАК Характеристика,
	|	ОтчетПереработчикаПродукция.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ОтчетПереработчикаПродукция.КлючСвязи КАК КлючСвязи,
	|	ОтчетПереработчикаПродукция.Партия КАК Партия,
	|	ОтчетПереработчикаПродукция.Количество КАК Количество,
	|	ОтчетПереработчикаПродукция.Ссылка.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ОтчетПереработчикаПродукция.Ссылка.Ячейка КАК Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления
	|ПОМЕСТИТЬ ВТЗапасы
	|ИЗ
	|	Документ.ОтчетПереработчика.Продукция КАК ОтчетПереработчикаПродукция
	|ГДЕ
	|	ОтчетПереработчикаПродукция.Ссылка = &ДокументОснование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОтчетПереработчикаОтходы.Номенклатура,
	|	ОтчетПереработчикаОтходы.ЕдиницаИзмерения,
	|	ОтчетПереработчикаОтходы.Характеристика,
	|	НЕОПРЕДЕЛЕНО,
	|	0,
	|	ОтчетПереработчикаОтходы.Партия,
	|	ОтчетПереработчикаОтходы.Количество,
	|	ОтчетПереработчикаОтходы.Ссылка.СтруктурнаяЕдиница,
	|	ОтчетПереработчикаОтходы.Ссылка.Ячейка,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ
	|ИЗ
	|	Документ.ОтчетПереработчика.Отходы КАК ОтчетПереработчикаОтходы
	|ГДЕ
	|	ОтчетПереработчикаОтходы.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТЗапасы.Номенклатура КАК Номенклатура,
	|	ВТЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВТЗапасы.Характеристика КАК Характеристика,
	|	ВТЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ВТЗапасы.КлючСвязи КАК КлючСвязи,
	|	ВТЗапасы.Партия КАК Партия,
	|	СУММА(ВТЗапасы.Количество) КАК Количество,
	|	ВТЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВТЗапасы.Ячейка КАК Ячейка,
	|	ВТЗапасы.ДокументПоступления КАК ДокументПоступления
	|ИЗ
	|	ВТЗапасы КАК ВТЗапасы
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТЗапасы.СерииНоменклатуры,
	|	ВТЗапасы.Номенклатура,
	|	ВТЗапасы.Ячейка,
	|	ВТЗапасы.ДокументПоступления,
	|	ВТЗапасы.ЕдиницаИзмерения,
	|	ВТЗапасы.Партия,
	|	ВТЗапасы.Характеристика,
	|	ВТЗапасы.СтруктурнаяЕдиница,
	|	ВТЗапасы.КлючСвязи
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВТЗапасы.Номенклатура КАК Номенклатура,
	|	ВТЗапасы.Характеристика КАК Характеристика,
	|	ВТЗапасы.Партия КАК Партия,
	|	ОтчетПереработчикаСерииНоменклатуры.Серия КАК Серия,
	|	ВТЗапасы.КлючСвязи КАК КлючСвязи,
	|	ОтчетПереработчикаСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	ВТЗапасы КАК ВТЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОтчетПереработчика.СерииНоменклатуры КАК ОтчетПереработчикаСерииНоменклатуры
	|		ПО ВТЗапасы.КлючСвязи = ОтчетПереработчикаСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	ОтчетПереработчикаСерииНоменклатуры.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	Если РезультатыЗапроса[3].Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаСерииНоменклатуры = РезультатыЗапроса[4].Выгрузить();
	ТаблицаОстаткиСерииНоменклатуры = РезультатыЗапроса[6].Выгрузить();
	ТаблицаОстаткиЗапасы = РезультатыЗапроса[3].Выгрузить();
	
	ВыборкаЗапасы = РезультатыЗапроса[1].Выбрать();
	
	ПараметрыПоискаСерии = Новый Структура("КлючСвязи");
	
	Если СкладскойУчетСервер.КонтролироватьОстаткиПоЯчейкамКПоступлениюОтгрзуке(СтруктурнаяЕдиница) Тогда
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия, Ячейка");
	Иначе
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия");
	КонецЕсли;
	
	ПараметрыПоискаОстаткиСерииНоменклатуры = Новый Структура("Номенклатура, Характеристика, Партия, Серия");
	
	КоличествоВСтрокеЗапасов = 0;
	Пока ВыборкаЗапасы.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(ВыборкаЗапасы.Количество) Тогда
			Продолжить;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиЗапасы, ВыборкаЗапасы);
		НайденныеОстаткиЗапасы = ТаблицаОстаткиЗапасы.НайтиСтроки(ПараметрыПоискаОстаткиЗапасы);
		
		Если Не НайденныеОстаткиЗапасы.Количество() Или (НайденныеОстаткиЗапасы.Количество() И НайденныеОстаткиЗапасы[0].Количество = 0) Тогда
			Продолжить
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ПараметрыПоискаСерии, ВыборкаЗапасы);
		НайденныеСерии = ТаблицаСерииНоменклатуры.НайтиСтроки(ПараметрыПоискаСерии);
		
		КоличествоСерий = 0;
		ИспользуютсяСерииВСтроке = Ложь;
		Для Каждого СтрокаСерии Из НайденныеСерии Цикл
			
			ИспользуютсяСерииВСтроке = Истина;
			
			ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиСерииНоменклатуры, СтрокаСерии);
			НайденныеОстаткиСерий = ТаблицаОстаткиСерииНоменклатуры.НайтиСтроки(ПараметрыПоискаОстаткиСерииНоменклатуры);
			
			Если Не НайденныеОстаткиСерий.Количество() Или (НайденныеОстаткиСерий.Количество() И НайденныеОстаткиСерий[0].Количество = 0) Тогда
				Продолжить
			КонецЕсли;
			
			ОстатокСерий = НайденныеОстаткиСерий[0];
			
			Если Не ОстатокСерий.Количество > 0 Тогда
				Продолжить;
			КонецЕсли;
			
			НоваяСтрокаСерии = СерииНоменклатуры.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаСерии, СтрокаСерии); 
			
			Если НоваяСтрокаСерии.Количество >= ОстатокСерий.Количество Тогда
				НоваяСтрокаСерии.Количество = ОстатокСерий.Количество;
			КонецЕсли;
			
			ОстатокСерий.Количество = ОстатокСерий.Количество - НоваяСтрокаСерии.Количество;
			
			КоличествоСерий = КоличествоСерий + НоваяСтрокаСерии.Количество;
			
		КонецЦикла;
		
		Если ИспользуютсяСерииВСтроке И КоличествоСерий = 0 Тогда
			Продолжить
		КонецЕсли;
		
		ОстатокЗапасов = НайденныеОстаткиЗапасы[0];
		
		НоваяСтрокаЗапасы = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаЗапасы, ВыборкаЗапасы);
		
		Если ТипЗнч(НоваяСтрокаЗапасы.ЕдиницаИзмерения) = ТИП("СправочникСсылка.КлассификаторЕдиницИзмерения") Тогда
			
			КоличествоВСтрокеЗапасов = ?(КоличествоСерий > 0, КоличествоСерий, НоваяСтрокаЗапасы.Количество);
			
			Если КоличествоВСтрокеЗапасов >= ОстатокЗапасов.Количество Тогда
				КоличествоВСтрокеЗапасов = ОстатокЗапасов.Количество;
				ОстатокЗапасов.Количество = 0;
			Иначе
				ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоВСтрокеЗапасов;
			КонецЕсли;
			
			НоваяСтрокаЗапасы.Количество = КоличествоВСтрокеЗапасов;
			
		Иначе
			
			КоличествоСтрокиВЕдиницахХранения = НоваяСтрокаЗапасы.Количество * НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			КоличествоВСтрокеЗапасов = ?(КоличествоСерий > 0, КоличествоСерий, КоличествоСтрокиВЕдиницахХранения);
			
			Если КоличествоВСтрокеЗапасов >= ОстатокЗапасов.Количество Тогда
				КоличествоВСтрокеЗапасов = ОстатокЗапасов.Количество;
				ОстатокЗапасов.Количество = 0;
			Иначе
				ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоВСтрокеЗапасов;
			КонецЕсли;
			
			НоваяСтрокаЗапасы.Количество = КоличествоВСтрокеЗапасов/ НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;;
			
		КонецЕсли;
		
		Если СерииНоменклатурыУНФ.ИспользоватьСерииНоменклатурыОстатки() = Истина Тогда
			НоваяСтрокаЗапасы.СерииНоменклатуры = СерииНоменклатурыУНФ.ПредставлениеСерийНоменклатуры(СерииНоменклатуры, НоваяСтрокаЗапасы.КлючСвязи)
		КонецЕсли;
			
	КонецЦикла;
	
КонецПроцедуры // ЗаполнитьПоОтчетПереработчика()

// Обработчик заполнения на основании документа ЗаказПоставщику.
//
// Параметры:
//  ДокументСсылкаЗаказПоставщику	 - ДокументСсылка.ЗаказПоставщику.
//
Процедура ЗаполнитьПоЗаказПоставщику(ДокументСсылкаЗаказПоставщику) Экспорт
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылкаЗаказПоставщику;
	Организация = ДокументСсылкаЗаказПоставщику.Организация;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	МИНИМУМ(ЗаказПоставщикуЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ЗаказПоставщикуЗапасы.Номенклатура КАК Номенклатура,
	|	ЗаказПоставщикуЗапасы.Характеристика КАК Характеристика,
	|	ЗаказПоставщикуЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЗаказПоставщикуЗапасы.Количество) КАК Количество
	|ИЗ
	|	Документ.ЗаказПоставщику.Запасы КАК ЗаказПоставщикуЗапасы
	|ГДЕ
	|	ЗаказПоставщикуЗапасы.Ссылка = &ДокументОснование
	|	И (ЗаказПоставщикуЗапасы.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас)
	|			ИЛИ ЗаказПоставщикуЗапасы.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗаказПоставщикуЗапасы.Номенклатура,
	|	ЗаказПоставщикуЗапасы.Характеристика,
	|	ЗаказПоставщикуЗапасы.ЕдиницаИзмерения
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаЗаказПоставщику);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;
	
КонецПроцедуры // ЗаполнитьПоЗаказПоставщику()

// Обработчик заполнения на основании документа СборкаЗапасов.
//
// Параметры:
//  ДокументСсылкаСборкаЗапасов	 - ДокументСсылка.СборкаЗапасов.
//
Процедура ЗаполнитьПоСборкаЗапасов(ДокументСсылкаСборкаЗапасов) Экспорт  
	
	ИменаРеквизитов = Новый Массив;
	ИменаРеквизитов.Добавить("Организация");
	ИменаРеквизитов.Добавить("ВидОперации");
	ИменаРеквизитов.Добавить("СтруктурнаяЕдиница");
	ИменаРеквизитов.Добавить("Ячейка");
	ИменаРеквизитов.Добавить("СтруктурнаяЕдиницаПродукции");
	ИменаРеквизитов.Добавить("ЯчейкаПродукции");
	ИменаРеквизитов.Добавить("СтруктурнаяЕдиницаОтходов");
	ИменаРеквизитов.Добавить("ЯчейкаОтходов");
	ИменаРеквизитов.Добавить("ПоложениеСклада");
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаСборкаЗапасов, ИменаРеквизитов);
	
	Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		
		СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиницаПродукции;
		Ячейка = ЗначенияРеквизитов.ЯчейкаПродукции;
						
	Иначе
		
		Если ЗначенияРеквизитов.СтруктурнаяЕдиница.ОрдерныйСклад Тогда
			
			СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиница;
			Ячейка = ЗначенияРеквизитов.Ячейка;
			
		Иначе
			
			Если ЗначенияРеквизитов.СтруктурнаяЕдиницаПродукции.ОрдерныйСклад Тогда
				
				СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиницаПродукции;
				Ячейка = ЗначенияРеквизитов.ЯчейкаПродукции;
								
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоСборкаЗапасовВидУчетаНеИспользуется(ДокументСсылкаСборкаЗапасов);
		Возврат;
	КонецЕсли;
	
	МассивТЧОрдер = Новый Массив;
	
	ЗаполнитьШапкуПоСборкаЗапасов(ДокументСсылкаСборкаЗапасов, ЗначенияРеквизитов, МассивТЧОрдер);
	
	ЗаполнитьТабличнуюЧастьПоСборкаЗапасов(ДокументСсылкаСборкаЗапасов, ЗначенияРеквизитов, МассивТЧОрдер);
	
КонецПроцедуры

// Обработчик заполнения на основании документа КомплектацияЗапасов.
//
// Параметры:
//  ДокументСсылкаКомплектацияЗапасов	 - ДокументСсылка.КомплектацияЗапасов.
//
Процедура ЗаполнитьПоКомплектацияЗапасов(ДокументСсылка) Экспорт 
	
	// Заполнение шапки.
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
			"Организация, ВидОперации, СтруктурнаяЕдиница, СтруктурнаяЕдиница.ОрдерныйСклад, СтруктурнаяЕдиница.ИспользоватьОрдернуюСхемуПриПоступлении, Ячейка");
		
	Если НЕ ЗначенияРеквизитов.СтруктурнаяЕдиницаОрдерныйСклад И НЕ ЗначенияРеквизитов.СтруктурнаяЕдиницаИспользоватьОрдернуюСхемуПриПоступлении Тогда
		ТекстИсключения = НСтр("ru = 'Невозможен ввод операции ""Поступление на ордерный склад"".
                                |Документ ""%1"" не имеет ордерного склада.'");
		ТекстИсключения = СтрШаблон(ТекстИсключения, ДокументСсылка);
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	ДокументОснование = ДокументСсылка;
	Организация = ЗначенияРеквизитов.Организация;
	СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиница;
	Ячейка = ЗначенияРеквизитов.Ячейка;
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	
	ПоложениеЯчейки = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке;
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
		ЗаполнитьПоКомплектацияЗапасовВидУчетаНеИспользуется(ДокументСсылка);
		Возврат;
	КонецЕсли;
		
		// Заполнение табличной части.
		Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	КомплектацияЗапасовЗапасы.Номенклатура КАК Номенклатура,
		|	КомплектацияЗапасовЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	КомплектацияЗапасовЗапасы.Характеристика КАК Характеристика,
		|	КомплектацияЗапасовЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
		|	КомплектацияЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
		|	КомплектацияЗапасовЗапасы.Партия КАК Партия,
		|	КомплектацияЗапасовЗапасы.Количество КАК Количество,
		|	КомплектацияЗапасовЗапасы.Ссылка.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|	КомплектацияЗапасовЗапасы.Ссылка.Ячейка КАК Ячейка,
		|	ВЫБОР
		|		КОГДА &КонтролироватьОстаткиПоДокументам
		|			ТОГДА &ДокументОснование
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ДокументПоступления
		|ИЗ
		|	Документ.КомплектацияЗапасов.Запасы КАК КомплектацияЗапасовЗапасы
		|ГДЕ
		|	КомплектацияЗапасовЗапасы.Ссылка = &ДокументОснование
		|	И КомплектацияЗапасовЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
		|	И КомплектацияЗапасовЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияЗапасов.Разборка)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	КомплектацияЗапасов.Номенклатура,
		|	КомплектацияЗапасов.ЕдиницаИзмерения,
		|	КомплектацияЗапасов.Характеристика,
		|	НЕОПРЕДЕЛЕНО,
		|	1,
		|	КомплектацияЗапасов.Партия,
		|	КомплектацияЗапасов.Количество,
		|	КомплектацияЗапасов.СтруктурнаяЕдиница,
		|	КомплектацияЗапасов.Ячейка,
		|	ВЫБОР
		|		КОГДА &КонтролироватьОстаткиПоДокументам
		|			ТОГДА &ДокументОснование
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ
		|ИЗ
		|	Документ.КомплектацияЗапасов КАК КомплектацияЗапасов
		|ГДЕ
		|	КомплектацияЗапасов.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияЗапасов.Сборка)
		|	И КомплектацияЗапасов.Ссылка = &ДокументОснование
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
		|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
		|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
		|	ВЫБОР
		|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
		|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
		|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
		|	КОНЕЦ КАК Количество,
		|	ВЫБОР
		|		КОГДА &КонтролироватьОстаткиПоДокументам
		|			ТОГДА &ДокументОснование
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ДокументПоступления,
		|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
		|ПОМЕСТИТЬ ЗапасыОстаткиИтог
		|ИЗ
		|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
		|			,
		|			Организация = &Организация
		|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗапасыКПоступлениюНаСклады.Номенклатура,
		|	ЗапасыКПоступлениюНаСклады.Характеристика,
		|	ЗапасыКПоступлениюНаСклады.Партия,
		|	ВЫБОР
		|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
		|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
		|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА &КонтролироватьОстаткиПоДокументам
		|			ТОГДА &ДокументОснование
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ,
		|	ЗапасыКПоступлениюНаСклады.Ячейка
		|ИЗ
		|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
		|ГДЕ
		|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
		|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
		|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
		|	ЗапасыОстаткиИтог.Партия КАК Партия,
		|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
		|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
		|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
		|ИЗ
		|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗапасыОстаткиИтог.Номенклатура,
		|	ЗапасыОстаткиИтог.Ячейка,
		|	ЗапасыОстаткиИтог.Характеристика,
		|	ЗапасыОстаткиИтог.Партия,
		|	ЗапасыОстаткиИтог.ДокументПоступления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	КомплектацияЗапасовЗапасы.Номенклатура КАК Номенклатура,
		|	КомплектацияЗапасовЗапасы.Характеристика КАК Характеристика,
		|	КомплектацияЗапасовЗапасы.Партия КАК Партия,
		|	КомплектацияЗапасовСерииНоменклатурыЗапасы.Серия КАК Серия,
		|	КомплектацияЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
		|	КомплектацияЗапасовСерииНоменклатурыЗапасы.Количество КАК Количество
		|ИЗ
		|	Документ.КомплектацияЗапасов.Запасы КАК КомплектацияЗапасовЗапасы
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КомплектацияЗапасов.СерииНоменклатурыЗапасы КАК КомплектацияЗапасовСерииНоменклатурыЗапасы
		|		ПО КомплектацияЗапасовЗапасы.КлючСвязи = КомплектацияЗапасовСерииНоменклатурыЗапасы.КлючСвязи
		|ГДЕ
		|	КомплектацияЗапасовЗапасы.Ссылка = &ДокументОснование
		|	И КомплектацияЗапасовСерииНоменклатурыЗапасы.Ссылка = &ДокументОснование
		|	И КомплектацияЗапасовЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияЗапасов.Разборка)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	КомплектацияЗапасов.Номенклатура,
		|	КомплектацияЗапасов.Характеристика,
		|	КомплектацияЗапасов.Партия,
		|	КомплектацияЗапасовСерииНоменклатуры.Серия,
		|	1,
		|	КомплектацияЗапасовСерииНоменклатуры.Количество
		|ИЗ
		|	Документ.КомплектацияЗапасов КАК КомплектацияЗапасов
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КомплектацияЗапасов.СерииНоменклатуры КАК КомплектацияЗапасовСерииНоменклатуры
		|		ПО (0 = КомплектацияЗапасовСерииНоменклатуры.КлючСвязи)
		|ГДЕ
		|	КомплектацияЗапасов.Ссылка = &ДокументОснование
		|	И КомплектацияЗапасовСерииНоменклатуры.Ссылка = &ДокументОснование
		|	И КомплектацияЗапасов.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийКомплектацияЗапасов.Сборка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
		|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
		|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
		|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
		|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
		|ПОМЕСТИТЬ ОстаткиСерииИтог
		|ИЗ
		|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
		|			,
		|			Организация = &Организация
		|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
		|ГДЕ
		|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	СерииНоменклатурыКПоступлению.Серия,
		|	СерииНоменклатурыКПоступлению.Количество,
		|	СерииНоменклатурыКПоступлению.Номенклатура,
		|	СерииНоменклатурыКПоступлению.Характеристика,
		|	СерииНоменклатурыКПоступлению.Партия
		|ИЗ
		|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
		|ГДЕ
		|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
		|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОстаткиСерииИтог.Серия КАК Серия,
		|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
		|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
		|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
		|	ОстаткиСерииИтог.Партия КАК Партия
		|ИЗ
		|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
		|
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиСерииИтог.Партия,
		|	ОстаткиСерииИтог.Характеристика,
		|	ОстаткиСерииИтог.Номенклатура,
		|	ОстаткиСерииИтог.Серия");
		
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
		Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
		
		КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
		
		Запрос.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
		Запрос.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено));
		
		ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылка, Неопределено);
		
		РезультатыЗапроса = Запрос.ВыполнитьПакет();
		
		ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);
		
КонецПроцедуры // ЗаполнитьПоКомплектацияЗапасов()

// Версии заполнения без вида учета

Процедура ЗаполнитьПоПриходнаяНакладнаяВидУчетаНеИспользуется(ДокументСсылка) 
	
		// Заполнение шапки.
	ДокументСсылкаПриходнаяНакладная = ДокументСсылка;
	ДокументОснование = ДокументСсылкаПриходнаяНакладная;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаПриходнаяНакладная,
		"Организация, СтруктурнаяЕдиница, Ячейка, ПоложениеСклада");
	
	Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		
		ЕстьОрдерныйСклад = ЕстьОрдерныйСкладВТабЧасти(ДокументСсылкаПриходнаяНакладная.Запасы);
		
		Если НЕ ЕстьОрдерныйСклад Тогда
			ВызватьИсключениеВводНаОсновании(ДокументСсылкаПриходнаяНакладная);
		КонецЕсли;
	Иначе
		ПроверитьВозможностьВводаНаОсновании(ДокументСсылкаПриходнаяНакладная, ЗначенияРеквизитов);
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	// Заполнение табличной части.
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ПриходнаяНакладнаяЗапасы.Номенклатура КАК Номенклатура,
	|	ПриходнаяНакладнаяЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ПриходнаяНакладнаяЗапасы.Характеристика КАК Характеристика,
	|	ПриходнаяНакладнаяЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ПриходнаяНакладнаяЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПриходнаяНакладнаяЗапасы.Партия КАК Партия,
	|	ПриходнаяНакладнаяЗапасы.Количество КАК Количество,
	|	ПриходнаяНакладнаяЗапасы.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ПриходнаяНакладнаяЗапасы.Ячейка КАК Ячейка
	|ИЗ
	|	Документ.ПриходнаяНакладная.Запасы КАК ПриходнаяНакладнаяЗапасы
	|ГДЕ
	|	ПриходнаяНакладнаяЗапасы.Ссылка = &ДокументОснование
	|	И ПриходнаяНакладнаяЗапасы.Номенклатура.ТипНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|	И ВЫБОР
	|			КОГДА ПриходнаяНакладнаяЗапасы.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|				ТОГДА ПриходнаяНакладнаяЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.Ячейка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПриходнаяНакладнаяЗапасы.Номенклатура КАК Номенклатура,
	|	ПриходнаяНакладнаяЗапасы.Характеристика КАК Характеристика,
	|	ПриходнаяНакладнаяЗапасы.Партия КАК Партия,
	|	ПриходнаяНакладнаяСерииНоменклатуры.Серия КАК Серия,
	|	ПриходнаяНакладнаяЗапасы.КлючСвязи КАК КлючСвязи,
	|	ПриходнаяНакладнаяСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	Документ.ПриходнаяНакладная.Запасы КАК ПриходнаяНакладнаяЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПриходнаяНакладная.СерииНоменклатуры КАК ПриходнаяНакладнаяСерииНоменклатуры
	|		ПО ПриходнаяНакладнаяЗапасы.КлючСвязи = ПриходнаяНакладнаяСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	ПриходнаяНакладнаяЗапасы.Ссылка = &ДокументОснование
	|	И ПриходнаяНакладнаяСерииНоменклатуры.Ссылка = &ДокументОснование
	|	И ВЫБОР
	|			КОГДА ПриходнаяНакладнаяЗапасы.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|				ТОГДА ПриходнаяНакладнаяЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаПриходнаяНакладная);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница);
	
КонецПроцедуры

Процедура ЗаполнитьПоАвансовомуОтчетуВидУчетаНеИспользуется(ДокументСсылка) 
	
	Для Каждого СтрокаЗапасов Из ДокументСсылка.Запасы Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаЗапасов.Количество) Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяСтрокаЗапасы = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаЗапасы, СтрокаЗапасов);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьПоПередачаТоваровМеждуОрганизациямиВидУчетаНеИспользуется(ДокументСсылка) 
	
	// Заполнение шапки.
	ДокументОснование = ДокументСсылка;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка,
		"ОрганизацияПолучатель, СтруктурнаяЕдиница, Ячейка, ПоложениеСклада");
	
	Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		ЕстьОрдерныйСклад = ЕстьОрдерныйСкладВТабЧасти(ДокументСсылка.Запасы);
		Если НЕ ЕстьОрдерныйСклад Тогда
			ВызватьИсключениеВводНаОсновании(ДокументСсылка);
		КонецЕсли;
	Иначе
		ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов);
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	Организация = ЗначенияРеквизитов.ОрганизацияПолучатель;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	МИНИМУМ(ПередачаТоваровМеждуОрганизациямиЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура КАК Номенклатура,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика КАК Характеристика,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Партия КАК Партия,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.СерииНоменклатуры КАК СерииНоменклатуры,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи КАК КлючСвязи
	|ПОМЕСТИТЬ ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.Запасы КАК ПередачаТоваровМеждуОрганизациямиЗапасы
	|ГДЕ
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Ссылка = &ДокументОснование
	|	И ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура.ТипНоменклатуры В
	|	(ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Запас), ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.ПодарочныйСертификат))
	|	И ВЫБОР
	|		КОГДА
	|			ПередачаТоваровМеждуОрганизациямиЗапасы.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|			ТОГДА ПередачаТоваровМеждуОрганизациямиЗапасы.СтруктурнаяЕдиница.ОрдерныйСклад
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|СГРУППИРОВАТЬ ПО
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Партия,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.ЕдиницаИзмерения,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.СерииНоменклатуры,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.НомерСтроки,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура КАК Номенклатура,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.Партия,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.ЕдиницаИзмерения,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.СерииНоменклатуры,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество
	|ИЗ
	|	ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы КАК ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(, Организация = &Организация
	|		И СтруктурнаяЕдиница = &СтруктурнаяЕдиница) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|		ПО ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура = ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура
	|		И ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика = ЗапасыКПоступлениюНаСкладыОстатки.Характеристика
	|		И ВТ_ПередачаТоваровМеждуОрганизациямиЗапасы.Партия = ЗапасыКПоступлениюНаСкладыОстатки.Партия
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Номенклатура КАК Номенклатура,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Характеристика КАК Характеристика,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.Партия КАК Партия,
	|	ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Серия КАК Серия,
	|	ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи КАК КлючСвязи
	|ПОМЕСТИТЬ ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры
	|ИЗ
	|	Документ.ПередачаТоваровМеждуОрганизациями.СерииНоменклатуры КАК ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПередачаТоваровМеждуОрганизациями.Запасы КАК ПередачаТоваровМеждуОрганизациямиЗапасы
	|		ПО ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Ссылка = &ДокументОснование
	|		И ПередачаТоваровМеждуОрганизациямиЗапасы.Ссылка = &ДокументОснование
	|		И ПередачаТоваровМеждуОрганизациямиЗапасы.КлючСвязи = ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.КлючСвязи
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Серия,
	|	ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.КлючСвязи
	|ИЗ
	|	ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры КАК ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(, Организация = &Организация
	|		И СтруктурнаяЕдиница = &СтруктурнаяЕдиница) КАК СерииНоменклатурыКПоступлениюОстатки
	|		ПО ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Номенклатура = СерииНоменклатурыКПоступлениюОстатки.Номенклатура
	|		И
	|			ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Характеристика = СерииНоменклатурыКПоступлениюОстатки.Характеристика
	|		И ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Партия = СерииНоменклатурыКПоступлениюОстатки.Партия
	|		И ВТ_ПередачаТоваровМеждуОрганизациямиСерииНоменклатуры.Серия = СерииНоменклатурыКПоступлениюОстатки.Серия");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылка);
	Запрос.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();

	РезультатыЗапроса = Запрос.ВыполнитьПакет();

	Если РезультатыЗапроса[1].Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаСерииНоменклатуры = РезультатыЗапроса[3].Выгрузить();
	ТаблицаСерииНоменклатуры.Индексы.Добавить("КлючСвязи");
	
	ВыборкаЗапасы = РезультатыЗапроса[1].Выбрать();
	Пока ВыборкаЗапасы.Следующий() Цикл
		Если Не ЗначениеЗаполнено(ВыборкаЗапасы.Количество) Тогда
			Продолжить;
		КонецЕсли;
		НоваяСтрокаЗапасы = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаЗапасы, ВыборкаЗапасы);
		Если СерииНоменклатурыУНФ.ИспользоватьСерииНоменклатурыОстатки() = Истина Тогда
			НоваяСтрокаЗапасы.СерииНоменклатуры = СерииНоменклатурыУНФ.ПредставлениеСерийНоменклатуры(
				ТаблицаСерииНоменклатуры, НоваяСтрокаЗапасы.КлючСвязи)
		КонецЕсли;
	КонецЦикла;
	
	Если СерииНоменклатурыУНФ.ИспользоватьСерииНоменклатурыОстатки() = Истина Тогда
		СерииНоменклатуры.Загрузить(ТаблицаСерииНоменклатуры);
	Иначе
		СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьПоОприходованиеЗапасовВидУчетаНеИспользуется(ДокументСсылка) 
	
	// Заполнение шапки.
	ДокументСсылкаОприходованиеЗапасов = ДокументСсылка;
	ДокументОснование = ДокументСсылкаОприходованиеЗапасов;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаОприходованиеЗапасов,
		"Организация, СтруктурнаяЕдиница, Ячейка");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылкаОприходованиеЗапасов, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	МИНИМУМ(ОприходованиеЗапасовЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ОприходованиеЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	ОприходованиеЗапасовЗапасы.Характеристика КАК Характеристика,
	|	ОприходованиеЗапасовЗапасы.Партия КАК Партия,
	|	ОприходованиеЗапасовЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ОприходованиеЗапасовЗапасы.Количество) КАК Количество,
	|	ОприходованиеЗапасовЗапасы.СерииНоменклатуры,
	|	ОприходованиеЗапасовЗапасы.КлючСвязи
	|ИЗ
	|	Документ.ОприходованиеЗапасов.Запасы КАК ОприходованиеЗапасовЗапасы
	|ГДЕ
	|	ОприходованиеЗапасовЗапасы.Ссылка = &ДокументОснование
	|
	|СГРУППИРОВАТЬ ПО
	|	ОприходованиеЗапасовЗапасы.Номенклатура,
	|	ОприходованиеЗапасовЗапасы.Характеристика,
	|	ОприходованиеЗапасовЗапасы.Партия,
	|	ОприходованиеЗапасовЗапасы.ЕдиницаИзмерения,
	|	ОприходованиеЗапасовЗапасы.СерииНоменклатуры,
	|	ОприходованиеЗапасовЗапасы.КлючСвязи
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаОприходованиеЗапасов);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;
	
	СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылкаОприходованиеЗапасов);
	
КонецПроцедуры

Процедура ЗаполнитьПоПересортицаЗапасовВидУчетаНеИспользуется(ДокументСсылка) 
	
	// Заполнение шапки.
	ДокументСсылкаПересортицаЗапасов = ДокументСсылка;
	ДокументОснование = ДокументСсылкаПересортицаЗапасов;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаПересортицаЗапасов,
		"Организация, СтруктурнаяЕдиница, Ячейка");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылкаПересортицаЗапасов, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	МИНИМУМ(ПересортицаЗапасовЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ПересортицаЗапасовЗапасы.НоменклатураОприходование КАК Номенклатура,
	|	ПересортицаЗапасовЗапасы.ХарактеристикаОприходование КАК Характеристика,
	|	ПересортицаЗапасовЗапасы.ПартияОприходование КАК Партия,
	|	ПересортицаЗапасовЗапасы.ЕдиницаИзмеренияОприходование КАК ЕдиницаИзмерения,
	|	СУММА(ПересортицаЗапасовЗапасы.Количество) КАК Количество,
	|	ПересортицаЗапасовЗапасы.СерииНоменклатурыОприходование КАК СерииНоменклатуры,
	|	ПересортицаЗапасовЗапасы.КлючСвязи
	|ИЗ
	|	Документ.ПересортицаЗапасов.Запасы КАК ПересортицаЗапасовЗапасы
	|ГДЕ
	|	ПересортицаЗапасовЗапасы.Ссылка = &ДокументОснование
	|
	|СГРУППИРОВАТЬ ПО
	|	ПересортицаЗапасовЗапасы.НоменклатураОприходование,
	|	ПересортицаЗапасовЗапасы.ХарактеристикаОприходование,
	|	ПересортицаЗапасовЗапасы.ПартияОприходование,
	|	ПересортицаЗапасовЗапасы.ЕдиницаИзмеренияОприходование,
	|	ПересортицаЗапасовЗапасы.СерииНоменклатурыОприходование,
	|	ПересортицаЗапасовЗапасы.КлючСвязи
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаПересортицаЗапасов);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;
	
	СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылкаПересортицаЗапасов, , "СерииНоменклатурыОприходование");
	
КонецПроцедуры

Процедура ЗаполнитьПоПеремещениеЗапасовВидУчетаНеИспользуется(ДокументСсылка) 
	
	// Заполнение шапки.
	ДокументСсылкаПеремещениеЗапасов = ДокументСсылка;
	ДокументОснование = ДокументСсылкаПеремещениеЗапасов;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаПеремещениеЗапасов,
		"Организация, СтруктурнаяЕдиницаПолучатель, Ячейка");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылкаПеремещениеЗапасов, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиницаПолучатель;
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	МИНИМУМ(ПеремещениеЗапасовЗапасы.НомерСтроки) КАК НомерСтроки,
	|	ПеремещениеЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	ПеремещениеЗапасовЗапасы.Характеристика КАК Характеристика,
	|	ПеремещениеЗапасовЗапасы.Партия КАК Партия,
	|	ПеремещениеЗапасовЗапасы.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ПеремещениеЗапасовЗапасы.Количество) КАК Количество,
	|	ПеремещениеЗапасовЗапасы.СерииНоменклатуры,
	|	ПеремещениеЗапасовЗапасы.КлючСвязи
	|ИЗ
	|	Документ.ПеремещениеЗапасов.Запасы КАК ПеремещениеЗапасовЗапасы
	|ГДЕ
	|	ПеремещениеЗапасовЗапасы.Ссылка = &ДокументОснование
	|
	|СГРУППИРОВАТЬ ПО
	|	ПеремещениеЗапасовЗапасы.Номенклатура,
	|	ПеремещениеЗапасовЗапасы.Характеристика,
	|	ПеремещениеЗапасовЗапасы.Партия,
	|	ПеремещениеЗапасовЗапасы.ЕдиницаИзмерения,
	|	ПеремещениеЗапасовЗапасы.СерииНоменклатуры,
	|	ПеремещениеЗапасовЗапасы.КлючСвязи
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаПеремещениеЗапасов);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = Запасы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		КонецЦикла;
	КонецЕсли;
	
	СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылкаПеремещениеЗапасов);
	
КонецПроцедуры

Процедура ЗаполнитьПоОтчетПереработчикаВидУчетаНеИспользуется(ДокументСсылка) 
	
	// Заполнение шапки.
	ДокументСсылкаОтчетПереработчика = ДокументСсылка;
	ДокументОснование = ДокументСсылкаОтчетПереработчика;
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаОтчетПереработчика,
		"Организация, СтруктурнаяЕдиница, Ячейка");
	
	ПроверитьВозможностьВводаНаОсновании(ДокументСсылкаОтчетПереработчика, ЗначенияРеквизитов);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ЗначенияРеквизитов);
	
	// Заполнение табличной части.
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	МИНИМУМ(ОтчетПереработчика.НомерСтроки) КАК НомерСтроки,
	|	ОтчетПереработчика.Номенклатура КАК Номенклатура,
	|	ОтчетПереработчика.Характеристика КАК Характеристика,
	|	ОтчетПереработчика.Партия КАК Партия,
	|	ОтчетПереработчика.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ОтчетПереработчика.Количество) КАК Количество,
	|	ОтчетПереработчика.СерииНоменклатуры,
	|	ОтчетПереработчика.КлючСвязи
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОтчетПереработчикаПродукция.НомерСтроки КАК НомерСтроки,
	|		ОтчетПереработчикаПродукция.Номенклатура КАК Номенклатура,
	|		ОтчетПереработчикаПродукция.Характеристика КАК Характеристика,
	|		ОтчетПереработчикаПродукция.Партия КАК Партия,
	|		ОтчетПереработчикаПродукция.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		ОтчетПереработчикаПродукция.Количество КАК Количество,
	|		ОтчетПереработчикаПродукция.СерииНоменклатуры КАК СерииНоменклатуры,
	|		ОтчетПереработчикаПродукция.КлючСвязи КАК КлючСвязи
	|	ИЗ
	|		Документ.ОтчетПереработчика.Продукция КАК ОтчетПереработчикаПродукция
	|	ГДЕ
	|		ОтчетПереработчикаПродукция.Ссылка = &ДокументОснование
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ОтчетПереработчикаОтходы.НомерСтроки,
	|		ОтчетПереработчикаОтходы.Номенклатура,
	|		ОтчетПереработчикаОтходы.Характеристика,
	|		ОтчетПереработчикаОтходы.Партия,
	|		ОтчетПереработчикаОтходы.ЕдиницаИзмерения,
	|		ОтчетПереработчикаОтходы.Количество,
	|		NULL,
	|		NULL
	|	ИЗ
	|		Документ.ОтчетПереработчика.Отходы КАК ОтчетПереработчикаОтходы
	|	ГДЕ
	|		ОтчетПереработчикаОтходы.Ссылка = &ДокументОснование) КАК ОтчетПереработчика
	|
	|СГРУППИРОВАТЬ ПО
	|	ОтчетПереработчика.Номенклатура,
	|	ОтчетПереработчика.Характеристика,
	|	ОтчетПереработчика.Партия,
	|	ОтчетПереработчика.ЕдиницаИзмерения,
	|	ОтчетПереработчика.СерииНоменклатуры,
	|	ОтчетПереработчика.КлючСвязи
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаОтчетПереработчика);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = Запасы.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		КонецЦикла;
	КонецЕсли;
	
	СерииНоменклатуры.Загрузить(ДокументСсылкаОтчетПереработчика.СерииНоменклатуры.Выгрузить());
	
КонецПроцедуры

Процедура ЗаполнитьПоСборкаЗапасовВидУчетаНеИспользуется(ДокументСсылка) 
	
	ИменаРеквизитов = Новый Массив;
	ИменаРеквизитов.Добавить("Организация");
	ИменаРеквизитов.Добавить("ВидОперации");
	ИменаРеквизитов.Добавить("СтруктурнаяЕдиница");
	ИменаРеквизитов.Добавить("Ячейка");
	ИменаРеквизитов.Добавить("СтруктурнаяЕдиницаПродукции");
	ИменаРеквизитов.Добавить("ЯчейкаПродукции");
	ИменаРеквизитов.Добавить("СтруктурнаяЕдиницаОтходов");
	ИменаРеквизитов.Добавить("ЯчейкаОтходов");
	ИменаРеквизитов.Добавить("ПоложениеСклада");
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылка, ИменаРеквизитов);
	
	МассивТЧОрдер = Новый Массив;
	
	ЗаполнитьШапкуПоСборкаЗапасов(ДокументСсылка, ЗначенияРеквизитов, МассивТЧОрдер);
	
	ЗаполнитьТабличнуюЧастьПоСборкаЗапасовВидУчетаНеИспользуется(ДокументСсылка, ЗначенияРеквизитов, МассивТЧОрдер);
	
КонецПроцедуры

Процедура ЗаполнитьТабличнуюЧастьПоСборкаЗапасовВидУчетаНеИспользуется(ДокументСсылкаСборкаЗапасов, ЗначенияРеквизитов, МассивТЧОрдер) 
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	СборкаЗапасов.Продукция.(
	|		Номенклатура КАК Номенклатура,
	|		Характеристика КАК Характеристика,
	|		Партия КАК Партия,
	|		Количество КАК Количество,
	|		ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		СерииНоменклатуры КАК СерииНоменклатуры,
	|		СтруктурнаяЕдиница.ОрдерныйСклад КАК ОрдерныйСклад,
	|		КлючСвязи КАК КлючСвязи
	|	) КАК Продукция,
	|	СборкаЗапасов.Запасы.(
	|		Номенклатура КАК Номенклатура,
	|		Характеристика КАК Характеристика,
	|		Партия КАК Партия,
	|		Количество КАК Количество,
	|		ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		СерииНоменклатуры КАК СерииНоменклатуры,
	|		СтруктурнаяЕдиница.ОрдерныйСклад КАК ОрдерныйСклад,
	|		КлючСвязи КАК КлючСвязи
	|	) КАК Запасы,
	|	СборкаЗапасов.Отходы.(
	|		Номенклатура КАК Номенклатура,
	|		Характеристика КАК Характеристика,
	|		Партия КАК Партия,
	|		Количество КАК Количество,
	|		ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		ЛОЖЬ КАК ОрдерныйСклад
	|	) КАК Отходы
	|ИЗ
	|	Документ.СборкаЗапасов КАК СборкаЗапасов
	|ГДЕ
	|	СборкаЗапасов.Ссылка = &ДокументОснование");
	
	Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаСборкаЗапасов);
	
	Запасы.Очистить();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	Для каждого ИмяТабличнойЧасти Из МассивТЧОрдер Цикл
		Для каждого СтрокаТаблицы Из Выборка[ИмяТабличнойЧасти].Выгрузить() Цикл
			
			Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти
					И ИмяТабличнойЧасти <> "Отходы" Тогда
				Если СтрокаТаблицы.ОрдерныйСклад Тогда
					НоваяСтрока = Запасы.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы);
				КонецЕсли;
			Иначе
				НоваяСтрока = Запасы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы);
			КонецЕсли;
			
		КонецЦикла;
	КонецЦикла;
	
	Если ЗначенияРеквизитов.ВидОперации = Перечисления.ВидыОперацийСборкаЗапасов.Разборка Тогда
		СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылкаСборкаЗапасов);
	Иначе
		СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, ДокументСсылкаСборкаЗапасов,
			"Продукция", "СерииНоменклатурыПродукция");
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьПоКомплектацияЗапасовВидУчетаНеИспользуется(ДокументСсылка) 
	
	ДокументСсылкаКомплектацияЗапасов = ДокументСсылка;
	
	// Заполнение шапки.
	ЗначенияРеквизитов = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаКомплектацияЗапасов,
			"Организация, ВидОперации, СтруктурнаяЕдиница, СтруктурнаяЕдиница.ОрдерныйСклад, Ячейка");
		
	Если НЕ ЗначенияРеквизитов.СтруктурнаяЕдиницаОрдерныйСклад Тогда
		ТекстИсключения = НСтр("ru = 'Невозможен ввод операции ""Поступление на ордерный склад"".
		|Документ ""%1"" не имеет ордерного склада.'");
		ТекстИсключения = СтрШаблон(ТекстИсключения, ДокументСсылкаКомплектацияЗапасов);
		ВызватьИсключение ТекстИсключения;
	КонецЕсли;
	
	ДокументОснование = ДокументСсылкаКомплектацияЗапасов;
	Организация = ЗначенияРеквизитов.Организация;
	СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиница;
	Ячейка = ЗначенияРеквизитов.Ячейка;
	
	Если ЗначенияРеквизитов.ВидОперации = Перечисления.ВидыОперацийКомплектацияЗапасов.Разборка Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ТабличнаяЧасть.Номенклатура КАК Номенклатура,
		|	ТабличнаяЧасть.Характеристика КАК Характеристика,
		|	ТабличнаяЧасть.Партия КАК Партия,
		|	ТабличнаяЧасть.Количество КАК Количество,
		|	ТабличнаяЧасть.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
		|	ТабличнаяЧасть.СерииНоменклатуры КАК СерииНоменклатуры,
		|	ТабличнаяЧасть.КлючСвязи КАК КлючСвязи
		|ИЗ
		|	Документ.КомплектацияЗапасов.Запасы КАК ТабличнаяЧасть
		|ГДЕ
		|	ТабличнаяЧасть.Ссылка = &ДокументОснование";
		Запрос.УстановитьПараметр("ДокументОснование", ДокументСсылкаКомплектацияЗапасов);
		
		Запасы.Загрузить(Запрос.Выполнить().Выгрузить());
		СерииНоменклатурыУНФ.ЗаполнитьТЧСерииНоменклатурыПоКлючуСвязи(ЭтотОбъект, 
			ДокументСсылкаКомплектацияЗапасов, , "СерииНоменклатурыЗапасы");
		
	Иначе
		
		ЗначенияРеквизитовЗапасы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументСсылкаКомплектацияЗапасов,
				"Номенклатура, Характеристика, Партия, Количество, ЕдиницаИзмерения, СерииНоменклатурыПредставление");
		
		Запасы.Очистить();
		НоваяСтрока = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, ЗначенияРеквизитовЗапасы);
		НоваяСтрока.СерииНоменклатуры = ЗначенияРеквизитовЗапасы.СерииНоменклатурыПредставление;
		ТабличныеЧастиУНФКлиентСервер.ЗаполнитьКлючСвязи(Запасы, НоваяСтрока, "КлючСвязи");
		
		СерииНоменклатуры.Загрузить(ДокументСсылкаКомплектацияЗапасов.СерииНоменклатуры.Выгрузить());
		Для каждого СтрокаТЧ Из СерииНоменклатуры Цикл
			СтрокаТЧ.КлючСвязи = НоваяСтрока.КлючСвязи;
		КонецЦикла; 
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ОбработчикиСобытий

// Процедура - обработчик события ОбработкаЗаполнения.
//
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	СтратегияЗаполнения = Новый Соответствие;
	СтратегияЗаполнения[Тип("ДокументСсылка.РасходныйОрдер")] = "ЗаполнитьПоРасходныйОрдер";
	СтратегияЗаполнения[Тип("ДокументСсылка.ПриходнаяНакладная")] = "ЗаполнитьПоПриходнаяНакладная";
	СтратегияЗаполнения[Тип("ДокументСсылка.АвансовыйОтчет")] = "ЗаполнитьПоАвансовомуОтчету"; 
	СтратегияЗаполнения[Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями")] = "ЗаполнитьПоПередачаТоваровМеждуОрганизациями";
	СтратегияЗаполнения[Тип("ДокументСсылка.ОприходованиеЗапасов")] = "ЗаполнитьПоОприходованиеЗапасов";
	СтратегияЗаполнения[Тип("ДокументСсылка.ПересортицаЗапасов")] = "ЗаполнитьПоПересортицаЗапасов";
	СтратегияЗаполнения[Тип("ДокументСсылка.ПеремещениеЗапасов")] = "ЗаполнитьПоПеремещениеЗапасов";
	СтратегияЗаполнения[Тип("ДокументСсылка.ОтчетПереработчика")] = "ЗаполнитьПоОтчетПереработчика";
	СтратегияЗаполнения[Тип("ДокументСсылка.ЗаказПоставщику")] = "ЗаполнитьПоЗаказПоставщику";
	СтратегияЗаполнения[Тип("ДокументСсылка.СборкаЗапасов")] = "ЗаполнитьПоСборкаЗапасов";
	СтратегияЗаполнения[Тип("ДокументСсылка.КомплектацияЗапасов")] = "ЗаполнитьПоКомплектацияЗапасов";
	СтратегияЗаполнения[Тип("Структура")] = "ЗаполнитьПоСтруктуре"; 
	
	ЗаполнениеОбъектовУНФ.ЗаполнитьДокумент(ЭтотОбъект, ДанныеЗаполнения, СтратегияЗаполнения);
	
КонецПроцедуры // ОбработкаЗаполнения()

// Процедура - обработчик события ОбработкаПроведения объекта.
//
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// Инициализация дополнительных свойств для проведения документа
	ПроведениеДокументовУНФ.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	ДополнительныеСвойства.Вставить("КонтрольОстатковПоЗапасамКПоступлению", КонтролироватьОстаткиПоДокументам);
	КонтролироватьОстатковПоОрерам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоСкладскимОрдерам;
	ДополнительныеСвойства.Вставить("КонтролироватьОстатковПоОрерам", КонтролироватьОстатковПоОрерам);
	
	// Инициализация данных документа
	Документы.ПриходныйОрдер.ИнициализироватьДанныеДокумента(Ссылка, ДополнительныеСвойства);
	
	// Подготовка наборов записей
	ПроведениеДокументовУНФ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	// Отражение в разделах учета
	ТаблицыДляДвижений = ДополнительныеСвойства.ТаблицыДляДвижений;
	ПроведениеДокументовУНФ.ОтразитьДвижения("ЗапасыКПоступлениюНаСклады", ТаблицыДляДвижений, Движения, Отказ);
	ПроведениеДокументовУНФ.ОтразитьДвижения("ЗапасыНаСкладах", ТаблицыДляДвижений, Движения, Отказ);
	
	// СерииНоменклатуры
	ПроведениеДокументовУНФ.ОтразитьДвижения("СерииНоменклатурыГарантии", ТаблицыДляДвижений, Движения, Отказ);
	ПроведениеДокументовУНФ.ОтразитьДвижения("ДвиженияСерииНоменклатуры", ТаблицыДляДвижений, Движения, Отказ);
	ПроведениеДокументовУНФ.ОтразитьДвижения("СерииНоменклатуры", ТаблицыДляДвижений, Движения, Отказ);
	ПроведениеДокументовУНФ.ОтразитьДвижения("СерииНоменклатурыКПоступлению", ТаблицыДляДвижений, Движения, Отказ);
	
	// Запись наборов записей
	ПроведениеДокументовУНФ.ЗаписатьНаборыЗаписей(ЭтотОбъект);
	
	// Контроль
	Документы.ПриходныйОрдер.ВыполнитьКонтроль(Ссылка, ДополнительныеСвойства, Отказ);
	
	ПроведениеДокументовУНФ.ЗакрытьМенеджерВременныхТаблиц(ЭтотОбъект);
	
КонецПроцедуры

// Процедура - обработчик события ОбработкаУдаленияПроведения объекта.
//
Процедура ОбработкаУдаленияПроведения(Отказ)
	
	// Инициализация дополнительных свойств для проведения документа
	ПроведениеДокументовУНФ.ИнициализироватьДополнительныеСвойстваДляПроведения(Ссылка, ДополнительныеСвойства);
	
	// Подготовка наборов записей
	ПроведениеДокументовУНФ.ПодготовитьНаборыЗаписейКРегистрацииДвижений(ЭтотОбъект);
	
	// Запись наборов записей
	ПроведениеДокументовУНФ.ЗаписатьНаборыЗаписей(ЭтотОбъект);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	ДополнительныеСвойства.Вставить("КонтрольОстатковПоЗапасамКПоступлению", КонтролироватьОстаткиПоДокументам);
	
	// Контроль
	Документы.ПриходныйОрдер.ВыполнитьКонтроль(Ссылка, ДополнительныеСвойства, Отказ, Истина);
	
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
		
	// Серии номенклатуры
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Объект", ЭтотОбъект);
	ДополнительныеПараметры.Вставить("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	ДополнительныеПараметры.Вставить("ЭтоОрдер", Истина);
	СерииНоменклатурыУНФ.ПроверитьЗаполнениеСерийНоменклатуры(Отказ, Запасы, СерииНоменклатуры, 
		ДополнительныеПараметры);
	
	НоменклатураВДокументахСервер.ПроверитьЗаполнениеХарактеристик(ЭтотОбъект, Отказ, Истина);
	
	// Подарочные сертификаты
	РаботаСПодарочнымиСертификатами.ПроверитьВозможностьИспользованияСертификатов(Отказ, ЭтотОбъект, "Запасы", "СтруктурнаяЕдиница", Истина);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	Если ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам Тогда
		
		Если Не ЗначениеЗаполнено(ПоложениеДокументаПоступления) Или ПоложениеДокументаПоступления = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке Тогда
			ПроверяемыеРеквизиты.Добавить("ДокументПоступления");
		Иначе
			
			Для Каждого СтрокаТабличнойЧасти Из Запасы Цикл
				
				Если Не ЗначениеЗаполнено(СтрокаТабличнойЧасти.ДокументПоступления) Тогда
					
					ТекстСообщения = ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Колонка", , НСтр(
					"ru = 'Документ поступления'"), СтрокаТабличнойЧасти.НомерСтроки, "Запасы");
					
					Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти("Запасы", СтрокаТабличнойЧасти.НомерСтроки,
					"ЗапасыДокументПоступления");
					ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, Поле, "Объект", Отказ);
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
			
	КонецЕсли;
	
	Если Не СтруктурнаяЕдиница.ИспользоватьОрдернуюСхемуПриПоступлении Тогда 
		Отказ = Истина;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Для склада не ведется ордерный учет при поступлении.'"));
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения) 
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение И ЗначениеЗаполнено(СтруктурнаяЕдиница) Тогда
		
		ЭтоПеремещение = ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.ПеремещениеЗапасов");
		
		Если ЭтоПеремещение Тогда
			ЗначенияРеквизитовСтруктурнойЕдиницы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СтруктурнаяЕдиница,
			"ОрдерныйСклад, ИспользоватьОрдернуюСхемуПриПеремещении, ВидУчетаОрдерныхСкладов");
		Иначе
			ЗначенияРеквизитовСтруктурнойЕдиницы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СтруктурнаяЕдиница,
			"ОрдерныйСклад, ИспользоватьОрдернуюСхемуПриПоступлении, ВидУчетаОрдерныхСкладов");
		КонецЕсли;
		
		ПроверятьИспользованиеОрдернойСхемы = ЗначенияРеквизитовСтруктурнойЕдиницы.ОрдерныйСклад
		И ЗначениеЗаполнено(ЗначенияРеквизитовСтруктурнойЕдиницы.ВидУчетаОрдерныхСкладов) 
		И НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ВидУчетаОрдерныхСкладов = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом;
		
		Если ПроверятьИспользованиеОрдернойСхемы Тогда
			
			Если ЭтоПеремещение Тогда
				Если НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ИспользоватьОрдернуюСхемуПриПеремещении Тогда
					
					ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
					|склад ""%1"" не использует ордерную схему при перемещении'"), СтруктурнаяЕдиница);
					
					ВызватьИсключениеВводНаОсновании(ДокументОснование, ТекстИсключения);
				КонецЕсли;
				
			Иначе
				
				Если НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ИспользоватьОрдернуюСхемуПриПоступлении Тогда
					
					ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
					|склад ""%1"" не использует ордерную схему при поступлении'"), СтруктурнаяЕдиница);
					
					ВызватьИсключениеВводНаОсновании(ДокументОснование, ТекстИсключения);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
	
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ПоложениеЯчейки) Или ПоложениеЯчейки = Перечисления.ПоложениеРеквизитаНаФорме.ВШапке Тогда
		Для Каждого СтрокаЗапасов Из Запасы Цикл
			СтрокаЗапасов.Ячейка = Ячейка;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаполнитьТабличнуюЧастьПоОстаткамСУчетомСерий(РезультатыЗапроса, СтруктурнаяЕдиница) 
	
	Если РезультатыЗапроса[2].Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	ТаблицаСерииНоменклатуры = РезультатыЗапроса[3].Выгрузить();
	ТаблицаОстаткиСерииНоменклатуры = РезультатыЗапроса[5].Выгрузить();
	ТаблицаОстаткиЗапасы = РезультатыЗапроса[2].Выгрузить();
	
	ВыборкаЗапасы = РезультатыЗапроса[0].Выбрать();
	
	ПараметрыПоискаСерии = Новый Структура("КлючСвязи");
	
	Если СкладскойУчетСервер.КонтролироватьОстаткиПоЯчейкамКПоступлениюОтгрзуке(СтруктурнаяЕдиница) Тогда
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия, Ячейка");
	Иначе
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия");
	КонецЕсли;
	
	ПараметрыПоискаОстаткиСерииНоменклатуры = Новый Структура("Номенклатура, Характеристика, Партия, Серия");

	Пока ВыборкаЗапасы.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(ВыборкаЗапасы.Количество) Тогда
			Продолжить;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиЗапасы, ВыборкаЗапасы);
		НайденныеОстаткиЗапасы = ТаблицаОстаткиЗапасы.НайтиСтроки(ПараметрыПоискаОстаткиЗапасы);
		
		Если Не НайденныеОстаткиЗапасы.Количество() Или (НайденныеОстаткиЗапасы.Количество() И НайденныеОстаткиЗапасы[0].Количество = 0) Тогда
			Продолжить
		КонецЕсли;
		
		ОстатокЗапасов = НайденныеОстаткиЗапасы[0];
		
		ЗаполнитьЗначенияСвойств(ПараметрыПоискаСерии, ВыборкаЗапасы);
		НайденныеСерии = ТаблицаСерииНоменклатуры.НайтиСтроки(ПараметрыПоискаСерии);
		
		КоличествоСерий = 0;
		ИспользуютсяСерииВСтроке = Ложь;
		Для Каждого СтрокаСерии Из НайденныеСерии Цикл
			
			ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиСерииНоменклатуры, СтрокаСерии);
			НайденныеОстаткиСерий = ТаблицаОстаткиСерииНоменклатуры.НайтиСтроки(ПараметрыПоискаОстаткиСерииНоменклатуры);
			
			ИспользуютсяСерииВСтроке = Истина;
			
			Если Не НайденныеОстаткиСерий.Количество() Или (НайденныеОстаткиСерий.Количество() И НайденныеОстаткиСерий[0].Количество = 0) Тогда
				Продолжить
			КонецЕсли;
			
			ОстатокСерий = НайденныеОстаткиСерий[0];
			
			Если Не ОстатокСерий.Количество > 0 Тогда
				Продолжить;
			КонецЕсли;
			
			НоваяСтрокаСерии = СерииНоменклатуры.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрокаСерии, СтрокаСерии); 
			
			Если НоваяСтрокаСерии.Количество >= ОстатокСерий.Количество Тогда
				НоваяСтрокаСерии.Количество = ОстатокСерий.Количество;
			КонецЕсли;
			
			ОстатокСерий.Количество = ОстатокСерий.Количество - НоваяСтрокаСерии.Количество;
			
			КоличествоСерий = КоличествоСерий + НоваяСтрокаСерии.Количество;
			
		КонецЦикла;
		
		Если ИспользуютсяСерииВСтроке И КоличествоСерий = 0 Тогда
			Продолжить
		КонецЕсли;
		
		НоваяСтрокаЗапасы = Запасы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаЗапасы, ВыборкаЗапасы);
		
		Если ТипЗнч(НоваяСтрокаЗапасы.ЕдиницаИзмерения) = ТИП("СправочникСсылка.КлассификаторЕдиницИзмерения") Тогда
			
			КоличествоВСтрокеЗапасов = ?(КоличествоСерий > 0, КоличествоСерий, НоваяСтрокаЗапасы.Количество);
			
			Если КоличествоВСтрокеЗапасов >= ОстатокЗапасов.Количество Тогда
				КоличествоВСтрокеЗапасов = ОстатокЗапасов.Количество;
				ОстатокЗапасов.Количество = 0;
			Иначе
				ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоВСтрокеЗапасов;
			КонецЕсли;
			
			НоваяСтрокаЗапасы.Количество = КоличествоВСтрокеЗапасов;
			
		Иначе
			
			КоличествоСтрокиВЕдиницахХранения = НоваяСтрокаЗапасы.Количество * НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
			КоличествоВСтрокеЗапасов = ?(КоличествоСерий > 0, КоличествоСерий, КоличествоСтрокиВЕдиницахХранения);
			
			Если КоличествоВСтрокеЗапасов >= ОстатокЗапасов.Количество Тогда
				КоличествоВСтрокеЗапасов = ОстатокЗапасов.Количество;
				ОстатокЗапасов.Количество = 0;
			Иначе
				ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоВСтрокеЗапасов;
			КонецЕсли;
			
			НоваяСтрокаЗапасы.Количество = КоличествоВСтрокеЗапасов/ НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;;
			
		КонецЕсли;
		
		Если СерииНоменклатурыУНФ.ИспользоватьСерииНоменклатурыОстатки() = Истина Тогда
			НоваяСтрокаЗапасы.СерииНоменклатуры = СерииНоменклатурыУНФ.ПредставлениеСерийНоменклатуры(СерииНоменклатуры, НоваяСтрокаЗапасы.КлючСвязи)
		КонецЕсли;
			
	КонецЦикла;
	
КонецПроцедуры

// Осуществляет проверку возможности ввода на основании.
//
Процедура ПроверитьВозможностьВводаНаОсновании(ДокументСсылка, ЗначенияРеквизитов)
	
	Если ЗначенияРеквизитов.Свойство("СтруктурнаяЕдиница") Тогда 
		
		ЭтоПеремещение = ТипЗнч(ДокументСсылка) = Тип("ДокументСсылка.ПеремещениеЗапасов");
		
		Если ЗначениеЗаполнено(ЗначенияРеквизитов.СтруктурнаяЕдиница) Тогда
			
			Если ЭтоПеремещение Тогда
				ЗначенияРеквизитовСтруктурнойЕдиницы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЗначенияРеквизитов.СтруктурнаяЕдиница,
				"ОрдерныйСклад, ИспользоватьОрдернуюСхемуПриПеремещении, ВидУчетаОрдерныхСкладов");
			Иначе
				ЗначенияРеквизитовСтруктурнойЕдиницы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЗначенияРеквизитов.СтруктурнаяЕдиница,
				"ОрдерныйСклад, ИспользоватьОрдернуюСхемуПриПоступлении, ВидУчетаОрдерныхСкладов");
			КонецЕсли;
			
			ПроверятьИспользованиеОрдернойСхемы = ЗначениеЗаполнено(ЗначенияРеквизитовСтруктурнойЕдиницы.ВидУчетаОрдерныхСкладов) 
			И НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ВидУчетаОрдерныхСкладов = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом;
			
			Если НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ОрдерныйСклад Тогда
				ВызватьИсключениеВводНаОсновании(ДокументСсылка);
			КонецЕсли;
			
			Если ПроверятьИспользованиеОрдернойСхемы Тогда
				
				Если ЭтоПеремещение Тогда
					Если ЗначенияРеквизитовСтруктурнойЕдиницы.ОрдерныйСклад И
						НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ИспользоватьОрдернуюСхемуПриПеремещении Тогда
						
						ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
						|Документ ""%1"" не использует ордерную схему при перемещении'"), ДокументСсылка);
						
						ВызватьИсключениеВводНаОсновании(ДокументСсылка, ТекстИсключения);
					КонецЕсли;
					
				Иначе
					
					Если ЗначенияРеквизитовСтруктурнойЕдиницы.ОрдерныйСклад И
						НЕ ЗначенияРеквизитовСтруктурнойЕдиницы.ИспользоватьОрдернуюСхемуПриПоступлении Тогда
						
						ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
						|Документ ""%1"" не использует ордерную схему при поступлении'"), ДокументСсылка);
						
						ВызватьИсключениеВводНаОсновании(ДокументСсылка, ТекстИсключения);
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначенияРеквизитов.Свойство("СтруктурнаяЕдиницаПолучатель") Тогда
		Если ЗначениеЗаполнено(ЗначенияРеквизитов.СтруктурнаяЕдиницаПолучатель)
				И НЕ ЗначенияРеквизитов.СтруктурнаяЕдиницаПолучатель.ОрдерныйСклад Тогда
			ВызватьИсключениеВводНаОсновании(ДокументСсылка);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ВызватьИсключениеВводНаОсновании(ДокументСсылка, ТекстИсключения = Неопределено) 
	
	Если ТекстИсключения = Неопределено Тогда
		ТекстИсключения = СтрШаблон(НСтр("ru = 'Невозможен ввод операции ""Поступления на ордерный склад"".
		|Документ ""%1"" не имеет ордерного склада.'"), ДокументСсылка);
	КонецЕсли;
	
	ВызватьИсключение ТекстИсключения;
	
КонецПроцедуры

Функция ЕстьОрдерныйСкладВТабЧасти(ТабЧасть, ВернутьОрдерныйСклад = Ложь) 
	
	ЗначенияРеквизитовСкладТЧ = ТабЧасть.ВыгрузитьКолонку("СтруктурнаяЕдиница");
	ЗначенияОрдерныйСклад = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(ЗначенияРеквизитовСкладТЧ, "ОрдерныйСклад");
	ЗначенияУчастоватьПриПоступлении = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(ЗначенияРеквизитовСкладТЧ, "ИспользоватьОрдернуюСхемуПриПоступлении");
	ВидУчетаОрдерныхСкладов = ОбщегоНазначения.ЗначениеРеквизитаОбъектов(ЗначенияРеквизитовСкладТЧ, "ВидУчетаОрдерныхСкладов");
	
	Для каждого СкладТЧ Из ЗначенияРеквизитовСкладТЧ Цикл
		
		ОрдерныйСклад = ЗначенияОрдерныйСклад.Получить(СкладТЧ);
		
		Если ОрдерныйСклад = Ложь Тогда
			Продолжить;
		КонецЕсли;
		
		ОрдернаяСхема = ВидУчетаОрдерныхСкладов.Получить(СкладТЧ);
		
		Если ЗначениеЗаполнено(ОрдернаяСхема) И Не ОрдернаяСхема = Перечисления.ВидыУчетаОрдерныхСкладов.ПоСкладуВЦелом Тогда
			Если ВернутьОрдерныйСклад Тогда
				Возврат Новый Структура("ЕстьОрдерныйСклад, СтруктурнаяЕдиница", ЗначенияУчастоватьПриПоступлении.Получить(СкладТЧ), СкладТЧ);
			Иначе
				Возврат ЗначенияУчастоватьПриПоступлении.Получить(СкладТЧ)
			КонецЕсли;
		Иначе
			Если ВернутьОрдерныйСклад Тогда
				Возврат Новый Структура("ЕстьОрдерныйСклад, СтруктурнаяЕдиница", Истина, СкладТЧ);
			Иначе
				Возврат Истина
			КонецЕсли
		КонецЕсли;
		
	КонецЦикла;
	
	Если ВернутьОрдерныйСклад Тогда
		Возврат Новый Структура("ЕстьОрдерныйСклад, СтруктурнаяЕдиница", Ложь, Неопределено);
	Иначе
		Возврат Ложь
	КонецЕсли;
	
КонецФункции

Процедура ЗаполнитьШапкуПоСборкаЗапасов(ДокументСсылкаСборкаЗапасов, ЗначенияРеквизитов, МассивТЧОрдер)
	
	ДокументОснование = ДокументСсылкаСборкаЗапасов;
	
	Организация = ЗначенияРеквизитов.Организация;
	
	Если ЗначенияРеквизитов.ПоложениеСклада = Перечисления.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти Тогда
		
		Если ЕстьОрдерныйСкладВТабЧасти(ДокументСсылкаСборкаЗапасов.Продукция) Тогда
			МассивТЧОрдер.Добавить("Продукция");
		КонецЕсли; 
		Если ЕстьОрдерныйСкладВТабЧасти(ДокументСсылкаСборкаЗапасов.Запасы) Тогда
			МассивТЧОрдер.Добавить("Запасы");
		КонецЕсли; 
		
		СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиницаПродукции;
		Ячейка = ЗначенияРеквизитов.ЯчейкаПродукции;
						
	Иначе
		
		Если ЗначенияРеквизитов.СтруктурнаяЕдиница.ОрдерныйСклад Тогда
			
			Если ЗначенияРеквизитов.ВидОперации = Перечисления.ВидыОперацийСборкаЗапасов.Разборка Тогда
				МассивТЧОрдер.Добавить("Запасы");
			Иначе
				МассивТЧОрдер.Добавить("Продукция");
			КонецЕсли;
			
			СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиница;
			Ячейка = ЗначенияРеквизитов.Ячейка;
			
		Иначе
			
			Если ЗначенияРеквизитов.СтруктурнаяЕдиницаПродукции.ОрдерныйСклад Тогда
				
				Если ЗначенияРеквизитов.ВидОперации = Перечисления.ВидыОперацийСборкаЗапасов.Разборка Тогда
					МассивТЧОрдер.Добавить("Запасы");
				Иначе
					МассивТЧОрдер.Добавить("Продукция");
				КонецЕсли;
				
				СтруктурнаяЕдиница = ЗначенияРеквизитов.СтруктурнаяЕдиницаПродукции;
				Ячейка = ЗначенияРеквизитов.ЯчейкаПродукции;
								
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли; 
	Если ЗначенияРеквизитов.СтруктурнаяЕдиницаОтходов.ОрдерныйСклад Тогда
		МассивТЧОрдер.Добавить("Отходы");
	КонецЕсли;
	
	Если МассивТЧОрдер.Количество() = 0 Тогда
		ВызватьИсключениеВводНаОсновании(ДокументСсылкаСборкаЗапасов);
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьТабличнуюЧастьПоСборкаЗапасов(ДокументСсылкаСборкаЗапасов, ЗначенияРеквизитов, МассивТЧОрдер) 
	
	ЗапросЗапасы = Новый Запрос;
	
	ЗапросЗапасы.Текст = 
	"ВЫБРАТЬ
	|	СборкаЗапасов.Продукция.(
	|		Номенклатура КАК Номенклатура,
	|		Характеристика КАК Характеристика,
	|		Партия КАК Партия,
	|		Количество КАК Количество,
	|		ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		СерииНоменклатуры КАК СерииНоменклатуры,
	|		СборкаЗапасов.Продукция.СтруктурнаяЕдиница.ОрдерныйСклад
	|			И СборкаЗапасов.Продукция.СтруктурнаяЕдиница.ИспользоватьОрдернуюСхемуПриПоступлении КАК ОрдерныйСклад,
	|		КлючСвязи КАК КлючСвязи,
	|		Ячейка КАК Ячейка
	|	) КАК Продукция,
	|	СборкаЗапасов.Запасы.(
	|		Номенклатура КАК Номенклатура,
	|		Характеристика КАК Характеристика,
	|		Партия КАК Партия,
	|		Количество КАК Количество,
	|		ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		СерииНоменклатуры КАК СерииНоменклатуры,
	|		СборкаЗапасов.Запасы.СтруктурнаяЕдиница.ОрдерныйСклад
	|			И СборкаЗапасов.Запасы.СтруктурнаяЕдиница.ИспользоватьОрдернуюСхемуПриПоступлении КАК ОрдерныйСклад,
	|		КлючСвязи КАК КлючСвязи,
	|		Ячейка КАК Ячейка
	|	) КАК Запасы,
	|	СборкаЗапасов.Отходы.(
	|		Номенклатура КАК Номенклатура,
	|		Характеристика КАК Характеристика,
	|		Партия КАК Партия,
	|		Количество КАК Количество,
	|		ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|		ЛОЖЬ КАК ОрдерныйСклад
	|	) КАК Отходы
	|ИЗ
	|	Документ.СборкаЗапасов КАК СборкаЗапасов
	|ГДЕ
	|	СборкаЗапасов.Ссылка = &ДокументОснование";
	
	ЗапросОстаткиИСерии = Новый Запрос(
	"ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСкладыОстатки.Номенклатура КАК Номенклатура,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Характеристика КАК Характеристика,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Партия КАК Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|		ИНАЧЕ ЗапасыКПоступлениюНаСкладыОстатки.КоличествоОстаток
	|	КОНЕЦ КАК Количество,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступления,
	|	ЗапасыКПоступлениюНаСкладыОстатки.Ячейка КАК Ячейка
	|ПОМЕСТИТЬ ЗапасыОстаткиИтог
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК ЗапасыКПоступлениюНаСкладыОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗапасыКПоступлениюНаСклады.Номенклатура,
	|	ЗапасыКПоступлениюНаСклады.Характеристика,
	|	ЗапасыКПоступлениюНаСклады.Партия,
	|	ВЫБОР
	|		КОГДА ЗапасыКПоступлениюНаСклады.Количество < 0
	|			ТОГДА -ЗапасыКПоступлениюНаСклады.Количество
	|		ИНАЧЕ ЗапасыКПоступлениюНаСклады.Количество
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА &КонтролироватьОстаткиПоДокументам
	|			ТОГДА &ДокументОснование
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ЗапасыКПоступлениюНаСклады.Ячейка
	|ИЗ
	|	РегистрНакопления.ЗапасыКПоступлениюНаСклады КАК ЗапасыКПоступлениюНаСклады
	|ГДЕ
	|	ЗапасыКПоступлениюНаСклады.ДокументОснование = &ДокументОснование
	|	И ЗапасыКПоступлениюНаСклады.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗапасыОстаткиИтог.Номенклатура КАК Номенклатура,
	|	ЗапасыОстаткиИтог.Характеристика КАК Характеристика,
	|	ЗапасыОстаткиИтог.Партия КАК Партия,
	|	СУММА(ЗапасыОстаткиИтог.Количество) КАК Количество,
	|	ЗапасыОстаткиИтог.ДокументПоступления КАК ДокументПоступления,
	|	ЗапасыОстаткиИтог.Ячейка КАК Ячейка
	|ИЗ
	|	ЗапасыОстаткиИтог КАК ЗапасыОстаткиИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапасыОстаткиИтог.Номенклатура,
	|	ЗапасыОстаткиИтог.Ячейка,
	|	ЗапасыОстаткиИтог.Характеристика,
	|	ЗапасыОстаткиИтог.Партия,
	|	ЗапасыОстаткиИтог.ДокументПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СборкаЗапасовЗапасы.Номенклатура КАК Номенклатура,
	|	СборкаЗапасовЗапасы.Характеристика КАК Характеристика,
	|	СборкаЗапасовЗапасы.Партия КАК Партия,
	|	СборкаЗапасовСерииНоменклатуры.Серия КАК Серия,
	|	СборкаЗапасовЗапасы.КлючСвязи КАК КлючСвязи,
	|	СборкаЗапасовСерииНоменклатуры.Количество КАК Количество
	|ИЗ
	|	Документ.СборкаЗапасов.Запасы КАК СборкаЗапасовЗапасы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаЗапасов.СерииНоменклатуры КАК СборкаЗапасовСерииНоменклатуры
	|		ПО СборкаЗапасовЗапасы.КлючСвязи = СборкаЗапасовСерииНоменклатуры.КлючСвязи
	|ГДЕ
	|	СборкаЗапасовЗапасы.Ссылка = &ДокументОснование
	|	И СборкаЗапасовСерииНоменклатуры.Ссылка = &ДокументОснование
	|	И ВЫБОР
	|			КОГДА СборкаЗапасовЗапасы.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|				ТОГДА СборкаЗапасовЗапасы.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	И СборкаЗапасовЗапасы.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийСборкаЗапасов.Разборка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СборкаЗапасовПродукция.Номенклатура,
	|	СборкаЗапасовПродукция.Характеристика,
	|	СборкаЗапасовПродукция.Партия,
	|	СборкаЗапасовСерииНоменклатурыПродукция.Серия,
	|	СборкаЗапасовПродукция.КлючСвязи,
	|	СборкаЗапасовСерииНоменклатурыПродукция.Количество
	|ИЗ
	|	Документ.СборкаЗапасов.Продукция КАК СборкаЗапасовПродукция
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СборкаЗапасов.СерииНоменклатурыПродукция КАК СборкаЗапасовСерииНоменклатурыПродукция
	|		ПО СборкаЗапасовПродукция.КлючСвязи = СборкаЗапасовСерииНоменклатурыПродукция.КлючСвязи
	|ГДЕ
	|	СборкаЗапасовПродукция.Ссылка = &ДокументОснование
	|	И СборкаЗапасовСерииНоменклатурыПродукция.Ссылка = &ДокументОснование
	|	И ВЫБОР
	|			КОГДА СборкаЗапасовПродукция.Ссылка.ПоложениеСклада = ЗНАЧЕНИЕ(Перечисление.ПоложениеРеквизитаНаФорме.ВТабличнойЧасти)
	|				ТОГДА СборкаЗапасовПродукция.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|	И СборкаЗапасовПродукция.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийСборкаЗапасов.Сборка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлениюОстатки.Серия КАК Серия,
	|	-СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток КАК Количество,
	|	СерииНоменклатурыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	|	СерииНоменклатурыКПоступлениюОстатки.Характеристика КАК Характеристика,
	|	СерииНоменклатурыКПоступлениюОстатки.Партия КАК Партия
	|ПОМЕСТИТЬ ОстаткиСерииИтог
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению.Остатки(
	|			,
	|			Организация = &Организация
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И ДокументОснование = &ДокументОснование) КАК СерииНоменклатурыКПоступлениюОстатки
	|ГДЕ
	|	СерииНоменклатурыКПоступлениюОстатки.КоличествоОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СерииНоменклатурыКПоступлению.Серия,
	|	СерииНоменклатурыКПоступлению.Количество,
	|	СерииНоменклатурыКПоступлению.Номенклатура,
	|	СерииНоменклатурыКПоступлению.Характеристика,
	|	СерииНоменклатурыКПоступлению.Партия
	|ИЗ
	|	РегистрНакопления.СерииНоменклатурыКПоступлению КАК СерииНоменклатурыКПоступлению
	|ГДЕ
	|	СерииНоменклатурыКПоступлению.ДокументОснование = &ДокументОснование
	|	И СерииНоменклатурыКПоступлению.Регистратор = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОстаткиСерииИтог.Серия КАК Серия,
	|	СУММА(ОстаткиСерииИтог.Количество) КАК Количество,
	|	ОстаткиСерииИтог.Номенклатура КАК Номенклатура,
	|	ОстаткиСерииИтог.Характеристика КАК Характеристика,
	|	ОстаткиСерииИтог.Партия КАК Партия
	|ИЗ
	|	ОстаткиСерииИтог КАК ОстаткиСерииИтог
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиСерииИтог.Партия,
	|	ОстаткиСерииИтог.Характеристика,
	|	ОстаткиСерииИтог.Номенклатура,
	|	ОстаткиСерииИтог.Серия");
	
	ЗапросОстаткиИСерии.УстановитьПараметр("Ссылка", Ссылка);
	ЗапросОстаткиИСерии.УстановитьПараметр("Организация", Константы.УчетПоКомпании.Компания(Организация));
	ЗапросОстаткиИСерии.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	ВидУчета = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтруктурнаяЕдиница, "ВидУчетаОрдерныхСкладов");
	КонтролироватьОстаткиПоДокументам = ВидУчета = Перечисления.ВидыУчетаОрдерныхСкладов.УчетОстатковПоПрочимДокументам;
	
	ЗапросОстаткиИСерии.УстановитьПараметр("КонтролироватьОстаткиПоДокументам", КонтролироватьОстаткиПоДокументам);
	ЗапросОстаткиИСерии.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылкаСборкаЗапасов, Неопределено));
	
	ЗапросЗапасы.УстановитьПараметр("ДокументОснование", ?(КонтролироватьОстаткиПоДокументам, ДокументСсылкаСборкаЗапасов, Неопределено));
	
	ДокументПоступления = ?(КонтролироватьОстаткиПоДокументам, ДокументСсылкаСборкаЗапасов, Неопределено);
	
	Запасы.Очистить();
	СерииНоменклатуры.Очистить();
	
	РезультатЗапросаЗапасы = ЗапросЗапасы.Выполнить();
	Если РезультатЗапросаЗапасы.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	РезультатыЗапроса = ЗапросОстаткиИСерии.ВыполнитьПакет();
	
	ТаблицаСерииНоменклатуры = РезультатыЗапроса[2].Выгрузить();
	ТаблицаОстаткиСерииНоменклатуры = РезультатыЗапроса[4].Выгрузить();
	ТаблицаОстаткиЗапасы = РезультатыЗапроса[1].Выгрузить();
	
	ПараметрыПоискаСерии = Новый Структура("КлючСвязи");
	
	Если СкладскойУчетСервер.КонтролироватьОстаткиПоЯчейкамКПоступлениюОтгрзуке(СтруктурнаяЕдиница) Тогда
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия, Ячейка");
	Иначе
		ПараметрыПоискаОстаткиЗапасы = Новый Структура("Номенклатура, Характеристика, Партия");
	КонецЕсли;
	
	ПараметрыПоискаОстаткиСерииНоменклатуры = Новый Структура("Номенклатура, Характеристика, Партия, Серия");
	
	ВыборкаЗапасы = РезультатЗапросаЗапасы.Выбрать();
	ВыборкаЗапасы.Следующий();
	Для Каждого ИмяТабличнойЧасти Из МассивТЧОрдер Цикл
		
		ТаблицаДНоменклатурыДокумента = ВыборкаЗапасы[ИмяТабличнойЧасти].Выгрузить();
		
		Для каждого СтрокаТаблицы Из ТаблицаДНоменклатурыДокумента Цикл
			
			Если Не ЗначениеЗаполнено(СтрокаТаблицы.Количество) Тогда
				Продолжить;
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиЗапасы, СтрокаТаблицы);
			НайденныеОстаткиЗапасы = ТаблицаОстаткиЗапасы.НайтиСтроки(ПараметрыПоискаОстаткиЗапасы);
			
			Если Не НайденныеОстаткиЗапасы.Количество() Или (НайденныеОстаткиЗапасы.Количество() И НайденныеОстаткиЗапасы[0].Количество = 0) Тогда
				Продолжить
			КонецЕсли;
			
			ОстатокЗапасов = НайденныеОстаткиЗапасы[0];
			
			Если Не ИмяТабличнойЧасти = "Отходы" Тогда
					
				Если СтрокаТаблицы.ОрдерныйСклад Тогда
					
					ЗаполнитьЗначенияСвойств(ПараметрыПоискаСерии, СтрокаТаблицы);
					НайденныеСерии = ТаблицаСерииНоменклатуры.НайтиСтроки(ПараметрыПоискаСерии);
					
					КоличествоСерий = 0;
					ИспользуютсяСерииВСтроке = Ложь;
					Для Каждого СтрокаСерии Из НайденныеСерии Цикл
						
						ИспользуютсяСерииВСтроке = Истина;
						
						ЗаполнитьЗначенияСвойств(ПараметрыПоискаОстаткиСерииНоменклатуры, СтрокаСерии);
						НайденныеОстаткиСерий = ТаблицаОстаткиСерииНоменклатуры.НайтиСтроки(ПараметрыПоискаОстаткиСерииНоменклатуры);
						
						Если Не НайденныеОстаткиСерий.Количество() Или (НайденныеОстаткиСерий.Количество() И НайденныеОстаткиСерий[0].Количество = 0) Тогда
							Продолжить
						КонецЕсли;
						
						ОстатокСерий = НайденныеОстаткиСерий[0];
						
						Если Не ОстатокСерий.Количество > 0 Тогда
							Продолжить;
						КонецЕсли;
						
						НоваяСтрокаСерии = СерииНоменклатуры.Добавить();
						ЗаполнитьЗначенияСвойств(НоваяСтрокаСерии, СтрокаСерии); 
						
						Если НоваяСтрокаСерии.Количество >= ОстатокСерий.Количество Тогда
							НоваяСтрокаСерии.Количество = ОстатокСерий.Количество;
						КонецЕсли;
						
						ОстатокСерий.Количество = ОстатокСерий.Количество - НоваяСтрокаСерии.Количество;
						
						КоличествоСерий = КоличествоСерий + НоваяСтрокаСерии.Количество;
						
					КонецЦикла;
					
					Если ИспользуютсяСерииВСтроке И КоличествоСерий = 0 Тогда
						Продолжить
					КонецЕсли;
					
					НоваяСтрокаЗапасы = Запасы.Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрокаЗапасы, СтрокаТаблицы);
					НоваяСтрокаЗапасы.ДокументПоступления = ДокументПоступления;
					
					
					Если ТипЗнч(НоваяСтрокаЗапасы.ЕдиницаИзмерения) = ТИП("СправочникСсылка.КлассификаторЕдиницИзмерения") Тогда
						
						КоличествоВСтрокеЗапасов = ?(КоличествоСерий > 0, КоличествоСерий, НоваяСтрокаЗапасы.Количество);
						
						Если КоличествоВСтрокеЗапасов >= ОстатокЗапасов.Количество Тогда
							КоличествоВСтрокеЗапасов = ОстатокЗапасов.Количество;
							ОстатокЗапасов.Количество = 0;
						Иначе
							ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоВСтрокеЗапасов;
						КонецЕсли;
						
						НоваяСтрокаЗапасы.Количество = КоличествоВСтрокеЗапасов;
						
					Иначе
						
						КоличествоСтрокиВЕдиницахХранения = НоваяСтрокаЗапасы.Количество * НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;
						КоличествоВСтрокеЗапасов = ?(КоличествоСерий > 0, КоличествоСерий, КоличествоСтрокиВЕдиницахХранения);
						
						Если КоличествоВСтрокеЗапасов >= ОстатокЗапасов.Количество Тогда
							КоличествоВСтрокеЗапасов = ОстатокЗапасов.Количество;
							ОстатокЗапасов.Количество = 0;
						Иначе
							ОстатокЗапасов.Количество = ОстатокЗапасов.Количество - КоличествоВСтрокеЗапасов;
						КонецЕсли;
						
						НоваяСтрокаЗапасы.Количество = КоличествоВСтрокеЗапасов/ НоваяСтрокаЗапасы.ЕдиницаИзмерения.Коэффициент;;
						
					КонецЕсли;
					
					Если СерииНоменклатурыУНФ.ИспользоватьСерииНоменклатурыОстатки() = Истина Тогда
						НоваяСтрокаЗапасы.СерииНоменклатуры = СерииНоменклатурыУНФ.ПредставлениеСерийНоменклатуры(СерииНоменклатуры, НоваяСтрокаЗапасы.КлючСвязи)
					КонецЕсли;
					
				КонецЕсли;
			Иначе
				НоваяСтрока = Запасы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы);
			КонецЕсли;
			
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры 

#КонецОбласти

#Иначе
ВызватьИсключение НСтр("ru = 'Недопустимый вызов объекта на клиенте.'");
#КонецЕсли