
&НаКлиенте
Процедура ДобавитьНовуюИнтеграцию(Команда)
	ОткрытьФорму("Справочник.НастройкиИнтеграцииСИнтернетМагазином.Форма.ФормаНастройкиСайт", Новый Структура,
	ЭтаФорма, УникальныйИдентификатор);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ОбновитьИнтеграцияСИнтернетМагазином" Тогда
		Элементы.Список.Обновить();
	ИначеЕсли ИмяСобытия = "ЗакрытьФормуСпискаНастройкиИнтеграцииСИнтернетМагазином" Тогда
		Закрыть();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗавершенияОбменаССайтом( Результат, ДополнительныеПараметры ) Экспорт
	Если ТипЗнч( ДополнительныеПараметры ) = Тип( "ФормаКлиентскогоПриложения" ) Тогда
		ФормаОбмена = ДополнительныеПараметры;
		Если ФормаОбмена.Открыта() Тогда
			ФормаОбмена.Закрыть();
		КонецЕсли;
	КонецЕсли;
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	НастройкаИнтеграции = Элементы.Список.ТекущаяСтрока;
	
	Если Результат.Статус = "Ошибка" Тогда
		ЖурналРегистрацииКлиент.ДобавитьСообщениеДляЖурналаРегистрации(НСтр("ru = 'Выполнение обмена с сайтом'",
		ОбщегоНазначенияКлиент.КодОсновногоЯзыка()), "Ошибка", Результат.ПодробноеПредставлениеОшибки, , Истина);
		
		СообщениеТекст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Выполнение обмена с сайтом прервано по причине:
		|%1 '"),
		Результат.ПодробноеПредставлениеОшибки);
		ОбщегоНазначенияКлиент.СообщитьПользователю( СообщениеТекст );
		
		Возврат;
	КонецЕсли;
    
    РезультатВыполнения = ПолучитьИзВременногоХранилища( Результат.АдресРезультата );
    
	Если Результат.Свойство( "Сообщения" ) Тогда
		Если Результат.Сообщения.Количество() > 0 Тогда
			// группировка сообщений
			Сообщения = Новый Массив;
			Для Каждого СообщениеЭлемент Из Результат.Сообщения Цикл
				Если Сообщения.Найти( СообщениеЭлемент.Текст ) = Неопределено Тогда
					Сообщения.Добавить( СообщениеЭлемент.Текст );
				КонецЕсли;
			КонецЦикла;
			
			Для Каждого СообщениеТекст Из Сообщения Цикл
				ОбщегоНазначенияКлиент.СообщитьПользователю( СообщениеТекст );
			КонецЦикла;
			
		КонецЕсли;
	КонецЕсли;
	
	ПоказатьОповещениеПользователя(
	СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
	НСтр("ru = '%1 ""%2""'"),
	Формат(ОбщегоНазначенияКлиент.ДатаСеанса(), "ДЛФ=DT"),
	НастройкаИнтеграции) 
	,,
	НСтр("ru = 'Обмен с сайтом завершен'"),
	БиблиотекаКартинок.Информация32);
	
	Оповестить("ЗавершенСеансОбменаССайтом", НастройкаИнтеграции);
	
КонецПроцедуры
